<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>35 个 Java 代码优化的细节，你知道几个？</title>
    <url>/2019/70236c20.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>代码优化 ，一个很重要的课题。可能有些人觉得没用，一些细小的地方有什么好修改的，改与不改对于代码的运行效率有什么影响呢？这个问题我是这么考虑的，就像大海里面的鲸鱼一样，它吃一条小虾米有用吗？没用，但是，吃的小虾米一多之后，鲸鱼就被喂饱了。</p>
<p>代码优化也是一样，如果项目着眼于尽快无 BUG 上线，那么此时可以抓大放小，代码的细节可以不精打细磨；但是如果有足够的时间开发、维护代码，这时候就必须考虑每个可以优化的细节了，一个一个细小的优化点累积起来，对于代码的运行效率绝对是有提升的。</p>
<span id="more"></span>

<p>转载自<code>掘金</code> @程序员追风 <a class="link" href="https://juejin.im/post/5d67d1a36fb9a06af629c388">https://juejin.im/post/5d67d1a36fb9a06af629c388<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>代码优化的目标是：</p>
<ul>
<li>减小代码的体积</li>
<li>提高代码运行的效率</li>
</ul>
<h2 id="代码优化细节"><a href="#代码优化细节" class="headerlink" title="代码优化细节"></a>代码优化细节</h2><h4 id="1、尽量指定类、方法的-final-修饰符"><a href="#1、尽量指定类、方法的-final-修饰符" class="headerlink" title="1、尽量指定类、方法的 final 修饰符"></a>1、尽量指定类、方法的 final 修饰符</h4><p>带有 final 修饰符的类是不可派生的。在 Java 核心 API 中，有许多应用 final 的例子，例如 <code>java.lang.String</code>，整个类都是 final 的。为类指定 final 修饰符可以让类不可以被继承，为方法指定 final 修饰符可以让方法不可以被重写。如果指定了一个类为 final，则该类所有的方法都是 final 的。Java 编译器会寻找机会内联所有的 final 方法，内联对于提升 Java 运行效率作用重大，具体参见 Java 运行期优化。 此举能够使性能平均提高 50% 。</p>
<h4 id="2、尽量重用对象"><a href="#2、尽量重用对象" class="headerlink" title="2、尽量重用对象"></a>2、尽量重用对象</h4><p>特别是 String 对象的使用，出现字符串连接时应该使用 <code>StringBuilder/StringBuffer</code> 代替。由于 Java 虚拟机不仅要花时间生成对象，以后可能还需要花时间对这些对象进行垃圾回收和处理，因此，生成过多的对象将会给程序的性能带来很大的影响。</p>
<h4 id="3、尽可能使用局部变量"><a href="#3、尽可能使用局部变量" class="headerlink" title="3、尽可能使用局部变量"></a>3、尽可能使用局部变量</h4><p>调用方法时传递的参数以及在调用中创建的临时变量都保存在栈中速度较快，其他变量，如静态变量、实例变量等，都在堆中创建，速度较慢。另外，栈中创建的变量，随着方法的运行结束，这些内容就没了，不需要额外的垃圾回收。</p>
<h4 id="4、及时关闭流"><a href="#4、及时关闭流" class="headerlink" title="4、及时关闭流"></a>4、及时关闭流</h4><p>Java 编程过程中，进行数据库连接、I/O 流操作时务必小心，在使用完毕后，及时关闭以释放资源。因为对这些大对象的操作会造成系统大的开销，稍有不慎，将会导致严重的后果。</p>
<h4 id="5、尽量减少对变量的重复计算"><a href="#5、尽量减少对变量的重复计算" class="headerlink" title="5、尽量减少对变量的重复计算"></a>5、尽量减少对变量的重复计算</h4><p>明确一个概念，对方法的调用，即使方法中只有一句语句，也是有消耗的，包括创建栈帧、调用方法时保护现场、调用方法完毕时恢复现场等。所以例如下面的操作：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++)</span><br><span class="line">{...}</span><br></pre></td></tr></tbody></table></figure></div>

<p>建议替换为：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://user-gold-cdn.xitu.io/2019/8/29/16cdd8ae1b53e4d0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>,<span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> list.size(); i &lt; length; i++)  <span class="comment">//修改原文中的错误 length定义时不用再加上int</span></span><br><span class="line">{...}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这样，在 <code>list.size()</code> 很大的时候，就减少了很多的消耗</p>
<h4 id="6、尽量采用懒加载的策略，即在需要的时候才创建"><a href="#6、尽量采用懒加载的策略，即在需要的时候才创建" class="headerlink" title="6、尽量采用懒加载的策略，即在需要的时候才创建"></a>6、尽量采用懒加载的策略，即在需要的时候才创建</h4><p>例如：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"aaa"</span>;<span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">{</span><br><span class="line">    list.add(str);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>建议替换为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">{</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"aaa"</span>;</span><br><span class="line">    list.add(str);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="7、慎用异常"><a href="#7、慎用异常" class="headerlink" title="7、慎用异常"></a>7、慎用异常</h4><p>异常对性能不利。抛出异常首先要创建一个新的对象，<code>Throwable</code> 接口的构造函数调用名为 <code>fillInStackTrace()</code> 的本地同步方法，fillInStackTrace () 方法检查堆栈，收集调用跟踪信息。只要有异常被抛出，Java 虚拟机就必须调整调用堆栈，因为在处理过程中创建了一个新的对象。异常只能用于错误处理，不应该用来控制程序流程。</p>
<h4 id="8、不要在循环中使用try…catch…，应该把其放在最外层"><a href="#8、不要在循环中使用try…catch…，应该把其放在最外层" class="headerlink" title="8、不要在循环中使用try…catch…，应该把其放在最外层"></a>8、不要在循环中使用 <code>try…catch…</code>，应该把其放在最外层</h4><p>除非不得已。如果毫无理由地这么写了，只要你的领导资深一点、有强迫症一点，八成就要骂你为什么写出这种垃圾代码来了。<br>除非不得已。如果毫无理由地这么写了，只要你的领导资深一点、有强迫症一点，八成就要骂你为什么写出这种垃圾代码来了。</p>
<h4 id="9、如果能估计到待添加的内容长度，为底层以数组方式实现的集合、工具类指定初始长度"><a href="#9、如果能估计到待添加的内容长度，为底层以数组方式实现的集合、工具类指定初始长度" class="headerlink" title="9、如果能估计到待添加的内容长度，为底层以数组方式实现的集合、工具类指定初始长度"></a>9、如果能估计到待添加的内容长度，为底层以数组方式实现的集合、工具类指定初始长度</h4><p>比如 <code>ArrayList</code>、<code>LinkedLlist</code>、<code>StringBuilder</code>、<code>StringBuffer</code>、<code>HashMap</code>、<code>HashSet</code> 等等，以 <code>StringBuilder</code> 为例：</p>
<blockquote>
<p>（1）StringBuilder () // 默认分配 16 个字符的空间</p>
</blockquote>
<blockquote>
<p>（2）StringBuilder (int size) // 默认分配 size 个字符的空间</p>
</blockquote>
<blockquote>
<p>（3）StringBuilder (String str) // 默认分配 16 个字符 + str.length () 个字符空间</p>
</blockquote>
<p>可以通过类（这里指的不仅仅是上面的 StringBuilder）的来设定它的初始化容量，这样可以明显地提升性能。比如 StringBuilder 吧，length 表示当前的 StringBuilder 能保持的字符数量。因为当 StringBuilder 达到最大容量的时候，它会将自身容量增加到当前的 2 倍再加 2，无论何时只要 StringBuilder 达到它的最大容量，它就不得不创建一个新的字符数组然后将旧的字符数组内容拷贝到新字符数组中 —- 这是十分耗费性能的一个操作。试想，如果能预估到字符数组中大概要存放 5000 个字符而不指定长度，最接近 5000 的 2 次幂是 4096，每次扩容加的 2 不管，那么：</p>
<p>（1）在 4096 的基础上，再申请 8194 个大小的字符数组，加起来相当于一次申请了 12290 个大小的字符数组，如果一开始能指定 5000 个大小的字符数组，就节省了一倍以上的空间；</p>
<p>（2）把原来的 4096 个字符拷贝到新的的字符数组中去。</p>
<p>这样，既浪费内存空间又降低代码运行效率。所以，给底层以数组实现的集合、工具类设置一个合理的初始化容量是错不了的，这会带来立竿见影的效果。但是，注意，像 HashMap 这种是以数组 + 链表实现的集合，别把初始大小和你估计的大小设置得一样，因为一个 table 上只连接一个对象的可能性几乎为 0。初始大小建议设置为 2 的 N 次幂，如果能估计到有 2000 个元素，设置成 new HashMap (128)、new HashMap (256) 都可以。</p>
<p><code>评论区建议</code></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//hashmap中我们传入的初始大小并不是真正的初始大小，hashmap会调用tableSizeFor这个方法去找这个值 离他最近的2的N次幂的值作为真正的初始大小。</span></span><br><span class="line"></span><br><span class="line">代码如下：</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY)?MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="comment">//所以我们指定hashmap的初始化大小时 一般设置为我们预估的大小即可 而不是一定设置为2的N次幂</span></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="10、当复制大量数据时，使用System-arraycopy-命令"><a href="#10、当复制大量数据时，使用System-arraycopy-命令" class="headerlink" title="10、当复制大量数据时，使用System.arraycopy()命令"></a>10、当复制大量数据时，使用 <code>System.arraycopy()</code> 命令</h4><h4 id="11、乘法和除法使用移位操作"><a href="#11、乘法和除法使用移位操作" class="headerlink" title="11、乘法和除法使用移位操作"></a>11、乘法和除法使用移位操作</h4><p>例如：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (val = <span class="number">0</span>; val &lt; <span class="number">100000</span>; val += <span class="number">5</span>) {</span><br><span class="line">    a = val * <span class="number">8</span>;</span><br><span class="line">    b = val / <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>用移位操作可以极大地提高性能，因为在计算机底层，对位的操作是最方便、最快的，因此建议修改为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (val = <span class="number">0</span>; val &lt; <span class="number">100000</span>; val += <span class="number">5</span>) {</span><br><span class="line">    a = val &lt;&lt; <span class="number">3</span>; <span class="comment">//左移三位 乘2^3</span></span><br><span class="line">    b = val &gt;&gt; <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>移位操作虽然快，但是可能会使代码不太好理解，因此最好加上相应的注释。</p>
<h4 id="12、循环内不要不断创建对象引用"><a href="#12、循环内不要不断创建对象引用" class="headerlink" title="12、循环内不要不断创建对象引用"></a>12、循环内不要不断创建对象引用</h4><p>例如：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= count; i++) {</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这种做法会导致内存中有 count 份 Object 对象引用存在，count 很大的话，就耗费内存了，建议为改为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= count; i++) {</span><br><span class="line">    obj = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这样的话，内存中只有一份 Object 对象引用，每次 new Object () 的时候，Object 对象引用指向不同的 Object 罢了，但是内存中只有一份，这样就大大节省了内存空间了。</p>
<h4 id="13、基于效率和类型检查的考虑，应该尽可能使用array，无法确定数组大小时才使用ArrayList"><a href="#13、基于效率和类型检查的考虑，应该尽可能使用array，无法确定数组大小时才使用ArrayList" class="headerlink" title="13、基于效率和类型检查的考虑，应该尽可能使用array，无法确定数组大小时才使用ArrayList"></a>13、基于效率和类型检查的考虑，应该尽可能使用 <code>array</code>，无法确定数组大小时才使用 <code>ArrayList</code></h4><h4 id="14、尽量使用HashMap、ArrayList、StringBuilder，除非线程安全需要，否则不推荐使用Hashtable、Vector、StringBuffer，后三者由于使用同步机制而导致了性能开销"><a href="#14、尽量使用HashMap、ArrayList、StringBuilder，除非线程安全需要，否则不推荐使用Hashtable、Vector、StringBuffer，后三者由于使用同步机制而导致了性能开销" class="headerlink" title="14、尽量使用HashMap、ArrayList、StringBuilder，除非线程安全需要，否则不推荐使用Hashtable、Vector、StringBuffer，后三者由于使用同步机制而导致了性能开销"></a>14、尽量使用 <code>HashMap</code>、<code>ArrayList</code>、<code>StringBuilder</code>，除非线程安全需要，否则不推荐使用 <code>Hashtable</code>、<code>Vector</code>、<code>StringBuffer</code>，后三者由于使用<code>同步机制</code>而导致了<code>性能开销</code></h4><h4 id="15、不要将数组声明为public-static-final"><a href="#15、不要将数组声明为public-static-final" class="headerlink" title="15、不要将数组声明为public static final"></a>15、不要将数组声明为 <code>public static final</code></h4><p>因为这毫无意义，这样只是定义了引用为 static final，数组的内容还是可以随意改变的，将数组声明为 public 更是一个安全漏洞，这意味着这个数组可以被外部类所改变。</p>
<h4 id="16、尽量在合适的场合使用单例"><a href="#16、尽量在合适的场合使用单例" class="headerlink" title="16、尽量在合适的场合使用单例"></a>16、尽量在合适的场合使用单例</h4><p>使用单例可以减轻加载的负担、缩短加载的时间、提高加载的效率，但并不是所有地方都适用于单例，简单来说，单例主要适用于以下三个方面：</p>
<blockquote>
<p>（1）控制资源的使用，通过线程同步来控制资源的并发访问</p>
</blockquote>
<blockquote>
<p>（2）控制实例的产生，以达到节约资源的目的</p>
</blockquote>
<blockquote>
<p>（3）控制数据的共享，在不建立直接关联的条件下，让多个不相关的进程或线程之间实现通信</p>
</blockquote>
<h4 id="17、尽量避免随意使用静态变量"><a href="#17、尽量避免随意使用静态变量" class="headerlink" title="17、尽量避免随意使用静态变量"></a>17、尽量避免随意使用静态变量</h4><p>要知道，当某个对象被定义为 static 的变量所引用，那么 gc 通常是不会回收这个对象所占有的堆内存的，如：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>此时静态变量 b 的生命周期与 A 类相同，如果 A 类不被卸载，那么引用 B 指向的 B 对象会常驻内存，直到程序终止</p>
<h4 id="18、及时清除不再需要的会话"><a href="#18、及时清除不再需要的会话" class="headerlink" title="18、及时清除不再需要的会话"></a>18、及时清除不再需要的会话</h4><p>为了清除不再活动的会话，许多应用服务器都有默认的会话超时时间，一般为 30 分钟。当应用服务器需要保存更多的会话时，如果内存不足，那么操作系统会把部分数据转移到磁盘，应用服务器也可能根据 <code>MRU</code>（最近最频繁使用）算法把部分不活跃的会话转储到磁盘，甚至可能抛出内存不足的异常。如果会话要被转储到磁盘，那么必须要先被序列化，在大规模集群中，对对象进行序列化的代价是很昂贵的。因此，当会话不再需要时，应当及时调用 <code>HttpSession</code> 的 <code>invalidate()</code> 方法清除会话。</p>
<h4 id="19、实现RandomAccess接口的集合比如ArrayList，应当使用最普通的-for-循环而不是foreach循环来遍历"><a href="#19、实现RandomAccess接口的集合比如ArrayList，应当使用最普通的-for-循环而不是foreach循环来遍历" class="headerlink" title="19、实现RandomAccess接口的集合比如ArrayList，应当使用最普通的 for 循环而不是foreach循环来遍历"></a>19、实现 <code>RandomAccess</code> 接口的集合比如 <code>ArrayList</code>，应当使用最普通的 for 循环而不是 <code>foreach</code> 循环来遍历</h4><p>这是 JDK 推荐给用户的。JDK API 对于 <code>RandomAccess</code> 接口的解释是：实现 <code>RandomAccess</code> 接口用来表明其支持快速随机访问，此接口的主要目的是允许一般的算法更改其行为，从而将其应用到随机或连续访问列表时能提供良好的性能。实际经验表明，实现 <code>RandomAccess</code> 接口的类实例，假如是随机访问的，使用普通 for 循环效率将高于使用 <code>foreach</code> 循环；反过来，如果是顺序访问的，则使用 Iterator 会效率更高。可以使用类似如下的代码作判断：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (list <span class="keyword">instanceof</span> RandomAccess) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++){}</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    Iterator&lt;?&gt; iterator = list.iterable();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">        iterator.next()</span><br><span class="line">    }</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    Iterator&lt;?&gt; iterator = list.iterable();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()){</span><br><span class="line">        iterator.next()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>foreach</code> 循环的底层实现原理就是迭代器 <code>Iterator</code>，参见 Java 语法糖 1：可变长度参数以及 <code>foreach</code> 循环原理。所以后半句 “反过来，如果是顺序访问的，则使用 Iterator 会效率更高” 的意思就是顺序访问的那些类实例，使用 <code>foreach</code> 循环去遍历。</p>
<h4 id="20、使用同步代码块替代同步方法"><a href="#20、使用同步代码块替代同步方法" class="headerlink" title="20、使用同步代码块替代同步方法"></a>20、使用同步代码块替代同步方法</h4><p>这点在多线程模块中的 <code>synchronized锁</code>方法块一文中已经讲得很清楚了，除非能确定一整个方法都是需要进行同步的，否则尽量使用同步代码块，避免对那些不需要进行同步的代码也进行了同步，影响了代码执行效率。</p>
<h4 id="21、将常量声明为static-final，并以大写命名"><a href="#21、将常量声明为static-final，并以大写命名" class="headerlink" title="21、将常量声明为static final，并以大写命名"></a>21、将常量声明为 <code>static final</code>，并以大写命名</h4><p>这样在编译期间就可以把这些内容放入常量池中，避免运行期间计算生成常量的值。另外，将常量的名字以大写命名也可以方便区分出常量与变量</p>
<h4 id="22、不要创建一些不使用的对象，不要导入一些不使用的类"><a href="#22、不要创建一些不使用的对象，不要导入一些不使用的类" class="headerlink" title="22、不要创建一些不使用的对象，不要导入一些不使用的类"></a>22、不要创建一些不使用的对象，不要导入一些不使用的类</h4><p>这毫无意义，如果代码中出现 <code>The value of the local variable i is not used</code>、<code>The import java.util is never used</code>，那么请删除这些无用的内容</p>
<h4 id="23、程序运行过程中避免使用反射"><a href="#23、程序运行过程中避免使用反射" class="headerlink" title="23、程序运行过程中避免使用反射"></a>23、程序运行过程中避免使用反射</h4><p>关于，请参见反射。反射是 Java 提供给用户一个很强大的功能，<code>功能强大往往意味着效率不高</code>。不建议在程序运行过程中使用尤其是频繁使用反射机制，特别是 Method 的 invoke 方法，如果确实有必要，一种建议性的做法是将那些需要通过反射加载的类在项目启动的时候通过反射实例化出一个对象并放入内存 —- 用户只关心和对端交互的时候获取最快的响应速度，并不关心对端的项目启动花多久时间。</p>
<h4 id="24、使用数据库连接池和线程池"><a href="#24、使用数据库连接池和线程池" class="headerlink" title="24、使用数据库连接池和线程池"></a>24、使用数据库连接池和线程池</h4><p>这两个池都是用于重用对象的，前者可以避免频繁地打开和关闭连接，后者可以避免频繁地创建和销毁线程</p>
<h4 id="25、使用带缓冲的输入输出流进行-IO-操作"><a href="#25、使用带缓冲的输入输出流进行-IO-操作" class="headerlink" title="25、使用带缓冲的输入输出流进行 IO 操作"></a>25、使用带缓冲的输入输出流进行 IO 操作</h4><p>带缓冲的输入输出流，即 <code>BufferedReader</code>、<code>BufferedWriter</code>、<code>BufferedInputStream</code>、<code>BufferedOutputStream</code>，这可以极大地提升 IO 效率</p>
<h4 id="26、顺序插入和随机访问比较多的场景使用ArrayList，元素删除和中间插入比较多的场景使用LinkedList这个，理解ArrayList和LinkedList的原理就知道了"><a href="#26、顺序插入和随机访问比较多的场景使用ArrayList，元素删除和中间插入比较多的场景使用LinkedList这个，理解ArrayList和LinkedList的原理就知道了" class="headerlink" title="26、顺序插入和随机访问比较多的场景使用ArrayList，元素删除和中间插入比较多的场景使用LinkedList这个，理解ArrayList和LinkedList的原理就知道了"></a>26、顺序插入和随机访问比较多的场景使用 <code>ArrayList</code>，元素删除和中间插入比较多的场景使用 <code>LinkedList</code> 这个，理解 <code>ArrayList</code> 和 <code>LinkedList</code> 的原理就知道了</h4><h4 id="27、不要让-public-方法中有太多的形参"><a href="#27、不要让-public-方法中有太多的形参" class="headerlink" title="27、不要让 public 方法中有太多的形参"></a>27、不要让 public 方法中有太多的形参</h4><p>public 方法即对外提供的方法，如果给这些方法太多形参的话主要有两点坏处：</p>
<p>1、违反了面向对象的编程思想，Java 讲求一切都是对象，太多的形参，和面向对象的编程思想并不契合</p>
<p>2、参数太多势必导致方法调用的出错概率增加</p>
<p>至于这个 “太多” 指的是多少个，3、4 个吧。比如我们用 JDBC 写一个 insertStudentInfo 方法，有 10 个学生信息字段要插如 Student 表中，可以把这 10 个参数封装在一个实体类中，作为 insert 方法的形参。</p>
<h4 id="28、字符串变量和字符串常量-equals-的时候将字符串常量写在前面"><a href="#28、字符串变量和字符串常量-equals-的时候将字符串常量写在前面" class="headerlink" title="28、字符串变量和字符串常量 equals 的时候将字符串常量写在前面"></a>28、字符串变量和字符串常量 equals 的时候将字符串常量写在前面</h4><p>这是一个比较常见的小技巧了，如果有以下代码：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"123"</span>;</span><br><span class="line"><span class="keyword">if</span> (str.equals(<span class="string">"123"</span>))</span><br><span class="line">{...}</span><br></pre></td></tr></tbody></table></figure></div>

<p>建议修改为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"123"</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"123"</span>.equals(str))</span><br><span class="line">{</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这么做主要是可以<code>避免空指针异常</code></p>
<h4 id="29、请知道，在-java-中-if-i-1-和-if-1-i-是没有区别的，但从阅读习惯上讲，建议使用前者"><a href="#29、请知道，在-java-中-if-i-1-和-if-1-i-是没有区别的，但从阅读习惯上讲，建议使用前者" class="headerlink" title="29、请知道，在 java 中 if (i == 1)和 if (1 == i)是没有区别的，但从阅读习惯上讲，建议使用前者"></a>29、请知道，在 java 中 if (i == 1) 和 if (1 == i) 是没有区别的，但从阅读习惯上讲，建议使用前者</h4><p>平时有人问，“if (i == 1)” 和 “if (1== i)” 有没有区别，这就要从 C/C++ 讲起。</p>
<p>在 C/C++ 中，“if (i == 1)” 判断条件成立，是以 0 与非 0 为基准的，0 表示 false，非 0 表示 true，如果有这么一段代码：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">{</span><br><span class="line">...</span><br><span class="line">}<span class="keyword">else</span>{</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>C/C++ 判断”i==1″不成立，所以以 0 表示，即 false。但是如果：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (i = <span class="number">1</span>) { ... }</span><br><span class="line"><span class="keyword">else</span> { ... }</span><br></pre></td></tr></tbody></table></figure></div>

<p>万一程序员一个不小心，把”if (i == 1)” 写成”if (i = 1)”，这样就有问题了。在 if 之内将 i 赋值为 1，if 判断里面的内容非 0，返回的就是 true 了，但是明明 i 为 2，比较的值是 1，应该返回的 false。这种情况在 C/C++ 的开发中是很可能发生的并且会导致一些难以理解的错误产生，所以，为了避免开发者在 if 语句中不正确的赋值操作，建议将 if 语句写为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span> == i) { ... }</span><br><span class="line"><span class="keyword">else</span> { ... }</span><br></pre></td></tr></tbody></table></figure></div>

<p>这样，即使开发者不小心写成了”1 = i”，C/C++ 编译器也可以第一时间检查出来，因为我们可以对一个变量赋值 i 为 1，但是不能对一个常量赋值 1 为 i。</p>
<p>但是，在 Java 中，C/C++ 这种”if (i = 1)” 的语法是不可能出现的，因为一旦写了这种语法，Java 就会编译报错 <code>Type mismatch: cannot convert from int to boolean</code>。但是，尽管 Java 的”if (i == 1)” 和”if (1 == i)” 在语义上没有任何区别，但是从阅读习惯上讲，建议使用前者会更好些。</p>
<h4 id="30、不要对数组使用-toString-方法"><a href="#30、不要对数组使用-toString-方法" class="headerlink" title="30、不要对数组使用 toString()方法"></a>30、不要对数组使用 toString () 方法</h4><p>看一下对数组使用 toString () 打印出来的是什么：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span>[] is = <span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br><span class="line">    System.out.println(is.toString());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>结果是：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">[I@18a992f</span><br></pre></td></tr></tbody></table></figure></div>

<p>本意是想打印出数组内容，却有可能因为数组引用 is 为空而导致空指针异常。不过虽然对数组 <code>toString()</code> 没有意义，但是对集合 <code>toString()</code> 是可以打印出集合里面的内容的，因为集合的父类 <code>AbstractCollections</code> 重写了 Object 的 <code>toString()</code> 方法。</p>
<h4 id="31、不要对超出范围的基本数据类型做向下强制转型"><a href="#31、不要对超出范围的基本数据类型做向下强制转型" class="headerlink" title="31、不要对超出范围的基本数据类型做向下强制转型"></a>31、不要对超出范围的基本数据类型做向下强制转型</h4><p>这绝不会得到想要的结果：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">12345678901234L</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (<span class="type">int</span>)l;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>我们可能期望得到其中的某几位，但是结果却是：</p>
<p>1942892530</p>
<p>解释一下。Java 中 long 是 8 个字节 64 位的，所以 12345678901234 在计算机中的表示应该是：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">0000 0000 0000 0000 0000 1011 0011 1010 0111 0011 1100 1110 0010 1111 1111 0010</span><br></pre></td></tr></tbody></table></figure></div>

<p>一个 int 型数据是 4 个字节 32 位的，从低位取出上面这串二进制数据的前 32 位是：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">0111 0011 1100 1110 0010 1111 1111 0010</span><br></pre></td></tr></tbody></table></figure></div>

<p>这串二进制表示为十进制 1942892530，所以就是我们上面的控制台上输出的内容。从这个例子上还能顺便得到两个结论：</p>
<p>1、整型默认的数据类型是 int，long l = 12345678901234L，这个数字已经超出了 int 的范围了，所以最后有一个 L，表示这是一个 long 型数。顺便，浮点型的默认类型是 double，所以定义 float 的时候要写成””float f = 3.5f”</p>
<p>2、接下来再写一句”int ii = l + i;” 会报错，因为 long + int 是一个 long，不能赋值给 int</p>
<h4 id="32、公用的集合类中不使用的数据一定要及时-remove-掉"><a href="#32、公用的集合类中不使用的数据一定要及时-remove-掉" class="headerlink" title="32、公用的集合类中不使用的数据一定要及时 remove 掉"></a>32、公用的集合类中不使用的数据一定要及时 remove 掉</h4><p>如果一个集合类是公用的（也就是说不是方法里面的属性），那么这个集合里面的元素是不会自动释放的，因为始终有引用指向它们。所以，如果公用集合里面的某些数据不使用而不去 remove 掉它们，那么将会造成这个公用集合不断增大，使得系统有内存泄露的隐患。</p>
<h4 id="33、把一个基本数据类型转为字符串，基本数据类型-toString-是最快的方式、String-valueOf-数据-次之、数据-””最慢"><a href="#33、把一个基本数据类型转为字符串，基本数据类型-toString-是最快的方式、String-valueOf-数据-次之、数据-””最慢" class="headerlink" title="33、把一个基本数据类型转为字符串，基本数据类型.toString()是最快的方式、String.valueOf(数据)次之、数据+””最慢"></a>33、把一个基本数据类型转为字符串，基本数据类型.toString () 是最快的方式、String.valueOf (数据) 次之、数据 +”” 最慢</h4><p>把一个基本数据类型转为一般有三种方式，我有一个 Integer 型数据 i，可以使用 i.toString ()、String.valueOf (i)、i+”” 三种方式，三种方式的效率如何，看一个测试：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[]args)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> <span class="variable">loopTime</span> <span class="operator">=</span> <span class="number">50000</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; loopTime; j++) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> String.valueOf(i);</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"String.valueOf()："</span> + (System.currentTimeMillis() - startTime) + <span class="string">"ms"</span>);</span><br><span class="line">    startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; loopTime; j++) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> i.toString();</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"Integer.toString()："</span> + (System.currentTimeMillis() - startTime) + <span class="string">"ms"</span>);</span><br><span class="line">    startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; loopTime; j++) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> i + <span class="string">""</span>;</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"i + \"\"："</span> + (System.currentTimeMillis() - startTime) + <span class="string">"ms"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>运行结果为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">String.valueOf()：11ms Integer.toString()：5ms i + <span class="string">""</span>：25ms</span><br></pre></td></tr></tbody></table></figure></div>

<p>所以以后遇到把一个基本数据类型转为 String 的时候，优先考虑使用 toString () 方法。至于为什么，很简单：</p>
<p>1、String.valueOf () 方法底层调用了 Integer.toString () 方法，但是会在调用前做空判断</p>
<p>2、Integer.toString () 方法就不说了，直接调用了</p>
<p>3、i +“” 底层使用了 <code>StringBuilder</code> 实现，先用 append 方法拼接，再用 <code>toString()</code> 方法获取字符串</p>
<p>三者对比下来，明显是 2 最快、1 次之、3 最慢</p>
<h4 id="34、使用最有效率的方式去遍历-Map"><a href="#34、使用最有效率的方式去遍历-Map" class="headerlink" title="34、使用最有效率的方式去遍历 Map"></a>34、使用最有效率的方式去遍历 Map</h4><p>遍历 Map 的方式有很多，通常场景下我们需要的是遍历 Map 中的 Key 和 Value，那么推荐使用的、效率最高的方式是：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    HashMap&lt;String, String&gt; hm = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">    hm.put(<span class="string">"111"</span>, <span class="string">"222"</span>);</span><br><span class="line">    Set&lt;Map.Entry&lt;String, String&gt;&gt; entrySet = hm.entrySet();</span><br><span class="line">    Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iter = entrySet.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) {</span><br><span class="line">        Map.Entry&lt;String, String&gt; entry = iter.next();</span><br><span class="line">        System.out.println(entry.getKey() + <span class="string">"\t"</span> + entry.getValue());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>如果你只是想遍历一下这个 Map 的 key 值，那用”Set keySet = hm.keySet ();” 会比较合适一些</p>
<p>35、对资源的 <code>close()</code> 建议分开操作</p>
<p>意思是，比如我有这么一段代码：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>{</span><br><span class="line">    XXX.close();</span><br><span class="line">    YYY.close();</span><br><span class="line">}<span class="keyword">catch</span> (Exception e)</span><br><span class="line">{...}</span><br></pre></td></tr></tbody></table></figure></div>

<p>建议修改为：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>{</span><br><span class="line">    XXX.close();</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">   ...</span><br><span class="line">}</span><br><span class="line"><span class="keyword">try</span>{</span><br><span class="line">    YYY.close();</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>虽然有些麻烦，却能避免资源泄露。我想，如果没有修改过的代码，万一 XXX.close () 抛异常了，那么就进入了 cath 块中了，YYY.close () 不会执行，YYY 这块资源就不会回收了，一直占用着，这样的代码一多，是可能引起资源句柄泄露的。而改为上面的写法之后，就保证了无论如何 XXX 和 YYY 都会被 close 掉。</p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Colab 在线 Python 神器</title>
    <url>/2019/944b25cb.html</url>
    <content><![CDATA[<ul>
<li><a class="link" href="https://colab.research.google.com/">Colab<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>是 google 最近推出的一项 Python 在线编程的免费服务，有了它，不学 Python 编程的理由又少了一个</li>
<li> Colab 环境已经集成了流行的深度学习框架 Tensorflow, 并附赠了一个虚拟机 (<code>40GB</code> 硬盘 +<code>2*2.30GHZ</code> CPU+<code>12.72GB</code> 内存), 如果在国内无法访问 google 的服务又无法 FQ, 可以考虑微软推出的 <a class="link" href="https://notebooks.azure.com/">notebook<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> </li>
<li>Colab 的操作类似于 jupyter notebook</li>
<li>Colab 如同使用 Google 文档或表格一样存储在 <a class="link" href="https://drive.google.com/">Google 云端硬盘<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>中，并且可以共享</li>
</ul>
<span id="more"></span>

<h4 id="执行终端命令"><a href="#执行终端命令" class="headerlink" title="执行终端命令"></a>执行终端命令</h4><p>Colab 绑定的是 UBuntu 系统，可以识别 Ubuntu shell 命令，在 Colab 中输入以 <code>!</code> 开头的终端命令即可</p>
<p>例如</p>
<ul>
<li><code>！ls</code></li>
</ul>
<p><a href="https://imgchr.com/i/VQ0g61"><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2019/05/31/VQ0g61.png" alt="VQ0g61.png"></a></p>
<ul>
<li><p>查看虚拟机硬盘容量 <code>!df -lh</code> </p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://ask.qcloudimg.com/http-save/yehe-1672643/rts5xsq9dq.png?imageView2/2/w/1620"></p>
</li>
<li><p>查看 cpu 配置 <code>!cat /proc/cpuinfo | grep model\ name</code></p>
<p> <img lazyload="" src="/images/loading.svg" data-src="https://ask.qcloudimg.com/http-save/yehe-1672643/qa435n4t7y.png?imageView2/2/w/1620"></p>
</li>
<li><p>查看内存容量 <code>!cat /proc/meminfo | grep MemTotal</code></p>
</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="https://ask.qcloudimg.com/http-save/yehe-1672643/5f5imjitih.png?imageView2/2/w/1620"></p>
<ul>
<li><p>安装 git</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">!apt install git</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="保存到本地"><a href="#保存到本地" class="headerlink" title="保存到本地"></a>保存到本地</h4><p>在文件中可以把当前代码保存到本地</p>
<h4 id="获取环境的公网地址"><a href="#获取环境的公网地址" class="headerlink" title="获取环境的公网地址"></a>获取环境的公网地址</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ip_by_ip138</span>():</span><br><span class="line">    response = requests.get(<span class="string">"http://2019.ip138.com/ic.asp"</span>)</span><br><span class="line">    ip = re.search(<span class="string">r"\[\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\]"</span>,response.content.decode(errors=<span class="string">'ignore'</span>)).group(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> ip</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"本机的ip地址为:"</span>,get_ip_by_ip138())</span><br></pre></td></tr></tbody></table></figure></div>

<p>colab 相当于 Jupyter notebook 的在线版，如果运行脚本时，提示缺失 requests 库，可以通过 <code>!pip install requests</code> 安装</p>
<h4 id="python展示图片"><a href="#python展示图片" class="headerlink" title="python展示图片"></a>python 展示图片</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">display(Image(name))</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h4 id="挂载Google-Drive"><a href="#挂载Google-Drive" class="headerlink" title="挂载Google Drive"></a>挂载 Google Drive</h4><p>由于 Colab 会在长时间闲置时或者一段时间（12 个小时）之后，就会断开资源，当然你上传的东西也就没有了！因为每次连接时提供的资源都是随机分配的！那么这时候，Colab 也提供了连接 Google Drive 的功能！</p>
<p>在官方给的 note 文档中给出了 3 种方案，可以连接 Google Drive！具体可以参考：<br><a class="link" href="https://colab.research.google.com/notebooks/io.ipynb#scrollTo=c2W5A2px3doP">https://colab.research.google.com/notebooks/io.ipynb#scrollTo=c2W5A2px3doP<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> google.colab <span class="keyword">import</span> drive</span><br><span class="line">drive.mount(<span class="string">'/content/gdrive'</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>点击之后授权登录 Google 账号，然后最后会有一个授权码，将这个授权码填入下边的对话框中，回车等待，出现 <code>Mounted at /content/gdrive</code> 则表示挂载成功！</p>
<p><a href="https://imgchr.com/i/VQB8HK"><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2019/05/31/VQB8HK.png" alt="VQB8HK.png"></a></p>
<blockquote>
<p>新增</p>
</blockquote>
<p>使用 <code>!cd</code> 切换工作路径并不能生效 (可能我的方法不对), 使用以下方法切换</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定当前的工作目录</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此处为google drive中的文件路径,drive为之前指定的工作根目录，要加上</span></span><br><span class="line">os.chdir(<span class="string">"drive/.../..."</span>) </span><br></pre></td></tr></tbody></table></figure></div>

<p><code>！ls</code> 看一下是不是换了</p>
<h4 id="选择GPU跑训练代码"><a href="#选择GPU跑训练代码" class="headerlink" title="选择GPU跑训练代码"></a>选择 GPU 跑训练代码</h4><p>代码执行程序 –&gt; 更改运行时类型 –&gt; 选择 python 版本和加速器</p>
<p><a href="https://imgchr.com/i/VQBK39"><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2019/05/31/VQBK39.png" alt="VQBK39.png"></a></p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>DDIA 书籍推荐</title>
    <url>/2025/546910043.html</url>
    <content><![CDATA[<p>最近看的一本很不错的书：<code>DDIA</code><br>《Designing Data-Intensive Applications》，设计数据密集型应用，分布式的问题都可以在里面找到，原理讲的非常清晰易懂。豆瓣评分 9.7</p>
<blockquote>
<p>现今，尤其是在互联网领域，大多数应用都属于数据密集型应用。本书从底层数据结构到顶层架构设计，将数据系统设计中的精髓娓娓道来。其中的宝贵经验无论是对架构师、DBA、还是后端工程师、甚至产品经理都会有帮助</p>
</blockquote>
<p>链接： <a class="link" href="https://github.com/Vonng/ddia">中文版<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Github Page 在线观看：<a class="link" href="https://vonng.github.io/ddia/">https://vonng.github.io/ddia/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>gitbook 在线观看  <a class="link" href="https://vonng.gitbook.io/vonng">https://vonng.gitbook.io/vonng<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>FRP 使用记录</title>
    <url>/2022/2277562201.html</url>
    <content><![CDATA[<h1 id="FRP使用记录"><a href="#FRP使用记录" class="headerlink" title="FRP使用记录"></a>FRP 使用记录</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>frp 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。</p>
<p>使用示例 <a class="link" href="https://gofrp.org/docs/examples/">https://gofrp.org/docs/examples/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>我对将要配置的 FRP 服务有如下目标：</p>
<ol>
<li>支持 HTTPS</li>
<li> 服务器打开端口尽可能少</li>
<li>使用简单、支持泛域名</li>
<li>和宝塔面板整合</li>
</ol>
<span id="more"></span>

<h2 id="安装服务端"><a href="#安装服务端" class="headerlink" title="安装服务端"></a>安装服务端</h2><h3 id="下载服务端"><a href="#下载服务端" class="headerlink" title="下载服务端"></a>下载服务端</h3><p>对于服务器在国内的可以手动下载 最新版本的软件包，手动上传 <a class="link" href="https://github.com/fatedier/frp/releases/">https://github.com/fatedier/frp/releases/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>服务器下载 <code>wget https://github.com/fatedier/frp/releases/download/v0.39.1/frp_0.39.1_linux_amd64.tar.gz</code></p>
<p>解压 并打开目录</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">tar xvfz frp_0.39.1_linux_amd64.tar.gz</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">cd</span> frp_0.39.1_linux_amd64</span><br></pre></td></tr></tbody></table></figure></div>

<p>服务器上不需要 <code>frpc</code> 和 <code>frpc.ini</code>，可以使用 <code>rm -f frpc*</code> 来进行删除</p>
<h3 id="编辑服务端配置"><a href="#编辑服务端配置" class="headerlink" title="编辑服务端配置"></a>编辑服务端配置</h3><p><code>vim frps.ini</code></p>
<div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">30364</span> </span><br><span class="line"><span class="attr">log_level</span> = trace</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br><span class="line"><span class="comment"># 配置http访问端口8571</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">8571</span></span><br><span class="line"><span class="attr">vhost_https_port</span> = <span class="number">4430</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启dashboard,frp提供了一个控制台，可以通过这个端口访问到控制台。可查看frp当前有多少代理连接以及对应的状态</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"><span class="comment"># dashboard 用户名密码，默认都为 admin</span></span><br><span class="line"><span class="attr">dashboard_user</span> = admin</span><br><span class="line"><span class="attr">dashboard_pwd</span> = xxxxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端的subdomain_host需要和客户端配置文件中的subdomain、local_port配合使用，</span></span><br><span class="line"><span class="comment"># 可通过{subdomain}.{subdomain_host} 的域名格式来访问自己本地的 web 服务。</span></span><br><span class="line"><span class="comment"># 假如服务端的subdomain_host为frp.spacevast.com，客户端某个配置组中的</span></span><br><span class="line"><span class="comment"># subdomain为a,local_port为8585，</span></span><br><span class="line"><span class="comment"># 则访问 a.frp.spacevast.com ，等同于访问本地的localhost:8585</span></span><br><span class="line"><span class="attr">subdomain_host</span> = frp.xxxx.cn</span><br></pre></td></tr></tbody></table></figure></div>

<p>对于 frp 服务端，可以使用系统的 <code>systemd</code>，因为我是宝塔面板，为了更好控制，这里使用了 <code>Supervisor管理器</code> , 在软件商店搜索并安装，为 frps 添加守护进程</p>
<p>这里需要注意启动命令是全路径命令 <code>/www/wwwroot/frp.xxx.cn/frp_0.39.1/frps -c /www/wwwroot/frp.xxx.cn/frp_0.39.1/frps.ini</code></p>
<p>在宝塔面板 <code>安全</code>中放行上面配置文件中写的 <code>bind_port</code>, 并在服务器管理控制台添加防火墙规则，此端口允许访问</p>
<p>在 <code>Supervisor管理器</code>中启动 frps 服务</p>
<h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx 配置</h2><p>这里提供几种配置</p>
<h3 id="无https-泛域名解析-无面板程序"><a href="#无https-泛域名解析-无面板程序" class="headerlink" title="无https + 泛域名解析 + 无面板程序"></a>无 https + 泛域名解析 + 无面板程序</h3><p>泛域名解析需要在 DNS 解析平台添加两个 A 记录，<code>frp.xxx.cn</code> 和 <code>*.frp.xxx.cn</code></p>
<p>宝塔站点中的” 域名管理 “也要添加 *.frp.xxx.cn</p>
<p>在站点的配置文件中添加如下部分，并删除其他无关的 <code>location css</code> 等配置，否则可能会导致部分资源 404</p>
<div class="code-container" data-rel="Nginx"><figure class="iseeu highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">#FRP反向代理</span></span><br><span class="line">    <span class="section">location</span> / {</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="comment">#proxy_set_header Host $http_host;</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Protocol <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Url-Scheme <span class="variable">$scheme</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">#以下三行配置wss</span></span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8571;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#禁止访问的文件或目录</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>https 的使用很简单，直接在宝塔面板中添加即可</p>
<h3 id="泛域名解析-面板程序"><a href="#泛域名解析-面板程序" class="headerlink" title="泛域名解析 + 面板程序"></a>泛域名解析 + 面板程序</h3><p>我想达到访问 <code>frp.xxx.cn</code> 是控制面板，访问 <code>a1.frp.xxx.cn</code>、<code>a2.frp.xxx.cn</code> 等 <code>*.frp.xxx.cn</code> 是正常的反代接口，由配置文件可知控制面板的端口是 <code>7500</code>，做如下修改即可</p>
<div class="code-container" data-rel="Nginx"><figure class="iseeu highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#FRP反向代理</span></span><br><span class="line">   <span class="section">location</span> / {</span><br><span class="line">       <span class="attribute">set</span> <span class="variable">$is_matched</span> <span class="number">0</span>;</span><br><span class="line">       <span class="comment">#FRP 面板</span></span><br><span class="line">       <span class="attribute">if</span> (<span class="variable">$host</span> = <span class="string">'frp.xxx.cn'</span>)</span><br><span class="line">       {</span><br><span class="line">         <span class="attribute">proxy_pass</span> http://127.0.0.1:7500;</span><br><span class="line">         <span class="attribute">set</span> <span class="variable">$is_matched</span> <span class="number">1</span>;</span><br><span class="line">       }</span><br><span class="line">       <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">       <span class="comment">#proxy_set_header Host $http_host;</span></span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-Protocol <span class="variable">$scheme</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Url-Scheme <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">#以下三行配置wss</span></span><br><span class="line">       <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">       </span><br><span class="line">       <span class="comment"># 没有匹配到，跳转到FRP</span></span><br><span class="line">       <span class="attribute">if</span> (<span class="variable">$is_matched</span> = <span class="number">0</span>) {</span><br><span class="line">           <span class="attribute">proxy_pass</span> http://127.0.0.1:8571;</span><br><span class="line">       }</span><br><span class="line">   }</span><br><span class="line"> </span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="frpc客户端配置-内网本地机子"><a href="#frpc客户端配置-内网本地机子" class="headerlink" title="frpc客户端配置(内网本地机子)"></a>frpc 客户端配置 (内网本地机子)</h2><p>从仓库里下载对应版本的包  <a class="link" href="https://github.com/fatedier/frp/releases/">https://github.com/fatedier/frp/releases/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>比如 windows 是 <a class="link" href="https://github.com/fatedier/frp/releases/download/v0.39.1/frp_0.39.1_windows_amd64.zip">frp_0.39.1_windows_amd64.zip<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>解压后打开 <code>frpc.ini</code> 文件</p>
<div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line">server_addr = <span class="comment">#公网服务器ip</span></span><br><span class="line"><span class="attr">server_port</span> = <span class="number">30364</span> <span class="comment"># 服务器配置中bind_port的端口</span></span><br><span class="line"> </span><br><span class="line"><span class="section">[web1]</span></span><br><span class="line"><span class="attr">type</span> = http </span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">32778</span> <span class="comment"># 本机服务的IP</span></span><br><span class="line"><span class="attr">subdomain</span>= <span class="number">01</span>  <span class="comment"># 访问01.frp.xxx.cn 即可访问本服务</span></span><br><span class="line"></span><br><span class="line"><span class="section">[web2]</span></span><br><span class="line"><span class="attr">type</span> = http </span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">192.168</span>.<span class="number">1.7</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">1456</span></span><br><span class="line"><span class="attr">subdomain</span>= <span class="number">02</span> <span class="comment"># 访问01.frp.xxx.cn 即可访问本服务</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>打开命令行 使用 <code>frpc.exe -c frpc.ini</code> 启动客户端</p>
]]></content>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 GitHub Actions 自动部署 Hexo</title>
    <url>/2021/3339913406.html</url>
    <content><![CDATA[<p>最近升级了 next 主题到 <code>v8.2</code> 版本，搜索后才发现最新的 <code>hexo-theme-next</code> 更换仓库到 <a class="link" href="https://github.com/next-theme/hexo-theme-next">https://github.com/next-theme/hexo-theme-next<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, 并且支持 npm 方式部署，而不用再 pull 源码，使用 npm 安装以后升级只需要 <code>npm install hexo-theme-next@latest</code> 就行了。<br>正好以前用过 <code>Azure DevOps</code> 和 <code>Travis CI</code> 的打包功能，就想着能不能用类似的方法直接部署到 gitPage、codingPage，于是搜索了相关问题。</p>
<span id="more"></span>

<p>使用 Actions 可以很方便的在 github 上对文章进行修改与新增<br><img lazyload="" src="/images/loading.svg" data-src="https://s3.ax1x.com/2021/03/08/6Qh34S.png" alt="6Qh34S.png"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s3.ax1x.com/2021/03/08/6Qhecd.png" alt="6Qh34S.png"></p>
<h2 id="hexo-next-的升级"><a href="#hexo-next-的升级" class="headerlink" title="hexo-next 的升级"></a>hexo-next 的升级</h2><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">INFO  ==================================</span><br><span class="line">  ███╗   ██╗███████╗██╗  ██╗████████╗</span><br><span class="line">  ████╗  ██║██╔════╝╚██╗██╔╝╚══██╔══╝</span><br><span class="line">  ██╔██╗ ██║█████╗   ╚███╔╝    ██║</span><br><span class="line">  ██║╚██╗██║██╔══╝   ██╔██╗    ██║</span><br><span class="line">  ██║ ╚████║███████╗██╔╝ ██╗   ██║</span><br><span class="line">  ╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝   ╚═╝</span><br><span class="line">========================================</span><br></pre></td></tr></tbody></table></figure></div>

<p>从 next <code>v7</code>-&gt;<code>v8</code> 还是有许多地方不一样的，更别说使用了 npm 的方式安装主题。</p>
<ul>
<li><p>首先是外部配置文件，在 7.x 版本中，外部配置文件是放在 <code>source/_data/next.yml</code> 中的，而在 8.x 的版本则是放在了项目根目录，与<code>_config.xml</code> 同级，并且命名为<code>_config.next.yml</code>, 具体安装可以查看 next 官方文档，都比较详细</p>
</li>
<li><p><code>v8</code> 中 <code>valine</code> 不再是内置评论模块，可能这涉及到一些 <code>xss</code> 或其他方面的安全问题，具体原因不清楚，不过可以使用 <code>npm install next-theme/hexo-next-valine</code> 手动安装，再将配置添加到<code>_config.next.yml</code> 中</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Valine</span></span><br><span class="line"><span class="comment"># For more information: https://valine.js.org, https://github.com/xCss/Valine</span></span><br><span class="line"><span class="attr">valine:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">appId:</span> <span class="comment"># Your leancloud application appid</span></span><br><span class="line">  <span class="attr">appKey:</span> <span class="comment"># Your leancloud application appkey</span></span><br><span class="line">  <span class="attr">serverURLs:</span> <span class="comment"># When the custom domain name is enabled, fill it in here</span></span><br><span class="line">  <span class="attr">placeholder:</span> <span class="string">~这里输入您的精彩评论下</span> <span class="comment"># Comment box placeholder</span></span><br><span class="line">  <span class="attr">avatar:</span> <span class="string">robohash</span> <span class="comment"># Gravatar style</span></span><br><span class="line">  <span class="attr">meta:</span> [<span class="string">nick</span>, <span class="string">mail</span>, <span class="string">link</span>] <span class="comment"># Custom comment header</span></span><br><span class="line">  <span class="attr">pageSize:</span> <span class="number">10</span> <span class="comment"># Pagination size</span></span><br><span class="line">  <span class="attr">lang:</span> <span class="string">zh-cn</span> <span class="comment"># Language, available values: en, zh-cn</span></span><br><span class="line">  <span class="comment"># Warning: Do not enable both `valine.visitor` and `leancloud_visitors`.</span></span><br><span class="line">  <span class="attr">visitor:</span> <span class="literal">false</span> <span class="comment"># Article reading statistic</span></span><br><span class="line">  <span class="attr">comment_count:</span> <span class="literal">true</span> <span class="comment"># If false, comment count will only be displayed in post page, not in home page</span></span><br><span class="line">  <span class="attr">recordIP:</span> <span class="literal">true</span> <span class="comment"># Whether to record the commenter IP</span></span><br><span class="line">  <span class="attr">enableQQ:</span> <span class="literal">true</span> <span class="comment"># Whether to enable the Nickname box to automatically get QQ Nickname and QQ Avatar</span></span><br><span class="line">  <span class="attr">requiredFields:</span> [] <span class="comment"># Set required fields: [nick] | [nick, mail]</span></span><br><span class="line">  <span class="attr">emojiCDN:</span> <span class="comment">#表情包地址</span></span><br><span class="line">  <span class="attr">emojiMaps:</span> {}</span><br></pre></td></tr></tbody></table></figure></div>

<p>因为源码中 <code>hexo-next-valine</code> 使用了 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，所以理论上 <code>valine</code> 官方所有支持的参数在这里都可以被支持，包括 emojiCDN 等等。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingimage-20210307152346228.png" alt="image-20210307152346228"></p>
</li>
</ul>
<h2 id="生成密钥"><a href="#生成密钥" class="headerlink" title="生成密钥"></a>生成密钥</h2><p>关于如何将 hexo 同时部署到 <code>GitHub Pages</code> 和 <code>coding Page</code> 这里不再赘述可以参考这里 <a href="https://blog.tbox.fun/2018/c067e22a.html">2018/c067e22a.html</a>，这里你可以生成一个新的密钥专门用于 Actions 部署，<font color="red">也可以使用原来的密钥文件</font></p>
<p>生成方法，使用 gitBash</p>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">ssh<span class="literal">-keygen</span> <span class="literal">-t</span> rsa <span class="literal">-b</span> <span class="number">4096</span> <span class="literal">-C</span> <span class="string">"xxx@xxx.com"</span> <span class="operator">-f</span> github<span class="literal">-deploy-key</span> <span class="literal">-N</span> <span class="string">""</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>会在 <code>C:\Users\用户名\.ssh</code> 看到两个文件</p>
<ul>
<li>github-deploy-key —— 私钥</li>
<li> github-deploy-key.pub —— 公钥</li>
</ul>
<h2 id="配置秘钥"><a href="#配置秘钥" class="headerlink" title="配置秘钥"></a>配置秘钥</h2><p>我们要在 GitHub 与 Coding 上部署密钥，<strong>其中<code>私钥</code>用于 Hexo 源码仓库里</strong> ，源码仓库我们可以新建一个空的私有仓库，然后将当前的文件源码关联到这个仓库中，在<code>源码目录执行</code> (源码目录指的是包含 package.json 文件的 hexo 根目录)</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin xxx.git</span><br></pre></td></tr></tbody></table></figure></div>

<p>把<code>公钥</code>放到 GitHub Pages 和 coding 对应的代码仓库里面，用于 Hexo 部署时的写入工作</p>
<h3 id="配置私钥"><a href="#配置私钥" class="headerlink" title="配置私钥"></a>配置私钥</h3><p>首先在 GitHub 上打开保存 Hexo 的仓库，访问 <code>Settings -&gt; Secrets</code>，画面如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingsecret_1.png" alt="img"></p>
<p>然后选择 <code>New secret</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingsecret_2.png" alt="img"></p>
<p>名字部分填写：<code>HEXO_DEPLOY_KEY</code>，注意大小写，这个后面的 GitHub Actions Workflow 要用到，一定不能写错。</p>
<p>在 <code>Value</code> 的部分填入 <code>github-deploy-key</code> 中的内容：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingsecret_3.png" alt="img"></p>
<p>添加了私钥以后的界面显示如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingsecret_4.png" alt="img"></p>
<h3 id="添加公钥"><a href="#添加公钥" class="headerlink" title="添加公钥"></a>添加公钥</h3><h4 id="github-Page"><a href="#github-Page" class="headerlink" title="github Page"></a>github Page</h4><p>接下来我们需要访问存放网页的仓库，也就是 Hexo 部署以后的仓库，比如：<code>xxx.github.io</code> 这种，访问 <code>Settings -&gt; Deploy keys</code>：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingdeploy_1.png" alt="img"></p>
<p>按 <code>Add deploy key</code> 来添加一个新的公钥：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingdeploy_2.png" alt="img"></p>
<p>在 <code>Title</code> 中输入：<code>HEXO_DEPLOY_PUB</code> 字样，当然也可以填写其它自定义的名字。</p>
<p>在 <code>Key</code> 中粘贴 <code>github-deploy-key.pub</code> 文件的内容。</p>
<blockquote>
<p><strong>注意：一定要勾选 <code>Allow write access</code> 来打开写权限，否则无法写入会导致部署失败</strong>。</p>
</blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingdeploy_3.png" alt="img"></p>
<p>最后添加好了公钥的界面如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingdeploy_4.png" alt="img"></p>
<h4 id="coding-Page"><a href="#coding-Page" class="headerlink" title="coding Page"></a>coding Page</h4><p>打开 <code>代码仓库-&gt;设置-&gt;部署公钥</code>，点击新建</p>
<p>在 <code>Title</code> 中输入：<code>HEXO_DEPLOY_PUB</code> 字样，当然也可以填写其它自定义的名字。</p>
<p>在 <code>Key</code> 中粘贴 <code>github-deploy-key.pub</code> 文件的内容。同样的，<strong>注意勾选<code>授予推送权限</code>和公钥<code>永久有效期</code></strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingimage-20210307171239337.png" alt="image-20210307171239337"></p>
<p>添加完的效果如下</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingimage-20210307171514199.png" alt="image-20210307171514199"></p>
<h2 id="创建-Workflow"><a href="#创建-Workflow" class="headerlink" title="创建 Workflow"></a>创建 Workflow</h2><p>首先在 Hexo 的仓库中创建一个新文件：<code>.github/workflows/deploy.yml</code>，文件名可以自己取，但是一定要放在 <code>.github/workflows</code> 目录中，文件的内容如下：</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">Deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">watch:</span></span><br><span class="line">    <span class="attr">types:</span> <span class="string">started</span> <span class="comment">#支持点击star部署</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># 只有本人点击star才会执行</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">github.event.repository.owner.id</span> <span class="string">==</span> <span class="string">github.event.sender.id</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">source</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">设置</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">"12"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装Hexo</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">ACTION_DEPLOY_KEY:</span> <span class="string">${{</span> <span class="string">secrets.HEXO_DEPLOY_KEY</span> <span class="string">}}</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir -p ~/.ssh/</span></span><br><span class="line"><span class="string">          echo "$ACTION_DEPLOY_KEY" | tr -d '\r' &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"><span class="string">          ssh-keyscan e.coding.net &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"><span class="string">          git config --global user.email "xxx@xxx.com"</span></span><br><span class="line"><span class="string">          git config --global user.name "xxxx"</span></span><br><span class="line"><span class="string">          npm install hexo-cli -g</span></span><br><span class="line"><span class="string">          npm install</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署编译</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          hexo clean</span></span><br><span class="line"><span class="string">          hexo deploy</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>简单解释一下，当我们推送内容到远程 <code>master</code> 分支的时候，就会触发这个 Workflow，同时给自己项目点击 star 也会触发。</p>
<p>使用 <code>Ubuntu</code> 作为 <code>hexo deploy</code> 的系统。</p>
<p>首先 checkout 源代码，然后设置使用最新的 Node.js v12 LTS 作为 node 解释器。</p>
<p>接下来就是创建 SSH 相关的配置文件，注意 <code>secrets.HEXO_DEPLOY_KEY</code> 就是对应我们之前设置的私钥，所以名字一定不要搞错。</p>
<p><code>git config</code> 相关的名字和邮件地址替换成自己使用的。</p>
<p>最后就是安装 Hexo CLI，各个依赖模块和部署了。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>下面就是 GitHub Actions 页面显示的运行结果：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHostingimage-20210307172003566.png" alt="image-20210307172003566"></p>
<p>绿色的，就表示部署成功，红色的表示失败。如果部署失败，可以点击部署任务查看错误日志，进行调试，点击项目 star 可以进行手动部署。</p>
<blockquote>
<p>部分内容和图片参考博文 <a class="link" href="https://tommy.net.cn/2020/08/06/deploy-hexo-with-github-actions/">https://tommy.net.cn/2020/08/06/deploy-hexo-with-github-actions/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>非常感谢</p>
</blockquote>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMap 相关学习</title>
    <url>/2020/bc6eced1.html</url>
    <content><![CDATA[<ul>
<li><a class="link" href="https://www.cnblogs.com/life-of-coding/p/12066962.html">HashMap 中的位运算<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>  </li>
<li><a class="link" href="https://juejin.im/post/5db92860e51d4529ee588406">准备用 HashMap 存 1w 条数据，构造时传 10000 还会触发扩容吗<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://www.jianshu.com/p/2e2a18d02218">HashMap 源码分析<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://juejin.im/post/5ba457a25188255c7b168023">HashMap 为何从头插入改为尾插入<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://yuanrengu.com/2020/ba184259.html">HashMap 在 Jdk1.7 和 1.8 中的实现<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://www.cnblogs.com/heyonggang/p/9112731.html">面试必备：HashMap、Hashtable、ConcurrentHashMap 的原理与区别<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://blog.csdn.net/ysvae/article/details/81090894">由 HashMap 哈希算法引出的求余 % 和与运算 &amp; 转换问题<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<span id="more"></span>

<h3 id="分析Hashtable、HashMap、TreeMap的区别"><a href="#分析Hashtable、HashMap、TreeMap的区别" class="headerlink" title="分析Hashtable、HashMap、TreeMap的区别"></a>分析 Hashtable、HashMap、TreeMap 的区别</h3><ul>
<li><code>HashMap</code> 是继承自 <code>AbstractMap</code> 类，而 <code>HashTable</code> 是继承自 <code>Dictionary</code> 类。不过它们都同时实现了 map、Cloneable（可复制）、Serializable（可序列化）这三个接口。存储的内容是基于 key-value 的键值对映射，不能有重复的 key，而且一个 key 只能映射一个 value。HashSet 底层就是基于 HashMap 实现的。</li>
<li>Hashtable 的 key、value 都不能为 null；HashMap 的 key、value 可以为 null，不过只能有一个 key 为 null，但可以有多个 null 的 value；TreeMap 键、值都不能为 null。</li>
<li>Hashtable、HashMap 具有<strong>无序</strong>特性。TreeMap 是利用<code>红黑树</code>实现的（树中的每个节点的值都会大于或等于它的左子树中的所有节点的值，并且小于或等于它的右子树中的所有节点的值），实现了 SortMap 接口，能够对保存的记录根据键进行排序。所以一般需求排序的情况下首选 TreeMap，<code>默认按键的升序排序</code>（深度优先搜索），也可以自定义实现 Comparator 接口实现排序方式。</li>
</ul>
<p>一般情况下我们选用 HashMap，因为 HashMap 的键值对在取出时是随机的，其依据键的 hashCode 和键的 equals 方法存取数据，具有很快的访问速度，所以在 Map 中插入、删除及索引元素时其是效率最高的实现。而 TreeMap 的键值对在取出时是排过序的，所以效率会低点。</p>
<p><code>TreeMap</code> 是基于红黑树的一种提供顺序访问的 Map，与 HashMap 不同的是它的 get、put、remove 之类操作都是 o (log (n)) 的时间复杂度，具体顺序可以由指定的 Comparator 来决定，或者根据键的自然顺序来判断。</p>
<p><strong>对 HashMap 做下总结</strong>：<br>HashMap 基于哈希散列表实现 ，可以实现对数据的读写。<strong>将键值对传递给 put 方法时，它调用键对象的 hashCode () 方法来计算 hashCode，然后找到相应的 bucket 位置（即数组）来储存值对象。当获取对象时，通过键对象的 equals () 方法找到正确的键值对，然后返回值对象</strong>。HashMap 使用链表来解决 hash 冲突问题，当发生冲突了，对象将会储存在链表的头节点中。HashMap 在每个链表节点中储存键值对对象，当两个不同的键对象的 hashCode 相同时，它们会储存在同一个 bucket 位置的链表中，如果链表大小超过阈值（TREEIFY_THRESHOLD,8），链表就会被改造为树形结构。</p>
<p><strong>有个问题要特别声明下</strong>：</p>
<ul>
<li>HashMap 在 jdk1.7 中采用<strong>表头插入法</strong>，在扩容时会<strong>改变</strong>链表中元素原本的顺序，以至于在并发场景下导致链表成环的问题。</li>
<li>在 jdk1.8 中采用的是<strong>尾部插入法</strong>，在扩容时会保持链表元素原本的顺序，就不会出现链表成环的问题了。</li>
</ul>
<p><strong>我们可以简单列下 HashMap 在 1.7 和 1.8 之间的变化：</strong></p>
<ul>
<li>1.7 中采用数组 + 链表，1.8 采用的是数组 + 链表 / 红黑树，即在 1.7 中链表长度超过一定长度后就改成红黑树存储，这个改变的阈值为 8，缓冲值为 6。</li>
<li>1.7 扩容时需要重新计算哈希值和索引位置，1.8 并不重新计算哈希值，巧妙地采用和扩容后容量进行 &amp; 操作来计算新的索引位置。</li>
<li>1.7 是采用表头插入法插入链表，1.8 采用的是尾部插入法。</li>
<li>在 1.7 中采用表头插入法，在扩容时会改变链表中元素原本的顺序，以至于在并发场景下导致链表成环的问题；在 1.8 中采用尾部插入法，在扩容时会保持链表元素原本的顺序，就不会出现链表成环的问题了。</li>
</ul>
<h3 id="关于扩容问题"><a href="#关于扩容问题" class="headerlink" title="关于扩容问题"></a><strong>关于扩容问题</strong></h3><p>在 HashMap 中，提供了一个指定初始容量的构造方法 <code>HashMap(int initialCapacity)</code>，这个方法最终会调用到 HashMap 另一个构造方法，其中的参数 loadFactor 就是默认值 0.75f。</p>
<p>其中的成员变量 <code>threshold</code> 就是用来存储，触发 HashMap 扩容的阈值，也就是说，当 HashMap 存储的数据量达到 <code>threshold</code> 时，就会触发扩容。</p>
<p>从构造方法的逻辑可以看出，HashMap 并不是直接使用外部传递进来的 <code>initialCapacity</code>，而是经过了 <code>tableSizeFor()</code> 方法的处理，再赋值到 <code>threshole</code> 上。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a power of two size for the given target capacity.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>在 <code>tableSizeFor()</code> 方法中，通过逐步位运算，就可以让返回值，保持在 2 的 N 次幂。以方便在扩容的时候，快速计算数据在扩容后的新表中的位置。</p>
<p>那么当我们从外部传递进来 1w 时，实际上经过 <code>tableSizeFor()</code> 方法处理之后，就会变成 2 的 14 次幂 16384，再算上负载因子 0.75f，实际在不触发扩容的前提下，可存储的数据容量是 12288（16384 * 0.75f）。</p>
<p>这种场景下，用来存放 1w 条数据，绰绰有余了，并不会触发我们猜想的扩容。</p>
<p>当我们把初始容量，调整到 1000 时，再回到 HashMap 的构造方法，<code>threshold</code> 为扩容的阈值，在构造方法中由 <code>tableSizeFor()</code> 方法调整后直接赋值，所以在构造 HashMap 时，如果传递 1000，<code>threshold</code> 调整后的值确实是 1024，但 HashMap 并不直接使用它。详细解释见<a class="link" href="https://juejin.im/post/5db92860e51d4529ee588406#heading-2">这里<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>结论：虽然 HashMap 初始容量指定为 1000，会被 <code>tableSizeFor()</code> 调整为 1024，但是它只是表示 table 数组为 1024，扩容的重要依据扩容阈值会在 <code>resize()</code> 中调整为 768（1024 * 0.75）</p>
<blockquote>
<p>通常在初始化 HashMap 时，初始容量都是根据业务来的，而不会是一个固定值，为此我们需要有一个特殊处理的方式，就是将预期的初始容量，再除以 HashMap 的装载因子，<strong>默认时就是除以 0.75</strong>。</p>
<p>例如想要用 HashMap 存放 1k 条数据，应该设置 1000 / 0.75，实际传递进去的值是 1333，然后会被 <code>tableSizeFor()</code> 方法调整到 2048，足够存储数据而不会触发扩容。</p>
<p>当想用 HashMap 存放 1w 条数据时，依然设置 10000 / 0.75，实际传递进去的值是 13333，会被调整到 16384，和我们直接传递 10000 效果是一样的。</p>
</blockquote>
<h3 id="tableSizeFor方法详解"><a href="#tableSizeFor方法详解" class="headerlink" title="tableSizeFor方法详解"></a>tableSizeFor 方法详解</h3><ul>
<li><p>让 cap-1 再赋值给 n 的目的是使得找到的目标值大于或等于原值。例如二进制 <code>0100</code>, 十进制是 4, 若不减 1 而直接操作，答案是 <code>0001 0000</code> 十进制是 16，明显不符合预期。</p>
</li>
<li><p>对 n 右移 1 位：001xx…xxx，再位或：011xx…xxx</p>
</li>
<li><p>对 n 右移 2 位：00011…xxx，再位或：01111…xxx</p>
</li>
<li><p>对 n 右移 4 位…</p>
</li>
<li><p>对 n 右移 8 位…</p>
</li>
<li><p>对 n 右移 16 位，因为 int 最大就 <code>2^32</code> 所以移动 1、2、4、8、16 位并取位或，会将最高位的 1 后面的位全变为 1。</p>
</li>
<li><p>再让结果 n+1，即得到了 2 的整数次幂的值了。</p>
<p>  <img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/05/02/Jxw1at.png" alt="img"></p>
</li>
</ul>
<h3 id="求余-和与运算-转换"><a href="#求余-和与运算-转换" class="headerlink" title="求余%和与运算&amp;转换"></a>求余 % 和与运算 &amp; 转换</h3><p>很多哈希算法，为了使元素分布均匀，都是用的取模运算，用一个值去模上总长度，即 n% hash。我们知道在计算机中 &amp; 的效率比 % 高很多，那么如何将 % 转换为 &amp; 运算呢？在 HashMap 中，是用的 (n - 1) &amp; hash 进行运算的</p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo - 修改永久链接的默认格式</title>
    <url>/2018/df9aa0b3.html</url>
    <content><![CDATA[<p>Hexo 的永久链接的默认格式是 <code>:year/:month/:day/:title/</code>，比如访问站点下某一篇文章时，其路径是 <code>2018/04/12/xxxx/</code>，如果我们的文章标题是中文的，那么该路径就会出现中文字符。在路径中出现了中文字符很容易引发各种问题，而且也不利于 seo，因为路径包含了年月日三个层级，层级太深不利于百度蜘蛛抓取。</p>
<span id="more"></span>

<p>解决办法就是利用其它的插件来生成唯一的路径，这样就算我们的文件标题随意修改，而不会导致原本的链接失效而造成站点下存在大量的死链。 </p>
<h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><p>在站点根目录使用 <code>git bash</code> 执行命令：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo-abbrlink --save1</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="修改站点配置文件"><a href="#修改站点配置文件" class="headerlink" title="修改站点配置文件"></a>修改站点配置文件</h2><p>打开根目录下的 <code>_config.yml</code> 文件，修改如下配置：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line"># permalink: :year/:month/:day/:title/</span><br><span class="line"># permalink_defaults:</span><br><span class="line">permalink: :year/:abbrlink.html</span><br><span class="line">abbrlink:</span><br><span class="line">  alg: crc32  # 算法：crc16(default) and crc32</span><br><span class="line">  rep: hex    # 进制：dec(default) and hex123456</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里将页面都添加了 <code>.html</code> 的后缀，用来伪装成静态页面 (虽说 Hexo 的页面本身就是静态页面)，这样可以直接从路径就知道这是个静态页面，方便 seo。</p>
<p>接下来重新部署三连，可以看到我们的文章路径变成了 <code>/2018/xxxxx.html</code>，接下来就算我们将文字标题命名为中文也没问题了。</p>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Jar 包替换内部依赖后 ClassNotFoundException 问题排查</title>
    <url>/2025/2294519147.html</url>
    <content><![CDATA[<blockquote>
<p>问题描述</p>
</blockquote>
<p>在维护 Spring Boot 项目时，需更新外部 Jar 包 <code>app.jar</code> 中 <code>BOOT-INF/lib/</code> 目录下的内部依赖 <code>core-service.jar</code>。按常规步骤替换后，程序启动抛出 <code>ClassNotFoundException</code>，但通过压缩工具及命令行验证，缺失的 Class 文件实际存在于新替换的 Jar 包中。</p>
<span id="more"></span>

<h2 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h2><h3 id="1-初步验证文件存在性"><a href="#1-初步验证文件存在性" class="headerlink" title="1. 初步验证文件存在性"></a>1. 初步验证文件存在性</h3><p>替换操作完成后，首先使用压缩 GUI 工具查看替换后的 jar 包：</p>
<p>观察到 <code>core-service.jar</code> 日期和大小发生变化，说明替换成功。</p>
<h3 id="2-排除-Jar-包本身问题"><a href="#2-排除-Jar-包本身问题" class="headerlink" title="2. 排除 Jar 包本身问题"></a>2. 排除 Jar 包本身问题</h3><p>为排除新 Jar 包 <code>core-service.jar</code> 本身缺少依赖，在使用 <code>jar xvf app.jar</code> 解压后，直接使用源 Jar 包替换（使用 <code>jar uvf app.jar BOOT-INF/lib/core-service.jar</code>），问题依旧。说明不是新 jar 包本身问题，问题可能存在替换命令上</p>
<h3 id="3-定位命令行参数问题"><a href="#3-定位命令行参数问题" class="headerlink" title="3. 定位命令行参数问题"></a>3. 定位命令行参数问题</h3><p>对比不同参数的执行效果，发现命令执行完整后会提示压缩比，怀疑是 jar 的二次压缩导致了无法正确找到 class。为了验证猜想，在使用 <code>jar xvf app.jar</code> 解压后，使用 <code>jar uf0 app.jar BOOT-INF/lib/core-service.jar</code> 替换，发现问题被解决，程序正常启动。</p>
<h2 id="问题复盘及操作步骤梳理"><a href="#问题复盘及操作步骤梳理" class="headerlink" title="问题复盘及操作步骤梳理"></a>问题复盘及操作步骤梳理</h2><h3 id="1-操作流程"><a href="#1-操作流程" class="headerlink" title="1. 操作流程"></a>1. 操作流程</h3><p>为避免替换时路径错误，采用完整解压再替换的方案：</p>
<ol>
<li>创建临时目录并进入：<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> temp &amp;&amp; <span class="built_in">cd</span> temp</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>解压整个外部 Jar 包以保留完整目录结构：<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">jar xvf ../app.jar</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>在临时目录中替换文件：<br>将新版本 <code>core-service.jar</code> 复制到 <code>temp/BOOT-INF/lib/</code> 目录，覆盖旧文件。</li>
<li>执行更新命令：<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">jar uf0 ../app.jar BOOT-INF/lib/core-service.jar</span><br></pre></td></tr></tbody></table></figure></div>
按相对路径更新文件，保证 Jar 包内部路径结构正确。</li>
<li>清理临时文件：<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> .. &amp;&amp; <span class="built_in">rm</span> -rf temp</span><br></pre></td></tr></tbody></table></figure></div></li>
</ol>
<h3 id="2-禁用压缩参数的作用"><a href="#2-禁用压缩参数的作用" class="headerlink" title="2. 禁用压缩参数的作用"></a>2. 禁用压缩参数的作用</h3><p>使用 <code>0</code> 参数禁用压缩功能，避免二次压缩导致 Class 文件结构异常：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">jar uf0 app.jar  BOOT-INF/lib/core-service.jar</span><br></pre></td></tr></tbody></table></figure></div>

<p>替换完成后，程序启动正常，<code>ClassNotFoundException</code> 问题解决。</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p><code>jar</code> 命令默认使用 DEFLATE 算法压缩文件，在替换内部依赖时，若对已压缩的 Jar 包再次压缩，可能导致 Class 文件结构异常。Spring Boot 的类加载器在扫描 <code>BOOT-INF/lib/</code> 目录时，无法正确解析异常的 Class 文件，从而抛出 <code>ClassNotFoundException</code>。使用 <code>0</code> 参数禁用压缩后，Class 文件以原始字节码形式存储，类加载器可正常读取。</p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaScript 高性能数组去重</title>
    <url>/2021/2692119065.html</url>
    <content><![CDATA[<h1 id="JavaScript-高性能数组去重"><a href="#JavaScript-高性能数组去重" class="headerlink" title="JavaScript 高性能数组去重"></a>JavaScript 高性能数组去重</h1><p>转载自： <a class="link" href="https://www.cnblogs.com/wisewrong/p/9642264.html">https://www.cnblogs.com/wisewrong/p/9642264.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>改为浏览器控制台测试性能</p>
<p>测试浏览器：<code>Microsoft Edge</code></p>
<p>Chromium 版本：<code>90.0.818.62</code></p>
<span id="more"></span>

<h2 id="一、测试模版"><a href="#一、测试模版" class="headerlink" title="一、测试模版"></a>一、测试模版</h2><p>数组去重是一个老生常谈的问题，网上流传着有各种各样的解法</p>
<p>为了测试这些解法的性能，我写了一个测试模版，用来计算数组去重的耗时</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 性能测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} callback 测试回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">callback</span>) {</span><br><span class="line">  <span class="keyword">let</span> arr1 = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">100000</span>), <span class="function">(<span class="params">x, index</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> index</span><br><span class="line">  })</span><br><span class="line">  <span class="keyword">let</span> arr2 = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">50000</span>), <span class="function">(<span class="params">x, index</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> index + index</span><br><span class="line">  })</span><br><span class="line">  <span class="keyword">let</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"开始数组去重"</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"去重后的长度"</span>, <span class="title function_">callback</span>(arr1, arr2).<span class="property">length</span>)</span><br><span class="line">  <span class="keyword">let</span> end = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"耗时"</span>, end - start)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里分别创建了两个长度为 10W 和 5W 的数组</p>
<p>然后通过 callback () 方法合并两个数组，并去掉其中的重复项</p>
<p>数据量不大也不小，但已经能说明一些问题了</p>
<p>粘贴到控制台</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/bXM9r5L8e3jTIsR.png" alt="image-20210518092634492"></p>
<h2 id="二、Array-filter-indexOf"><a href="#二、Array-filter-indexOf" class="headerlink" title="二、Array.filter() + indexOf"></a>二、Array.filter () + indexOf</h2><p>这个方法的思路是，将两个数组拼接为一个数组，然后使用 ES6 中的 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/filter">Array.filter()<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 遍历数组，并结合 indexOf 来排除重复项</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> arr = a.<span class="title function_">concat</span>(b)</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">filter</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">indexOf</span>(item) === index</span><br><span class="line">  })</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></div>

<p>这就是我被吐槽的那个数组去重方法，看起来非常简洁，但实际性能。。。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/zoH3XrDOfm1Mcd7.png" alt="image-20210518093002800"></p>
<p>是的，现实就是这么残酷，处理一个长度为 15W 的数组都需要 8427ms</p>
<h2 id="三、双重-for-循环"><a href="#三、双重-for-循环" class="headerlink" title="三、双重 for 循环"></a>三、双重 for 循环</h2><p>最容易理解的方法，外层循环遍历元素，内层循环检查是否重复</p>
<p>当有重复值的时候，可以使用 push ()，也可以使用 splice ()</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> arr = a.<span class="title function_">concat</span>(b)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = arr.<span class="property">length</span>; i &lt; len; i++) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = i + <span class="number">1</span>; j &lt; len; j++) {</span><br><span class="line">      <span class="keyword">if</span> (arr[i] == arr[j]) {</span><br><span class="line">        arr.<span class="title function_">splice</span>(j, <span class="number">1</span>) <span class="comment">// splice 会改变数组长度，所以要将数组长度 len 和下标 j 减一</span></span><br><span class="line">        len--</span><br><span class="line">        j--</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> arr</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></div>

<p>但这种方法占用的内存较高，效率也是最低的</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/14HOWMKlCT7nsZJ.png" alt="image-20210518093721920"></p>
<h2 id="四、for…of-includes"><a href="#四、for…of-includes" class="headerlink" title="四、for…of + includes()"></a>四、for…of + includes ()</h2><p>双重 for 循环的升级版，外层用 <code>for...of</code> 语句替换 for 循环，把内层循环改为 <code>includes()</code></p>
<p>先创建一个空数组，当 <code>includes()</code> 返回 <code>false</code> 的时候，就将该元素 <code>push</code> 到空数组中</p>
<p>类似的，还可以用 <code>indexOf()</code> 来替代 <code>includes()</code></p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> arr = a.<span class="title function_">concat</span>(b)</span><br><span class="line">  <span class="keyword">let</span> result = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> arr) {</span><br><span class="line">    !result.<span class="title function_">includes</span>(i) &amp;&amp; result.<span class="title function_">push</span>(i)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></div>

<p>这种方法和 filter + indexOf 挺类似</p>
<p>只是把 filter () 的内部逻辑用 for 循环实现出来，再把 indexOf 换为 includes</p>
<p>所以时长上也比较接近</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/xsKVCorXl3LjPzF.png" alt="image-20210518093941022"></p>
<h2 id="五、Array-sort"><a href="#五、Array-sort" class="headerlink" title="五、Array.sort()"></a>五、Array.sort ()</h2><p>首先使用 sort () 将数组进行排序</p>
<p>然后比较相邻元素是否相等，从而排除重复项</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> arr = a.<span class="title function_">concat</span>(b)</span><br><span class="line">  arr = arr.<span class="title function_">sort</span>()</span><br><span class="line">  <span class="keyword">let</span> result = [arr[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, len = arr.<span class="property">length</span>; i &lt; len; i++) {</span><br><span class="line">    arr[i] !== arr[i - <span class="number">1</span>] &amp;&amp; result.<span class="title function_">push</span>(arr[i])</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></div>

<p>这种方法只做了一次排序和一次循环，所以效率会比上面的方法都要高</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/fI3v9A2jnK7BWLC.png" alt="image-20210518094245327"></p>
<h2 id="六、new-Set"><a href="#六、new-Set" class="headerlink" title="六、new Set()"></a>六、new Set ()</h2><p>ES6 新增了 <a class="link" href="http://es6.ruanyifeng.com/#docs/set-map">Set<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 这一数据结构，类似于数组，但 <strong>Set 的成员具有唯一性</strong></p>
<p>基于这一特性，就非常适合用来做数组去重了</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Set</span>([...a, ...b]))</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></div>

<p>那使用 Set 又需要多久时间来处理 15W 的数据呢？</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/rKOvJYSQVmpTNBx.png" alt="image-20210518094608155"></p>
<p>喵喵喵？？？ 57ms ？？我没眼花吧？？</p>
<p>然后我在两个数组长度后面分别加了一个 0，在 150W 的数据量之下…</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/BogKefRIliJ5Sza.png" alt="image-20210518145606340"></p>
<p>居然有如此高性能且简洁的数组去重办法？！</p>
<p><strong>七、for…of + Object</strong></p>
<p>这个方法我只在一些文章里见过，实际工作中倒没怎么用</p>
<p>首先创建一个空对象，然后用 for 循环遍历</p>
<p>利用<strong>对象的属性不会重复</strong>这一特性，校验数组元素是否重复</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> arr = a.<span class="title function_">concat</span>(b)</span><br><span class="line">  <span class="keyword">let</span> result = []</span><br><span class="line">  <span class="keyword">let</span> obj = {}</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> arr) {</span><br><span class="line">    <span class="keyword">if</span> (!obj[i]) {</span><br><span class="line">      result.<span class="title function_">push</span>(i)</span><br><span class="line">      obj[i] = <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></div>

<p>当我看到这个方法的处理时长，我又傻眼了</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/IACupLY12shKb4V.png" alt="image-20210518145321012"></p>
<p><strong>15W 的数据居然只要 <s>16</s> 8ms ？？？ 比 Set () 还快？？？</strong></p>
<p>然后我又试了试 150W 的数据量…</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/18/M5CBWVLt2ZFU8jY.png" alt="image-20210518145642579"></p>
]]></content>
      <tags>
        <tag>javascript</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 中一些不常用的函数</title>
    <url>/2018/8defd4c4.html</url>
    <content><![CDATA[<blockquote>
<p>对于我来说目前比较不怎么常用的函数</p>
</blockquote>
<span id="more"></span>

<h2 id="字符串和数字转换"><a href="#字符串和数字转换" class="headerlink" title="字符串和数字转换"></a>字符串和数字转换</h2><h3 id="数字转字符串"><a href="#数字转字符串" class="headerlink" title="数字转字符串"></a>数字转字符串</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">		<span class="type">int</span> i=<span class="number">5</span>;</span><br><span class="line">		<span class="comment">//方法1</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> String.valueOf(i);</span><br><span class="line">		<span class="comment">//方法2</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">it</span> <span class="operator">=</span> i;</span><br><span class="line">		<span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> it.toString();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="字符串转数字"><a href="#字符串转数字" class="headerlink" title="字符串转数字"></a>字符串转数字</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">		<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"123"</span>;</span><br><span class="line">		<span class="comment">//方法1</span></span><br><span class="line">		<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.paeseInt(str);</span><br><span class="line">		<span class="comment">//方法2</span></span><br><span class="line">		<span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> Integer.valueOf(str);</span><br><span class="line">		System.out.println(i);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="浮点型（不能有字母）"><a href="#浮点型（不能有字母）" class="headerlink" title="浮点型（不能有字母）"></a>浮点型（不能有字母）</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">	<span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">3.14</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> String.valueOf(d);</span><br><span class="line">	<span class="comment">//字符串转浮点</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"3.14"</span>;</span><br><span class="line">	<span class="type">double</span> <span class="variable">d1</span> <span class="operator">=</span> Double.parseDouble(str);</span><br><span class="line">	<span class="comment">//错误情况</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">"3.1a4"</span>;</span><br><span class="line">	<span class="type">double</span> <span class="variable">d2</span> <span class="operator">=</span> Double.parseDouble(str2);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h2 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h2><h3 id="四舍五入-随机数，开方，次方，π，自然常数"><a href="#四舍五入-随机数，开方，次方，π，自然常数" class="headerlink" title="四舍五入, 随机数，开方，次方，π，自然常数"></a>四舍五入，随机数，开方，次方，π，自然常数</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">		<span class="type">float</span> <span class="variable">f1</span> <span class="operator">=</span> <span class="number">5.4f</span>;</span><br><span class="line">		<span class="type">float</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="number">5.5f</span>;</span><br><span class="line">		<span class="comment">//5.4四舍五入</span></span><br><span class="line">		System.out.println(Math.round(f1));</span><br><span class="line">		<span class="comment">//5.5四舍五入</span></span><br><span class="line">		System.out.println(Math.round(f2));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//得到0-1之间的随机数，小于1</span></span><br><span class="line">		System.out.println(Math.random());</span><br><span class="line">		<span class="comment">//得到0-10之间的随机数，小于10</span></span><br><span class="line">		System.out.println((<span class="type">int</span>)(Math.random()*<span class="number">10</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//π</span></span><br><span class="line">        System.out.println(Math.PI);</span><br><span class="line">		<span class="comment">//自然常数</span></span><br><span class="line">        System.out.println(Math.E);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="求一千万以内的质数个数"><a href="#求一千万以内的质数个数" class="headerlink" title="求一千万以内的质数个数"></a>求一千万以内的质数个数</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">Prime</span><span class="params">(<span class="type">int</span> n)</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="type">int</span> i, j, k, count = <span class="number">0</span>;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; n; i++) {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = (<span class="type">int</span>) Math.sqrt(i);</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (j = <span class="number">2</span>; j &lt;= k; j++) {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (<span class="number">0</span> == i % j)</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span>;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (j &gt; k) {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(i);</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count++;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> count;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"一千万的素数的个数为"</span> + Prime(<span class="number">10000</span> * <span class="number">1000</span>));</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br></pre></td></tr></tbody></table></figure></div>
<h2 id="字符串控制"><a href="#字符串控制" class="headerlink" title="字符串控制"></a>字符串控制</h2><h3 id="charAt-int-index-获取指定位置的字符"><a href="#charAt-int-index-获取指定位置的字符" class="headerlink" title="charAt(int index)获取指定位置的字符"></a>charAt (int index) 获取指定位置的字符</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">   </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"盖伦,在进行了连续8次击杀后,获得了 超神 的称号"</span>;</span><br><span class="line">         </span><br><span class="line">        <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> sentence.charAt(<span class="number">0</span>);</span><br><span class="line">         </span><br><span class="line">        System.out.println(c);</span><br><span class="line">           </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="toCharArray-获取对应的字符数组"><a href="#toCharArray-获取对应的字符数组" class="headerlink" title="toCharArray()获取对应的字符数组"></a>toCharArray () 获取对应的字符数组</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">   </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"盖伦,在进行了连续8次击杀后,获得了超神 的称号"</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="type">char</span>[] cs = sentence.toCharArray(); <span class="comment">//获取对应的字符数组</span></span><br><span class="line">         </span><br><span class="line">        System.out.println(sentence.length() == cs.length);</span><br><span class="line">         </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="subString-截取子字符串"><a href="#subString-截取子字符串" class="headerlink" title="subString 截取子字符串"></a>subString 截取子字符串</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">   </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"盖伦,在进行了连续8次击杀后,获得了 超神 的称号"</span>;</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//截取从第3个开始的字符串 （基0）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">subString1</span> <span class="operator">=</span> sentence.substring(<span class="number">3</span>);</span><br><span class="line">         </span><br><span class="line">        System.out.println(subString1);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//截取从第3个开始的字符串 （基0）</span></span><br><span class="line">        <span class="comment">//到5-1的位置的字符串</span></span><br><span class="line">        <span class="comment">//左闭右开</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">subString2</span> <span class="operator">=</span> sentence.substring(<span class="number">3</span>,<span class="number">5</span>);</span><br><span class="line">         </span><br><span class="line">        System.out.println(subString2);</span><br><span class="line">         </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="split-根据分隔符进行分隔"><a href="#split-根据分隔符进行分隔" class="headerlink" title="split 根据分隔符进行分隔"></a>split 根据分隔符进行分隔</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">   </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"盖伦,在进行了连续8次击杀后,获得了 超神 的称号"</span>;</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//根据,进行分割，得到3个子字符串</span></span><br><span class="line">        String subSentences[] = sentence.split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">for</span> (String sub : subSentences) {</span><br><span class="line">            System.out.println(sub);</span><br><span class="line">        }</span><br><span class="line">           </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="trim-去掉首尾空格"><a href="#trim-去掉首尾空格" class="headerlink" title="trim 去掉首尾空格"></a>trim 去掉首尾空格</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">   </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"        盖伦,在进行了连续8次击杀后,获得了 超神 的称号      "</span>;</span><br><span class="line">         </span><br><span class="line">        System.out.println(sentence);</span><br><span class="line">        <span class="comment">//去掉首尾空格</span></span><br><span class="line">        System.out.println(sentence.trim());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="toLowerCase-全部变成小写"><a href="#toLowerCase-全部变成小写" class="headerlink" title="toLowerCase 全部变成小写"></a>toLowerCase 全部变成小写</h3><p>toUpperCase 全部变成大写</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">   </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"Garen"</span>;</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//全部变成小写</span></span><br><span class="line">        System.out.println(sentence.toLowerCase());</span><br><span class="line">        <span class="comment">//全部变成大写</span></span><br><span class="line">        System.out.println(sentence.toUpperCase());</span><br><span class="line">         </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h3><p>indexOf 判断字符或者子字符串出现的位置<br>contains 是否包含子字符串</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> character;</span><br><span class="line">     </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> {</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    </span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">"盖伦,在进行了连续8次击杀后,获得了超神 的称号"</span>;</span><br><span class="line">  </span><br><span class="line">        System.out.println(sentence.indexOf(<span class="string">'8'</span>)); <span class="comment">//字符第一次出现的位置</span></span><br><span class="line">          </span><br><span class="line">        System.out.println(sentence.indexOf(<span class="string">"超神"</span>)); <span class="comment">//字符串第一次出现的位置</span></span><br><span class="line">          </span><br><span class="line">        System.out.println(sentence.lastIndexOf(<span class="string">"了"</span>)); <span class="comment">//字符串最后出现的位置</span></span><br><span class="line">          </span><br><span class="line">        System.out.println(sentence.indexOf(<span class="string">','</span>,<span class="number">5</span>)); <span class="comment">//从位置5开始，出现的第一次,的位置</span></span><br><span class="line">          </span><br><span class="line">        System.out.println(sentence.contains(<span class="string">"击杀"</span>)); <span class="comment">//是否包含字符串"击杀"</span></span><br><span class="line">          </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><h3 id="finally"><a href="#finally" class="headerlink" title="finally"></a>finally</h3><p><code> finally里一般拿来做一些善后清理工作,try块里出现错误的话，会立即跳出try块，找到匹配的错误，执行catch块里的语句此时，可能在try块里打开的文件没关闭，连接的网络没断开，对这些浪费的内存就不能及时释放回收。如果有finally块的话，不管有没有出错，都会执行finally块里的内容。</code></p>
<p>无论是否出现异常，finally 中的代码都会被执行代码比较复制代码 </p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestException</span> {</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">         </span><br><span class="line">        File f= <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"d:/LOL.exe"</span>);</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            System.out.println(<span class="string">"试图打开 d:/LOL.exe"</span>);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(f);</span><br><span class="line">            System.out.println(<span class="string">"成功打开"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span>(FileNotFoundException e){</span><br><span class="line">            System.out.println(<span class="string">"d:/LOL.exe不存在"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">finally</span>{</span><br><span class="line">            System.out.println(<span class="string">"无论文件是否存在， 都会执行的代码"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 线程池的使用</title>
    <url>/2020/ss1wdcs236.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 Java 中，我们可以利用多线程来最大化地压榨 CPU 多核计算的能力。但是，线程本身是把双刃剑，我们需要知道它的利弊，才能在实际系统中游刃有余地运用。</p>
<span id="more"></span>

<p><a href="#%E6%9C%80%E7%BB%88%E7%A4%BA%E4%BE%8B">一个例子</a></p>
<p>在进入主题之前，我们先了解一下线程池的基本概念。</p>
<blockquote>
<p>线程池，本质上是一种对象池，用于管理线程资源。<br> 在任务执行前，需要从线程池中拿出线程来执行。<br> 在任务执行完成之后，需要把线程放回线程池。<br> 通过线程的这种反复利用机制，可以有效地避免直接创建线程所带来的坏处。</p>
</blockquote>
<p>我们先来看看线程池带来了哪些好处。</p>
<ol>
<li>降低资源的消耗。线程本身是一种资源，创建和销毁线程会有 CPU 开销；创建的线程也会占用一定的内存。</li>
<li>提高任务执行的响应速度。任务执行时，可以不必等到线程创建完之后再执行。</li>
<li>提高线程的可管理性。线程不能无限制地创建，需要进行统一的分配、调优和监控。</li>
</ol>
<p>接下来，我们看看不使用线程池有哪些坏处。</p>
<ol>
<li>频繁的线程创建和销毁会占用更多的 CPU 和内存</li>
<li>频繁的线程创建和销毁会对 GC 产生比较大的压力</li>
<li>线程太多，线程切换带来的开销将不可忽视</li>
<li>线程太少，多核 CPU 得不到充分利用，是一种浪费</li>
</ol>
<p>因此，我们有必要对线程池进行比较完整地说明，以便能对线程池进行正确地治理。</p>
<h2 id="线程池实现原理"><a href="#线程池实现原理" class="headerlink" title="线程池实现原理"></a>线程池实现原理</h2><p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2020/01/16/lxVfj1.png" alt="线程池主要处理流程"></p>
<center><font size="”8”">线程池主要处理流程</font></center>
通过上图，我们看到了线程池的主要处理流程。我们的关注点在于，任务提交之后是怎么执行的。大致如下：

<ol>
<li>判断核心线程池是否已满，如果不是，则创建线程执行任务</li>
<li>如果核心线程池满了，判断队列是否满了，如果队列没满，将任务放在队列中</li>
<li>如果队列满了，则判断线程池是否已满，如果没满，创建线程执行任务</li>
<li>如果线程池也满了，则按照拒绝策略对任务进行处理</li>
</ol>
<p>在 jdk 里面，我们可以将处理流程描述得更清楚一点。来看看 <code>ThreadPoolExecutor</code> 的处理流程。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2020/01/16/lxVxDP.png" alt="ThreadPoolExecutor的处理流程"></p>
<p>我们将概念做一下映射。</p>
<ol>
<li><code>corePool</code> -&gt; 核心线程池</li>
<li><code>maximumPool </code>-&gt; 线程池</li>
<li><code>BlockQueue</code> -&gt; 队列</li>
<li><code>RejectedExecutionHandler</code> -&gt; 拒绝策略</li>
</ol>
<h2 id="入门级例子"><a href="#入门级例子" class="headerlink" title="入门级例子"></a>入门级例子</h2><p>为了更直观地理解线程池，我们通过一个例子来宏观地了解一下线程池用法。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            executor.submit(() -&gt; {</span><br><span class="line">                System.out.println(<span class="string">"thread id is: "</span> + Thread.currentThread().getId());</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>在这个例子中，我们首先创建了一个固定长度为 5 的线程池。然后使用循环的方式往线程池中提交了 10 个任务，每个任务休眠 1 秒。在任务休眠之前，将任务所在的线程 id 进行打印输出。</p>
<p>所以，理论上只会打印 5 个不同的线程 id，且每个线程 id 会被打印 2 次。是不是这样的呢？检验真理最好的方式就是运行一下。我们看看执行结果如何</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2020/01/17/lxIt3R.png" alt="lxIt3R.png"></p>
<h2 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h2><p><code>Executors</code> 是一个线程池工厂，提供了很多的工厂方法，我们来看看它大概能创建哪些线程池。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 创建单一线程的线程池</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// 创建固定数量的线程池</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span>;</span><br><span class="line"><span class="comment">// 创建带缓存的线程池</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// 创建定时调度的线程池</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span>;</span><br><span class="line"><span class="comment">// 创建流式（fork-join）线程池</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newWorkStealingPool</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="1-创建单一线程的线程池"><a href="#1-创建单一线程的线程池" class="headerlink" title="1. 创建单一线程的线程池"></a>1. 创建单一线程的线程池</h3><p>顾名思义，这个线程池只有一个线程。若多个任务被提交到此线程池，那么会被缓存到队列（队列长度为 <code>Integer.MAX_VALUE</code>）。当线程空闲的时候，按照 FIFO 的方式进行处理。</p>
<h3 id="2-创建固定数量的线程池"><a href="#2-创建固定数量的线程池" class="headerlink" title="2. 创建固定数量的线程池"></a>2. 创建固定数量的线程池</h3><p>和<code>创建单一线程的线程池</code>类似，只是这儿可以并行处理任务的线程数更多一些罢了。若多个任务被提交到此线程池，会有下面的处理过程。</p>
<ol>
<li>如果线程的数量未达到指定数量，则创建线程来执行任务</li>
<li>如果线程池的数量达到了指定数量，并且有线程是空闲的，则取出空闲线程执行任务</li>
<li>如果没有线程是空闲的，则将任务缓存到队列（队列长度为 <code>Integer.MAX_VALUE</code>）。当线程空闲的时候，按照 FIFO 的方式进行处理</li>
</ol>
<h3 id="3-创建带缓存的线程池"><a href="#3-创建带缓存的线程池" class="headerlink" title="3. 创建带缓存的线程池"></a>3. 创建带缓存的线程池</h3><p>这种方式创建的线程池，核心线程池的长度为 0，线程池最大长度为 <code>Integer.MAX_VALUE</code>。由于本身使用 <code>SynchronousQueue</code> 作为等待队列的缘故，导致往队列里面每插入一个元素，必须等待另一个线程从这个队列删除一个元素。</p>
<h3 id="4-创建定时调度的线程池"><a href="#4-创建定时调度的线程池" class="headerlink" title="4. 创建定时调度的线程池"></a>4. 创建定时调度的线程池</h3><p>和上面 3 个工厂方法返回的线程池类型有所不同，它返回的是 <code>ScheduledThreadPoolExecutor</code> 类型的线程池。平时我们实现定时调度功能的时候，可能更多的是使用第三方类库，比如：quartz 等。但是对于更底层的功能，我们仍然需要了解。</p>
<p>我们写一个例子来看看如何使用。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定时调度，每个调度任务会至少等待`period`的时间，</span></span><br><span class="line">        <span class="comment">// 如果任务执行的时间超过`period`，则等待的时间为任务执行的时间</span></span><br><span class="line">        executor.scheduleAtFixedRate(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                System.out.println(System.currentTimeMillis() / <span class="number">1000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }, <span class="number">0</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定时调度，第二个任务执行的时间 = 第一个任务执行时间 + `delay`</span></span><br><span class="line">        executor.scheduleWithFixedDelay(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                System.out.println(System.currentTimeMillis() / <span class="number">1000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }, <span class="number">0</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定时调度，延迟`delay`后执行，且只执行一次</span></span><br><span class="line">        executor.schedule(() -&gt; System.out.println(<span class="string">"5 秒之后执行 schedule"</span>), <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ol>
<li><code>scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit)</code>，定时调度，每个调度任务会至少等待 <code>period</code> 的时间，如果任务执行的时间超过 <code>period</code>，则等待的时间为任务执行的时间</li>
<li><code>scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit)</code>，定时调度，第二个任务执行的时间 = 第一个任务执行时间 + <code>delay</code> </li>
<li><code>schedule(Runnable command, long delay, TimeUnit unit)</code>，定时调度，延迟 <code>delay</code> 后执行，且只执行一次</li>
</ol>
<h2 id="手动创建线程池"><a href="#手动创建线程池" class="headerlink" title="手动创建线程池 "></a><span id="手动创建线程池">手动创建线程池 </span></h2><p>理论上，我们可以通过 <code>Executors</code> 来创建线程池，这种方式非常简单。但正是因为简单，所以限制了线程池的功能。比如：无长度限制的队列，可能因为任务堆积导致 OOM，这是非常严重的 bug，应尽可能地避免。怎么避免？归根结底，还是需要我们通过更底层的方式来创建线程池。</p>
<p>抛开定时调度的线程池不管，我们看看 <code>ThreadPoolExecutor</code>。它提供了好几个构造方法，但是最底层的构造方法却只有一个。那么，我们就从这个构造方法着手分析。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个构造方法有 7 个参数，我们逐一来进行分析。</p>
<ol>
<li><code>corePoolSize</code>，线程池中的核心线程数</li>
<li><code>maximumPoolSize</code>，线程池中的最大线程数</li>
<li><code>keepAliveTime</code>，空闲时间，当线程池数量超过核心线程数时，多余的空闲线程存活的时间，即：这些线程多久被销毁。</li>
<li><code>unit</code>，空闲时间的单位，可以是毫秒、秒、分钟、小时和天，等等</li>
<li><code>workQueue</code>，等待队列，线程池中的线程数超过核心线程数时，任务将放在等待队列，它是一个 <code>BlockingQueue</code> 类型的对象</li>
<li><code>threadFactory</code>，线程工厂，我们可以使用它来创建一个线程</li>
<li><code>handler</code>，拒绝策略，当线程池和等待队列都满了之后，需要通过该对象的回调函数进行回调处理</li>
</ol>
<p>这些参数里面，基本类型的参数都比较简单，我们不做进一步的分析。我们更关心的是 <code>workQueue</code>、<code>threadFactory</code> 和 <code>handler</code>，接下来我们将进一步分析。</p>
<h3 id="1-等待队列-workQueue"><a href="#1-等待队列-workQueue" class="headerlink" title="1. 等待队列-workQueue"></a>1. 等待队列 - workQueue</h3><p>等待队列是 <code>BlockingQueue</code> 类型的，理论上只要是它的子类，我们都可以用来作为等待队列。</p>
<p>同时，jdk 内部自带一些阻塞队列，我们来看看大概有哪些。</p>
<ol>
<li><code>ArrayBlockingQueue</code>，队列是有界的，基于数组实现的阻塞队列</li>
<li><code>LinkedBlockingQueue</code>，队列可以有界，也可以无界。基于链表实现的阻塞队列</li>
<li><code>SynchronousQueue</code>，不存储元素的阻塞队列，每个插入操作必须等到另一个线程调用移除操作，否则插入操作将一直处于阻塞状态。该队列也是 <code>Executors.newCachedThreadPool()</code> 的默认队列</li>
<li><code>PriorityBlockingQueue</code>，带优先级的无界阻塞队列</li>
</ol>
<p>通常情况下，我们需要指定阻塞队列的上界（比如 1024）。另外，如果执行的任务很多，我们可能需要将任务进行分类，然后将不同分类的任务放到不同的线程池中执行。</p>
<h3 id="2-线程工厂-threadFactory"><a href="#2-线程工厂-threadFactory" class="headerlink" title="2. 线程工厂-threadFactory"></a>2. 线程工厂 - threadFactory</h3><p><code>ThreadFactory</code> 是一个接口，只有一个方法。既然是线程工厂，那么我们就可以用它生产一个线程对象。来看看这个接口的定义。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ThreadFactory</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new {<span class="doctag">@code</span> Thread}.  Implementations may also initialize</span></span><br><span class="line"><span class="comment">     * priority, name, daemon status, {<span class="doctag">@code</span> ThreadGroup}, etc.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r a runnable to be executed by new thread instance</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> constructed thread, or {<span class="doctag">@code</span> null} if the request to</span></span><br><span class="line"><span class="comment">     *         create a thread is rejected</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>Executors</code> 的实现使用了默认的线程工厂 -<code>DefaultThreadFactory</code>。它的实现主要用于创建一个线程，线程的名字为 <code>pool-{poolNum}-thread-{threadNum}</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">poolNumber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">threadNumber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line"></span><br><span class="line">    DefaultThreadFactory() {</span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">s</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">        group = (s != <span class="literal">null</span>) ? s.getThreadGroup() :</span><br><span class="line">                              Thread.currentThread().getThreadGroup();</span><br><span class="line">        namePrefix = <span class="string">"pool-"</span> +</span><br><span class="line">                      poolNumber.getAndIncrement() +</span><br><span class="line">                     <span class="string">"-thread-"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> {</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(group, r,</span><br><span class="line">                              namePrefix + threadNumber.getAndIncrement(),</span><br><span class="line">                              <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">            t.setDaemon(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</span><br><span class="line">            t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>很多时候，我们需要自定义线程名字。我们只需要自己实现 <code>ThreadFactory</code>，用于创建特定场景的线程即可。</p>
<h3 id="3-拒绝策略-handler"><a href="#3-拒绝策略-handler" class="headerlink" title="3. 拒绝策略-handler"></a>3. 拒绝策略 - handler</h3><p>所谓拒绝策略，就是当线程池满了、队列也满了的时候，我们对任务采取的措施。或者丢弃、或者执行、或者其他…</p>
<p>jdk 自带 4 种拒绝策略，我们来看看。</p>
<ol>
<li><code>CallerRunsPolicy</code> // 在调用者线程执行</li>
<li><code>AbortPolicy</code> // 直接抛出 <code>RejectedExecutionException</code> 异常</li>
<li><code>DiscardPolicy</code> // 任务直接丢弃，不做任何处理</li>
<li><code>DiscardOldestPolicy</code> // 丢弃队列里最旧的那个任务，再尝试执行当前任务</li>
</ol>
<p>这四种策略各有优劣，比较常用的是 <code>DiscardPolicy</code>，但是这种策略有一个弊端就是任务执行的轨迹不会被记录下来。所以，我们往往需要实现自定义的拒绝策略， 通过实现 <code>RejectedExecutionHandler</code> 接口的方式。</p>
<h2 id="提交任务的几种方式"><a href="#提交任务的几种方式" class="headerlink" title="提交任务的几种方式"></a>提交任务的几种方式</h2><p>往线程池中提交任务，主要有两种方法，<code>execute()</code> 和 <code>submit()</code>。</p>
<p><code>execute()</code> 用于提交不需要返回结果的任务，我们看一个例子。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    executor.execute(() -&gt; System.out.println(<span class="string">"hello"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>submit()</code> 用于提交一个需要返回果的任务。该方法返回一个 <code>Future</code> 对象，通过调用这个对象的 <code>get()</code> 方法，我们就能获得返回结果。<code>get()</code> 方法会一直阻塞，直到返回结果返回。另外，我们也可以使用它的重载方法 <code>get(long timeout, TimeUnit unit)</code>，这个方法也会阻塞，但是在超时时间内仍然没有返回结果时，将抛出异常 <code>TimeoutException</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    Future&lt;Long&gt; future = executor.submit(() -&gt; {</span><br><span class="line">        System.out.println(<span class="string">"task is executed"</span>);</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    });</span><br><span class="line">    System.out.println(<span class="string">"task execute time is: "</span> + future.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="关闭线程池"><a href="#关闭线程池" class="headerlink" title="关闭线程池"></a>关闭线程池</h2><p>在线程池使用完成之后，我们需要对线程池中的资源进行释放操作，这就涉及到关闭功能。我们可以调用线程池对象的 <code>shutdown()</code> 和 <code>shutdownNow()</code> 方法来关闭线程池。</p>
<p>这两个方法都是关闭操作，又有什么不同呢？</p>
<ol>
<li><code>shutdown()</code> 会将线程池状态置为 <code>SHUTDOWN</code>，不再接受新的任务，同时会等待线程池中已有的任务执行完成再结束。</li>
<li><code>shutdownNow()</code> 会将线程池状态置为 <code>SHUTDOWN</code>，对所有线程执行 <code>interrupt()</code> 操作，清空队列，并将队列中的任务返回回来。</li>
</ol>
<p>另外，关闭线程池涉及到两个返回 boolean 的方法，<code>isShutdown()</code> 和 <code>isTerminated</code>，分别表示是否关闭和是否终止。</p>
<h2 id="如何正确配置线程池的参数"><a href="#如何正确配置线程池的参数" class="headerlink" title="如何正确配置线程池的参数"></a>如何正确配置线程池的参数</h2><p>前面我们讲到了手动创建线程池涉及到的几个参数，那么我们要如何设置这些参数才算是正确的应用呢？实际上，需要根据任务的特性来分析。</p>
<ol>
<li>任务的性质：CPU 密集型、IO 密集型和混杂型</li>
<li>任务的优先级：高中低</li>
<li>任务执行的时间：长中短</li>
<li>任务的依赖性：是否依赖数据库或者其他系统资源</li>
</ol>
<p>不同的性质的任务，我们采取的配置将有所不同。在《Java 并发编程实践》中有相应的计算公式。</p>
<p>通常来说，如果任务属于 CPU 密集型，那么我们可以将线程池数量设置成 CPU 的个数，以减少线程切换带来的开销。如果任务属于 IO 密集型，我们可以将线程池数量设置得更多一些，比如 CPU 个数 * 2。</p>
<blockquote>
<p>PS：我们可以通过 <code>Runtime.getRuntime().availableProcessors()</code> 来获取 CPU 的个数。</p>
</blockquote>
<h2 id="线程池监控"><a href="#线程池监控" class="headerlink" title="线程池监控"></a>线程池监控</h2><p>如果系统中大量用到了线程池，那么我们有必要对线程池进行监控。利用监控，我们能在问题出现前提前感知到，也可以根据监控信息来定位可能出现的问题。</p>
<p>那么我们可以监控哪些信息？又有哪些方法可用于我们的扩展支持呢？</p>
<p>首先，<code>ThreadPoolExecutor</code> 自带了一些方法。</p>
<ol>
<li><code>long getTaskCount()</code>，获取已经执行或正在执行的任务数</li>
<li><code>long getCompletedTaskCount()</code>，获取已经执行的任务数</li>
<li><code>int getLargestPoolSize()</code>，获取线程池曾经创建过的最大线程数，根据这个参数，我们可以知道线程池是否满过</li>
<li><code>int getPoolSize()</code>，获取线程池线程数</li>
<li><code>int getActiveCount()</code>，获取活跃线程数（正在执行任务的线程数）</li>
</ol>
<p>其次，<code>ThreadPoolExecutor</code> 留给我们自行处理的方法有 3 个，它在 <code>ThreadPoolExecutor</code> 中为空实现（也就是什么都不做）。</p>
<ol>
<li><code>protected void beforeExecute(Thread t, Runnable r)</code> // 任务执行前被调用</li>
<li><code>protected void afterExecute(Runnable r, Throwable t)</code> // 任务执行后被调用</li>
<li><code>protected void terminated()</code> // 线程池结束后被调用</li>
</ol>
<p>针对这 3 个方法，我们写一个例子。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1</span>)) {</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> {</span><br><span class="line">                System.out.println(<span class="string">"beforeExecute is called"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> {</span><br><span class="line">                System.out.println(<span class="string">"afterExecute is called"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">terminated</span><span class="params">()</span> {</span><br><span class="line">                System.out.println(<span class="string">"terminated is called"</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        executor.submit(() -&gt; System.out.println(<span class="string">"this is a task"</span>));</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>输出结果如下：</p>
<div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">beforeExecute <span class="keyword">is</span> called</span><br><span class="line"><span class="keyword">this</span> <span class="keyword">is</span> a task</span><br><span class="line">afterExecute <span class="keyword">is</span> called</span><br><span class="line">terminated <span class="keyword">is</span> called</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="一个特殊的问题"><a href="#一个特殊的问题" class="headerlink" title="一个特殊的问题"></a>一个特殊的问题</h2><p>任何代码在使用的时候都可能遇到问题，线程池也不例外。楼主在现实的系统中就遇到过很奇葩的问题。我们来看一个例子。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">            executor.submit(<span class="keyword">new</span> <span class="title class_">DivTask</span>(<span class="number">100</span>, i));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DivTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">        <span class="type">int</span> a, b;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DivTask</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> {</span><br><span class="line">            <span class="built_in">this</span>.a = a;</span><br><span class="line">            <span class="built_in">this</span>.b = b;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">double</span> <span class="variable">result</span> <span class="operator">=</span> a / b;</span><br><span class="line">            System.out.println(result);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>该代码执行的结果如下。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2020/01/17/lxI2vt.png" alt="lxI2vt.png"></p>
<p>我们循环了 5 次，理论上应该有 5 个结果被输出。可是最终的执行结果却很让人很意外–只有 4 次输出。我们进一步分析发现，当第一次循环，除数为 0 时，理论上应该抛出异常才对，但是这儿却没有，异常被莫名其妙地吞掉了！</p>
<p>这又是为什么呢？</p>
<p>我们进一步看看 <code>submit()</code> 方法，这个方法是一个非阻塞方法，有一个返回对象，返回的是 <code>Future</code> 对象。那么我们就猜测，会不会是因为没有对 <code>Future</code> 对象做处理导致的。</p>
<p>我们将代码微调一下，重新运行，异常信息终于打印出来了。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">    Future future= executor.submit(<span class="keyword">new</span> <span class="title class_">DivTask</span>(<span class="number">100</span>, i));</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        future.get();</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p>PS：在使用 <code>submit()</code> 的时候一定要注意它的返回对象 <code>Future</code>，为了避免任务执行异常被吞掉的问题，我们需要调用 <code>Future.get()</code> 方法。另外，使用 <code>execute()</code> 将不会出现这种问题。</p>
</blockquote>
<h2 id="Java编程规范插件提示手动创建线程池的解决办法"><a href="#Java编程规范插件提示手动创建线程池的解决办法" class="headerlink" title="Java编程规范插件提示手动创建线程池的解决办法"></a>Java 编程规范插件提示手动创建线程池的解决办法</h2><p>由于 IDEA 安装了阿里的 Java 编程规范检查插件，提示让手动创建线程池。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2020/01/16/lxe3FS.png" alt="lxe3FS.png"></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//当使用</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(services.size());</span><br><span class="line"><span class="comment">//创建线程池时，由于IDEA安装了阿里的Java编程规范检查插件，提示让手动创建线程池。</span></span><br><span class="line"><span class="comment">//查看源码得知该函数最终调用的还是ThreadPoolExecutor构造方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure></div>

<p>此上面一句可以改成：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> services.size();</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(size,size,<span class="number">0L</span>,TimeUnit.MILLISECONDS,<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br></pre></td></tr></tbody></table></figure></div>

<p>但是又有提示，建议要为线程池中的线程设置名称（<a href="#%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0">原因在这里</a>）：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2020/01/16/lxexk8.png" alt="lxexk8.png"></p>
<p>最后修改为</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">ThreadFactory</span> <span class="variable">namedThreadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="string">"线程-%d"</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,<span class="number">200</span>,<span class="number">0L</span>,TimeUnit.MILLISECONDS,<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">1024</span>),namedThreadFactory);</span><br><span class="line"></span><br><span class="line"><span class="comment">//一个测试</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++){</span><br><span class="line"> 	ececutor.submit(<span class="keyword">new</span> <span class="title class_">Runable</span>(){</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>{</span><br><span class="line">         System.out.println(Thread.currentThread().getName());</span><br><span class="line">     }</span><br><span class="line">   });</span><br><span class="line">}</span><br><span class="line">executor.shutdown();</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>.ThreadFactoryBuilder</code> 来自  <code>guava</code> 工具包</p>
<p><code>com.google.common.util.concurrent.ThreadFactoryBuilder</code></p>
<!-- https://mvnrepository.com/artifact/com.google.guava/guava -->

<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>27.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="最终示例"><a href="#最终示例" class="headerlink" title="最终示例"></a>最终示例</h2><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.tsvico.music.tool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.ThreadFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建静态单例线程池</span></span><br><span class="line"><span class="comment"> * ThreadPoolExecutor executor = ThreadPool.getInstance().getExecutor();</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 2020-01-24 18:20:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPool</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     创建基本线程池</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolExecutor executor;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ThreadPool</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">ThreadFactory</span> <span class="variable">nameThreadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="string">"线程-%d"</span>).build();</span><br><span class="line"></span><br><span class="line">        executor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,</span><br><span class="line">                <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">50</span>), nameThreadFactory);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadPool <span class="title function_">getInstance</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> ThreadPoolClassInstance.INSTANCE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ThreadPoolExecutor 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">getExecutor</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolClassInstance</span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadPool</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPool</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>测试用例</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> ThreadPool.getInstance().getExecutor();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            executor.submit(() -&gt; {</span><br><span class="line">                System.out.println(<span class="string">"thread id is: "</span> + Thread.currentThread().getId());</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过这篇文章，我们已经对 Java 线程池有了一个比较全面和深入的理解。根据前人的经验，我们需要注意下面几点：</p>
<ol>
<li>尽量使用手动的方式创建线程池，避免使用 <code>Executors</code> 工厂类</li>
<li>根据场景，合理设置线程池的各个参数，包括线程池数量、队列、线程工厂和拒绝策略</li>
<li>在调线程池 <code>submit()</code> 方法的时候，一定要尽量避免任务执行异常被吞掉的问题</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a class="link" href="https://www.jianshu.com/p/0424d339c85c">https://www.jianshu.com/p/0424d339c85c<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="http://www.cnblogs.com/superfj/p/7544971.html">http://www.cnblogs.com/superfj/p/7544971.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://book.douban.com/subject/26591326">书籍 - Java 并发编程的艺术<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://book.douban.com/subject/2148132">书籍 - Java 并发编程实践<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<p> 本文转载自<a class="link" href="https://www.jianshu.com/p/7ab4ae9443b9">简书<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>    <a class="link" href="https://blog.csdn.net/w605283073/article/details/80259493">CSDN<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>NexT 主题中添加网页标题崩溃</title>
    <url>/2018/c2e476fc.html</url>
    <content><![CDATA[<p>给网页添加一些特效</p>
<p>浮动心形和 title 崩溃欺骗</p>
<span id="more"></span>

<p>crash_cheat.js</p>
<p>在 <code>next\source\js\src</code> 文件夹下创建 <code>crash_cheat.js</code>，添加代码：</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">&lt;!--崩溃欺骗--&gt;</span><br><span class="line"> <span class="keyword">var</span> <span class="title class_">OriginTitle</span> = <span class="variable language_">document</span>.<span class="property">title</span>;</span><br><span class="line"> <span class="keyword">var</span> titleTime;</span><br><span class="line"> <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'visibilitychange'</span>, <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">     <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">hidden</span>) {</span><br><span class="line">         $(<span class="string">'[rel="icon"]'</span>).<span class="title function_">attr</span>(<span class="string">'href'</span>, <span class="string">"/img/TEP.ico"</span>);</span><br><span class="line">         <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">'╭(°A°`)╮ 页面崩溃啦 ~'</span>;</span><br><span class="line">         <span class="built_in">clearTimeout</span>(titleTime);</span><br><span class="line">     }</span><br><span class="line">     <span class="keyword">else</span> {</span><br><span class="line">         $(<span class="string">'[rel="icon"]'</span>).<span class="title function_">attr</span>(<span class="string">'href'</span>, <span class="string">"/favicon.ico"</span>);</span><br><span class="line">         <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">'(ฅ&gt;ω&lt;*ฅ) 噫又好了~'</span> + <span class="title class_">OriginTitle</span>;</span><br><span class="line">         titleTime = <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">             <span class="variable language_">document</span>.<span class="property">title</span> = <span class="title class_">OriginTitle</span>;</span><br><span class="line">         }, <span class="number">2000</span>);</span><br><span class="line">     }</span><br><span class="line"> });</span><br></pre></td></tr></tbody></table></figure></div>

<p>你也可以将 js 存储到你的七牛或其他云存储上</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p>在 <code>next\layout\_layout.swig</code> 文件中，添加引用（注：在 swig 末尾添加）：</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">&lt;!--崩溃欺骗--&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/js/src/crash_cheat.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure></div>

<h1 id="添加点击love背景动画"><a href="#添加点击love背景动画" class="headerlink" title="添加点击love背景动画"></a>添加点击 love 背景动画</h1><p><a class="link" href="http://7u2ss1.com1.z0.glb.clouddn.com/love.js">loveJs 文件下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br> 把 js 文件 <code>love.js</code> 放在 <code>\themes\next\source\js\src</code> 文件目录下</p>
<p>在 <code>\themes\next\layout\_layout.swig</code> 文件，在末尾（在前面引用会出现找不到的 bug）添加同上 js 引入代码</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/js/src/love.js"</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>本文系转载，感谢，只负责整合两种特效</p>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP CURL 数据中转</title>
    <url>/2019/53349589.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当你用 <code>ajax</code> 请求其他网站数据爆出跨域错误时，你可能查找过很多方法，jsonp、CORS  等 ，当然这些大多都是你要请求的站点也是你的站点的情况<br>示例：<a class="link" href="https://segmentfault.com/a/1190000012469713">https://segmentfault.com/a/1190000012469713<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>当目标站点所有者并不是你时 你或许会想到反向代理<br>可能做 php 数据中转不如做 nginx 反向代理更节省资源，但是在某些非正常状态下，请求次数过多会被源服务器封掉 IP，emm…  </p>
<span id="more"></span>
<p>贴上反代代码</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">反向代理 模糊匹配</span></span><br><span class="line">      location ^~/v1 {</span><br><span class="line">          #proxy_redirect  off;</span><br><span class="line">          proxy_pass http://api.fastdown666.com;</span><br><span class="line">       proxy_set_header Host $host;</span><br><span class="line">       proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">       proxy_set_header REMOTE-HOST $remote_addr;     </span><br><span class="line">      }</span><br><span class="line">location = /v1/get/device/quota{</span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash"><span class="built_in">return</span> 520;</span></span><br><span class="line"> proxy_pass http://www.xxxxxx.cn/quota.json;</span><br><span class="line">}</span><br><span class="line">      #error_page 520 /quota.json;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">反向代理 精确匹配</span></span><br><span class="line">      location = /index/dispatch.html { </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">proxy_redirect  off;</span></span><br><span class="line">          proxy_pass http://www.xxxxxx.com;</span><br><span class="line">       proxy_set_header Host www.xxxxxx.com; #需要带host</span><br><span class="line">       proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">       proxy_set_header REMOTE-HOST $remote_addr;     </span><br><span class="line">      }</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ul>
<li>收集头部信息</li>
<li>收集请求数据</li>
<li>转换头部信息为 CURL 头部请求格式</li>
<li>使用 Curl 进行转发</li>
</ul>
<h3 id="收集-HTTP-头信息"><a href="#收集-HTTP-头信息" class="headerlink" title="收集 HTTP 头信息"></a>收集 HTTP 头信息</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAllHeaders</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="variable">$headers</span> = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_SERVER</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$value</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="number">0</span>, <span class="number">5</span>) == <span class="string">'HTTP_'</span>) {</span><br><span class="line">            <span class="variable">$headers</span>[<span class="title function_ invoke__">str_replace</span>(<span class="string">' '</span>, <span class="string">'-'</span>, <span class="title function_ invoke__">ucwords</span>(<span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">'_'</span>, <span class="string">' '</span>, <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="number">5</span>)))))] = <span class="variable">$value</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$headers</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="使用-PHP-封装协议获取输入数据"><a href="#使用-PHP-封装协议获取输入数据" class="headerlink" title="使用 PHP 封装协议获取输入数据"></a>使用 PHP 封装协议获取输入数据</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPOST</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>{  </span><br><span class="line"> <span class="variable">$maGetPostData</span> = [];</span><br><span class="line">        <span class="variable">$handle</span> = @<span class="title function_ invoke__">fopen</span>(<span class="string">'php://input'</span>, <span class="string">'r'</span>);  </span><br><span class="line">        <span class="variable">$data</span> = <span class="string">''</span>;  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        {  </span><br><span class="line">            <span class="variable">$data</span> = @<span class="title function_ invoke__">fread</span>(<span class="variable">$handle</span>, <span class="number">1024</span>);  </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>) == <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">else</span>  </span><br><span class="line">                <span class="variable">$maGetPostData</span>[] = <span class="variable">$data</span>;  </span><br><span class="line">        }<span class="keyword">while</span>(<span class="literal">true</span>);  </span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$handle</span>);  </span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$data</span>, <span class="variable">$handle</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$maGetPostData</span>;  </span><br><span class="line">}  </span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">getPOST</span>();</span><br><span class="line"><span class="comment">//$content = file_get_contents('php://input')</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="转换头信息为-Curl-请求格式"><a href="#转换头信息为-Curl-请求格式" class="headerlink" title="转换头信息为 Curl 请求格式"></a>转换头信息为 Curl 请求格式</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable">$headers</span> = <span class="title function_ invoke__">getAllHeaders</span>();</span><br><span class="line"><span class="variable">$header_joins</span> = [];</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$headers</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$k</span> == <span class="string">'X-Pingplusplus-Signature'</span> || <span class="variable">$k</span> == <span class="string">'Content-Type'</span>)</span><br><span class="line">    <span class="title function_ invoke__">array_push</span>(<span class="variable">$header_joins</span>, <span class="variable">$k</span> . <span class="string">': '</span> . <span class="variable">$v</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="使用-Curl-进行转发"><a href="#使用-Curl-进行转发" class="headerlink" title="使用 Curl 进行转发"></a>使用 Curl 进行转发</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$headers</span>, <span class="variable">$raw_data</span></span>) </span>{</span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$raw_data</span>) &gt; <span class="number">0</span>)  </span><br><span class="line"> {   <span class="comment">//存在POST数据需要提交  </span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_CUSTOMREQUEST, <span class="string">"POST"</span>);  <span class="comment">// POST </span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="variable">$raw_data</span>);  <span class="comment">// Post Da</span></span><br><span class="line"> }</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);<span class="comment">//设置要访问的 URL</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_USERAGENT, <span class="variable">$user_agent</span>); <span class="comment">//模拟用户使用的浏览器</span></span><br><span class="line">    @<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">1</span> );  <span class="comment">// 使用自动跳转</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="number">60</span>);  <span class="comment">//设置超时时间</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_AUTOREFERER, <span class="number">1</span> ); <span class="comment">// 自动设置Referer</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); <span class="comment">// 收集结果而非直接展示</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="variable">$headers</span>); <span class="comment">// 自定义 Headers</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// @ini_set('display_errors', 1);</span><br><span class="line"></span><br><span class="line">if (!function_exists('getallheaders')) {</span><br><span class="line"> </span><br><span class="line">    function getallheaders() {</span><br><span class="line">        $headers = array();</span><br><span class="line">        foreach ($_SERVER as $name =&gt; $value) {</span><br><span class="line">            if (substr($name, 0, 5) == 'HTTP_') {</span><br><span class="line">                $headers[str_replace(' ', '-', ucwords(strtolower(str_replace('_', ' ', substr($name, 5)))))] = $value;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return $headers;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function getPOST()  </span><br><span class="line">{  </span><br><span class="line"> $maGetPostData = [];</span><br><span class="line">        $handle = @fopen('php://input', 'r');  </span><br><span class="line">        $data = '';  </span><br><span class="line">        do  </span><br><span class="line">        {  </span><br><span class="line">            $data = @fread($handle, 1024);  </span><br><span class="line">            if (strlen($data) == 0)  </span><br><span class="line">                break;  </span><br><span class="line">            else  </span><br><span class="line">                $maGetPostData[] = $data;  </span><br><span class="line">        }while(true);  </span><br><span class="line">        fclose($handle);  </span><br><span class="line">        unset($data, $handle);  </span><br><span class="line">        return $maGetPostData;  </span><br><span class="line">}  </span><br><span class="line">$content = getPOST();</span><br><span class="line"></span><br><span class="line">$headers = getAllHeaders();</span><br><span class="line">$header_joins = [];</span><br><span class="line">foreach ($headers as $k =&gt; $v) {</span><br><span class="line">    if ($k == 'Cookie' || $k == 'Content-Type')</span><br><span class="line">    array_push($header_joins, $k . ': ' . $v);</span><br><span class="line">}</span><br><span class="line">//自定义头</span><br><span class="line">array_push($header_joins,"Referer :http://www.tooln.cn");</span><br><span class="line">//print_r($headers);</span><br><span class="line">//print_r($header_joins);die();</span><br><span class="line"></span><br><span class="line">function post($url, $headers, $raw_data) {</span><br><span class="line"> $user_agent=$_SERVER['HTTP_USER_AGENT'];</span><br><span class="line">    $ch = curl_init();</span><br><span class="line"> if (count($raw_data) &gt; 0)  </span><br><span class="line"> {   //存在POST数据需要提交  </span><br><span class="line">    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");  // POST </span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $raw_data);  // Post Da</span><br><span class="line"> }</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);//设置要访问的 URL</span><br><span class="line">    curl_setopt($ch, CURLOPT_USERAGENT, $user_agent); //模拟用户使用的浏览器</span><br><span class="line">    @curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1 );  // 使用自动跳转</span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, 60);  //设置超时时间</span><br><span class="line">    curl_setopt($ch, CURLOPT_AUTOREFERER, 1 ); // 自动设置Referer</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); // 收集结果而非直接展示</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers); // 自定义 Headers</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line">    return $result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$result = post('http://www.tooln.cn/', $header_joins, $content);</span><br><span class="line"></span><br><span class="line">echo $result;</span><br></pre></td></tr></tbody></table></figure></div>

<p>代码转载链接：<a class="link" href="https://www.jianshu.com/p/0c8de9dc99ac">https://www.jianshu.com/p/0c8de9dc99ac<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>  </p>
<p>有修改，增加了对 GET 的支持</p>
]]></content>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 对代理池的使用</title>
    <url>/2019/fb19b135.html</url>
    <content><![CDATA[<p>没啥好说的，都在代码里</p>
<span id="more"></span>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//获取新IP,并写入文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ip_file</span>(<span class="params"></span>)</span>{</span><br><span class="line">    <span class="keyword">if</span>((<span class="variable">$fp</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">"ip.txt"</span>,<span class="string">"r"</span>))==<span class="literal">false</span>){   </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"打开ip.txt失败!"</span>;</span><br><span class="line">    }<span class="keyword">else</span>{   </span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">        $counter=fgets($fp,1024);       //读取文件中数据  </span></span><br><span class="line"><span class="comment">        fclose($fp);                    //关闭文本文件  </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">	    <span class="variable">$counter</span> = <span class="title function_ invoke__">get_ip</span>();</span><br><span class="line">        <span class="variable">$fp</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">"ip.txt"</span>,<span class="string">"w"</span>);   <span class="comment">//以写的方式打开文本文件&lt;!----&gt;  </span></span><br><span class="line">        <span class="title function_ invoke__">fputs</span>(<span class="variable">$fp</span>,<span class="variable">$counter</span>);            <span class="comment">//将新的统计数据增加1  </span></span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);      </span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">//读IP</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_ip</span>(<span class="params"></span>)</span>{</span><br><span class="line">	<span class="variable">$fp</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">"ip.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">	<span class="variable">$ip</span>=<span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>,<span class="number">1024</span>);       <span class="comment">//读取文件中数据  </span></span><br><span class="line">	<span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>); </span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$ip</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_ip</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="variable">$url</span> = <span class="string">'https://proxy.357.im/api/proxies/stable?protocol=http&amp;anonymity=high_anonymous'</span>;</span><br><span class="line">	<span class="variable">$curl</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置头信息（当用IP直接访问时，加这个如：https://baibu.com -&gt; 220.15.23.5）</span></span><br><span class="line">	<span class="comment">// curl_setopt($ci, CURLOPT_HTTPHEADER, array('Host:baibu.com'));</span></span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>); <span class="comment">//这个是重点,规避ssl的证书检查。</span></span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_SSL_VERIFYHOST, <span class="literal">FALSE</span>); <span class="comment">// 跳过host验证</span></span><br><span class="line">	<span class="variable">$response</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curl</span>);</span><br><span class="line">	<span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$curl</span>,CURLINFO_HTTP_CODE);</span><br><span class="line">	<span class="title function_ invoke__">curl_close</span>(<span class="variable">$curl</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$httpCode</span>==<span class="number">200</span>){</span><br><span class="line">		<span class="variable">$json</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$response</span>);</span><br><span class="line">		<span class="comment">//$str = $json[]['protocol']."://".$json['ip'].":".$json['port'];</span></span><br><span class="line">		<span class="variable">$json2</span> = <span class="variable">$json</span>-&gt;data;</span><br><span class="line">		<span class="variable">$json3</span> = <span class="title function_ invoke__">json_to_array</span>(<span class="variable">$json2</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="variable">$json3</span>[<span class="string">'protocol'</span>].<span class="string">"://"</span>.<span class="variable">$json3</span>[<span class="string">'ip'</span>].<span class="string">":"</span>.<span class="variable">$json3</span>[<span class="string">'port'</span>];</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">json_to_array</span>(<span class="params"><span class="variable">$web</span></span>)</span>{</span><br><span class="line">    	<span class="variable">$arr</span>	= <span class="keyword">array</span>();</span><br><span class="line">    	<span class="keyword">foreach</span>(<span class="variable">$web</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$w</span>){</span><br><span class="line">    		<span class="keyword">if</span>(<span class="title function_ invoke__">is_object</span>(<span class="variable">$w</span>)) <span class="variable">$arr</span>[<span class="variable">$k</span>]=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">json_to_array</span>(<span class="variable">$w</span>);  <span class="comment">//判断类型是不是object</span></span><br><span class="line">    		<span class="keyword">else</span> <span class="variable">$arr</span>[<span class="variable">$k</span>]=<span class="variable">$w</span>;</span><br><span class="line">    	}</span><br><span class="line">    	<span class="keyword">return</span> <span class="variable">$arr</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">//判断目标服务器是否挂掉</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isType</span>(<span class="params"></span>)</span>{</span><br><span class="line">	<span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(<span class="string">"http://www.xulirun.com"</span>);</span><br><span class="line">	<span class="variable">$proxy</span> = <span class="title function_ invoke__">read_ip</span>();</span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span> (<span class="variable">$ch</span>, CURLOPT_PROXY, <span class="variable">$proxy</span>);</span><br><span class="line">	<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_PROXYTYPE, CURLPROXY_HTTP);</span><br><span class="line">	<span class="variable">$result</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">	<span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$curl</span>,CURLINFO_HTTP_CODE);</span><br><span class="line">	<span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">	<span class="title function_ invoke__">curl_close</span>(<span class="variable">$curl</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$httpCode</span>==<span class="number">200</span>){</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//没挂</span></span><br><span class="line">	}<span class="keyword">else</span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">//挂了</span></span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">}</span><br><span class="line"><span class="title function_ invoke__">ip_file</span>();</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Qt 局域网聊天</title>
    <url>/2019/eba88ba7.html</url>
    <content><![CDATA[<blockquote>
<p>本次设计是一个简易的局域网聊天，功能设计主要分为群聊和私聊两部分，每部分都支持基础聊天以及文件传输功能，私聊页面相较于主页面支持更多功能，例如表情发送、窗口抖动，语音聊天等。参考了《Qt 及 Qt Quick 开发实战精解》中第 5 章群聊实例，在群聊的基础设计了私聊这部分内容以及其他一些功能。下面介绍下整体的设计以及实现。</p>
</blockquote>
<p>本文档将依据启动次序来写</p>
<span id="more"></span>

<ul>
<li>设计时这里用的是主机的 ip 地址，可使用多台主机运行程序进行测试，确保多台主机连接同一局域网，之前调试过程中发现可能会检测到本地多个局域网 IP，所以程序启动之初需要手动选择检测列表中的某个 IP。<br><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729172809754.webp" alt="选择IP"></li>
</ul>
<p>文件的传输、私聊、语音采用的是 TCP、UDP、UDP，其中 UDP 中主要用来保存进行不同操作的消息状态（新用户的加入、消息的发送，传输文件、拒绝接受文件、用户离开、进入私聊阶段），然后通过广播发送给其他的客户端从而保证各个客户端的即时性，各个客户端接受到不同的消息状态进行响应执行操作。程序执行时属于新用户加入阶段， 此时所有用户都处于同一界面，相当于群聊阶段，可发送消息进行群聊。TCP 主要用来传输文件，当接受到由 UPD 发送的传输文件消息时，发送文件一方作为 Server 端，接受文件一方作为 Client 端，实现点到点之间的传输。</p>
<p>1. 用户加入<br>对于新用户的加入我们会显示主机的用户名，每加入一个客户端，在其他客户端以及自己客户端中显示用户名、主机名 (此列存在但被人工隐藏)、IP 地址、并在消息记录框中显示 xxx 在线，此时某一方发送消息在其他客户端即可实时收到消息，实现群聊功能（图一）。当某个客户端关闭或退出程序时，此时在消息框记录框中显示于时间离开，当再有新用户加入时又再次显示 xxx 在线。（本机局域网的 IP 是 172.16.22.48），另一客户端 IP（172.16.22.53）</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729172848526.webp" alt="图一"><br> <img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729172923470.webp" alt="图二"><br><strong>此处的关键是在主界面的构造函数中发送上线广播，关闭时发送离线广播</strong><br>2. 界面介绍</p>
<ul>
<li><p>消息发送框上分别代表字体样式、字体大小、加粗、斜体、下划线、颜色、截图、选择文件；</p>
</li>
<li><p>消息接受框上为语音聊天、视频通话 (未实现)、文件传输、远程桌面。</p>
</li>
<li><p>选择 IP 左侧为切换皮肤，效果如下图</p>
<figure class="half">
  <img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729173110525.webp" width="400">
  <img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729173126754.webp" width="230">
</figure>
</li>
<li><p>截图界面展示<br><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729173149157.webp" alt="在这里插入图片描述"><br>3. 文件的传输</p>
</li>
<li><p>群聊界面:</p>
<ul>
<li>在文件传输前，我们首先选择要发送到的 IP 地址，从右侧的显示主机信息中选择，若未选中，会提示用户未选中并重新选择，在选中接收文件的 IP 后（群聊可以选中自己 IP 进行测试），点击消息输入框上的传输文件按钮，此时进入 Server 文件发送界面。选择发送文件进行发送，此时另一选中的用户弹出 Client 文件接收界面，选择是否接收。</li>
</ul>
</li>
<li><p>私聊<br>私聊界面文件发送直接点击，效果和主界面相同</p>
</li>
</ul>
<p>4. 私人聊天</p>
<ul>
<li>从右侧显示主机信息栏中双击，为了方便测试，此处可以和自己聊天。当双击用户时，此时弹出私人聊天界面，并显示与某某聊天中，获得它的 IP 地址。对方收到消息会在主页面显示 “XXX 正在给您发送私聊消息”<br><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729173211842.webp" alt="私聊"></li>
<li>发送窗口抖动<br>建立窗口抖动标志，在发送消息里，接收端收到消息后窗口在上下左右不同幅度抖动 <div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line">QPropertyAnimation *pAnimation = <span class="keyword">new</span> <span class="built_in">QPropertyAnimation</span>(<span class="keyword">this</span>, <span class="string">"pos"</span>);</span><br><span class="line">pAnimation-&gt;<span class="built_in">setDuration</span>(<span class="number">500</span>);</span><br><span class="line">pAnimation-&gt;<span class="built_in">setLoopCount</span>(<span class="number">2</span>);</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() - <span class="number">3</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() - <span class="number">3</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.1</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() + <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() + <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.2</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() - <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() + <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.3</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() + <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() - <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.4</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() - <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() - <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.5</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() + <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() + <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.6</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() - <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() + <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.7</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() + <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() - <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.8</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() - <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() - <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">0.9</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() + <span class="number">6</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() + <span class="number">6</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">setKeyValueAt</span>(<span class="number">1</span>, <span class="built_in">QPoint</span>(<span class="built_in">geometry</span>().<span class="built_in">x</span>() - <span class="number">3</span>, <span class="built_in">geometry</span>().<span class="built_in">y</span>() - <span class="number">3</span>));</span><br><span class="line">pAnimation-&gt;<span class="built_in">start</span>(QAbstractAnimation::DeleteWhenStopped);</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>语音发送<br>创建语音标志在发送消息里，为了发语音的同时还要能听到，发送时要对语音进行接收。一方取消语音时要发送关闭语音广播，另一方同时关闭语音传输。为了保证接收端和发送端同时关闭，这里重写了关闭事件 <div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">autrans::closeEvent</span><span class="params">(QCloseEvent *e)</span></span>{</span><br><span class="line">    <span class="function">emit <span class="title">meclose</span><span class="params">()</span></span>; <span class="comment">//发送关闭信号</span></span><br><span class="line">    QWidget::<span class="built_in">closeEvent</span>(e);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>表情发送<br>创建新的 tableview 在私聊界面，将表情通过代码加载到 UI 界面 <div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">priroom::addEmotionItem</span><span class="params">(<span class="type">int</span> row,<span class="type">int</span> low,<span class="type">int</span> lo)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    QLabel* label1 = <span class="keyword">new</span> QLabel;</span><br><span class="line">    QString path = <span class="string">":/emoji/%1.gif"</span>;</span><br><span class="line">    QMovie *movie =<span class="keyword">new</span> <span class="built_in">QMovie</span>(path.<span class="built_in">arg</span>(lo<span class="number">+1</span>));</span><br><span class="line">    movie-&gt;<span class="built_in">setScaledSize</span>(<span class="built_in">QSize</span>(<span class="number">25</span>,<span class="number">25</span>));</span><br><span class="line">    label1-&gt;<span class="built_in">setMovie</span>(movie);</span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setCellWidget</span>(row,low,label1);</span><br><span class="line">    movie-&gt;<span class="built_in">start</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/20250729173236074.webp" width="350"></li>
</ul>
<p>获取点击的行列位置，计算出图片路径，将表情发送</p>
<ul>
<li>等等</li>
</ul>
<p>5. 其他细节</p>
<ul>
<li>支持列表改名</li>
</ul>
<p>总结：基本也就这么多，目前没有注册、登录功能，对于数据库的操作，后面打算把这些也添加进去，代码解释大家可以去看《Qt 及 Qt Quick 开发实战精解》这本书，对于私聊这块大家也可以下载下面的源程序链接，添加了很多注释，以及 qDebug 调试。</p>
<p>视频展示 (此处录制较早没有语音聊天，如果无法播放可以点击<a class="link" href="https://streamja.com/AJGR">这里<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>)</p>
<video id="video" controls="" preload="none" poster="https://s2.ax1x.com/2019/06/28/ZKvb60.png">
      <source id="mp4" src="https://streamja.com/AJGR" type="video/mp4">
</video>

<p>主题部分参考</p>
<p><a class="link" href="https://blog.csdn.net/zhangquan2015/article/details/52137892">https://blog.csdn.net/zhangquan2015/article/details/52137892<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://www.cnblogs.com/feiyangqingyun/p/3915657.html">https://www.cnblogs.com/feiyangqingyun/p/3915657.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>应用程序测试链接 (双击.exe 文件):<br><a class="link" href="https://www.lanzous.com/i4unced">https://www.lanzous.com/i4unced<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>源程序代码下载链接：<a class="link" href="https://download.csdn.net/download/tsvico/11286445">https://download.csdn.net/download/tsvico/11286445<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>qt</tag>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>初识 TensorFlow_1</title>
    <url>/2018/cc35f015.html</url>
    <content><![CDATA[<p>记录一个 tensorflow 的 demo，详细记录一下学习过程中的一些术语和步骤</p>
<span id="more"></span>

<p><a href="http://blog.tbox.fun/2018/cc35f015.html#demo">直接跳转到代码</a></p>
<p>本个 demo 的神经元模型</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1bg0kc-uz.webp" alt="image.png"></p>
<h2 id="名词理解"><a href="#名词理解" class="headerlink" title="名词理解"></a>名词理解</h2><h3 id="张量（tensor）"><a href="#张量（tensor）" class="headerlink" title="张量（tensor）"></a>张量（tensor）</h3><p>多维数组（列表） 阶：张量的维数</p>
<table>
<thead>
<tr>
<th>维数</th>
<th>阶</th>
<th>名字</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td> 0-D</td>
<td>0</td>
<td> 标量 scalar</td>
<td>s=1 2 3</td>
</tr>
<tr>
<td>1-D</td>
<td>1</td>
<td> 向量 vector</td>
<td>v=[1,2,3]</td>
</tr>
<tr>
<td>2-D</td>
<td>2</td>
<td> 矩阵 matrix</td>
<td>m=[[1,2,3],[4,5,6]]</td>
</tr>
<tr>
<td>n-D</td>
<td>n</td>
<td> 张量 tensor</td>
<td>t=[[[ …</td>
</tr>
</tbody></table>
<p>ps: 左边方括号有几个，张量就是几阶</p>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>tf.float32 tf.int32 …</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>导入相应模块</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre></td></tr></tbody></table></figure></div>

<p>tf 是 tensorflow 的缩写，约定俗成写成 tf, 可以根据自己口味酌情更改</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">a = tf.constant([<span class="number">1.0</span>,<span class="number">2.0</span>])</span><br><span class="line">b = tf.constant([<span class="number">3.0</span>,<span class="number">4.0</span>])</span><br></pre></td></tr></tbody></table></figure></div>

<p>张量 a、b 的常数定义，下边会详细写</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">print a+b</span><br></pre></td></tr></tbody></table></figure></div>

<p>结果</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://wx1.sinaimg.cn/large/006NPPBTly1fu1ir4lcxqj308e03pq3z.jpg" alt="image"></p>
<h3 id="计算图（Graph）"><a href="#计算图（Graph）" class="headerlink" title="计算图（Graph）"></a>计算图（Graph）</h3><p>搭建神经网络的计算过程，<code>只搭建，不计算</code></p>
<p>下图是神经元（神经网络的基本单元）的基本模型</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://wx1.sinaimg.cn/large/006NPPBTly1fu1itxu6u9j306d04owfe.jpg" alt="image"></p>
<p>数学公式表示为：<code>y=wx=x1*w1+x2*w2</code></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">x = tf.constant([[<span class="number">1.0</span>,<span class="number">2.0</span>]])</span><br><span class="line"><span class="comment">#x一行两列</span></span><br><span class="line">w = tf.constant([[<span class="number">3.0</span>],[<span class="number">4.0</span>]])</span><br><span class="line"><span class="comment">#两行一列</span></span><br><span class="line">y = tf.matmul(x,w)</span><br><span class="line"><span class="comment">#矩阵乘法</span></span><br><span class="line"><span class="built_in">print</span> y</span><br></pre></td></tr></tbody></table></figure></div>

<p>结果 <code>Tensor("MatMul:0", shape=(1, 1), dtype=float32)</code></p>
<p>想得到运算结果，需要用到<code>会话</code></p>
<h3 id="会话（Session）"><a href="#会话（Session）" class="headerlink" title="会话（Session）"></a>会话（Session）</h3><p>执行计算图中的结点运算</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">x = tf.constant([[<span class="number">1.0</span>,<span class="number">2.0</span>]])</span><br><span class="line"><span class="comment">#x一行两列</span></span><br><span class="line">w = tf.constant([[<span class="number">3.0</span>],[<span class="number">4.0</span>]])</span><br><span class="line"><span class="comment">#两行一列</span></span><br><span class="line">y = tf.matmul(x,w)</span><br><span class="line"><span class="comment">#矩阵乘法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    <span class="built_in">print</span> sess.run(y)</span><br></pre></td></tr></tbody></table></figure></div>

<p>结果 <code>[[ 11.]]</code></p>
<p>$$<br>1.3<em>3.0+2.0</em>4.0 = 11.0<br>$$</p>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><p>即<img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1bdkyp-j4.webp" alt="image.png">线上的权重 W，用变量表示，随机给初值</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">w = tf.Variable(tf.random_normal([2,3],stddev=2, mean=0, seed=1))</span><br></pre></td></tr></tbody></table></figure></div>

<p>其中：<code>tf.random_normal()</code>—&gt; 正态分布</p>
<p><code>[2,3]</code>—&gt; 产生 2x3 矩阵</p>
<p><code>stddev=2</code>—&gt; 标准差 2</p>
<p>均值，随机种子</p>
<p>除了 <code>tf.random_normal()</code> 外，还有</p>
<p><code>tf.truncated_normal()</code>—&gt; 去掉过大偏离点的正态分布</p>
<p><code>tf.random_uniform()</code>—&gt; 平均分布</p>
<p><strong>除了生成随机数，还能生成常量</strong></p>
<p>eg</p>
<p><code>tf.zeros</code> 全 0 数组 *tf.zeros ([3,2],int32)* 生成 [[0,0],[0,0],[0,0]]</p>
<p><code>tf.ones</code> 全 1 数组 同上</p>
<p><code>tf.fill</code> 全定值数组 *tf.fill ([3,2],6)* 生成 [[6,6],[6,6],[6,6]]</p>
<p><code>tf.constant</code> 直接给值 <em>tf.constant([3,2,1])</em>—&gt;[3,2,1]</p>
<h2 id="神经网络实现过程"><a href="#神经网络实现过程" class="headerlink" title="神经网络实现过程"></a>神经网络实现过程</h2><ol>
<li><p>准备数据集，提取特征，作为输入喂给神经网络</p>
</li>
<li><p>搭建 NN 结构，从输入到输出（先搭建计算图，再用会话执行）</p>
</li>
</ol>
<blockquote>
<p>NN 前向传播算法 —&gt; 计算输出</p>
</blockquote>
<ol start="3">
<li>大量特征数据喂给 NN，迭代优化 NN 参数</li>
</ol>
<blockquote>
<p>NN 反向传播算法 —&gt; 优化参数训练模型</p>
</blockquote>
<ol start="4">
<li>使用训练好的模型预测和分类</li>
</ol>
<p>训练过程 1,2,3 的迭代</p>
<p>使用过程 4</p>
<h2 id="前向传播"><a href="#前向传播" class="headerlink" title="前向传播"></a>前向传播</h2><p>使模型有推理能力</p>
<p>eg. 生产一批零件将体积 x, 和重量 x 为特征输入 NN, 通过 NN<br>后输出一个数值。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1bayf4-k7.webp" alt="image.png"></p>
<p>—&gt;</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">a = tf.matmul(X,W1)</span><br><span class="line">y = tf.matmul(a,W2)</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="变量初始化"><a href="#变量初始化" class="headerlink" title="变量初始化"></a>变量初始化</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sees.run(init)</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="计算图结点运算"><a href="#计算图结点运算" class="headerlink" title="计算图结点运算"></a>计算图结点运算</h3><p>sess.run(y)</p>
<p>用 <code>tf.placeholder</code> 占位，在 <code>sess.run</code> 中用 feed_dict 喂数据</p>
<p>占位的意思就是画图的过程中先占一个位置，不存入数据</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">x = tf.placeholder(tf.float32,shape=(<span class="literal">None</span>,<span class="number">2</span>))</span><br></pre></td></tr></tbody></table></figure></div>

<p>shape = 中参数意思：None 为未指定多少组数据，2 是指数据有重量和体积两个参数</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sees.run(y, feed_dict={x: [[0.7,0.5],[0.2,0.3],[0.3,0.4],[0.4,0.5]]})</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="反向传播"><a href="#反向传播" class="headerlink" title="反向传播"></a>反向传播</h2><p>目的：训练模型参数，在所有参数上用梯度下降，使 NN 模型在训练数据上的损失函数最小</p>
<h3 id="损失函数（loss）"><a href="#损失函数（loss）" class="headerlink" title="损失函数（loss）"></a>损失函数（loss）</h3><p>预测值 (y) 与已知答案 (y_) 的差距</p>
<h3 id="均方误差"><a href="#均方误差" class="headerlink" title="均方误差"></a>均方误差</h3><p>loss = tf.reduce<em>mean(tf.square(y</em>-y))</p>
<h3 id="反向传播训练方法"><a href="#反向传播训练方法" class="headerlink" title="反向传播训练方法"></a>反向传播训练方法</h3><p>以减小 loss 为优化目标</p>
<p>三种优化器</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">train_step= tf.train. GradientDescentOptimizer(learning_rate).minimize (loss)</span><br><span class="line"></span><br><span class="line">train_step= tf.train.MomentumOptimizer(learning_rate, momentum).minimize(loss)</span><br><span class="line"></span><br><span class="line">train_step =tf.train.AdamOptimizer(learning_rate).minimize(loss)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="学习率"><a href="#学习率" class="headerlink" title="学习率"></a>学习率</h3><p>以上三种优化器都有一个学习率的参数，学习率决定参数每次更新的幅度</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>本个代码的神经元模型</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1b7zw0-vx.webp" alt="image.png"></p>
<p>加深学习的印象</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>防止中文输出报错，加入格式</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></tbody></table></figure></div>

<p>导入 TensorFlow 模块和 numpy 模块（Python 的科学计算模块）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">BATCH_SIZE = <span class="number">8</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>一次传入神经网络 8 组数据，宏定义</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">seed = <span class="number">23455</span></span><br><span class="line"><span class="comment">##基于seed产生数据集</span></span><br><span class="line">rng = np.random.RandomState(seed)</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>nump.random.RandomState (0) 为随机数产生器的种子，里面的数字相同，则产生的随机数相同</strong>，对于某一个伪随机数发生器，只要该种子（seed）相同，产生的随机数序列就是相同的，此处的 23455 不具有特殊含义</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#随机数返回32行2列的矩阵 表示32组 体积和重量 作为输入数据集</span></span><br><span class="line">X = rng.rand(<span class="number">32</span>,<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>32 组，每组两个特征</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#从x这个32行2列的矩阵中取出一行，判断如果和小于1，给y赋值1，不小于赋值0  零件1合格</span></span><br><span class="line">Y = [[<span class="built_in">int</span>(x0 + x1 &lt;<span class="number">1</span>)] <span class="keyword">for</span> (x0,x1) <span class="keyword">in</span> X]</span><br></pre></td></tr></tbody></table></figure></div>

<p>用 Y 生成序列集对应的标签，人为的给出一个零件 体积 + 重量 合格为小于 1，不合格为 0。因为这个例子没有实际的数据集，是虚拟的零件样本（X）和标签（Y）</p>
<h3 id="定义神经网络的输入、参数和输出，定义前向传播过程"><a href="#定义神经网络的输入、参数和输出，定义前向传播过程" class="headerlink" title="定义神经网络的输入、参数和输出，定义前向传播过程"></a>定义神经网络的输入、参数和输出，定义前向传播过程</h3><p>占位</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">x = tf.placeholder(tf.float32,shape=(<span class="literal">None</span>,<span class="number">2</span>))</span><br></pre></td></tr></tbody></table></figure></div>

<p>输入的特征，32 位浮点型，两个特征，没定义多少组</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">y_= tf.placeholder(tf.float32,shape=(<span class="literal">None</span>,<span class="number">1</span>)) <span class="comment">#标准答案占位</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>下边是参数</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">w1= tf.Variable(tf.random_normal([<span class="number">2</span>,<span class="number">3</span>]))</span><br><span class="line">w2= tf.Variable(tf.random_normal([<span class="number">3</span>,<span class="number">1</span>]))</span><br></pre></td></tr></tbody></table></figure></div>

<p>要匹配输入和输出，输入是两个特征，输出是一个数。w1 两行，对应 x，w2 一列对应 y</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">a = tf.matmul(x,w1)</span><br><span class="line">y = tf.matmul(a,w2)</span><br></pre></td></tr></tbody></table></figure></div>

<p>前向传播计算描述，用矩阵乘法实现</p>
<h3 id="定义损失函数及反向传播方法"><a href="#定义损失函数及反向传播方法" class="headerlink" title="定义损失函数及反向传播方法"></a>定义损失函数及反向传播方法</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">loss = tf.reduce_mean(tf.square(y-y_))</span><br><span class="line">train_step = tf.train.GradientDescentOptimizer(<span class="number">0.1</span>).minimize(loss)</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="生成会话"><a href="#生成会话" class="headerlink" title="生成会话"></a>生成会话</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess.run(init)</span><br><span class="line">    <span class="comment">#输出未训练前的参数</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">"w1:\n"</span>,sess.run(w1)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">"w2:\n"</span>,sess.run(w2)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#训练模型</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3000</span>):</span><br><span class="line">        start = (i*BATCH_SIZE) % <span class="number">32</span></span><br><span class="line">        end = start + BATCH_SIZE</span><br><span class="line">        sess.run(train_step,feed_dict={x:X[start:end],y_:Y[start:end]})</span><br><span class="line">        <span class="keyword">if</span> i%<span class="number">500</span> == <span class="number">0</span>:</span><br><span class="line">            total_loss = sess.run(loss,feed_dict={x:X,y_:Y})</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"第%d次训练的值为%g"</span>%(i,total_loss)</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">"\n"</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">"w1:\n"</span>,sess.run(w1)</span><br><span class="line"><span class="built_in">print</span> <span class="string">"w2:\n"</span>,sess.run(w2)</span><br></pre></td></tr></tbody></table></figure></div>

<p>最后输出优化后的 w1，w2</p>
<p>运行结果</p>
<p>x:<br>[[0.83494319  0.11482951]<br> [ 0.66899751  0.46594987]<br> [ 0.60181666  0.58838408]<br> [ 0.31836656  0.20502072]<br> [ 0.87043944  0.02679395]<br> [ 0.41539811  0.43938369]<br> [ 0.68635684  0.24833404]<br> [ 0.97315228  0.68541849]<br> [ 0.03081617  0.89479913]<br> [ 0.24665715  0.28584862]<br> [ 0.31375667  0.47718349]<br> [ 0.56689254  0.77079148]<br> [ 0.7321604   0.35828963]<br> [ 0.15724842  0.94294584]<br> [ 0.34933722  0.84634483]<br> [ 0.50304053  0.81299619]<br> [ 0.23869886  0.9895604 ]<br> [ 0.4636501   0.32531094]<br> [ 0.36510487  0.97365522]<br> [ 0.73350238  0.83833013]<br> [ 0.61810158  0.12580353]<br> [ 0.59274817  0.18779828]<br> [ 0.87150299  0.34679501]<br> [ 0.25883219  0.50002932]<br> [ 0.75690948  0.83429824]<br> [ 0.29316649  0.05646578]<br> [ 0.10409134  0.88235166]<br> [ 0.06727785  0.57784761]<br> [ 0.38492705  0.48384792]<br> [ 0.69234428  0.19687348]<br> [ 0.42783492  0.73416985]<br> [ 0.09696069  0.04883936]]<br>y:<br>[[1], [0], [0], [1], [1], [1], [1], [0], [1], [1], [1], [0], [0], [0], [0], [0], [0], [1], [0], [0], [1], [1], [0], [1], [0], [1], [1], [1], [1], [1], [0], [1]]</p>
<p>第 0 次训练的值为 0.646454<br>第 500 次训练的值为 0.383877<br>第 1000 次训练的值为 0.383805<br>第 1500 次训练的值为 0.38375<br>第 2000 次训练的值为 0.38371<br>第 2500 次训练的值为 0.383681</p>
<p>w1:<br>[[-0.54031479  0.58477235  0.78871536]<br> [ 0.35046345 -0.73379153  0.00478574]]<br>w2:<br>[[-0.83987921]<br> [-0.57386231]<br> [ 0.74306184]]</p>
]]></content>
      <tags>
        <tag>tensorflow</tag>
      </tags>
  </entry>
  <entry>
    <title>Traefik 入门及全自动 HTTPS</title>
    <url>/2025/3450057868.html</url>
    <content><![CDATA[<p><code>Traefik</code> 是一个云原生的新型 HTTP 反向代理、负载均衡软件。作用类似于 <code>nginx</code>，在全 <code>docker</code> 环境中，<code>Traefik</code> 会比 <code>nginx</code> 配置简略很多。我使用过 <code>nginx</code> 反代 <code>docker</code> 同网络（networks）下的其他服务，统一出口，使用泛域名解析，但是当 <code>docker</code> 数量变多时，每新增一个 <code>docker</code> 都要手动复制一份文件，尝试向 <code>Traefik</code> 迁移</p>
<span id="more"></span>

<p>本文借鉴<a class="link" href="https://doc.traefik.io/traefik/">官方文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>、<a class="link" href="https://github.com/traefik/traefik/blob/master/traefik.sample.yml">traefik 仓库示例<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>、<a class="link" href="https://linux.do/t/topic/202898">Traefik 全自动 HTTPS 方案 <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>本文以反代 <code>alist</code> 举例，在以往 <code>nginx</code> 环境中通常需要在 <code>nginx.conf</code> 中为每个服务创建配置文件</p>
<h2 id="nginx-举例"><a href="#nginx-举例" class="headerlink" title="nginx 举例"></a>nginx 举例</h2><p>创建 <code>nginx.conf</code>，并映射到 <code>/etc/nginx/nginx.conf</code><br>nginx 的 docker-compose.yml 如下</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment">#服务根节点</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="comment">#jenkins服务/其他服务（web服务/nginx服务等）</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25.3</span> <span class="comment">#nginx镜像</span></span><br><span class="line">    <span class="comment">#image: jungsoft/alpine-nginx-forward-proxy:1.25.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span> <span class="comment">#容器的名称</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span> <span class="comment">#跟随docker的启动而启动</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment">#挂载卷命令</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/conf/nginx.conf:/etc/nginx/nginx.conf</span> <span class="comment">#映射配置文件入口文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/html:/usr/share/nginx/html</span> <span class="comment">#静态资源根目录挂载</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/logs:/var/log/nginx</span> <span class="comment">#日志文件挂载</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/conf.d:/etc/nginx/conf.d</span> <span class="comment">#映射配置文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/ssl:/etc/nginx/ssl</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">../php/data:/var/www/html</span> <span class="comment"># php映射路径</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PUID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PGID=1000</span></span><br><span class="line">    <span class="attr">mem_limit:</span> <span class="string">400m</span></span><br><span class="line">    <span class="attr">memswap_limit:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span> <span class="comment">#宿主主机端口80 映射到 容器端口80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my_net</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><code>nginx.conf</code> 内容为</p>
<div class="code-container" data-rel="Nginx"><figure class="iseeu highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">user</span>  nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  auto;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/<span class="literal">error</span>.log <span class="literal">notice</span>;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> {</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> {</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>; <span class="comment">#添加，关闭版本号</span></span><br><span class="line">    <span class="comment">#fastcgi_intercept_errors on;</span></span><br><span class="line">    <span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /tmp/cache keys_zone=mycache:<span class="number">10m</span> levels=<span class="number">1</span>:<span class="number">2</span> inactive=<span class="number">60s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">gzip</span>  <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>注意上面引入了 <code>/etc/nginx/conf.d/*.conf;</code> /etc/nginx/conf.d 目录下的所有 .conf 文件</p>
<p>在 <code>/data/conf.d</code> 中创建 <code>alist.conf</code></p>
<div class="code-container" data-rel="Nginx"><figure class="iseeu highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">http2</span>  <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">server_name</span> alist.xx.cn;<span class="comment"># 服务器地址或绑定域名</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#HTTP_TO_HTTPS_START</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$server_port</span> !<span class="regexp">~ 443)</span> {</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(/.*)$</span> https://<span class="variable">$host</span><span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">#HTTP_TO_HTTPS_END</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/ssl/<span class="literal">error</span>.conf;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/ssl/ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / {</span><br><span class="line">        <span class="attribute">resolver</span> <span class="number">127.0.0.11</span> valid=<span class="number">30s</span> ipv6=<span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">resolver_timeout</span> <span class="number">2s</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$upstream_host</span> http://alist:5244;</span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$upstream_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Range <span class="variable">$http_range</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> If-Range <span class="variable">$http_if_range</span>;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="comment"># the max size of file to upload</span></span><br><span class="line">        <span class="attribute">client_max_body_size</span> <span class="number">20000m</span>;</span><br><span class="line">        <span class="attribute">client_body_buffer_size</span> <span class="number">128k</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>写入如上内容，这样就将 <code>alist.xx.cn</code> 的请求全部转发到 <code>http://alist:5244</code> 中（alist 为 docker-compose.yml 配置中的服务名，docker 会自动添加 host 映射）,alist 的 <code>docker-compose.yml</code> 示例</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">alist:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>这种写法虽然简单清晰，但是需要为每种 docker 都创建一份 <code>conf</code> 配置，而 <code>traefik</code> 可以简化这点，通过简单的配置即可自动查找</p>
<h2 id="Traefik-介绍及举例"><a href="#Traefik-介绍及举例" class="headerlink" title="Traefik 介绍及举例"></a>Traefik 介绍及举例</h2><p>Traefik 启动时会读取配置文件和 Docker Compose 配置中的各个服务。请求进入时候，将会按这样一个顺序解析:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">-&gt; Entrypoint (入口, 80/443)</span><br><span class="line">-&gt; Router (规则, 例如子域名为 www)</span><br><span class="line">-&gt; Service (服务)</span><br><span class="line">-&gt; LoadBalancer (源地址, 这里可以设定用 Docker 容器内的哪个端口)</span><br></pre></td></tr></tbody></table></figure></div>

<p>同时，启动时会根据你设定的域名，向 Let’s Encrypt 申请泛域名 ACME 证书，用于 HTTPS.</p>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>首先当然需要 Docker 和 Docker Compose (<a class="link" href="https://docs.docker.com/compose/install/">Tutorial<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>).</p>
<p>然后，新建一个文件夹，新建一个 docker-compose.yml（我这里多写了 alist 的 docker 配置）:</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">traefik:</span></span><br><span class="line">    <span class="comment"># The official v3 Traefik docker image</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">traefik:v3.3</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--providers.docker</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># The HTTP port</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"80:80"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"443:443"</span></span><br><span class="line">      <span class="comment"># - "8080:8080"</span></span><br><span class="line">    <span class="attr">security_opt:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="literal">no</span><span class="string">-new-privileges:true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./traefik/static.yml:/traefik.yml:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./traefik/acme.json:/acme.json:rw</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./traefik/traefik.log:/var/log/traefik.log:rw</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_API_EMAIL=</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_API_KEY=</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_DNS_API_TOKEN=</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"traefik.enable=true"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"traefik.http.routers.dashboard.rule=Host(`dash.example.com`)"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"traefik.http.routers.dashboard.service=api@internal"</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">alist:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"./alist:/opt/alist/data"</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">alist</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PUID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PGID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UMASK=022</span></span><br><span class="line">    <span class="attr">mem_limit:</span> <span class="string">300m</span></span><br><span class="line">    <span class="attr">memswap_limit:</span> <span class="string">400m</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"xhofe/alist:latest"</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik.enable=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik.http.routers.alist.rule=Host(`alist.example.com`)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik.http.services.alist.loadbalancer.server.port=5244</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">bridge</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>然后创建一个文件夹 <code>traefik</code> 存配置和日志</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> traefik</span><br><span class="line"><span class="built_in">touch</span> traefik/{static.yml, dynamic.yml, acme.json, traefik.log}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这几个文件分别的作用及内容:</p>
<ul>
<li><code>traefik/static.yml</code>: 静态配置，改了需要重启 Traefik.</li>
<li><code>traefik/dynamic.yml</code>: 动态配置，改了不需要重启 Traefik.</li>
<li><code>traefik/acme.json</code>: 申请 HTTPS 时自动存储的密钥.</li>
<li><code>traefik/traefik.log</code>: 日志文件.</li>
</ul>
<h4 id="第一个文件-traefik-static-yml-请将-example-com-替换为你的域名"><a href="#第一个文件-traefik-static-yml-请将-example-com-替换为你的域名" class="headerlink" title="第一个文件 traefik/static.yml (请将 example.com 替换为你的域名):"></a>第一个文件 <code>traefik/static.yml</code> (请将 example.com 替换为你的域名):</h4><div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">checkNewVersion:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sendAnonymousUsage:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># EntryPoints configuration</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EntryPoints definition</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">entryPoints:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">:80</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">websecure:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">:443</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="comment"># 通过 路由部分的host自动生成证书(Let's Encrypt)</span></span><br><span class="line">        <span class="attr">certResolver:</span> <span class="string">le-dns</span></span><br><span class="line">        <span class="attr">domains:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">main:</span> <span class="string">"example.com"</span></span><br><span class="line">            <span class="attr">sans:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">"*.example.com"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">certificatesResolvers:</span></span><br><span class="line">  <span class="attr">le-dns:</span></span><br><span class="line">    <span class="attr">acme:</span></span><br><span class="line">      <span class="attr">email:</span> <span class="string">xxx@gmail.com</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">"/acme.json"</span></span><br><span class="line">      <span class="attr">dnsChallenge:</span></span><br><span class="line">        <span class="attr">provider:</span> <span class="string">cloudflare</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Traefik logs configuration</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Traefik logs</span></span><br><span class="line"><span class="comment"># Enabled by default and log to stdout</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="comment"># Log level</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Optional</span></span><br><span class="line">  <span class="comment"># Default: "ERROR"</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Sets the filepath for the traefik log. If not specified, stdout will be used.</span></span><br><span class="line">  <span class="comment"># Intermediate directories are created if necessary.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Optional</span></span><br><span class="line">  <span class="comment"># Default: os.Stdout</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="attr">filePath:</span> <span class="string">/var/log/traefik.log</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Format is either "json" or "common".</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Optional</span></span><br><span class="line">  <span class="comment"># Default: "common"</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"><span class="comment">#  format: json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Access logs configuration</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable access logs</span></span><br><span class="line"><span class="comment"># By default it will write to stdout and produce logs in the textual</span></span><br><span class="line"><span class="comment"># Common Log Format (CLF), extended with additional fields.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#accessLog:</span></span><br><span class="line"><span class="comment"># Sets the file path for the access log. If not specified, stdout will be used.</span></span><br><span class="line"><span class="comment"># Intermediate directories are created if necessary.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment"># Default: os.Stdout</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  filePath: /path/to/log/log.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Format is either "json" or "common".</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment"># Default: "common"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  format: json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># API and dashboard configuration</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable API and dashboard</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">dashboard:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Ping configuration</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable ping</span></span><br><span class="line"><span class="comment">#ping:</span></span><br><span class="line"><span class="comment"># Name of the related entry point</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Optional</span></span><br><span class="line"><span class="comment"># Default: "traefik"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  entryPoint: traefik</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Docker configuration backend</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="attr">providers:</span></span><br><span class="line">  <span class="attr">docker:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">"unix:///var/run/docker.sock"</span></span><br><span class="line">    <span class="attr">exposedByDefault:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">web</span></span><br><span class="line">    <span class="comment"># 当启用 traefik 时, 默认使用 docker-compose 中的服务名作为子域名</span></span><br><span class="line">    <span class="attr">defaultRule:</span> <span class="string">Host(`{{if</span> <span class="string">index</span> <span class="string">.Labels</span> <span class="string">"com.docker.compose.service"</span> <span class="string">}}{{</span> <span class="string">index</span> <span class="string">.Labels</span> <span class="string">"com.docker.compose.service"</span> <span class="string">}}.example.com{{else}}{{</span> <span class="string">trimPrefix</span> <span class="string">`/`</span> <span class="string">.Name</span> <span class="string">}}.example.com{{end}}`)</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">filename:</span> <span class="string">"/etc/traefik/dynamic.yml"</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>这里需要解释一下:</p>
<ul>
<li><code>defaultRule</code> 这一行，表示当启用 traefik 时，默认使用 docker-compose 中的服务名作为子域名.</li>
<li><code>provider</code> 这一行，如果不使用 cloudflare 作为 DNS 服务商，可以自行根据 <a class="link" href="https://doc.traefik.io/traefik/https/acme/#providers">WIKI<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>修改.</li>
</ul>
<h4 id="第二个文件-traefik-dynamic-yml"><a href="#第二个文件-traefik-dynamic-yml" class="headerlink" title="第二个文件 traefik/dynamic.yml:"></a>第二个文件 traefik/dynamic.yml:</h4><div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">routers:</span></span><br><span class="line">    <span class="comment"># 在 web 入口 (80端口, 也就是 HTTP) 请求任何子域名时, 使用 to-https 中间件 (也就是重定向到 https). 该条目优先级为 500, 也就是我们如果设定某个服务优先级为 500 以上, 就可以不自动跳转 HTTPS.</span></span><br><span class="line">    <span class="attr">all-https:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">"HostRegexp(`{host:.+}`)"</span></span><br><span class="line">      <span class="attr">entryPoints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">tls:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">to-https</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">gzip-compress</span></span><br><span class="line">      <span class="attr">priority:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">noop@internal</span></span><br><span class="line">  <span class="attr">middlewares:</span></span><br><span class="line">    <span class="attr">to-https:</span></span><br><span class="line">      <span class="attr">redirectScheme:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">gzip-compress:</span></span><br><span class="line">      <span class="attr">compress:</span></span><br><span class="line">        <span class="attr">defaultEncoding:</span> <span class="string">gzip</span></span><br><span class="line">        <span class="attr">excludedContentTypes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">text/event-stream</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>解释：</p>
<ul>
<li><code>all-https</code> 这一行，表示在 <code>web</code> 入口 (80 端口，也就是 HTTP) 请求任何子域名时，使用 <code>to-https</code> 中间件 (也就是重定向到 <code>https</code>). 该条目优先级为 500, 也就是我们如果设定某个服务优先级为 500 以上，就可以不自动跳转 HTTPS.</li>
<li><code>gzip-compress</code> 这一行代表开启 gzip 压缩</li>
</ul>
<h4 id="最后调整环境变量："><a href="#最后调整环境变量：" class="headerlink" title="最后调整环境变量："></a>最后调整环境变量：</h4><div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CF_API_EMAIL=</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CF_API_KEY=</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CF_DNS_API_TOKEN=</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>这个主要是用于启用 HTTPS 时，需要通过 <code>Let’s Encrypt</code> 的所有权认证，<code>Traefik</code> 会自动新建一个临时的 DNS 解析记录用于认证。怎么获得？</p>
<p>进入 <code>Cloudflare</code> 控制台，进入 我的个人资料 中的 API 令牌，创建一个 Token, 需要在 <code>所有区域</code> 具有 <code>区域读取</code> , <code>DNS 编辑</code> 权限，完成后复制 <code>Token</code> 填入.<br><a href="https://imgse.com/i/pECcKjU"><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2025/01/09/pECcKjU.png" alt="pECcKjU.png"></a><br><a href="https://imgse.com/i/pECcUgK"><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2025/01/09/pECcUgK.png" alt="pECcUgK.png"></a></p>
<p>然后，创建一个 <code>Cloudflare</code> 的泛解析记录到服务器:</p>
<p><a href="https://imgse.com/i/pECcsUA"><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2025/01/09/pECcsUA.png" alt="pECcsUA.png"></a></p>
<p>然后运行</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">docker compose up -d --force-recreate --build</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 安装 opencv3.2+contrib_modules</title>
    <url>/2018/c592fb4d.html</url>
    <content><![CDATA[<p>我之前安装了.opencv2.4 版本，再安装这个也是很费波折，这里说一下共存安装碰到的几个问题</p>
<p>1. 编译安装的目录不能相同，我一个是 /usr/local  一个是 /usr/local/opencv3</p>
<p>2. 网络要好，github 不能被墙，因为安装过程要下载东西</p>
<span id="more"></span>

<ol start="3">
<li>opencv_contrib 要和 opencv 版本号相同，不然会出很多错，这里我用的是 opencv_contrib3.2</li>
</ol>
<p>以下为<a class="link" href="https://blog.csdn.net/nbadwde/article/details/72898396">转载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>–原文地址</p>
<p>opencv3.X 版本的编译和之前有些区别，它将一些不稳定或者说在开发中的模块都放到 contrib modules 里面了，用户视自己的需求去编译．这篇文章记录了 Ubuntu14.04 + opencv3.2.0 + contrib modules 的配置方法，供自己记录和大家参考一下．谢谢</p>
<p>１　opencv 依赖项安装</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install build-essential</span><br><span class="line">sudo apt-get install cmake git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev</span><br><span class="line">sudo apt-get install python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev</span><br></pre></td></tr></tbody></table></figure></div>

<p>这些依赖项有些机器上可能已经装好了，但是以防万一，可以再做一遍．</p>
<p>２　opencv 源码下载</p>
<p>　源码的下载有两种方式：去官网下载压缩包再解压，或者直接 git 拉取源码</p>
<p>3 　编译以及安装</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mkdir ~/opencv320</span><br><span class="line">cd ~/opencv320</span><br></pre></td></tr></tbody></table></figure></div>

<p>第２步里面下载的应该是两个包：opencv-master 和 opencv_contrib-master,</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">将contrib模块拷贝到opencv-master文件夹下</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cp -r opencv_contrib-master opencv-master</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cd opencv-master</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mkdir build</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cd build</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">开始cmake</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr/local/opencv3 -D OPENCV_EXTRA_MODULES_PATH=../opencv_contrib-master/modules/ ..</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">cmake完成之后（确认complete，没有error）</span><br><span class="line">make -j4 #j4为四线程</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">完成安装</span><br></pre></td></tr></tbody></table></figure></div>

<p>4　测试安装结</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">１) 创建工作目录</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mkdir ~/opencv-lena</span><br><span class="line">cd ~/opencv-lena</span><br><span class="line">gedit DisplayImage.cpp</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">编写如下代码</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">if</span> ( argc != <span class="number">2</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"usage: DisplayImage.out &lt;Image_Path&gt;\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  Mat image;</span><br><span class="line">  image = <span class="built_in">imread</span>( argv[<span class="number">1</span>], <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">if</span> ( !image.data )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"No image data \n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">namedWindow</span>(<span class="string">"Display Image"</span>, WINDOW_AUTOSIZE );</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">"Display Image"</span>, image);</span><br><span class="line">  <span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">３)　创建CMake编译文件 </span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">gedit CMakeLists.txt</span><br></pre></td></tr></tbody></table></figure></div>

<p>写入如下内容</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project( DisplayImage )</span><br><span class="line">find_package( OpenCV REQUIRED )</span><br><span class="line">add_executable( DisplayImage DisplayImage.cpp )</span><br><span class="line">target_link_libraries( DisplayImage ${OpenCV_LIBS} )</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">４) 编译</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cd ~/opencv-lena</span><br><span class="line">cmake .</span><br><span class="line">make</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">５)　执行</span><br></pre></td></tr></tbody></table></figure></div>

<p>此时 opencv-lena 文件夹中已经产生了可执行文件 DisplayImage，下载 lena.jpg 放在 opencv-lena 下，运行</p>
<p>./DispalyImage lena.jpg</p>
<p>此时应该会显示一张图片</p>
<p>至此，安装配置完成．</p>
]]></content>
      <tags>
        <tag>opencv</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>WebView 与 JavaScript 交互</title>
    <url>/2018/ce16bff8.html</url>
    <content><![CDATA[<p>写 Android 通过 webView 与 js 交互</p>
<p>转载自 <a class="link" href="https://www.jianshu.com/p/345f4d8a5cfa">https://www.jianshu.com/p/345f4d8a5cfa<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<span id="more"></span>

<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting006NPPBTly1fw87k7uuurj31a60e2tb7.jpg" alt="image"></p>
<h2 id="1-交互方式总结"><a href="#1-交互方式总结" class="headerlink" title="1.交互方式总结"></a>1. 交互方式总结</h2><p>Android 与 JS 通过 WebView 互相调用方法，实际上是：</p>
<ul>
<li>Android 去调用 JS 的代码</li>
<li> JS 去调用 Android 的代码</li>
</ul>
<blockquote>
<p>二者沟通的桥梁是 WebView</p>
</blockquote>
<p><strong>对于 Android 调用 JS 代码的方法有 2 种：</strong></p>
<ol>
<li>通过 <code>WebView</code> 的 <code>loadUrl（）</code></li>
<li>通过 <code>WebView</code> 的 <code>evaluateJavascript（）</code></li>
</ol>
<p><strong>对于 JS 调用 Android 代码的方法有 3 种：</strong></p>
<ol>
<li>通过 <code>WebView</code> 的 <code>addJavascriptInterface（）</code>进行对象映射</li>
<li>通过 <code>WebViewClient</code> 的 <code>shouldOverrideUrlLoading ()</code> 方法回调拦截 url</li>
<li> 通过 <code>WebChromeClient</code> 的 <code>onJsAlert()</code>、<code>onJsConfirm()</code>、<code>onJsPrompt（）</code>方法回调拦截 JS 对话框 <code>alert()</code>、<code>confirm()</code>、<code>prompt（）</code> 消息</li>
</ol>
<h2 id="2-具体分析"><a href="#2-具体分析" class="headerlink" title="2.具体分析"></a>2. 具体分析</h2><h3 id="2-1-Android-通过-WebView-调用-JS"><a href="#2-1-Android-通过-WebView-调用-JS" class="headerlink" title="2.1 Android 通过 WebView 调用 JS"></a>2.1 Android 通过 WebView 调用 JS</h3><p>对于 Android 调用 JS 代码的方法有 2 种：</p>
<ol>
<li>通过 <code>WebView</code> 的 <code>loadUrl（）</code></li>
<li>通过 <code>WebView</code> 的 <code>evaluateJavascript（）</code></li>
</ol>
<p>方式 1：通过 <code>WebView</code> 的 <code>loadUrl（）</code></p>
<ul>
<li>实例介绍：点击 Android 按钮，即调用 WebView JS（文本名为 <code>javascript</code>）中 callJS（）</li>
<li>具体使用：</li>
</ul>
<p><strong>步骤 1：将需要调用的 JS 代码以.html 格式放到 src/main/assets 文件夹里</strong></p>
<blockquote>
<ol>
<li>为了方便展示，本文是采用 Andorid 调用本地 JS 代码说明；</li>
<li>实际情况时，Android 更多的是调用远程 JS 代码，即将加载的 JS 代码路径改成 url 即可</li>
</ol>
</blockquote>
<p><em>需要加载 JS 代码：javascript.html</em></p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tbody><tr><td class="code"><pre><span class="line">// 文本名：javascript</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson_Ho<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    // JS代码</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// Android需要调用的方法</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">callJS</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">"Android调用了JS的callJS方法"</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>步骤 2：在 Android 里通过 WebView 设置调用 JS 代码</strong></p>
<p><em>Android 代码：MainActivity.java</em></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> {</span><br><span class="line"></span><br><span class="line">    WebView mWebView;</span><br><span class="line">    Button button;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> {</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mWebView =(WebView) findViewById(R.id.webview);</span><br><span class="line"></span><br><span class="line">        <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">        webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line">        webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先载入JS代码</span></span><br><span class="line">        <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">        mWebView.loadUrl(<span class="string">"file:///android_asset/javascript.html"</span>);</span><br><span class="line"></span><br><span class="line">        button = (Button) findViewById(R.id.button);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> {</span><br><span class="line">                <span class="comment">// 通过Handler发送消息</span></span><br><span class="line">                mWebView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 注意调用的JS方法名要对应上</span></span><br><span class="line">                        <span class="comment">// 调用javascript的callJS()方法</span></span><br><span class="line">                        mWebView.loadUrl(<span class="string">"javascript:callJS()"</span>);</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由于设置了弹窗检验调用结果,所以需要支持js对话框</span></span><br><span class="line">        <span class="comment">// webview只是载体，内容的渲染需要使用webviewChromClient类去实现</span></span><br><span class="line">        <span class="comment">// 通过设置WebChromeClient对象处理JavaScript的对话框</span></span><br><span class="line">        <span class="comment">//设置响应js 的Alert()函数</span></span><br><span class="line">        mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> {</span><br><span class="line">                AlertDialog.<span class="type">Builder</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">                b.setTitle(<span class="string">"Alert"</span>);</span><br><span class="line">                b.setMessage(message);</span><br><span class="line">                b.setPositiveButton(android.R.string.ok, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> {</span><br><span class="line">                        result.confirm();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">                b.setCancelable(<span class="literal">false</span>);</span><br><span class="line">                b.create().show();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1b5n89-pa.webp" alt="image.png"></p>
<p><strong>特别注意：JS 代码调用一定要在 onPageFinished（） 回调之后才能调用，否则不会调用。</strong></p>
<blockquote>
<p><code>onPageFinished()</code> 属于 WebViewClient 类的方法，主要在页面加载结束时调用</p>
</blockquote>
<p>方式 2：通过 <code>WebView</code> 的 <code>evaluateJavascript（）</code></p>
<ul>
<li><p>优点：该方法比第一种方法效率更高、使用更简洁。</p>
<blockquote>
<ol>
<li>因为该方法的执行不会使页面刷新，而第一种方法（loadUrl ）的执行则会。</li>
<li>Android 4.4 后才可使用 </li>
</ol>
</blockquote>
</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 只需要将第一种方法的loadUrl()换成下面该方法即可</span></span><br><span class="line">    mWebView.evaluateJavascript（<span class="string">"javascript:callJS()"</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> {</span><br><span class="line">            <span class="comment">//此处为 js 返回的结果</span></span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="2-1-2-方法对比"><a href="#2-1-2-方法对比" class="headerlink" title="2.1.2 方法对比"></a>2.1.2 方法对比</h4><p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fw883mi70jj30l406o3yz.jpg" alt="image"></p>
<h4 id="2-1-3-使用建议"><a href="#2-1-3-使用建议" class="headerlink" title="2.1.3 使用建议"></a>2.1.3 使用建议</h4><p>两种方法混合使用，即 Android 4.4 以下使用方法 1，Android 4.4 以上方法 2</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Android版本变量</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">version</span> <span class="operator">=</span> Build.VERSION.SDK_INT;</span><br><span class="line"><span class="comment">// 因为该方法在 Android 4.4 版本才可使用，所以使用时需进行版本判断</span></span><br><span class="line"><span class="keyword">if</span> (version &lt; <span class="number">18</span>) {</span><br><span class="line">    mWebView.loadUrl(<span class="string">"javascript:callJS()"</span>);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    mWebView.evaluateJavascript（<span class="string">"javascript:callJS()"</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> {</span><br><span class="line">            <span class="comment">//此处为 js 返回的结果</span></span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="2-2-JS-通过-WebView-调用-Android-代码"><a href="#2-2-JS-通过-WebView-调用-Android-代码" class="headerlink" title="2.2 JS 通过 WebView 调用 Android 代码"></a>2.2 JS 通过 WebView 调用 Android 代码</h3><p>对于 JS 调用 Android 代码的方法有 3 种：</p>
<ol>
<li>通过 <code>WebView</code> 的 <code>addJavascriptInterface（）</code>进行对象映射</li>
<li>通过 <code>WebViewClient</code> 的 <code>shouldOverrideUrlLoading ()</code> 方法回调拦截 url</li>
<li> 通过 <code>WebChromeClient</code> 的 <code>onJsAlert()</code>、<code>onJsConfirm()</code>、<code>onJsPrompt（）</code>方法回调拦截 JS 对话框 <code>alert()</code>、<code>confirm()</code>、<code>prompt（）</code> 消息</li>
</ol>
<h4 id="2-2-1-方法分析"><a href="#2-2-1-方法分析" class="headerlink" title="2.2.1 方法分析"></a>2.2.1 方法分析</h4><p>方式 1：通过 <code>WebView</code> 的 <code>addJavascriptInterface（）</code>进行对象映射</p>
<p><strong>步骤 1：定义一个与 JS 对象映射关系的 Android 类：AndroidtoJs</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 继承自Object类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> <span class="keyword">extends</span> <span class="title class_">Object</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义JS需要调用的方法</span></span><br><span class="line">    <span class="comment">// 被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> {</span><br><span class="line">        System.out.println(<span class="string">"JS调用了Android的hello方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>步骤 2：将需要调用的 JS 代码以.html 格式放到 src/main/assets 文件夹里</strong></p>
<p><em>需要加载 JS 代码：javascript.html</em></p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span><br><span class="line"><span class="language-javascript">        test.<span class="title function_">hello</span>(<span class="string">"js调用了android中的hello方法"</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    //点击按钮则调用callAndroid函数</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"button1"</span> <span class="attr">onclick</span>=<span class="string">"callAndroid()"</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>步骤 3：在 Android 里通过 WebView 设置 Android 类与 JS 代码的映射</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> {</span><br><span class="line"></span><br><span class="line">   WebView mWebView;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> {</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">       mWebView = (WebView) findViewById(R.id.webview);</span><br><span class="line">       <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">       webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 通过addJavascriptInterface()将Java对象映射到JS对象</span></span><br><span class="line">       <span class="comment">//参数1：Javascript对象名</span></span><br><span class="line">       <span class="comment">//参数2：Java对象名</span></span><br><span class="line">       mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">"test"</span>);<span class="comment">//AndroidtoJS类对象映射到js的test对象</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// 加载JS代码</span></span><br><span class="line">       <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">       mWebView.loadUrl(<span class="string">"file:///android_asset/javascript.html"</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fw88a2aelcj30kg0jhaar.jpg" alt="image"></p>
<h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><ul>
<li>优点：使用简单</li>
</ul>
<blockquote>
<p>仅将 Android 对象和 JS 对象映射即可</p>
</blockquote>
<ul>
<li>缺点：存在严重的漏洞问题，具体请看文章：<a class="link" href="https://www.jianshu.com/p/3a345d27cd42">你不知道的 Android WebView 使用漏洞<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<p>方式 2：通过 <code>WebViewClient</code> 的方法 <code>shouldOverrideUrlLoading ()</code> 回调拦截 url</p>
<ul>
<li>具体原理：</li>
</ul>
<ol>
<li>Android 通过 <code>WebViewClient</code> 的回调方法 <code>shouldOverrideUrlLoading ()</code> 拦截 url</li>
<li> 解析该 url 的协议</li>
<li>如果检测到是预先约定好的协议，就调用相应方法</li>
</ol>
<blockquote>
<p>即 JS 需要调用 Android 的方法</p>
</blockquote>
<ul>
<li>具体使用：<br><strong>步骤 1：</strong>在 JS 约定所需要的 Url 协议<br><em>JS 代码：javascript.html</em></li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">   &lt;head&gt;</span><br><span class="line">      &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">      &lt;title&gt;Carson_Ho&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">     &lt;script&gt;</span><br><span class="line">         function <span class="title function_">callAndroid</span><span class="params">()</span>{</span><br><span class="line">            <span class="comment">/*约定的url协议为：js://webview?arg1=111&amp;arg2=222*/</span></span><br><span class="line">            document.location = <span class="string">"js://webview?arg1=111&amp;arg2=222"</span>;</span><br><span class="line">         }</span><br><span class="line">      &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 点击按钮则调用callAndroid（）方法  --&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">     &lt;button type=<span class="string">"button"</span> id=<span class="string">"button1"</span> onclick=<span class="string">"callAndroid()"</span>&gt;点击调用Android代码&lt;/button&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>当该 JS 通过 Android 的 <code>mWebView.loadUrl("file:///android_asset/javascript.html")</code> 加载后，就会回调 <code>shouldOverrideUrlLoading （）</code>，接下来继续看步骤 2：</p>
<p><strong>步骤 2：在 Android 通过 WebViewClient 复写 shouldOverrideUrlLoading （）</strong></p>
<p><em>MainActivity.java</em></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> {</span><br><span class="line"></span><br><span class="line">   WebView mWebView;</span><br><span class="line"><span class="comment">//    Button button;</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> {</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">       mWebView = (WebView) findViewById(R.id.webview);</span><br><span class="line"></span><br><span class="line">       <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">       webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">       <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line">       webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 步骤1：加载JS代码</span></span><br><span class="line">       <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">       mWebView.loadUrl(<span class="string">"file:///android_asset/javascript.html"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复写WebViewClient类的shouldOverrideUrlLoading方法</span></span><br><span class="line">mWebView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() {</span><br><span class="line">                                     <span class="meta">@Override</span></span><br><span class="line">                                     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> {</span><br><span class="line"></span><br><span class="line">                                         <span class="comment">// 步骤2：根据协议的参数，判断是否是所需要的url</span></span><br><span class="line">                                         <span class="comment">// 一般根据scheme（协议格式） &amp; authority（协议名）判断（前两个参数）</span></span><br><span class="line">                                         <span class="comment">//假定传入进来的 url = "js://webview?arg1=111&amp;arg2=222"（同时也是约定好的需要拦截的）</span></span><br><span class="line"></span><br><span class="line">                                         <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                                         <span class="comment">// 如果url的协议 = 预先约定的 js 协议</span></span><br><span class="line">                                         <span class="comment">// 就解析往下解析参数</span></span><br><span class="line">                                         <span class="keyword">if</span> ( uri.getScheme().equals(<span class="string">"js"</span>)) {</span><br><span class="line"></span><br><span class="line">                                             <span class="comment">// 如果 authority  = 预先约定协议里的 webview，即代表都符合约定的协议</span></span><br><span class="line">                                             <span class="comment">// 所以拦截url,下面JS开始调用Android需要的方法</span></span><br><span class="line">                                             <span class="keyword">if</span> (uri.getAuthority().equals(<span class="string">"webview"</span>)) {</span><br><span class="line"></span><br><span class="line">                                                <span class="comment">//  步骤3：</span></span><br><span class="line">                                                 <span class="comment">// 执行JS所需要调用的逻辑</span></span><br><span class="line">                                                 System.out.println(<span class="string">"js调用了Android的方法"</span>);</span><br><span class="line">                                                 <span class="comment">// 可以在协议上带有参数并传递到Android上</span></span><br><span class="line">                                                 HashMap&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                                                 Set&lt;String&gt; collection = uri.getQueryParameterNames();</span><br><span class="line"></span><br><span class="line">                                             }</span><br><span class="line"></span><br><span class="line">                                             <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                                         }</span><br><span class="line">                                         <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                                     }</span><br><span class="line">                                 }</span><br><span class="line">       );</span><br><span class="line">  }</span><br><span class="line">       }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h5><ul>
<li>优点：不存在方式 1 的漏洞；</li>
<li>缺点：JS 获取 Android 方法的返回值复杂。</li>
</ul>
<blockquote>
<p>如果 JS 想要得到 Android 方法的返回值，只能通过 WebView 的 <code>loadUrl （）</code>去执行 JS 方法把返回值传递回去，相关的代码如下：</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Android：MainActivity.java</span></span><br><span class="line">mWebView.loadUrl(<span class="string">"javascript:returnResult("</span> + result + <span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// JS：javascript.html</span></span><br><span class="line">function <span class="title function_">returnResult</span><span class="params">(result)</span>{</span><br><span class="line">    alert(<span class="string">"result is"</span> + result);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>方式 3：通过 <code>WebChromeClient</code> 的 <code>onJsAlert()</code>、<code>onJsConfirm()</code>、<code>onJsPrompt（）</code>方法回调拦截 JS 对话框 <code>alert()</code>、<code>confirm()</code>、<code>prompt（）</code> 消息</p>
<p>在 JS 中，有三个常用的对话框方法：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fw88g44q4wj30lh07mwf6.jpg" alt="image"></p>
<p>方式 3 的原理：Android 通过 WebChromeClient 的 onJsAlert ()、onJsConfirm ()、onJsPrompt（）方法回调分别拦截 JS 对话框<br>（即上述三个方法），得到他们的消息内容，然后解析即可。</p>
<p>下面的例子将用拦截 JS 的输入框（即 prompt（）方法）说明 ：</p>
<blockquote>
<p>常用的拦截是：_拦截 JS 的输入框_（即 prompt（）方法）<br>因为只有 prompt（）可以返回任意类型的值，操作最全面方便、更加灵活；而 alert（）对话框没有返回值；confirm（）对话框只能返回两种状态（确定 / 取消）两个</p>
</blockquote>
<p>步骤 1：加载 JS 代码，如下：<br>javascript.html</p>
<blockquote>
<p>以.html 格式放到 src/main/assets 文件夹</p>
</blockquote>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson_Ho<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">clickprompt</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 调用prompt（）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> result = <span class="title function_">prompt</span>(<span class="string">"js://demo?arg1=111&amp;arg2=222"</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">"demo "</span> + result);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 点击按钮则调用clickprompt()  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"button1"</span> <span class="attr">onclick</span>=<span class="string">"clickprompt()"</span>&gt;</span></span><br><span class="line">      点击调用Android代码</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>当使用 <code>mWebView.loadUrl("file:///android_asset/javascript.html")</code> 加载了上述 JS 代码后，就会触发回调 <code>onJsPrompt（）</code>，具体如下：</p>
<blockquote>
<ol>
<li>如果是拦截警告框（即 <code>alert()</code>），则触发回调 <code>onJsAlert（）</code>；</li>
<li>如果是拦截确认框（即 <code>confirm()</code>），则触发回调 <code>onJsConfirm（）</code>；</li>
</ol>
</blockquote>
<p><strong>步骤 2：在 Android 通过 WebChromeClient 复写 onJsPrompt（）</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> {</span><br><span class="line"></span><br><span class="line">    WebView mWebView;</span><br><span class="line"><span class="comment">//    Button button;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> {</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mWebView = (WebView) findViewById(R.id.webview);</span><br><span class="line"></span><br><span class="line">        <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">        webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line">        webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先加载JS代码</span></span><br><span class="line">        <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">        mWebView.loadUrl(<span class="string">"file:///android_asset/javascript.html"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() {</span><br><span class="line">                                        <span class="comment">// 拦截输入框(原理同方式2)</span></span><br><span class="line">                                        <span class="comment">// 参数message:代表promt（）的内容（不是url）</span></span><br><span class="line">                                        <span class="comment">// 参数result:代表输入框的返回值</span></span><br><span class="line">                                        <span class="meta">@Override</span></span><br><span class="line">                                        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsPrompt</span><span class="params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span> {</span><br><span class="line">                                            <span class="comment">// 根据协议的参数，判断是否是所需要的url(原理同方式2)</span></span><br><span class="line">                                            <span class="comment">// 一般根据scheme（协议格式） &amp; authority（协议名）判断（前两个参数）</span></span><br><span class="line">                                            <span class="comment">//假定传入进来的 url = "js://webview?arg1=111&amp;arg2=222"（同时也是约定好的需要拦截的）</span></span><br><span class="line"></span><br><span class="line">                                            <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(message);</span><br><span class="line">                                            <span class="comment">// 如果url的协议 = 预先约定的 js 协议</span></span><br><span class="line">                                            <span class="comment">// 就解析往下解析参数</span></span><br><span class="line">                                            <span class="keyword">if</span> ( uri.getScheme().equals(<span class="string">"js"</span>)) {</span><br><span class="line"></span><br><span class="line">                                                <span class="comment">// 如果 authority  = 预先约定协议里的 webview，即代表都符合约定的协议</span></span><br><span class="line">                                                <span class="comment">// 所以拦截url,下面JS开始调用Android需要的方法</span></span><br><span class="line">                                                <span class="keyword">if</span> (uri.getAuthority().equals(<span class="string">"webview"</span>)) {</span><br><span class="line"></span><br><span class="line">                                                    <span class="comment">//</span></span><br><span class="line">                                                    <span class="comment">// 执行JS所需要调用的逻辑</span></span><br><span class="line">                                                    System.out.println(<span class="string">"js调用了Android的方法"</span>);</span><br><span class="line">                                                    <span class="comment">// 可以在协议上带有参数并传递到Android上</span></span><br><span class="line">                                                    HashMap&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                                                    Set&lt;String&gt; collection = uri.getQueryParameterNames();</span><br><span class="line"></span><br><span class="line">                                                    <span class="comment">//参数result:代表消息框的返回值(输入值)</span></span><br><span class="line">                                                    result.confirm(<span class="string">"js调用了Android的方法成功啦"</span>);</span><br><span class="line">                                                }</span><br><span class="line">                                                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                                            }</span><br><span class="line">                                            <span class="keyword">return</span> <span class="built_in">super</span>.onJsPrompt(view, url, message, defaultValue, result);</span><br><span class="line">                                        }</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过alert()和confirm()拦截的原理相同，此处不作过多讲述</span></span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 拦截JS的警告框</span></span><br><span class="line">                                        <span class="meta">@Override</span></span><br><span class="line">                                        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, JsResult result)</span> {</span><br><span class="line">                                            <span class="keyword">return</span> <span class="built_in">super</span>.onJsAlert(view, url, message, result);</span><br><span class="line">                                        }</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 拦截JS的确认框</span></span><br><span class="line">                                        <span class="meta">@Override</span></span><br><span class="line">                                        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsConfirm</span><span class="params">(WebView view, String url, String message, JsResult result)</span> {</span><br><span class="line">                                            <span class="keyword">return</span> <span class="built_in">super</span>.onJsConfirm(view, url, message, result);</span><br><span class="line">                                        }</span><br><span class="line">                                    }</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="2-2-2-三种方式的对比-使用场景"><a href="#2-2-2-三种方式的对比-使用场景" class="headerlink" title="2.2.2 三种方式的对比 &amp; 使用场景"></a>2.2.2 三种方式的对比 &amp; 使用场景</h4><p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fw88kyx0n2j30oq08wabh.jpg" alt="image"></p>
<h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3. 总结</h3><ul>
<li>本文主要对 <strong>Android 通过 WebView 与 JS 的交互方式进行了全面介绍</strong></li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fw88lnrnshj30x10botba.jpg" alt="image"></p>
]]></content>
      <tags>
        <tag>android</tag>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>ajax 发送请求</title>
    <url>/2018/85cd9d36.html</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>AJAX = Asynchronous JavaScript and XML（异步的 JavaScript 和 XML）。</p>
<p>AJAX 不是新的编程语言，而是一种使用现有标准的新方法。</p>
<p>AJAX 最大的优点是在不重新加载整个页面的情况下，可以与服务器交换数据并更新部分网页内容。</p>
<p>AJAX 不需要任何浏览器插件，但需要用户允许 JavaScript 在浏览器上执行。</p>
<p>今天聊一下 ajax 发送 get/post 请求的问题</p>
<span id="more"></span>

<h3 id="GET-POST"><a href="#GET-POST" class="headerlink" title="GET/POST"></a>GET/POST</h3><p>AJAX 是一种在无需重新加载整个网页的情况下，能够更新部分网页的技术。传统网页不使用 AJAX 如果需要更新内容，必需重载整个网页面。有很多使用 AJAX 的应用程序案例：新浪微博、Google 地图等等。</p>
<p>使用前引入 js</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>示例代码</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        $(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">            $(<span class="string">"#btnget2"</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">                $.<span class="title function_">ajax</span>({</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">"GET"</span>,        <span class="comment">//type：(string)请求方式，POST或GET</span></span><br><span class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">async</span>: <span class="literal">true</span>,   <span class="comment">//是否异步</span></span><br><span class="line">                    <span class="attr">dataType</span>: <span class="string">"jsonp"</span>,    <span class="comment">//dataType：(string)预期返回的数据类型。xml,html,json,text等</span></span><br><span class="line">      <span class="attr">jsonp</span>:<span class="string">"callback"</span>,</span><br><span class="line">                    <span class="attr">jsonpCallback</span>:<span class="string">"refreshPrice"</span>,</span><br><span class="line">                    <span class="attr">url</span>: <span class="string">"http://api.money.126.net/data/feed/0000001,1399001?callback=refreshPrice"</span>,  <span class="comment">//url：(string)发送请求的地址，可以是服务器页面也可以是WebService动作。</span></span><br><span class="line">                    <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">msge</span>) {</span><br><span class="line">                        <span class="keyword">var</span> str = <span class="string">""</span>;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(msge);</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> msge) {</span><br><span class="line">                            str += <span class="string">"&lt;tr&gt;&lt;td&gt;编号:"</span> + msge[i].<span class="property">code</span> + <span class="string">"&lt;/td&gt;&lt;td&gt;名字:"</span> + msge[i].<span class="property">name</span> + <span class="string">"&lt;/td&gt;&lt;td&gt;当前价格:"</span></span><br><span class="line">                            + msge[i].<span class="property">price</span> + <span class="string">"&lt;/td&gt;&lt;td&gt;类别:"</span> + msge[i].<span class="property">type</span> + <span class="string">"&lt;/td&gt;&lt;/tr&gt;"</span>;</span><br><span class="line"></span><br><span class="line">                        }</span><br><span class="line">                        $(<span class="string">"#div"</span>).<span class="title function_">append</span>(str);</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">    &lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>运行效果<img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1b3t43-8p.webp" alt="image.png"></p>
<p>（上面只给出 js 部分代码）</p>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><p><font color="”red”">此处建议电脑打开，可以看左侧参数列表</font></p>
<p>ajax 方法有很多参数</p>
<h4 id="1-url"><a href="#1-url" class="headerlink" title="1.url"></a><strong>1.url</strong></h4><p>要求为 String 类型的参数，（默认为当前页地址）发送请求的地址。</p>
<h4 id="2-type"><a href="#2-type" class="headerlink" title="2.type"></a><strong>2.type</strong></h4><p>要求为 String 类型的参数，请求方式（<code>post</code> 或 <code>get</code>）默认为 get。注意其他 http 请求方法，例如 put 和 delete 也可以使用，但仅部分浏览器支持。</p>
<h4 id="3-timeout"><a href="#3-timeout" class="headerlink" title="3.timeout"></a><strong>3.timeout</strong></h4><p>要求为 Number 类型的参数，设置请求超时时间（毫秒）。此设置将覆盖 $.ajaxSetup () 方法的全局设置。</p>
<h4 id="4-async"><a href="#4-async" class="headerlink" title="4.async"></a><strong>4.async</strong></h4><p>要求为 <code>Boolean</code> 类型的参数，默认设置为 true，所有请求均为异步请求。如果需要发送同步请求，请将此选项设置为 false。注意，同步请求将锁住浏览器，用户其他操作必须等待请求完成才可以执行。</p>
<h4 id="5-cache"><a href="#5-cache" class="headerlink" title="5.cache"></a><strong>5.cache</strong></h4><p>要求为 Boolean 类型的参数，默认为 true（当 dataType 为 script 时，默认为 false），设置为 false 将不会从浏览器缓存中加载请求信息。</p>
<h4 id="6-data"><a href="#6-data" class="headerlink" title="6.data"></a><strong>6.data</strong></h4><p>要求为 Object 或 String 类型的参数，发送到服务器的数据。如果已经不是字符串，将自动转换为字符串格式。get 请求中将附加在 url 后。防止这种自动转换，可以查看　　 processData 选项。对象必须为 key/value 格式，例如 {foo1:”bar1”,foo2:”bar2”} 转换为 &amp; foo1=bar1&amp;foo2=bar2。如果是数组，JQuery 将自动为不同值对应同一个名称。例如 {foo:[“bar1”,”bar2”]} 转换为 &amp; foo=bar1&amp;foo=bar2。</p>
<h4 id="7-dataType"><a href="#7-dataType" class="headerlink" title="7.dataType"></a><strong>7.dataType</strong></h4><p>要求为 String 类型的参数，预期服务器返回的数据类型。如果不指定，JQuery 将自动根据 http 包 mime 信息返回 responseXML 或 responseText，并作为回调函数参数传递。可用的类型如下：<br>xml：返回 XML 文档，可用 JQuery 处理。<br>html：返回纯文本 HTML 信息；包含的 script 标签会在插入 DOM 时执行。<br>script：返回纯文本 JavaScript 代码。不会自动缓存结果。除非设置了 cache 参数。注意在远程请求时（不在同一个域下），所有 post 请求都将转为 get 请求。<br>json：返回 JSON 数据。<br>jsonp：JSONP 格式。使用 SONP 形式调用函数时，例如 myurl?callback=?，JQuery 将自动替换后一个 “?” 为正确的函数名，以执行回调函数。（异域加载时使用）<br>text：返回纯文本字符串。</p>
<h4 id="8-beforeSend"><a href="#8-beforeSend" class="headerlink" title="8.beforeSend"></a><strong>8.beforeSend</strong></h4><p>要求为 Function 类型的参数，发送请求前可以修改 XMLHttpRequest 对象的函数，例如添加自定义 HTTP 头。在 beforeSend 中如果返回 false 可以取消本次 ajax 请求。XMLHttpRequest 对象是惟一的参数。</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>){</span><br><span class="line">             <span class="variable language_">this</span>;<span class="comment">//调用本次ajax请求时传递的options参数</span></span><br><span class="line">          }</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="9-complete"><a href="#9-complete" class="headerlink" title="9.complete"></a><strong>9.complete</strong></h4><p>要求为 Function 类型的参数，请求完成后调用的回调函数（请求成功或失败时均调用）。参数：XMLHttpRequest 对象和一个描述成功请求类型的字符串。<br>function(XMLHttpRequest, textStatus){<br>this; // 调用本次 ajax 请求时传递的 options 参数<br>}</p>
<h4 id="10-success"><a href="#10-success" class="headerlink" title="10.success"></a><strong>10.success</strong></h4><p>要求为 Function 类型的参数，请求成功后调用的回调函数，有两个参数。<br>(1) 由服务器返回，并根据 dataType 参数进行处理后的数据。<br>(2) 描述状态的字符串。</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">data, textStatus</span>){</span><br><span class="line">          <span class="comment">//data可能是xmlDoc、jsonObj、html、text等等</span></span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>;  <span class="comment">//调用本次ajax请求时传递的options参数</span></span><br><span class="line">       }</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="11-error"><a href="#11-error" class="headerlink" title="11.error"></a><strong>11.error</strong></h4><p>要求为 Function 类型的参数，请求失败时被调用的函数。该函数有 3 个参数，即 XMLHttpRequest 对象、错误信息、捕获的错误对象 (可选)。ajax 事件函数如下：</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">XMLHttpRequest, textStatus, errorThrown</span>){</span><br><span class="line">         <span class="comment">//通常情况下textStatus和errorThrown只有其中一个包含信息</span></span><br><span class="line">         <span class="variable language_">this</span>;   <span class="comment">//调用本次ajax请求时传递的options参数</span></span><br><span class="line">      }</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="12-contentType"><a href="#12-contentType" class="headerlink" title="12.contentType"></a><strong>12.contentType</strong></h4><p>要求为 String 类型的参数，当发送信息至服务器时，内容编码类型默认为 <code>application/x-www-form-urlencoded</code>。该默认值适合大多数应用场合。</p>
<h4 id="13-dataFilter"><a href="#13-dataFilter" class="headerlink" title="13.dataFilter"></a><strong>13.dataFilter</strong></h4><p>要求为 Function 类型的参数，给 Ajax 返回的原始数据进行预处理的函数。提供 data 和 type 两个参数。data 是 Ajax 返回的原始数据，type 是调用 jQuery.ajax 时提供的 dataType 参数。函数返回的值将由 jQuery 进一步处理。</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">data, type</span>){</span><br><span class="line"></span><br><span class="line">               <span class="comment">//返回处理后的数据</span></span><br><span class="line">               <span class="keyword">return</span> data;</span><br><span class="line">           }</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="14-dataFilter"><a href="#14-dataFilter" class="headerlink" title="14.dataFilter"></a><strong>14.dataFilter</strong></h4><p>要求为 Function 类型的参数，给 Ajax 返回的原始数据进行预处理的函数。提供 data 和 type 两个参数。data 是 Ajax 返回的原始数据，type 是调用 jQuery.ajax 时提供的 dataType 参数。函数返回的值将由 jQuery 进一步处理。</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">data, type</span>){</span><br><span class="line"></span><br><span class="line">                <span class="comment">//返回处理后的数据</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            }</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="15-global"><a href="#15-global" class="headerlink" title="15.global"></a><strong>15.global</strong></h4><p>要求为 Boolean 类型的参数，默认为 true。表示是否触发全局 ajax 事件。设置为 false 将不会触发全局 ajax 事件，ajaxStart 或 ajaxStop 可用于控制各种 ajax 事件。</p>
<h4 id="16-ifModified"><a href="#16-ifModified" class="headerlink" title="16.ifModified"></a><strong>16.ifModified</strong></h4><p>要求为 Boolean 类型的参数，默认为 false。仅在服务器数据改变时获取新数据。服务器数据改变判断的依据是 Last-Modified 头信息。默认值是 false，即忽略头信息。</p>
<h4 id="17-jsonp"><a href="#17-jsonp" class="headerlink" title="17.jsonp"></a><strong>17.jsonp</strong></h4><p>要求为 String 类型的参数，在一个 jsonp 请求中重写回调函数的名字。该值用来替代在”callback=?” 这种 GET 或 POST 请求中 URL 参数里的”callback” 部分，例如 {jsonp:’onJsonPLoad’} 会导致将”onJsonPLoad=?” 传给服务器。</p>
<h4 id="18-username"><a href="#18-username" class="headerlink" title="18.username"></a><strong>18.username</strong></h4><p>要求为 String 类型的参数，用于响应 HTTP 访问认证请求的用户名。</p>
<h4 id="19-password"><a href="#19-password" class="headerlink" title="19.password"></a><strong>19.password</strong></h4><p>要求为 String 类型的参数，用于响应 HTTP 访问认证请求的密码。</p>
<h4 id="20-processData"><a href="#20-processData" class="headerlink" title="20.processData"></a><strong>20.processData</strong></h4><p>要求为 Boolean 类型的参数，默认为 true。默认情况下，发送的数据将被转换为对象（从技术角度来讲并非字符串）以配合默认内容类型”application/x-www-form-urlencoded”。如果要发送 DOM 树信息或者其他不希望转换的信息，请设置为 false。</p>
<h4 id="21-scriptCharset"><a href="#21-scriptCharset" class="headerlink" title="21.scriptCharset"></a><strong>21.scriptCharset</strong></h4><p>要求为 String 类型的参数，只有当请求时 dataType 为”jsonp” 或者”script”，并且 type 是 GET 时才会用于强制修改字符集 (charset)。通常在本地和远程的内容编码不同时使用。</p>
<p>关于 <a class="link" href="http://www.w3school.com.cn/jquery/index.asp">jQuery 的教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>debian11/12 系统如何开启 ipv6</title>
    <url>/2024/1889416420.html</url>
    <content><![CDATA[<p>debian 系统默认只配置了 ipv4, 参考 <a class="link" href="https://www.v2ex.com/t/884267">v2ex<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>上的一篇讨论，快速 dhcp ipv6</p>
<span id="more"></span>
<h2 id="获取网卡名称"><a href="#获取网卡名称" class="headerlink" title="获取网卡名称"></a>获取网卡名称</h2><p>执行 <code>ip a</code> 命令列出网卡，可以看到这时候我们的系统只有以 fe80 开始的内网 ipv6，记下网卡名，可以使用 <code>cat /etc/network/interfaces</code> 核对网卡名</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eno2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 9a:ee:cb:04:72:98 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp2s0</span><br><span class="line">    inet 192.168.2.2/24 brd 192.168.2.255 scope global dynamic eno2</span><br><span class="line">       valid_lft 39162sec preferred_lft 39162sec</span><br><span class="line">    inet6 fe80::9aee:cbff:fe04:7298/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure></div>
<h2 id="新增z-network"><a href="#新增z-network" class="headerlink" title="新增z.network"></a>新增 <code>z.network</code></h2><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> /etc/network/interfaces /etc/network/interfaces.save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网卡名，并修改下边的enp0s3</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> sh -c <span class="string">"echo '[Match]</span></span><br><span class="line"><span class="string">Name=enp0s3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Network]</span></span><br><span class="line"><span class="string">DHCP=yes' &gt;&gt; /etc/systemd/network/z.network"</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="重启网络服务"><a href="#重启网络服务" class="headerlink" title="重启网络服务"></a>重启网络服务</h2><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> systemd-networkd</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart systemd-networkd</span><br><span class="line"><span class="built_in">sudo</span> systemctl status systemd-networkd</span><br></pre></td></tr></tbody></table></figure></div>
<p>检查 <code>ip a</code></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eno2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 95:ee:cb:02:72:38 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp2s0</span><br><span class="line">    inet 192.168.2.2/24 brd 192.168.2.255 scope global dynamic eno2</span><br><span class="line">       valid_lft 39162sec preferred_lft 39162sec</span><br><span class="line">    inet6 2408:8110:xxx:xxx:xxx:xxx:fe04:7298/64 scope global dynamic mngtmpaddr noprefixroute</span><br><span class="line">       valid_lft 210634sec preferred_lft 124234sec</span><br><span class="line">    inet6 fe80::9aee:cbff:fe04:7298/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure></div>]]></content>
      <tags>
        <tag>debian</tag>
      </tags>
  </entry>
  <entry>
    <title>debian13 双网口开启桥接</title>
    <url>/2025/38671282.html</url>
    <content><![CDATA[<p>书接上文，<a href="https://blog.tbox.fun/2025/3600149751.html">双网口飞牛 NAS 设置二级路由</a></p>
<p>后来作为系统的 U 盘挂掉了，现在索性重装 <code>debian13</code>，并启用双网口桥接，使 <code>NAS</code> 作为作为交换机使用</p>
<span id="more"></span>
<p>重装后当前网络接口状态如下：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: enp1s0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:e8:4c:69:1b:44 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enx00e84c691b44</span><br><span class="line">    inet 10.20.0.210/16 brd 10.20.255.255 scope global dynamic noprefixroute enp1s0</span><br><span class="line">       valid_lft 86189sec preferred_lft 75389sec</span><br><span class="line">    inet6 fe80::bf24:3c80:c53e:7e8a/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: enp2s0: &lt;BROADCAST,MULTICAST,PROMISC&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:e8:4c:69:1b:45 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enx00e84c691b45</span><br></pre></td></tr></tbody></table></figure></div>

<p>要将 <code>Debian 13</code> 系统上的双网口（<code>enp1s0</code> 和 <code>enp2s0</code>）配置为桥接模式，需要安装 <code>bridge-utils</code> 并修改网络接口配置文件 <code>/etc/network/interfaces</code><br>注意： 网卡要打开<code>混杂模式</code>，可以参考上篇文章  <a href="https://blog.tbox.fun/2025/3600149751.html">双网口飞牛 NAS 设置二级路由</a></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install bridge-utils</span><br></pre></td></tr></tbody></table></figure></div>
<p>目前 <code>enp1s0</code> 已经有一个 DHCP 分配的 IP 地址，为了将这两个接口桥接，需要将它们都设置为手动模式，然后创建一个网桥 <code>br0</code> 并将这两个接口添加到其中</p>
<p>有两种实现方式：DHCP 为网桥获取地址、网桥静态 IP 地址</p>
<blockquote>
<p>操作有风险，请先备份 /etc/network/interfaces 文件</p>
</blockquote>
<h3 id="DHCP方式"><a href="#DHCP方式" class="headerlink" title="DHCP方式"></a>DHCP 方式</h3><p>修改 <code>/etc/network/interfaces</code></p>
<div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tbody><tr><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"><span class="comment"># 将网卡enp1s0和enp2s0设置为手动模式，以便加入网桥</span></span><br><span class="line">iface enp1s0 inet manual</span><br><span class="line">iface enp2s0 inet manual</span><br><span class="line"><span class="comment"># 自动激活br0网桥</span></span><br><span class="line">auto br0</span><br><span class="line"><span class="comment"># 配置br0通过DHCP获取IP地址</span></span><br><span class="line">iface br0 inet dhcp</span><br><span class="line">    <span class="comment"># 将enp1s0和enp2s0端口添加到br0网桥中</span></span><br><span class="line">    bridge_ports enp1s0 enp2s0</span><br><span class="line">    <span class="comment"># 禁用生成树协议</span></span><br><span class="line">    bridge_stp off</span><br><span class="line">    <span class="comment"># 端口立即可用</span></span><br><span class="line">    bridge_waitport 0 </span><br><span class="line">    <span class="comment"># 无转发延迟</span></span><br><span class="line">    bridge_fd 0 </span><br></pre></td></tr></tbody></table></figure></div>


<h3 id="静态IP地址配置网桥"><a href="#静态IP地址配置网桥" class="headerlink" title="静态IP地址配置网桥"></a>静态 IP 地址配置网桥</h3><div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tbody><tr><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">iface enp1s0 inet manual</span><br><span class="line">iface enp2s0 inet manual</span><br><span class="line"></span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static</span><br><span class="line">    address 10.20.0.X/16   <span class="comment"># 静态IP地址替换 10.20.0.X</span></span><br><span class="line">    netmask 255.255.0.0      <span class="comment"># 根据实际调整子网掩码</span></span><br><span class="line">    gateway 10.20.0.1      <span class="comment"># 默认网关IP替换 10.20.0.1</span></span><br><span class="line">    bridge_ports enp1s0 enp2s0</span><br><span class="line">    bridge_stp off       <span class="comment"># 禁用生成树协议（可选，但对于虚拟化环境可能有用）</span></span><br><span class="line">    bridge_waitport 0    <span class="comment"># 端口立即可用，无延迟（可选</span></span><br><span class="line">    bridge_fd 0          <span class="comment"># 无转发延迟（可选）</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="重启网络"><a href="#重启网络" class="headerlink" title="重启网络"></a>重启网络</h2><blockquote>
<p>如果为远程 ssh，这一步有断连风险</p>
</blockquote>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart networking</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h2><p>操作完成后发现 enp2s0 还是 down 的状态</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"> ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: enp1s0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master br0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:e8:4c:69:1b:44 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enx00e84c691b44</span><br><span class="line">    inet6 fe80::bf24:3c80:c53e:7e8a/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: enp2s0: &lt;BROADCAST,MULTICAST,PROMISC&gt; mtu 1500 qdisc noop master br0 state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:e8:4c:69:1b:45 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enx00e84c691b45</span><br><span class="line">4: tailscale0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1280 qdisc fq_codel state UNKNOWN group default qlen 500</span><br><span class="line">    <span class="built_in">link</span>/none</span><br><span class="line">    inet 100.64.0.6/32 scope global tailscale0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fd7a:115c:a1e0::7e01:8325/128 scope global</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::38c1:9cd8:bb78:2f5d/64 scope <span class="built_in">link</span> stable-privacy proto kernel_ll</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether f6:e0:ed:7c:90:3e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">6: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether de:44:f5:ac:9b:8c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.20.0.216/16 brd 10.20.255.255 scope global dynamic noprefixroute br0</span><br><span class="line">       valid_lft 86362sec preferred_lft 75562sec</span><br><span class="line">    inet6 fe80::dc44:f5ff:feac:9b8c/64 scope <span class="built_in">link</span> proto kernel_ll</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure></div>
<p>重新拔插网线，执行如下命令重启后成功</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart networking</span><br></pre></td></tr></tbody></table></figure></div>
<h2 id="使用ShellCrash创建旁路由"><a href="#使用ShellCrash创建旁路由" class="headerlink" title="使用ShellCrash创建旁路由"></a>使用 ShellCrash 创建旁路由</h2><p>参考最新教程<br><a class="link" href="https://github.com/juewuy/ShellCrash/blob/dev/README_CN.md">https://github.com/juewuy/ShellCrash/blob/dev/README_CN.md<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>安装步骤：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> -i <span class="comment">#切换到root用户，如果需要密码，请输入密码</span></span><br><span class="line">bash <span class="comment">#如已处于bash环境可跳过</span></span><br><span class="line"><span class="built_in">export</span> url=<span class="string">'https://fastly.jsdelivr.net/gh/juewuy/ShellCrash@master'</span> &amp;&amp; wget -q --no-check-certificate -O /tmp/install.sh <span class="variable">$url</span>/install.sh  &amp;&amp; bash /tmp/install.sh &amp;&amp; <span class="built_in">source</span> /etc/profile &amp;&gt; /dev/null</span><br></pre></td></tr></tbody></table></figure></div>

<p>配置好后，需要将本地设备的<code>网关</code>和 <code>DNS</code> 服务器地址设置为 <code>Debian 13</code> 设备的 IP 地址，以实现旁路由功能</p>
]]></content>
      <tags>
        <tag>debian</tag>
      </tags>
  </entry>
  <entry>
    <title>GO 记录 1</title>
    <url>/2021/3726022903.html</url>
    <content><![CDATA[<h3 id="开始学习go语言"><a href="#开始学习go语言" class="headerlink" title="开始学习go语言"></a>开始学习 <code>go</code> 语言</h3><span id="more"></span>

<p>参考资料<br><a class="link" href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/preface.md">https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/preface.md<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>  </p>
<p>官网教程<br><a class="link" href="https://tour.go-zh.org/basics/13">https://tour.go-zh.org/basics/13<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<blockquote>
<p>IDE<br>code-server</p>
</blockquote>
]]></content>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title>docker 理解及常用命令</title>
    <url>/2018/ce28352e.html</url>
    <content><![CDATA[<p>因为要把一些服务进行 docker 部署，系统的学习了一下 docker 的使用，不说原理，网上很多，只记录一些命令</p>
<span id="more"></span>

<p>docker 类似于虚拟机，但是又不同于虚拟机，所有的容器以及镜像都是基于精简的 linux 系统进行展开（划重点，刚开始学习过程中一直在疑惑怎么跑起来一些服务的）</p>
<h2 id="自定义镜像"><a href="#自定义镜像" class="headerlink" title="自定义镜像"></a>自定义镜像</h2><p>获取镜像有两种方式，<code>第一种</code>方式是从网上 pull 下来，然后根据要求更改（如果有现成的可以不改），<code>第二种</code>方式，使用 Dockerfile 文件</p>
<h3 id="一"><a href="#一" class="headerlink" title="一"></a>一</h3><p>获取</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">docker pull ubuntu</span><br></pre></td></tr></tbody></table></figure></div>

<p>启动</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">docker run -it -d --name test-ubuntu ubuntu</span><br></pre></td></tr></tbody></table></figure></div>

<p>这样就从 ubuntu 这个镜像上新建了一个容器</p>
<p>查看后台运行的容器</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></tbody></table></figure></div>

<p>进入</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">docker attach 上方的id</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到是一个精简的 Ubuntu 系统</p>
<p>安装完想要的东西后，生成新镜像（可选）</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">docker commit --change='CMD ["python /app/Api.py"]' -c "EXPOSE 22" flask ubuntu</span><br></pre></td></tr></tbody></table></figure></div>



<p>其他命令后面补上</p>
<h3 id="二"><a href="#二" class="headerlink" title="二"></a>二</h3><p>基于在 Dockerfile 中的指令，我们可以使用 <code>Docker build</code> 命令来创建镜像。通过减少镜像和容器的创建过程来简化部署。</p>
<p>以创建一个 python Flask 为例</p>
<p>新建一个目录，名称随意</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mkdir python</span><br><span class="line">cd python</span><br><span class="line">vim Dockerfile</span><br></pre></td></tr></tbody></table></figure></div>

<p>输入以下内容</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">#根镜像</span><br><span class="line">FROM daocloud.io/ubuntu:trusty</span><br><span class="line">MAINTAINER tsvico tsxygwj@163.com</span><br><span class="line"># APT 自动安装 PHP 相关的依赖包，如需其他依赖包在此添加</span><br><span class="line">RUN apt-get update &amp;&amp; \  </span><br><span class="line">      apt-get install -y python \</span><br><span class="line">                       python-dev \</span><br><span class="line">                       python-pip  \</span><br><span class="line">                       vim \</span><br><span class="line">    # 用完包管理器后安排打扫卫生可以显著的减少镜像大小</span><br><span class="line">    &amp;&amp; apt-get clean \</span><br><span class="line">    &amp;&amp; apt-get autoclean \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* </span><br><span class="line">ADD re.txt re.txt</span><br><span class="line">RUN pip install -r re.txt</span><br><span class="line"># 配置默认放置 App 的目录</span><br><span class="line">RUN mkdir -p /app  </span><br><span class="line">WORKDIR /app  </span><br><span class="line">COPY ./test /app</span><br><span class="line">#开放8080端口</span><br><span class="line">EXPOSE 8080  </span><br><span class="line">CMD ["python /app/Api.py"]</span><br></pre></td></tr></tbody></table></figure></div>

<p>注：re.txt 放在 python 目录下，是我 flask 环境的一些依赖，把程序源码同样拷贝到 python 目录，放在新建文件夹 test 目录下，</p>
<p><code>FROM</code>： 必不可少的命令，从某个镜像作为基。如 FROM <image_name> ，或者 FROM <image_name>:<tag>. 如果不加 tag，默认为 latest。先从本地镜像仓库去搜索基镜像，如过本地没有，在去网上 docker registry 去寻找。</tag></image_name></image_name></p>
<p><code>MAINTAINER</code>：标明该 Dockerfile 作者及联系方式，可忽略不写</p>
<p><code>RUN</code>：建立新的镜像时，可以执行在系统里的命令，如安装特定的软件以及设置环境变量。</p>
<p><code>ENV</code>：设置系统环境变量（注意：写在 /etc/profile 里的命令在 dockerfile 这里会不生效，所以为改成 ENV 的方式）</p>
<p><code>EXPOSE</code>：开放容器内的端口，但不和宿主机进行映射。方便在宿主机上进行开发测试。（如需映射到宿主机端口，可在运行容器时使用 -p host_port:container_port）</p>
<p><code>CMD</code>：设置执行的命令，经常用于容器启动时指定的某个操作。如执行自定义脚本服务，或者是执行系统命令。CMD 只能存在一条，如在 Dockerfile 中有多条 CMD 的话，只有最后一条 CMD 生效！</p>
<p>文件中每一条 RUN 命令都为一层，一次写完最好，详情 Google.com</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">#构建</span><br><span class="line">docker build -t ubuntu-flask .</span><br><span class="line">最后的.不能缺少</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>启动服务</p>
<p><code>docker run -d -p 8080:8080 --name=api flask-api:latest python /app/Api.py</code></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">//拉取镜像</span><br><span class="line">docker pull &lt;仓库地址&gt;/&lt;镜像名&gt;:&lt;镜像tag&gt;</span><br><span class="line">//启动容器</span><br><span class="line">docker run -it &lt;镜像名&gt;:&lt;镜像tag&gt; /bin/bash</span><br><span class="line">eg docker run -t -i ubuntu:14.04 /bin/bash</span><br><span class="line">//后台守护进程启动</span><br><span class="line">docker run -dit &lt;镜像名&gt;:&lt;镜像tag&gt; /bin/bash</span><br><span class="line">docker run -dit  training/webapp python app.py</span><br><span class="line">-d即是以守护态运行</span><br><span class="line">//自定义端口映射,启动服务</span><br><span class="line">宿主机到容器内的端口映射</span><br><span class="line">docker run -dit -p &lt;hostPort&gt;:&lt;containerPort&gt; --name &lt;自定义容器名&gt; &lt;镜像名&gt;:&lt;镜像tag&gt; /bin/bash &amp;&amp; command1 command2</span><br><span class="line">eg docker run -dit -p 5000:5000 training/webapp python app.py</span><br><span class="line">	-P：默认匹配docker容器的5000端口号到宿主机的49153 to 65535端口</span><br><span class="line">	-p &lt;HOT_PORT&gt;:&lt;CONTAINER_PORT&gt;：指定端口号</span><br><span class="line">	--name &lt;自定义容器名&gt;</span><br><span class="line">//查看容器进程</span><br><span class="line">docker ps -a //查看所有容器</span><br><span class="line">docker ps //查看运行中容器</span><br><span class="line">//查看docker的一些底层信息</span><br><span class="line">docker inspect</span><br><span class="line">//重新启动之前的容器</span><br><span class="line">docker start -i 容器名或者id</span><br><span class="line">//删除容器</span><br><span class="line">docker rm 容器id </span><br><span class="line">//删除镜像</span><br><span class="line">docker rmi 镜像id </span><br><span class="line">//退出交互式容器：后台</span><br><span class="line">Ctrl + p Ctrl+Q</span><br><span class="line">进入已经退出的容器</span><br><span class="line">docker attach id/name</span><br><span class="line">直接后台</span><br><span class="line">docker run -d 容器</span><br><span class="line">//查看日志</span><br><span class="line">docker logs -t（时间） -f(更新) 容器名</span><br><span class="line">//查看容器内进程</span><br><span class="line">docker top name</span><br><span class="line">//在容器中启动新进程</span><br><span class="line">docker exec [-d][-i][-t] 容器名[COMMAND][ARG...]  </span><br><span class="line">ps: docker exec -i -t 名字 进程</span><br><span class="line">//将容器另存为镜像</span><br><span class="line">docker commit --change='CMD ["启动命令，可选"]' -c "EXPOSE 22" centos123 centos</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>java 中级学习笔记</title>
    <url>/2018/67c5c210.html</url>
    <content><![CDATA[<p>一分耕耘一分收获，时间再晚也无法阻挡我学习的热情</p>
<span id="more"></span>

<h2 id="文件拆分"><a href="#文件拆分" class="headerlink" title="文件拆分"></a>文件拆分</h2><p>这里之前主要不太明白的是怎么把文件流拆分成相等的块，只拆分第一块还是明白的，第二块怎么处理呢，直到我看到了 <code>Arrays.copyOfRange()</code>，豁然开朗，在此记录 </p>
<p>解释：</p>
<p>与<a class="link" href="http://how2j.cn/k/array/array-copyarray/284.html#step575">使用 System.arraycopy 进行数组复制<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>类似的， Arrays 提供了一个 copyOfRange 方法进行数组复制。<br>不同的是 <code>System.arraycopy</code>，需要事先准备好目标数组，并分配长度。 <code>copyOfRange</code> 只需要源数组就就可以了，通过返回值，就能够得到目标数组了。<br>除此之外，需要注意的是 copyOfRange 的第 3 个参数，表示源数组的结束位置，是取不到的。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> stream;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStream</span> {</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">eachSize</span> <span class="operator">=</span> <span class="number">100</span> * <span class="number">1024</span>; <span class="comment">// 100k</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"d:/eclipse.exe"</span>);</span><br><span class="line">        splitFile(srcFile, eachSize);</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拆分的思路，先把源文件的所有内容读取到内存中，然后从内存中挨个分到子文件里</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcFile 要拆分的源文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eachSize 按照这个大小，拆分</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">splitFile</span><span class="params">(File srcFile, <span class="type">int</span> eachSize)</span> {</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == srcFile.length())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"文件长度为0，不可拆分"</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] fileContent = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) srcFile.length()];</span><br><span class="line">        <span class="comment">// 先把文件读取到数组中</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile);</span><br><span class="line">            fis.read(fileContent);</span><br><span class="line">            fis.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 计算需要被划分成多少份子文件</span></span><br><span class="line">        <span class="type">int</span> fileNumber;</span><br><span class="line">        <span class="comment">// 文件是否能被整除得到的子文件个数是不一样的</span></span><br><span class="line">        <span class="comment">// (假设文件长度是25，每份的大小是5，那么就应该是5个)</span></span><br><span class="line">        <span class="comment">// (假设文件长度是26，每份的大小是5，那么就应该是6个)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == fileContent.length % eachSize)</span><br><span class="line">            fileNumber = (<span class="type">int</span>) (fileContent.length / eachSize);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            fileNumber = (<span class="type">int</span>) (fileContent.length / eachSize) + <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fileNumber; i++) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">eachFileName</span> <span class="operator">=</span> srcFile.getName() + <span class="string">"-"</span> + i;</span><br><span class="line">            <span class="type">File</span> <span class="variable">eachFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(srcFile.getParent(), eachFileName);</span><br><span class="line">            <span class="type">byte</span>[] eachContent;</span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 从源文件的内容里，复制部分数据到子文件</span></span><br><span class="line">            <span class="comment">// 除开最后一个文件，其他文件大小都是100k</span></span><br><span class="line">            <span class="comment">// 最后一个文件的大小是剩余的</span></span><br><span class="line">            <span class="keyword">if</span> (i != fileNumber - <span class="number">1</span>) <span class="comment">// 不是最后一个</span></span><br><span class="line">                eachContent = Arrays.copyOfRange(fileContent, eachSize * i, eachSize * (i + <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">else</span> <span class="comment">// 最后一个</span></span><br><span class="line">                eachContent = Arrays.copyOfRange(fileContent, eachSize * i, fileContent.length);</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 写出去</span></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(eachFile);</span><br><span class="line">                fos.write(eachContent);</span><br><span class="line">                <span class="comment">// 记得关闭</span></span><br><span class="line">                fos.close();</span><br><span class="line">                System.out.printf(<span class="string">"输出子文件%s，其大小是 %d字节%n"</span>, eachFile.getAbsoluteFile(), eachFile.length());</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java 判断字符串是否包含某个字符</title>
    <url>/2018/b3681148.html</url>
    <content><![CDATA[<p>判断一个字符串是否包含某个子串的 n 种方法</p>
<ul>
<li>startsWith()</li>
<li>contains 方法</li>
<li> indexOf 方法</li>
</ul>
<span id="more"></span>

<h2 id="startsWith"><a href="#startsWith" class="headerlink" title="startsWith()"></a>startsWith()</h2><p>这个方法有两个变体并测试如果一个字符串开头的指定索引指定的前缀或在默认情况下从字符串开始位置</p>
<p>此方法定义的语法如下:</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startsWith</span><span class="params">(String prefix, <span class="type">int</span> toffset)</span></span><br><span class="line">or</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startsWith</span><span class="params">(String prefix)</span></span><br></pre></td></tr></tbody></table></figure></div>

<p> 这里是参数的细节:</p>
<ul>
<li>prefix – 要匹配的前缀。</li>
<li>toffset – 从哪里开始寻找字符串。</li>
</ul>
<p>返回值为 true 和 false</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>{</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span>{</span><br><span class="line">      <span class="type">String</span> <span class="variable">Str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">"Welcome to Yiibai.com"</span>);</span><br><span class="line"></span><br><span class="line">      System.out.print(<span class="string">"Return Value :"</span> );</span><br><span class="line">      System.out.println(Str.startsWith(<span class="string">"Welcome"</span>) );</span><br><span class="line"></span><br><span class="line">      System.out.print(<span class="string">"Return Value :"</span> );</span><br><span class="line">      System.out.println(Str.startsWith(<span class="string">"Tutorials"</span>) );</span><br><span class="line"></span><br><span class="line">      System.out.print(<span class="string">"Return Value :"</span> );</span><br><span class="line">      System.out.println(Str.startsWith(<span class="string">"Yiibai"</span>, <span class="number">11</span>) );</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="contains方法"><a href="#contains方法" class="headerlink" title="contains方法"></a><strong>contains 方法</strong></h2><p>java.lang.String.contains () 方法返回 true，当且仅当此字符串包含指定的 char 值序列</p>
<p>返回值为 true 和 false</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"abc"</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> str.contains(<span class="string">"a"</span>);</span><br><span class="line">        <span class="keyword">if</span>(status){</span><br><span class="line">            System.out.println(<span class="string">"包含"</span>);</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            System.out.println(<span class="string">"不包含"</span>);</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="indexOf方法"><a href="#indexOf方法" class="headerlink" title="indexOf方法"></a><strong>indexOf 方法</strong></h2><p>java.lang.String.indexOf () 的用途是在一个字符串中寻找一个字的位置，同时也可以判断一个字符串中是否包含某个字符</p>
<p>indexOf 的返回值为 int</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="string">"abcdefg"</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result1</span> <span class="operator">=</span> str1.indexOf(<span class="string">"ab"</span>);</span><br><span class="line">    <span class="keyword">if</span>(result1 != -<span class="number">1</span>){</span><br><span class="line">        System.out.println(<span class="string">"字符串str中包含子串“ab”"</span>+result1);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        System.out.println(<span class="string">"字符串str中不包含子串“ab”"</span>+result1);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java 文件读入流问题处理</title>
    <url>/2020/3ce8107e.html</url>
    <content><![CDATA[<h1 id="java输出流写入"><a href="#java输出流写入" class="headerlink" title="java输出流写入"></a>java 输出流写入</h1><p>在使用 mysql 的 <code>select * from a into outfile 'E:\\a.csv' character set utf8</code>, 如果字段中有换行，会被转义成 <code>\\n</code>,Tab 转义为 <code>\\t</code>，无法正常处理数据文件，使用 java 处理该文件，有一个现象，写入文件尾会出现’\u0000’乱码，乱码数量取决于定义的 buff 大小</p>
<span id="more"></span>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>(</span><br><span class="line">	<span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> </span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath), <span class="string">"utf-8"</span>),<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">100</span>);</span><br><span class="line">	<span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> </span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">BufferedWriter</span> (</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">OutputStreamReader</span>(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tofilePath), <span class="string">"utf-8"</span>),<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">100</span>);</span><br><span class="line">){</span><br><span class="line">	bw.write(<span class="string">""</span>);</span><br><span class="line">	<span class="type">char</span>[] buff = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">10249</span>*<span class="number">1024</span>*<span class="number">10</span>];</span><br><span class="line">	<span class="comment">//逐行读取会读取行错误</span></span><br><span class="line">	<span class="keyword">while</span>(br.read(buff)!=-<span class="number">1</span>){</span><br><span class="line">		<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buff);</span><br><span class="line">		<span class="comment">//正则替换所有\r</span></span><br><span class="line">		str = str.replaceAll(<span class="string">"\\r"</span>,<span class="string">""</span>);</span><br><span class="line">		<span class="comment">//正则替换\\n </span></span><br><span class="line">		str = str.replaceAll(<span class="string">"\\\\\\n"</span>,<span class="string">""</span>);</span><br><span class="line">		bw.append(str);</span><br><span class="line">	}</span><br><span class="line">}<span class="keyword">catch</span>(IOException e){}</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p> 对代码进行修改，去掉文件尾乱码</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>(</span><br><span class="line">	<span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> </span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath), <span class="string">"utf-8"</span>),<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">100</span>);</span><br><span class="line">	<span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> </span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">BufferedWriter</span> (</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">OutputStreamReader</span>(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tofilePath), <span class="string">"utf-8"</span>),<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">100</span>);</span><br><span class="line">){</span><br><span class="line">	bw.write(<span class="string">""</span>);</span><br><span class="line">	<span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">10249</span>*<span class="number">1024</span>*<span class="number">10</span>;</span><br><span class="line">	<span class="type">char</span>[] buff = <span class="keyword">new</span> <span class="title class_">char</span>[N];</span><br><span class="line">	<span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//逐行读取会读取行错误</span></span><br><span class="line">	<span class="keyword">while</span>((len=br.read(buff))!=-<span class="number">1</span>){</span><br><span class="line">		<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buff,<span class="number">0</span>,len);</span><br><span class="line">		<span class="comment">//正则替换所有\r</span></span><br><span class="line">		str = str.replaceAll(<span class="string">"\\r"</span>,<span class="string">""</span>);</span><br><span class="line">		<span class="comment">//正则替换\\n </span></span><br><span class="line">		str = str.replaceAll(<span class="string">"\\\\\\n"</span>,<span class="string">""</span>);</span><br><span class="line">		bw.append(str);</span><br><span class="line">		len = <span class="number">0</span>;</span><br><span class="line">	}</span><br><span class="line">}<span class="keyword">catch</span>(IOException e){}</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure></div>



]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>jsdelivr 被墙，hexo-next 切换为自定义 CDN</title>
    <url>/2022/2394798680.html</url>
    <content><![CDATA[<blockquote>
<p>Thank you all for your tests, feedback and support. I am personally sorry for the issues we had today.<br>We can consider the issue as resolved, now its a question of DNS propagation getting to everyone.<br>Our official announcement regarding the problems today:<br>Unfortunately today jsDelivr unexpectedly lost its ICP license in China. As effect the regional CDN disabled our account.</p>
<p>This resulted in the extended outage we had in mainland China and Taiwan.</p>
<p>Other regions were unaffected.</p>
<p>We understand how difficult it was for our users to experience this unique situation.</p>
<p>From now on all Chinese traffic will be served by “near China” locations provided by global CDN providers.</p>
<p>This will have the additional benefit of better failover logic in the future.</p>
</blockquote>
<blockquote>
<p><a class="link" href="https://github.com/jsdelivr/jsdelivr/issues/18348#issuecomment-997777996">https://github.com/jsdelivr/jsdelivr/issues/18348#issuecomment-997777996<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>在 <code>jsDelivr</code> 被吊销 ICP 许可证五个月后，<code>fastly.jsdelivr.net</code> 开始遭到污染，非魔法上网已经不能正常加载，各中原因不做讨论，无外乎<font color="red">滥用</font></p>
<p>本博客使用 Hexo 框架和 NexT 主题，默认使用的是 JSDelivr 作为 静态资源的 CDN 服务提供商，为了能正常访问，所以需要切换到国内 CDN</p>
<span id="more"></span>

<h2 id="1-升级Next主题"><a href="#1-升级Next主题" class="headerlink" title="1. 升级Next主题"></a>1. 升级 Next 主题</h2><p><code>hexo-theme-next</code> 在 <a class="link" href="https://github.com/next-theme/hexo-theme-next/releases/tag/v8.9.0">v8.9.0<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>已经支持自定义 cdn</p>
<ul>
<li><p>使用 npm 管理的</p>
  <div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目前最新的是8.11.1，大于8.9.0就可以</span></span><br><span class="line">npm install hexo-theme-next@8.11.1</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>使用 git 仓库管理的使用 git pull</p>
</li>
</ul>
<h2 id="2-修改Next主题CDN"><a href="#2-修改Next主题CDN" class="headerlink" title="2.修改Next主题CDN"></a>2. 修改 Next 主题 CDN</h2><p>参照 <a class="link" href="https://github.com/next-theme/hexo-theme-next/issues/424#issuecomment-998810166">issuses<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<table>
<thead>
<tr>
<th>运营方</th>
<th>节点</th>
<th>地域</th>
<th>链接及格式</th>
<th>上游</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td> 75CDN (360 前端)</td>
<td>360 自有节点？</td>
<td>全球 </td>
<td><a class="link" href="https://lib.baomitu.com/%7Bcdnjs%E6%A0%BC%E5%BC%8F%7D">https://lib.baomitu.com/{cdnjs 格式}<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
<td>cdnjs </td>
<td></td>
</tr>
<tr>
<td><del>知乎</del></td>
<td>阿里云</td>
<td>全球 </td>
<td><a class="link" href="https://unpkg.zhimg.com/%7Bunpkg%E6%A0%BC%E5%BC%8F%7D">https://unpkg.zhimg.com/{unpkg 格式}<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
<td>unpkg</td>
<td></td>
</tr>
<tr>
<td> 百度</td>
<td>百度云</td>
<td>全球 </td>
<td><a class="link" href="https://code.bdstatic.com/npm/%7Bunpkg%E6%A0%BC%E5%BC%8F%7D">https://code.bdstatic.com/npm/{unpkg 格式}<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
<td>内建 npm 镜像（上游淘宝 cmpnjs）</td>
<td></td>
</tr>
<tr>
<td>饿了么</td>
<td>阿里云</td>
<td>中国大陆 </td>
<td><a class="link" href="https://npm.elemecdn.com/%7Bunpkg%E6%A0%BC%E5%BC%8F%7D">https://npm.elemecdn.com/{unpkg 格式}<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
<td>unpkg?</td>
<td></td>
</tr>
</tbody></table>
<p>修改本地<code>_config.next.yml</code></p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># It's recommended to use the same version as in `_vendors.yml` to avoid potential problems.</span></span><br><span class="line"><span class="comment"># Remember to use the HTTPS protocol of CDN links when you enable HTTPS on your site.</span></span><br><span class="line"><span class="attr">vendors:</span></span><br><span class="line">  <span class="comment"># The CDN provider of NexT internal scripts.</span></span><br><span class="line">  <span class="comment"># Available values: local | jsdelivr | unpkg | cdnjs | custom</span></span><br><span class="line">  <span class="comment"># Warning: If you are using the latest master branch of NexT, please set `internal: local`</span></span><br><span class="line">  <span class="attr">internal:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># The default CDN provider of third-party plugins.</span></span><br><span class="line">  <span class="comment"># Available values: local | jsdelivr | unpkg | cdnjs | custom</span></span><br><span class="line">  <span class="comment"># Dependencies for `plugins: local`: https://github.com/next-theme/plugins</span></span><br><span class="line">  <span class="attr">plugins:</span> <span class="string">custom</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Custom CDN URL</span></span><br><span class="line">  <span class="comment"># For example:</span></span><br><span class="line">  <span class="comment"># custom_cdn_url: https://fastly.jsdelivr.net/npm/${npm_name}@${version}/${minified}</span></span><br><span class="line">  <span class="comment"># custom_cdn_url: https://fastly.jsdelivr.net/npm/${npm_name}@${version}/${minified}</span></span><br><span class="line">  <span class="comment"># custom_cdn_url: https://cdnjs.cloudflare.com/ajax/libs/${cdnjs_name}/${version}/${cdnjs_file}</span></span><br><span class="line">  <span class="comment"># jsdelivr: `https://fastly.jsdelivr.net/npm/${name}@${version}/${file}`,</span></span><br><span class="line">  <span class="comment"># unpkg : `https://unpkg.com/${name}@${version}/${file}`,</span></span><br><span class="line">  <span class="comment"># cdnjs : `https://cdnjs.cloudflare.com/ajax/libs/${alias || name}/${version}/${file.replace(/^(dist|lib|)\/(browser\/|)/, '')}`</span></span><br><span class="line">  <span class="attr">custom_cdn_url:</span> <span class="string">https://lib.baomitu.com/${cdnjs_name}/${version}/${cdnjs_file}</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="3-修改谷歌字体库"><a href="#3-修改谷歌字体库" class="headerlink" title="3. 修改谷歌字体库"></a>3. 修改谷歌字体库</h2><p>参照<a class="link" href="https://blog.csdn.net/AlvinCasper/article/details/112461876">别做无用功 - 禁止谷歌字体真的能加速网站访问速度吗？<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>修改<code>_config.next.yml</code> 配置项</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">font:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uri of fonts host, e.g. https://fonts.googleapis.com (Default).</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">https://fonts.geekzu.org</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="4-修改Valine"><a href="#4-修改Valine" class="headerlink" title="4.修改Valine"></a>4. 修改 Valine</h2><blockquote>
<p>npm install next-theme/hexo-next-valine#v2.0.0<br>新版 (2.1.0) 已经更换 CDN，可以直接使用</p>
</blockquote>
<p>博客使用了 Valine 作为评论系统，依赖于 <a class="link" href="https://github.com/next-theme/hexo-next-valine">next-theme/hexo-next-valine<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，查看源码发现将 <code>cdn.jsdelivr.net</code> 写死在代码里</p>
<p><a class="link" href="https://github.com/next-theme/hexo-next-valine/blob/main/valine.njk">https://github.com/next-theme/hexo-next-valine/blob/main/valine.njk<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'page:loaded'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">loadComments</span>(<span class="variable constant_">CONFIG</span>.<span class="property">valine</span>.<span class="property">el</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">getScript</span>(</span><br><span class="line">      <span class="string">'https://fastly.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js'</span>,</span><br><span class="line">      { <span class="attr">condition</span>: <span class="variable language_">window</span>.<span class="property">Valine</span> }</span><br><span class="line">    ))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Valine</span>(<span class="variable constant_">CONFIG</span>.<span class="property">valine</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">...</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">loadComments</span>(<span class="string">'#valine-comments'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">getScript</span>(<span class="string">'https://fastly.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Valine</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>({{ config.<span class="property">valine</span> | safedump }}, {</span><br><span class="line">      <span class="attr">el</span>: <span class="string">'#valine-comments'</span>,</span><br><span class="line">      <span class="attr">path</span>: {{ <span class="title function_">url_for</span>(page.<span class="property">path</span>) | <span class="title function_">replace</span>(r/index\.<span class="property">html$</span>/, <span class="string">''</span>) | safedump }},</span><br><span class="line">      <span class="attr">serverURLs</span>: {{ serverURLs | safedump }}</span><br><span class="line">    }));</span><br><span class="line">  }, <span class="variable language_">window</span>.<span class="property">Valine</span>);</span><br><span class="line">});</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>修改 <code>node_modules/hexo-next-valine/valine.njk</code></p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line">{%- <span class="keyword">if</span> next_data %}</span><br><span class="line"></span><br><span class="line">{{ <span class="title function_">next_data</span>(<span class="string">'valine'</span>, config.<span class="property">valine</span>, {</span><br><span class="line">  <span class="attr">el</span>: <span class="string">'#valine-comments'</span>,</span><br><span class="line">  <span class="attr">path</span>: <span class="title function_">url_for</span>(page.<span class="property">path</span>) | <span class="title function_">replace</span>(r/index\.<span class="property">html$</span>/, <span class="string">''</span>),</span><br><span class="line">  <span class="attr">libUrl</span>: config.<span class="property">valine</span>.<span class="property">libUrl</span> | <span class="title function_">default</span>(<span class="string">'https://lib.baomitu.com/valine/latest/Valine.min.js'</span>,<span class="literal">true</span>),</span><br><span class="line">  <span class="attr">serverURLs</span>: config.<span class="property">valine</span>.<span class="property">serverURLs</span> or <span class="string">'https://'</span> + config.<span class="property">valine</span>.<span class="property">appId</span>.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">8</span>) | lower + <span class="string">'.api.lncldglobal.com'</span></span><br><span class="line">}) }}</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'page:loaded'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">loadComments</span>(<span class="variable constant_">CONFIG</span>.<span class="property">valine</span>.<span class="property">el</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">getScript</span>(</span><br><span class="line">      <span class="variable constant_">CONFIG</span>.<span class="property">valine</span>.<span class="property">libUrl</span>,</span><br><span class="line">      { <span class="attr">condition</span>: <span class="variable language_">window</span>.<span class="property">Valine</span> }</span><br><span class="line">    ))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Valine</span>(<span class="variable constant_">CONFIG</span>.<span class="property">valine</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">{%- <span class="keyword">else</span> %}</span><br><span class="line"></span><br><span class="line">{%- set serverURLs = config.<span class="property">valine</span>.<span class="property">serverURLs</span> or <span class="string">'https://'</span> + config.<span class="property">valine</span>.<span class="property">appId</span>.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">8</span>) | lower + <span class="string">'.api.lncldglobal.com'</span> %}</span><br><span class="line">{%- set libUrl =  config.<span class="property">valine</span>.<span class="property">libUrl</span> | <span class="title function_">default</span>(<span class="string">'https://lib.baomitu.com/valine/latest/Valine.min.js'</span>,<span class="literal">true</span>) %}</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">loadComments</span>(<span class="string">'#valine-comments'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="title class_">NexT</span>.<span class="property">utils</span>.<span class="title function_">getScript</span>(<span class="string">'{{libUrl}}'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Valine</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>({{ config.<span class="property">valine</span> | safedump }}, {</span><br><span class="line">      <span class="attr">el</span>: <span class="string">'#valine-comments'</span>,</span><br><span class="line">      <span class="attr">path</span>: {{ <span class="title function_">url_for</span>(page.<span class="property">path</span>) | <span class="title function_">replace</span>(r/index\.<span class="property">html$</span>/, <span class="string">''</span>) | safedump }},</span><br><span class="line">      <span class="attr">serverURLs</span>: {{ serverURLs | safedump }}</span><br><span class="line">    }));</span><br><span class="line">  }, <span class="variable language_">window</span>.<span class="property">Valine</span>);</span><br><span class="line">});</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">{%- endif %}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>使用 <code>patch-package</code> 修改 node_module，配合 github/actions 使用</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">npm i patch-package -D</span><br></pre></td></tr></tbody></table></figure></div>

<p>生成补丁包</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">npx patch-package hexo-next-valine</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>_config.next.yml</code> 增加配置项</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">valine:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">appId:</span> <span class="string">xx</span> <span class="comment"># Your leancloud application appid</span></span><br><span class="line">  <span class="attr">appKey:</span> <span class="string">xx</span> <span class="comment"># Your leancloud application appkey</span></span><br><span class="line">  <span class="comment"># library CDN url, you can set this to your preferred CDN</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="string">https://cdnjs.cloudflare.com/ajax/libs/valine/1.4.18/Valine.min.js</span></span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>cdn</tag>
      </tags>
  </entry>
  <entry>
    <title>neo4j 数据库使用 Bolt 转换 RestApi 请求结果格式</title>
    <url>/2020/e526b597.html</url>
    <content><![CDATA[<p>在做图数据库的数据库可视化的时候，使用到了 <a class="link" href="https://github.com/eisman/neo4jd3">eisman/neo4jd3<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>这个可视化库，查看了一下其数据格式，发现和 neo4j 自带的 RestApi 接口大致一致</p>
<span id="more"></span>

<p>d3 库数据格式为👇，</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"results"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"columns"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"user"</span><span class="punctuation">,</span> <span class="string">"entity"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"data"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                    <span class="attr">"graph"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"nodes"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"1"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"labels"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"User"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                                    <span class="attr">"userId"</span><span class="punctuation">:</span> <span class="string">"eisman"</span></span><br><span class="line">                                <span class="punctuation">}</span></span><br><span class="line">                            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"8"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"labels"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"Project"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                                    <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"neo4jd3"</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">"title"</span><span class="punctuation">:</span> <span class="string">"neo4jd3.js"</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">"description"</span><span class="punctuation">:</span> <span class="string">"Neo4j graph visualization using D3.js."</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">"url"</span><span class="punctuation">:</span> <span class="string">"https://eisman.github.io/neo4jd3"</span></span><br><span class="line">                                <span class="punctuation">}</span></span><br><span class="line">                            <span class="punctuation">}</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"relationships"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"7"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"DEVELOPES"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"startNode"</span><span class="punctuation">:</span> <span class="string">"1"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"endNode"</span><span class="punctuation">:</span> <span class="string">"8"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                                    <span class="attr">"from"</span><span class="punctuation">:</span> <span class="number">1470002400000</span></span><br><span class="line">                                <span class="punctuation">}</span></span><br><span class="line">                            <span class="punctuation">}</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"errors"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>而 neo4j RestAPI 返回的数据为↓，可以看到两者的格式还是有些地方不一样的</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"results"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"columns"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"p"</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"data"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                    <span class="attr">"row"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"updateDate"</span><span class="punctuation">:</span> <span class="number">1608600619</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"departmentId"</span><span class="punctuation">:</span> <span class="number">880</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"sex"</span><span class="punctuation">:</span> <span class="string">"35"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"mobile"</span><span class="punctuation">:</span> <span class="string">"11112247826"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"classificationLevel"</span><span class="punctuation">:</span> <span class="string">"非密"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"political"</span><span class="punctuation">:</span> <span class="string">"党员"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"birth"</span><span class="punctuation">:</span> <span class="number">801936000</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"userCode"</span><span class="punctuation">:</span> <span class="string">"110000200001010001"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"syncId"</span><span class="punctuation">:</span> <span class="string">"1"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"post"</span><span class="punctuation">:</span> <span class="string">"会计"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"isImportant"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"leaveDate"</span><span class="punctuation">:</span> <span class="number">1608600622</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"张三"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"national"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"email"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"education_degree"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"createDate"</span><span class="punctuation">:</span> <span class="number">1607576509</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"status"</span><span class="punctuation">:</span> <span class="string">"在职"</span></span><br><span class="line">                            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"updateDate"</span><span class="punctuation">:</span> <span class="number">1608600619</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"财务部"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"pid"</span><span class="punctuation">:</span> <span class="number">879</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"order"</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"syncId"</span><span class="punctuation">:</span> <span class="string">"880"</span></span><br><span class="line">                            <span class="punctuation">}</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"meta"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"node"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"deleted"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"relationship"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"deleted"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">{</span></span><br><span class="line">                                <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"node"</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">"deleted"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                            <span class="punctuation">}</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"errors"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>使用 postman 请求 Neo4j REST API  <a class="link" href="https://neo4j.com/docs/rest-docs/current/">文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<ul>
<li>这里用到的接口 <code>/db/data/transaction/commit</code></li>
<li>POST body</li>
</ul>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"statements"</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"statement"</span><span class="punctuation">:</span> <span class="string">"MATCH p=(n:oa_userInfo)-[:`部门`]-() where n.name='张三' RETURN p LIMIT 25"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting20201222220744889.png" alt="img"></p>
<p>这里要加上鉴权，以及请求头 <code>Content-Type: application/json</code><br><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting20200818184955486.png" alt="在这里插入图片描述"><br>这样就可以得到上边的结果，可以使用 neo4jd3 对数据渲染</p>
<p>由于在系统中已经使用了 bolt 的连接方式，于是尝试使用 <code>neo4j.ogm</code> 驱动中的 session 去请求查询，将结果转换，返回和 RestApi 一样的结果<br>在 <code>springboot</code> 中可以直接取得 <code>SessionFactory</code> (编码使用的是 kotlin)</p>
<div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> sessionFactory: SessionFactory</span><br></pre></td></tr></tbody></table></figure></div>

<p>  声明一个结果类</p>
  <div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QueryRest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">results</span>(</span><br><span class="line">            <span class="keyword">var</span> errors: MutableList&lt;Any&gt;?,</span><br><span class="line">            <span class="keyword">var</span> results: MutableList&lt;Result&gt;?</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Result</span>(</span><br><span class="line">            <span class="keyword">var</span> columns: MutableList&lt;String&gt;,</span><br><span class="line">            <span class="keyword">var</span> `<span class="keyword">data</span>`: MutableList&lt;Data&gt;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Data</span>(</span><br><span class="line">            <span class="keyword">var</span> graph: Graph</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Graph</span>(</span><br><span class="line">            <span class="keyword">var</span> nodes: List&lt;Node&gt;,</span><br><span class="line">            <span class="keyword">var</span> relationships: List&lt;Relationship&gt;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Node</span>(</span><br><span class="line">            <span class="keyword">var</span> id: String,</span><br><span class="line">            <span class="keyword">var</span> labels: ArrayList&lt;String&gt;,</span><br><span class="line">            <span class="keyword">var</span> properties: Any?</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Relationship</span>(</span><br><span class="line">            <span class="keyword">var</span> endNode: String,</span><br><span class="line">            <span class="keyword">var</span> id: String,</span><br><span class="line">            <span class="keyword">var</span> properties: Any?,</span><br><span class="line">            <span class="keyword">var</span> startNode: String,</span><br><span class="line">            <span class="keyword">var</span> type: String</span><br><span class="line">    )</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>ServerImpl</p>
<blockquote>
<p>初步实现的效果，直接传递 <code>Cypher</code> 语句并不严谨，可能会存在注入问题</p>
</blockquote>
<div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">query</span><span class="params">(sql: <span class="type">String</span>)</span></span>: QueryRest.results {</span><br><span class="line">    <span class="keyword">val</span> session: Session = sessionFactory.openSession()</span><br><span class="line">    <span class="keyword">val</span> grep = session.query(sql, mutableMapOf&lt;String, String&gt;())</span><br><span class="line">    <span class="keyword">val</span> results = mutableListOf&lt;QueryRest.Result&gt;()</span><br><span class="line">    <span class="keyword">val</span> columns = mutableListOf&lt;String&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> datas = mutableListOf&lt;QueryRest.Data&gt;()</span><br><span class="line">    grep.forEach { map -&gt;</span><br><span class="line">        map.forEach { (key, value) -&gt;</span><br><span class="line">            columns.add(key)</span><br><span class="line">            <span class="keyword">val</span> v = value <span class="keyword">as</span> Array&lt;*&gt;</span><br><span class="line">            v.forEach {</span><br><span class="line">                <span class="keyword">val</span> vv = it <span class="keyword">as</span> Path.Segment</span><br><span class="line">                <span class="keyword">val</span> nodeStart = QueryRest.Node(</span><br><span class="line">                        id = vv.start().id().toString(),</span><br><span class="line">                        labels = vv.start().labels() <span class="keyword">as</span> ArrayList&lt;String&gt;,</span><br><span class="line">                        properties = vv.start().asMap()</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">val</span> nodeEnd = QueryRest.Node(</span><br><span class="line">                        id = vv.end().id().toString(),</span><br><span class="line">                        labels = vv.end().labels() <span class="keyword">as</span> ArrayList&lt;String&gt;,</span><br><span class="line">                        properties = vv.end().asMap()</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">val</span> nodes = mutableListOf&lt;QueryRest.Node&gt;(nodeStart, nodeEnd)</span><br><span class="line">                <span class="keyword">val</span> relationship = QueryRest.Relationship(</span><br><span class="line">                        id = vv.relationship().id().toString(),</span><br><span class="line">                        type = vv.relationship().type(),</span><br><span class="line">                        startNode = vv.relationship().startNodeId().toString(),</span><br><span class="line">                        endNode = vv.relationship().endNodeId().toString(),</span><br><span class="line">                        properties = vv.relationship().asMap()</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">val</span> relationships = mutableListOf&lt;QueryRest.Relationship&gt;(relationship)</span><br><span class="line">                <span class="keyword">val</span> graph = QueryRest.Graph(nodes, relationships)</span><br><span class="line">                datas.add(QueryRest.Data(graph))</span><br><span class="line">                logger.info(<span class="string">"<span class="variable">$value</span> -- <span class="variable">$vv</span>"</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    results.add(QueryRest.Result(columns.distinct() <span class="keyword">as</span> MutableList&lt;String&gt;, datas))</span><br><span class="line">    <span class="keyword">return</span> QueryRest.results(mutableListOf(), results)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>over</p>
<hr>
<blockquote>
<p>2020/12/22 更新</p>
</blockquote>
<p>使用过程中发现 ogm 的一个 TODO，是否自动映射 Bean，现在我使用的 <code>neo4j-ogm-bolt-driver:3.2.18</code> 默认是开启映射的，所以上方的转换代码可能会出现一些问题，影响到我们功能的使用。<br><code>Are we going to use the neo4jOperations conversion method to cast the value object to its proper class?</code></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * a cypher statement this method will return a Result object containing a collection of Map's which represent Neo4j</span></span><br><span class="line"><span class="comment"> * objects as properties, along with query statistics if applicable.</span></span><br><span class="line"><span class="comment"> * Each element of the query result is a map which you can access by the name of the returned field</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> Are we going to use the neo4jOperations conversion method to cast the value object to its proper class?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cypher     The parameterisable cypher to execute.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parameters Any parameters to attach to the cypher.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> readOnly   true if the query is readOnly, false otherwise</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A {<span class="doctag">@link</span> Result} of {<span class="doctag">@link</span> Iterable}s with each entry representing a neo4j object's properties.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Result <span class="title function_">query</span><span class="params">(String cypher, Map&lt;String, ?&gt; parameters, <span class="type">boolean</span> readOnly)</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting20201222221528514.png" alt="在这里插入图片描述"><br>通过 Debug neo4j-ogm 源代码，找到自动转换的类，发现无法使用重写解决，经过研究 <code>Neo4jSession</code> 的类变量，针对这个问题，对原有的 <code>handlers</code> 做了如下更改：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> fun <span class="title function_">handlers</span><span class="params">(grep: org.neo4j.ogm.model.Result)</span>: QueryRest.results {</span><br><span class="line">        <span class="type">val</span> <span class="variable">results</span> <span class="operator">=</span> mutableListOf&lt;QueryRest.Result&gt;()</span><br><span class="line">        <span class="type">val</span> <span class="variable">columns</span> <span class="operator">=</span> mutableListOf&lt;String&gt;()</span><br><span class="line">        <span class="type">val</span> <span class="variable">daTas</span> <span class="operator">=</span> mutableListOf&lt;QueryRest.Data&gt;()</span><br><span class="line">        grep.forEach { map -&gt;</span><br><span class="line">            map.forEach { (key, value) -&gt;</span><br><span class="line">                columns.add(key)</span><br><span class="line">                <span class="keyword">if</span> (value is Array&lt;*&gt;) {</span><br><span class="line">                    <span class="comment">// 是查询的结点关系数据</span></span><br><span class="line">                    <span class="comment">// MATCH p=(n)-[r]-()</span></span><br><span class="line">                    value.forEach {</span><br><span class="line">                        <span class="type">val</span> <span class="variable">vv</span> <span class="operator">=</span> it as Path.Segment</span><br><span class="line">                        <span class="type">val</span> <span class="variable">nodeStart</span> <span class="operator">=</span> QueryRest.Node(</span><br><span class="line">                            id = vv.start().id().toString(),</span><br><span class="line">                            labels = vv.start().labels() as ArrayList&lt;String&gt;,</span><br><span class="line">                            properties = vv.start().asMap()</span><br><span class="line">                        )</span><br><span class="line">                        <span class="type">val</span> <span class="variable">nodeEnd</span> <span class="operator">=</span> QueryRest.Node(</span><br><span class="line">                            id = vv.end().id().toString(),</span><br><span class="line">                            labels = vv.end().labels() as ArrayList&lt;String&gt;,</span><br><span class="line">                            properties = vv.end().asMap()</span><br><span class="line">                        )</span><br><span class="line">                        <span class="type">val</span> <span class="variable">nodes</span> <span class="operator">=</span> mutableListOf&lt;QueryRest.Node&gt;(nodeStart, nodeEnd)</span><br><span class="line">                        <span class="type">val</span> <span class="variable">relationship</span> <span class="operator">=</span> QueryRest.Relationship(</span><br><span class="line">                            id = vv.relationship().id().toString(),</span><br><span class="line">                            type = vv.relationship().type(),</span><br><span class="line">                            startNode = vv.relationship().startNodeId().toString(),</span><br><span class="line">                            endNode = vv.relationship().endNodeId().toString(),</span><br><span class="line">                            properties = vv.relationship().asMap()</span><br><span class="line">                        )</span><br><span class="line">                        <span class="type">val</span> <span class="variable">relationships</span> <span class="operator">=</span> mutableListOf&lt;QueryRest.Relationship&gt;(relationship)</span><br><span class="line">                        <span class="type">val</span> <span class="variable">graph</span> <span class="operator">=</span> QueryRest.Graph(nodes, relationships)</span><br><span class="line">                        daTas.add(QueryRest.Data(graph))</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (value is NodeModel) {</span><br><span class="line">                    <span class="comment">// 是查询的结点数据</span></span><br><span class="line">                    <span class="comment">// MATCH (n:make_sec_entity) RETURN n LIMIT 3</span></span><br><span class="line">                    <span class="type">val</span> <span class="variable">arraylist</span> <span class="operator">=</span> ArrayList&lt;String&gt;(<span class="number">7</span>)</span><br><span class="line">                    value.labels.forEach {</span><br><span class="line">                        arraylist.add(it)</span><br><span class="line">                    }</span><br><span class="line">                    <span class="type">val</span> <span class="variable">propertiesMap</span> <span class="operator">=</span> HashMap&lt;String, String&gt;(<span class="number">8</span>)</span><br><span class="line">                    value.propertyList.forEach {</span><br><span class="line">                        propertiesMap[it.key] = it.value.toString()</span><br><span class="line">                    }</span><br><span class="line">                    <span class="type">val</span> <span class="variable">node</span> <span class="operator">=</span> QueryRest.Node(</span><br><span class="line">                        id = value.id.toString(),</span><br><span class="line">                        labels = arraylist,</span><br><span class="line">                        properties = propertiesMap</span><br><span class="line">                    )</span><br><span class="line">                    <span class="type">val</span> <span class="variable">nodes</span> <span class="operator">=</span> mutableListOf(node)</span><br><span class="line">                    daTas.add(QueryRest.Data(QueryRest.Graph(nodes, <span class="literal">null</span>)))</span><br><span class="line">                    <span class="comment">// throw BizException(500, "暂时不可查询未计算关系的数据")</span></span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="type">val</span> <span class="variable">node</span> <span class="operator">=</span> beanToNodeModel(value)</span><br><span class="line">                    <span class="type">val</span> <span class="variable">nodes</span> <span class="operator">=</span> mutableListOf(node)</span><br><span class="line">                    daTas.add(QueryRest.Data(QueryRest.Graph(nodes, <span class="literal">null</span>)))</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        results.add(QueryRest.Result(columns.distinct() as? MutableList&lt;String&gt;, daTas))</span><br><span class="line">        <span class="keyword">if</span> (results.size != <span class="number">0</span>) {</span><br><span class="line">            logger.info(<span class="string">"-*---图数据查询成功"</span>)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> QueryRest.results(mutableListOf(), results)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> fun <span class="title function_">beanToNodeModel</span><span class="params">(bean: Any)</span>: QueryRest.Node {</span><br><span class="line">        <span class="type">val</span> <span class="variable">neo4jSession</span> <span class="operator">=</span> session as Neo4jSession</span><br><span class="line">        <span class="type">val</span> <span class="variable">metadata</span> <span class="operator">=</span> neo4jSession.metaData()</span><br><span class="line">        <span class="type">val</span> <span class="variable">label</span> <span class="operator">=</span> metadata.classInfo(bean::class.java).neo4jName()</span><br><span class="line">        <span class="type">val</span> <span class="variable">id</span> <span class="operator">=</span> metadata.classInfo(bean::class.java).getFieldInfo(<span class="string">"id"</span>).read(bean)</span><br><span class="line">        <span class="keyword">return</span> QueryRest.Node(</span><br><span class="line">            id = id.toString(),</span><br><span class="line">            labels = arrayListOf(label),</span><br><span class="line">            properties = bean</span><br><span class="line">        )</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>neo4j</tag>
      </tags>
  </entry>
  <entry>
    <title>php 接入单点</title>
    <url>/2024/4120651335.html</url>
    <content><![CDATA[<p><a class="link" href="https://tbox.fun/">工具站<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>后台是极简风的登录系统，想着接入 <code>passKey</code>，看了一下挺复杂，还是先接入下局域网部署的 <code>authelia</code> 吧</p>
<blockquote>
<p>前置条件：服务器可以访问到 authelia</p>
</blockquote>
<span id="more"></span>

<h2 id="authelia-介绍及配置"><a href="#authelia-介绍及配置" class="headerlink" title="authelia 介绍及配置"></a>authelia 介绍及配置</h2><p><a class="link" href="https://www.authelia.com/">Authelia<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 是一个开源身份验证和授权服务器和门户，它履行信息安全的身份和访问管理 (IAM) 角色，通过 Web 门户为您的应用程序提供多因素身份验证和单点登录 (SSO)。它充当常见反向代理的伴侣。</p>
<p>其以下特点是我选择它的重要原因：</p>
<ul>
<li>轻量级<blockquote>
<p>压缩容器大小小于 20 兆字节，并且观察到的内存使用量通常在 30 兆字节以下，它是最轻量级的解决方案之一</p>
</blockquote>
</li>
<li>速度超快 ⚡<blockquote>
<p>用 Go 和 React 编写，授权策略和许多其他后端任务仅在几毫秒内完成，100 毫秒的登录门户加载时间使其成为最快的解决方案之一。</p>
</blockquote>
</li>
</ul>
<p><code>Authelia</code> 主要配置都在 yml 文件中，打开 yml 配置文件，在合适位置添加 client 配置，<a class="link" href="https://www.authelia.com/integration/prologue/introduction/">配置参考<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## Identity Providers</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="attr">identity_providers:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># OpenID Connect (Identity Provider)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># It's recommended you read the documentation before configuration of this section:</span></span><br><span class="line">  <span class="comment"># https://www.authelia.com/c/oidc</span></span><br><span class="line">  <span class="attr">oidc:</span></span><br><span class="line">    <span class="comment"># The hmac_secret is used to sign OAuth2 tokens (authorization code, access tokens and refresh tokens).</span></span><br><span class="line">    <span class="comment"># HMAC Secret can also be set using a secret: https://www.authelia.com/c/secrets</span></span><br><span class="line">    <span class="attr">hmac_secret:</span> <span class="string">'abc123abc123abc'</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="comment">## Clients is a list of known clients and their configuration.</span></span><br><span class="line">    <span class="attr">clients:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">client_id:</span> <span class="string">'tool'</span></span><br><span class="line">        <span class="attr">client_name:</span> <span class="string">'tool'</span></span><br><span class="line">        <span class="attr">client_secret:</span> <span class="string">'$pbkdf2-sha512$310000$c8p78n7pUMln0jzvd4aK4Q$JNRBzwAo0ek5qKn50cFzzvE9RXV88h1wJn5KGiHrD0YKtZaR/nCb2CJPOsKaPK0hjf.9yHxzQGZziziccp6Yng'</span>  <span class="comment"># The digest of 'insecure_secret'.</span></span><br><span class="line">        <span class="attr">public:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">authorization_policy:</span> <span class="string">'two_factor'</span></span><br><span class="line">        <span class="attr">require_pkce:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">pkce_challenge_method:</span> <span class="string">'S256'</span></span><br><span class="line">        <span class="attr">redirect_uris:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">'https://服务器地址/oidc/oidc_login.php'</span></span><br><span class="line">        <span class="attr">scopes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">'openid'</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">'profile'</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">'email'</span></span><br><span class="line">        <span class="attr">userinfo_signed_response_alg:</span> <span class="string">'none'</span></span><br><span class="line">        <span class="attr">token_endpoint_auth_method:</span> <span class="string">'client_secret_basic'</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="登录页配置"><a href="#登录页配置" class="headerlink" title="登录页配置"></a>登录页配置</h2><p>在登陆页添加按钮，a 标签访问 oidc_login.php</p>
<p>大致如下</p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-form-item demo-login-other"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"padding: 0 21px 0 6px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"../oidc/oidc_login.php"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"layui-icon layui-icon-auz"</span> <span class="attr">style</span>=<span class="string">"color: #3492ed;"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="php-后端代码"><a href="#php-后端代码" class="headerlink" title="php 后端代码"></a>php 后端代码</h3><p>PHP 后端库使用的是 <a class="link" href="https://github.com/jumbojett/OpenID-Connect-PHP">OpenID-Connect-PHP<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>按照文档，在项目根目录安装</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">composer require jumbojett/openid-connect-php</span><br></pre></td></tr></tbody></table></figure></div>

<p>创建文件 <code>oidc/oidc_login.php</code></p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 启用session，以便登录成功后设置状态</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="comment">// 按照实际所在位置修改</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Jumbojett</span>\<span class="title">OpenIDConnectClient</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Jumbojett</span>\<span class="title">OpenIDConnectClientException</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// 初始化 OIDC 客户端</span></span><br><span class="line">    <span class="variable">$oidc</span> = <span class="keyword">new</span> <span class="title class_">OpenIDConnectClient</span>(</span><br><span class="line">        <span class="comment">// OIDC 提供者 URL,Authelia服务所在地址</span></span><br><span class="line">        <span class="string">'https://auth.xxx.xxx'</span>,</span><br><span class="line">        <span class="comment">// 从提供者控制台获得的 client_id</span></span><br><span class="line">        <span class="string">'tool'</span>,</span><br><span class="line">        <span class="comment">// 从提供者控制台获得的 client_secret</span></span><br><span class="line">        <span class="string">'insecure_secret'</span></span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">setCodeChallengeMethod</span>(<span class="string">'S256'</span>);</span><br><span class="line">     <span class="comment">// 回调 URL（当前php的地址），登陆成功后返回当前php</span></span><br><span class="line">    <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">setRedirectURL</span>(<span class="string">'http://xxx/oidc/oidc_login.php'</span>);</span><br><span class="line">    <span class="comment">// 请求的用户信息</span></span><br><span class="line">    <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">addScope</span>([<span class="string">'openid'</span>, <span class="string">'email'</span>, <span class="string">'profile'</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否有 'code' 参数以确定是否是回调</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'code'</span>])) {</span><br><span class="line">        <span class="comment">// 用户授权后，OIDC 提供程序会将用户重定向回此 URL，并带上授权码（code）</span></span><br><span class="line">        <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">authenticate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取用户信息</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">requestUserInfo</span>(<span class="string">'name'</span>);</span><br><span class="line">        <span class="variable">$email</span> = <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">requestUserInfo</span>(<span class="string">'email'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> =  [<span class="string">"nick"</span> =&gt; <span class="variable">$name</span>, <span class="string">"email"</span> =&gt; <span class="variable">$email</span>];</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">'user'</span>] = <span class="variable">$user</span>;</span><br><span class="line">        <span class="comment">// 在这里处理用户信息，可以将用户信息保存到数据库或创建会话等</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"欢迎, <span class="subst">$name</span>! 邮箱是 <span class="subst">$email</span>."</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里想跳到哪里按照实际填写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;meta http-equiv='refresh' content='3; url=/' /&gt;"</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 如果没有授权码，启动 OIDC 认证流程</span></span><br><span class="line">        <span class="variable">$oidc</span>-&gt;<span class="title function_ invoke__">authenticate</span>();</span><br><span class="line">    }</span><br><span class="line">} <span class="keyword">catch</span> (OpenIDConnectClientException <span class="variable">$e</span>) {</span><br><span class="line">    <span class="comment">// 捕获并显示 OIDC 认证过程中的异常</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"登录出错: "</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;a href='/login'&gt;返回&lt;/a&gt;"</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整体流程还是很简单的，接下来看看 passkey 的接入</p>
<pre class="mermaid">%% Example of sequence diagram
 sequenceDiagram;
  用户-&gt;&gt;oidc_login.php : 请求
  oidc_login.php-&gt;&gt;Authelia : 组成参数302跳转Authelia
  Authelia-&gt;&gt; oidc_login.php: 携带结果返回
  oidc_login.php-&gt;&gt;Authelia : 获取用户信息</pre>
]]></content>
      <tags>
        <tag>php</tag>
        <tag>OIDC</tag>
        <tag>authelia</tag>
      </tags>
  </entry>
  <entry>
    <title>poi-ooxml 在 gradle 上 publishmaven 的调整</title>
    <url>/2021/2954458456.html</url>
    <content><![CDATA[<blockquote>
<p>摘抄<br>Apache POI 简介是用 Java 编写的免费开源的跨平台的 Java API，Apache POI 提供 API 给 Java 程式对 Microsoft Office（Excel、WORD、PowerPoint、Visio 等）格式档案读和写的功能。POI 为 “Poor Obfuscation Implementation” 的首字母缩写，意为 “可怜的模糊实现”。</p>
</blockquote>
<p>官方主页： <a class="link" href="http://poi.apache.org/index.html">http://poi.apache.org/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>API 文档： <a class="link" href="http://poi.apache.org/apidocs/index.html">http://poi.apache.org/apidocs/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<span id="more"></span>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>项目中使用了 poi-ooxml，但是有些地方需要调整，所有拿到 1.4.2 的源码进行了适当的修改<br>源码使用了 gradle，理所当然的需要使用 gradle 将源码推送到仓库中，参见上一篇中的修改<a href="https://blog.tbox.fun/2021/3213641848.htm">解析 word 内嵌文件名中文乱码</a></p>
<h2 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h2><ul>
<li><p>源码修改后无法 build</p>
</li>
<li><p>使用 <code>publishToMavenLocal</code> 本地测试时发现，某些方法无法正常编译，原因是缺少包，定位到 poi-ooxml 依赖引入问题，我本地 <code>publishToMavenLocal</code> 的依赖和原先包的依赖不同。</p>
</li>
</ul>
<h2 id="无法-build-问题"><a href="#无法-build-问题" class="headerlink" title="无法 build 问题"></a>无法 build 问题</h2><p>根目录有一个 <code>build.xml</code> 会去下载一些 <code>Office Open XML</code> 规范之类的东西，无法 build 是因为这些地址太老已经 <code>404</code> 了<br>从网上搜索了一些替代镜像 <code>https://docs.huihoo.com/ooxml/</code>，但是不知道什么原因依旧无法 build</p>
<p>找到官网相关地址 <code>https://www.ecma-international.org/publications-and-standards/standards/ecma-376/</code><br><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN@master/ImageHosting/image.1yyv0l8c81xc.png" alt="image">，下载，解压后本地搭建 http，替换原先地址一气呵成，成功解决 build 问题</p>
<h2 id="publish-踩坑"><a href="#publish-踩坑" class="headerlink" title="publish 踩坑"></a>publish 踩坑</h2><p>以为是打包没有把依赖都加进去，因为缺少的正好是 <code>ooxml-schemas</code></p>
<div class="code-container" data-rel="Gradle"><figure class="iseeu highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> {</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':main'</span>)</span><br><span class="line">        <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':scratchpad'</span>)  <span class="comment">// <span class="doctag">TODO:</span> get rid of this dependency!</span></span><br><span class="line">        <span class="keyword">compile</span> files(<span class="string">'../../ooxml-lib/ooxml-schemas-1.4.jar'</span>)</span><br><span class="line">        <span class="keyword">compile</span> files(<span class="string">'../../ooxml-lib/ooxml-security-1.1.jar'</span>)</span><br><span class="line">        ...</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>调整打包脚本发现包太大了，直线上升 40M，感觉应该不是这里的问题。</p>
<h2 id="原本打包方式"><a href="#原本打包方式" class="headerlink" title="原本打包方式"></a>原本打包方式</h2><p>参考原来项目自带的打包方式，发现原项目是用 sh 脚本打包的，使用 maven，项目下有.pom 文件</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/image-20210826112429037.png" alt="image-20210826112429037"></p>
<p>gradle 生成的 pom 和这个有些差别，gradle 是根据本地引用来生成的，gradle 生成的里边有 11 个 <code>dependencies</code>(原项目写的只有四个依赖) 唯独缺少</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml-schemas<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>@VERSION@<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/image-20210826112649475.png" alt="image-20210826112649475"></p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>经过搜索如何引入 pom 当做模板生成最终 pom，未果</p>
<p>找到的示例 <code>maven-publish</code> 插件只有新增，修改选项</p>
<p>基于此，通过查阅插件源码发现 <code>Node</code> 结点的文档 (见参考)，找到删除方法</p>
<p>最终修改结果如下</p>
<div class="code-container" data-rel="Groovy"><figure class="iseeu highlight groovy"><table><tbody><tr><td class="code"><pre><span class="line">publishing {</span><br><span class="line">    publications {</span><br><span class="line">        basic(MavenPublication) {</span><br><span class="line">            pom.withXml {</span><br><span class="line">                <span class="keyword">def</span> root = asNode()</span><br><span class="line">                <span class="keyword">def</span> oldDependenciesNode = root.getAt(<span class="string">"dependencies"</span>)[<span class="number">0</span>]</span><br><span class="line">                root.remove(oldDependenciesNode)</span><br><span class="line">                <span class="keyword">def</span> dependenciesNode = root.appendNode(<span class="string">'dependencies'</span>)</span><br><span class="line">                Node xml = <span class="keyword">new</span> XmlParser().parse(<span class="string">"../../maven/poi-ooxml.pom"</span>)</span><br><span class="line">                xml.dependencies.first().each {</span><br><span class="line">                    <span class="keyword">def</span> dependencyNode = dependenciesNode.appendNode(<span class="string">'dependency'</span>)</span><br><span class="line">                    dependencyNode.appendNode(<span class="string">'groupId'</span>, it.getAt(<span class="string">"groupId"</span>)[<span class="number">0</span>].value())</span><br><span class="line">                    dependencyNode.appendNode(<span class="string">'artifactId'</span>, it.getAt(<span class="string">"artifactId"</span>)[<span class="number">0</span>].value())</span><br><span class="line">                    <span class="keyword">def</span> v = it.getAt(<span class="string">"version"</span>)[<span class="number">0</span>].value()</span><br><span class="line">                    <span class="keyword">if</span>(v.contains(<span class="string">"@VERSION@"</span>)){</span><br><span class="line">                        v = version</span><br><span class="line">                    }</span><br><span class="line">                    dependencyNode.appendNode(<span class="string">'version'</span>,v)</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            artifactId = <span class="string">"poi-ooxml"</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同时需要禁用gradle 元数据生成 https://docs.gradle.org/current/userguide/publishing_gradle_module_metadata.html</span></span><br><span class="line"><span class="comment">// 因为如果不禁用，我们只修改了pom生成，元数据生成还是原来的，使用方如果是gradle，还会发生以前的问题</span></span><br><span class="line"></span><br><span class="line">tasks.withType(GenerateModuleMetadata) {</span><br><span class="line">    enabled = <span class="literal">false</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a class="link" href="https://stackoverflow.com/questions/20959558/in-gradle-how-can-i-generate-a-pom-file-with-dynamic-dependencies-resolved-to-t">In Gradle, how can I generate a POM file with dynamic dependencies resolved to the actual version used?<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" href="https://github.com/gradle/gradle/blob/cf443ec830b0ae086b47c288801f67f633fdda84/subprojects/maven/src/main/java/org/gradle/api/publish/maven/plugins/MavenPublishPlugin.java#L186">gradle 源码<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" href="https://github.com/gradle/gradle/blob/cf443ec830b0ae086b47c288801f67f633fdda84/subprojects/core-api/src/main/java/org/gradle/api/XmlProvider.java#L24">gradle-XmlProvider - 代码<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" href="https://docs.groovy-lang.org/latest/html/api/groovy/util/Node.html">groovy-Node 手册<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" href="http://www.xknote.com/ask/60d0259ae8e94.html">Gradle 不包括已发布的 pom.xml 中的依赖项<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>python3.5.2 下载安装 Tensorflow</title>
    <url>/2018/4efee0a5.html</url>
    <content><![CDATA[<p>安装的翻译官方文档 <a class="link" href="http://wiki.jikexueyuan.com/project/tensorflow-zh/get_started/os_setup.html">极客学院<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>按照文档直接安装可能会安装不上，我使用的是 virtualenv 安装方式</p>
<p>下面说一下遇到的问题</p>
<span id="more"></span>

<p>Ubuntu16.04 默认 virtualenv 虚拟机是 python2.7 版本的，这里先弄一个 python3.5 版本的</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">virtualenv --system-site-packages -p /usr/bin/python3.5 ~/tensorflow3</span><br></pre></td></tr></tbody></table></figure></div>

<p>打开 virtualenv 镜像</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cd tensorflow3</span><br><span class="line">#切换工作路径到镜像</span><br><span class="line">source bin/activate  </span><br></pre></td></tr></tbody></table></figure></div>

<p>从官网下载的 <a class="link" href="https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.8.0-cp34-cp34m-linux_x86_64.whl">https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.8.0-cp34-cp34m-linux_x86_64.whl<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>直接安装会报出如下错误</p>
<p><code>Cannot install tensorflow on fresh ubuntu partition: tensorflow-0.8.0-cp34-cp34m-linux_x86_64.whl is not a supported wheel on this platform</code></p>
<p>因为官方安装包是 py3.4 版本，直接安装的话可能会出现问题，这里有个解决方法</p>
<p><strong>主要步骤</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">#通过wget命令获取whl</span><br><span class="line">$ wget https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.8.0-cp34-cp34m-linux_x86_64.whl</span><br><span class="line">#将whl重命名</span><br><span class="line">$ mv tensorflow-0.8.0-cp34-cp34m-linux_x86_64.whl tensorflow-0.8.0-py3-none-linux_x86_64.whl</span><br><span class="line">#使用--ignore-installed标记防止错误的产生,权限问题的话加上sudo</span><br><span class="line">$ pip install --ignore-installed --upgrade tensorflow-0.8.0-py3-none-linux_x86_64.whl</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>tensorflow</tag>
      </tags>
  </entry>
  <entry>
    <title>python 图片分割</title>
    <url>/2018/894aeec1.html</url>
    <content><![CDATA[<p>要用到 Python 中的 PIL (Python Image Library) 库，学习一个关于图片分割的 demo</p>
<span id="more"></span>

<p>这是发的一个朋友圈，切图前是一张图，切图后就是九张图</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fu6u6jf4swj30u01hc4hx.jpg" alt="image"></p>
<p>除了可以处理规整的正方形图片，还可以处理非规则的图片。比如宽度远大于高度的图片，取宽和高之间的较大值，然后填充白色，就可以构造出一张正方形的图片啦。</p>
<p>PIL 库是一个非常强大的 Python 图像处理标准库，但是呢，由于 PIL 支持 Python2.7，所以使用 Python3 的程序媛 men 又在 PIL 的基础上分离出来一个分支，创建了另外一个库 Pillow。Pillow 兼容大部分 PIL 语法，使用起来也方便。第一次使用需要安装，以下是 Python2.7 版本示例，这里安装 PIL</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install python-imaging</span><br><span class="line">或者</span><br><span class="line">pip install pillow -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></tbody></table></figure></div>

<p>Python3 的要安装 <code>Pillow</code>，如果安装了 Anaconda，Pillow 就已经可用了。否则，需要在命令行下通过 pip 安装</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">pip3 install pillow -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>下面写一下如何使用 PIL 库实现图片分割</strong></p>
<p>思路如下</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fu6qu2dqpjj307p0gi41c.jpg" alt="思路图"></p>
<p>对应代码（有相关注释）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">将一张图片填充为正方形后切成9张图</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">#_1_#将图片填充为正方形</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill_image</span>(<span class="params">image</span>):</span><br><span class="line">    width,height = image.size</span><br><span class="line">    <span class="comment">#选取长和宽中的较大值作为新图片的长和宽</span></span><br><span class="line">    new_image_legth = width <span class="keyword">if</span> width &gt; height <span class="keyword">else</span> height</span><br><span class="line">    <span class="comment">#生成新图片【白底】</span></span><br><span class="line">    new_image = Image.new(image.mode,(new_image_legth,new_image_legth),color=<span class="string">'white'</span>)</span><br><span class="line">    <span class="comment">#将之前的图片粘贴到新图片上，居中</span></span><br><span class="line">    <span class="keyword">if</span> width &gt; height:<span class="comment">#原图宽大于高，则填充图片竖直维度</span></span><br><span class="line">        <span class="comment">#（x，y）二元组表示粘贴上图相对下图的起始位置</span></span><br><span class="line">        new_image.paste(image, (<span class="number">0</span>, <span class="built_in">int</span>((new_image_legth - height) / <span class="number">2</span>)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        new_image.paste(image ,(<span class="built_in">int</span>((new_image_legth - width) / <span class="number">2</span>), <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> new_image</span><br><span class="line"><span class="comment">#_2_切图</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cut_image</span>(<span class="params">image</span>):</span><br><span class="line">    width,height = image.size</span><br><span class="line">    item_width = <span class="built_in">int</span>(width / <span class="number">3</span>)</span><br><span class="line">    box_list = []</span><br><span class="line">    <span class="comment">#(left,upper,right,lower)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">3</span>):<span class="comment">#两重循环，生成9张图片基于原图的位置</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">3</span>):</span><br><span class="line">            box = (j*item_width,i*item_width,(j+<span class="number">1</span>)*item_width,(i+<span class="number">1</span>)*item_width)</span><br><span class="line">            box_list.append(box)</span><br><span class="line">    image_list = [image.crop(box) <span class="keyword">for</span> box <span class="keyword">in</span> box_list]</span><br><span class="line">    <span class="keyword">return</span> image_list</span><br><span class="line"></span><br><span class="line"><span class="comment">#_3_保存</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_images</span>(<span class="params">image_list</span>):</span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> image_list:</span><br><span class="line">        image.save(<span class="string">'./image/python'</span>+<span class="built_in">str</span>(index) + <span class="string">'.png'</span>, <span class="string">'PNG'</span>)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    file_path = <span class="string">"1.jpg"</span></span><br><span class="line">    image = Image.<span class="built_in">open</span>(file_path)</span><br><span class="line">    <span class="comment">#image.show()#打开图片</span></span><br><span class="line">    image = fill_image(image)</span><br><span class="line">    image_list = cut_image(image)</span><br><span class="line">    save_images(image_list)</span><br></pre></td></tr></tbody></table></figure></div>

<p>示例原图</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/006NPPBTly1fu6u8rjfjgj30j60pkhca.jpg" alt="image"></p>
<p>成功后的图</p>
<p>图片可能太大了☺, 删除了</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（一）</title>
    <url>/2018/2459ae9b.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>本节讲解 python 的安装<br>2.7 和 3.5 版本的切换<br>python 基础学习的途径<br>IDE 的使用</p>
</blockquote>
<span id="more"></span>

<p>PC 端左侧查看目录，点击即可直达</p>
<p>以下正文：</p>
<p>python 都知道？</p>
<p>Python [1]  （英国发音：/ˈpaɪθən/ 美国发音：/ˈpaɪθɑːn/）, 是一种面向对象的解释型<a class="link" href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80">计算机程序设计语言<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，由荷兰人 <a class="link" href="https://baike.baidu.com/item/Guido%20van%20Rossum">Guido van Rossum<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>于 1989 年发明，第一个公开发行版发行于 1991 年。</p>
<p>Python 是纯粹的<a class="link" href="https://baike.baidu.com/item/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6/405190">自由软件<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>， <a class="link" href="https://baike.baidu.com/item/%E6%BA%90%E4%BB%A3%E7%A0%81/3969">源代码<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>和<a class="link" href="https://baike.baidu.com/item/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>CPython 遵循 <a class="link" href="https://baike.baidu.com/item/GPL">GPL<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>(<a class="link" href="https://baike.baidu.com/item/GNU">GNU<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> General Public License) 协议。Python 语法简洁清晰，特色之一是强制用空白符 (white space) 作为语句缩进。</p>
<p>Python 具有丰富和强大的库。它常被昵称为<a class="link" href="https://baike.baidu.com/item/%E8%83%B6%E6%B0%B4%E8%AF%AD%E8%A8%80/3564482">胶水语言<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，能够把用其他语言制作的各种模块（尤其是 <a class="link" href="https://baike.baidu.com/item/C/7252092">C<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>/<a class="link" href="https://baike.baidu.com/item/C%2B%2B">C++<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>）很轻松地联结在一起。常见的一种应用情形是，使用 Python 快速生成程序的原型（有时甚至是程序的最终界面），然后对其中有特别要求的部分，用更合适的语言改写，比如 <a class="link" href="https://baike.baidu.com/item/3D%E6%B8%B8%E6%88%8F">3D 游戏<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>中的图形渲染模块，性能要求特别高，就可以用 <a class="link" href="https://baike.baidu.com/item/C%2FC%2B%2B/6824246">C/C++<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>重写，而后封装为 Python 可以调用的扩展类库。需要注意的是在您使用扩展类库时可能需要考虑平台问题，某些可能不提供<a class="link" href="https://baike.baidu.com/item/%E8%B7%A8%E5%B9%B3%E5%8F%B0/8558902">跨平台<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>的实现。—–摘自百度百科</p>
<p><a class="link" href="https://baike.baidu.com/item/Python/407313?fr=aladdin">想要了解更多，点我直达百度百科<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装 python</h2><p>python 是一种跨平台语言，在 pc 上无论你使用哪种系统，都可以轻松的学习 python，如果你有其他语言 c、c++、java、php 等任何一门语言的学习经验，那么再看 python 你会轻松很多。现在 python 有两个版本，分别为 2.x 和 3.x，这两个版本会有某些语法上的不兼容，你的电脑可以把两个版本都安装，我这里安装的是 2.7 和 3.5</p>
<h3 id="在Mac上安装Python"><a href="#在Mac上安装Python" class="headerlink" title="在Mac上安装Python"></a>在 Mac 上安装 Python</h3><p>如果你正在使用 Mac，系统是 OS X 10.8~10.10，那么系统自带的 Python 版本是 2.7。要安装最新的 Python 3.6，有两个方法：</p>
<p>方法一：从 Python 官网下载 Python 3.6 的<a class="link" href="https://www.python.org/ftp/python/3.6.3/python-3.6.3-macosx10.6.pkg">安装程序<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>（网速慢的同学请移步<a class="link" href="https://pan.baidu.com/s/1kU5OCOB#list/path=%2Fpub%2Fpython">国内镜像<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>），双击运行并安装；</p>
<p>方法二：如果安装了 Homebrew，直接通过命令 <code>brew install python3</code> 安装即可。</p>
<h3 id="在Linux上安装Python"><a href="#在Linux上安装Python" class="headerlink" title="在Linux上安装Python"></a>在 Linux 上安装 Python</h3><p>如果你正在使用 Linux，那我可以假定你有 Linux 系统管理经验，自行安装 Python 3 应该没有问题，否则，请换回 Windows 系统。</p>
<p>对于大量的目前仍在使用 Windows 的同学，如果短期内没有打算换 Mac，就可以继续阅读以下内容。</p>
<h3 id="在Windows上安装Python"><a href="#在Windows上安装Python" class="headerlink" title="在Windows上安装Python"></a>在 Windows 上安装 Python</h3><p>首先，根据你的 Windows 版本（64 位还是 32 位）从 Python 的官方网站下载 Python 3.6 对应的 <a class="link" href="https://www.python.org/ftp/python/3.6.3/python-3.6.3-amd64.exe">64 位安装程序<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>或 <a class="link" href="https://www.python.org/ftp/python/3.6.3/python-3.6.3.exe">32 位安装程序<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>（网速慢的同学请移步<a class="link" href="https://pan.baidu.com/s/1kU5OCOB#list/path=%2Fpub%2Fpython">国内镜像<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>），然后，运行下载的 EXE 安装包：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200519151017.png"></p>
<p>安装教程摘自廖雪峰老师博客</p>
<p>此时如果你打开命令行窗口 输入 python 如果显示</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200519151225.jpg"></p>
<p>说明你安装成功</p>
<h2 id="python版本的切换"><a href="#python版本的切换" class="headerlink" title="python版本的切换"></a>python 版本的切换</h2><p>这里我展示的是基于 Ubuntu（Linux 系统）的相关方法，望知悉</p>
<p>摘自我的 csdn 博客</p>
<h3 id="介绍两个方法"><a href="#介绍两个方法" class="headerlink" title="介绍两个方法"></a>介绍两个方法</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>ubuntu16.04 默认安装了 python2.7 和 3.5</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">cd /usr/bin  </span><br><span class="line">ls |grep python </span><br></pre></td></tr></tbody></table></figure></div>

<p>查看有哪些版本</p>
<p>之后，进行相互切换操作</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo rm /usr/bin/python</span><br><span class="line">sudo ln -s /usr/bin/python3.5 /usr/bin/python</span><br></pre></td></tr></tbody></table></figure></div>

<p>主要就是你需要用哪一个版本，你就把哪一个版本放到 python 的系统文件夹路径里，之前需要将目前的版本移出即可。</p>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>列出版本</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo update-alternatives --list python  </span><br></pre></td></tr></tbody></table></figure></div>

<p>选择</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo update-alternatives --config python</span><br></pre></td></tr></tbody></table></figure></div>

<p>如果第一条命令 “无 python 候选项”</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1</span>  </span><br><span class="line">update-alternatives: using /usr/bin/python2.7 to provide /usr/bin/python (python) in auto mode  </span><br><span class="line">update-alternatives --install /usr/bin/python python /usr/bin/python3.5 2  </span><br><span class="line">update-alternatives: using /usr/bin/python3.5 to provide /usr/bin/python (python) in auto mode  </span><br></pre></td></tr></tbody></table></figure></div>

<p>先 su 切换到 root 用户再执行上面命令添加</p>
<h2 id="基础学习"><a href="#基础学习" class="headerlink" title="基础学习"></a>基础学习</h2><p> 推荐 <a class="link" href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000">廖雪峰老师博客<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="工具IDE"><a href="#工具IDE" class="headerlink" title="工具ＩＤＥ"></a>工具ＩＤＥ</h2><ul>
<li>pycharm</li>
<li>IDEA 也可以</li>
</ul>
<p>以上工具学生认证免费</p>
<p>破解请留言获取</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（七）</title>
    <url>/2018/36ec0175.html</url>
    <content><![CDATA[<p>多线程抓取表情包</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1b8vyj-j4.webp" alt="image.png"></p>
<span id="more"></span>

<p>用的新浪的图床，不用顾虑表情包网站服务器压力的问题，可以实验操作一下</p>
<p>其他网站还请手下留情，尽量不要用多线程爬别人网站，学习的目的不是破坏</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095550604.webp" alt="image"></p>
<p>正文开始</p>
<p>首先初始化锁</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">gLock = threading.Lock()</span><br></pre></td></tr></tbody></table></figure></div>

<p>创建一个数组存放表情包链接地址，名字</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">FACE_URL_LIST = []</span><br><span class="line"><span class="comment">#名字</span></span><br><span class="line">FACE_NAME_LIST = []</span><br></pre></td></tr></tbody></table></figure></div>

<p>同上一个单线程的 demo，先保存链接</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">1500</span>):</span><br><span class="line">    url = BESE_PAGE_URL + <span class="built_in">str</span>(x)</span><br><span class="line">    PAGE_URL_LIST.append(url)</span><br></pre></td></tr></tbody></table></figure></div>

<p>定义一个生产者，负责从每个页面中提取表情 URL</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(PAGE_URL_LIST) &gt; <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment">#在访问PAGE_URL_LIST中要使用锁机制</span></span><br><span class="line">            gLock.acquire()</span><br><span class="line">            page_url = PAGE_URL_LIST.pop()</span><br><span class="line">            <span class="comment">#使用完把锁释放，方便其他线程使用</span></span><br><span class="line">            gLock.release()</span><br><span class="line">            <span class="comment">#url请求</span></span><br><span class="line">            response = requests.get(page_url)</span><br><span class="line">            <span class="comment">#使用返回的数据构建ｂｅｓｕ对象</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#requests对象中　response.content返回的是二进制的数值，</span></span><br><span class="line">            <span class="comment"># response.text返回的是Unicode型的数据</span></span><br><span class="line">            <span class="comment"># 也就是说，如果你想获取文本，可以通过.text</span></span><br><span class="line">            <span class="comment"># 如果你想获取图片，文件可以通过　.content</span></span><br><span class="line">            soup = BeautifulSoup(response.content,<span class="string">'lxml'</span>)</span><br><span class="line">            img_list = soup.find(<span class="string">'div'</span>,class_ = <span class="string">'page-content'</span>).find_all(<span class="string">'img'</span>,class_ = <span class="string">'img-responsive lazy image_dta'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#加锁</span></span><br><span class="line">            gLock.acquire()</span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> img_list:</span><br><span class="line">                title = img[<span class="string">'alt'</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(img_list):</span><br><span class="line">                    src = img[<span class="string">'data-original'</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(title)</span><br><span class="line">                <span class="built_in">print</span>(src)</span><br><span class="line">                <span class="comment"># 把提取到的表情url，添加到FACE_URL_LIST中</span></span><br><span class="line">                FACE_URL_LIST.append(src)</span><br><span class="line">                FACE_NAME_LIST.append(title)</span><br><span class="line">            <span class="comment">#释放</span></span><br><span class="line">            gLock.release()</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>多线程相比单线程重要的是使用某种资源时要为它<code>加锁</code>，用完及时释放资源<code>解锁</code></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#消费者，负责从FACE_URL_LIST中提取链接，并下载</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Consumer</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">'%s is runing'</span> % threading.current_thread()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment">#上锁</span></span><br><span class="line">            gLock.acquire()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(FACE_URL_LIST)==<span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(FACE_NAME_LIST)==<span class="number">0</span>:</span><br><span class="line">                <span class="comment">#不管什么情况，先释放锁</span></span><br><span class="line">                gLock.release()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment">#提取数据</span></span><br><span class="line">                face_url = FACE_URL_LIST.pop()</span><br><span class="line">                filename = FACE_NAME_LIST.pop()</span><br><span class="line">                gLock.release()</span><br><span class="line">                z = face_url[-<span class="number">4</span>:]  <span class="comment">#后缀取名</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">#防止名字过长出错　２０１８．０９．０５</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(filename) &gt; <span class="number">20</span> :</span><br><span class="line">                    filename = filename[:<span class="number">20</span>]</span><br><span class="line">                path = <span class="string">'images2'</span>+ <span class="string">'/'</span> +filename.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>)+z</span><br><span class="line">                urllib.urlretrieve(face_url,path)</span><br></pre></td></tr></tbody></table></figure></div>

<p>详细作用都在注释里</p>
<p>最后创建多线程调用上边的函数</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#两个生产者线程</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        Producer().start()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#５个消费者</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        Consumer().start()</span><br></pre></td></tr></tbody></table></figure></div>

<p>爬虫暂时告一段落</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（三）</title>
    <url>/2018/5951e111.html</url>
    <content><![CDATA[<p>本节：</p>
<p>带 Cookies 的访问</p>
<p>设置 headers 访问绕过网站检测</p>
<p>　<span id="more"></span></p>
<h2 id="设置Headers"><a href="#设置Headers" class="headerlink" title="设置Headers"></a>设置 Headers</h2><p>有些网站会验证访问者是否合法，所以上一节的访问方式在一些网站就会<code>失灵</code> ，网站对请求不予以响应，为了模拟浏览器工作，我们需要设置一些 Headers 属性。</p>
<p>我们再来看一下访问网站的一些请求，打开 Chrome 浏览器，按 F12 打开 开发者工具</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://wx2.sinaimg.cn/large/006NPPBTly1fsfrc872vqj31ah0o9as1.jpg" alt="image"></p>
<p>（允许我皮一下）</p>
<p>第一个请求返回的状态码是 302，是一个网页跳转，我截图让大家看的是 Request Headers，这里包含了文件编码、压缩方式、cookie、Host、UA 等一些信息，大部分网站只要传入一个 UA 就可以啦，当然有些网站会加入防盗链，如果遇到，还要加入 Referer 字段，后边的实战例子会说</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="comment">#有header</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">url = <span class="string">"http://www.baidu.com/"</span></span><br><span class="line">value = {<span class="string">'username'</span>:<span class="string">'tsvico'</span>,<span class="string">'password'</span>:<span class="string">'123456789'</span>}<span class="comment">#如果提交数据中需要传参，在这里填入</span></span><br><span class="line">header = {<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span>,</span><br><span class="line">          <span class="string">'host'</span>:<span class="string">'www.baidu.com'</span>,</span><br><span class="line">          <span class="string">'Referer'</span>:<span class="string">'http://www.baidu.com'</span>}</span><br><span class="line"><span class="comment">#头中多个数据用','相隔</span></span><br><span class="line">data = urllib.urlencode(value)</span><br><span class="line">request = urllib2.Request(url,data,header)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>上边的例子中传递了参数和 headers，大体格式就是这个样子。</p>
<p>如果请求不需要传递参数直接置空就可以</p>
<p>我们设置了一个 Headers，在构建 request 时传入，在请求时，就加入了 headers 传送，服务器若识别了是浏览器发来的请求，就会得到响应。</p>
<p>特别的，这里要写一下这些属性的意思</p>
<p><code>User-Agent</code>: 有些服务器或 Proxy 会通过该值来判断是否是浏览器发出的请求 Content-Type : 在使用 REST 接口时，服务器会检查该值，用来确定 HTTP Body 中的内容该怎样解析。</p>
<p><code>application/xml</code>： 在 XML RPC，如 RESTful/SOAP 调用时使用</p>
<p><code>application/json</code>： 在 JSON RPC 调用时使用</p>
<p><code>application/x-www-form-urlencoded</code> ： 浏览器提交 Web 表单时使用 在使用服务器提供的 RESTful 或 SOAP 服务时， Content-Type 设置错误会导致服务器拒绝服务</p>
<h2 id="Proxy（代理）的设置"><a href="#Proxy（代理）的设置" class="headerlink" title="Proxy（代理）的设置"></a>Proxy（代理）的设置</h2><p>urllib2 默认会使用环境变量 http_proxy 来设置 HTTP Proxy。假如一个网站它会检测某一段时间某个 IP 的访问次数，如果访问次数过多，它会禁止你的访问。所以你可以设置一些代理服务器来帮助你做工作，每隔一段时间换一个代理</p>
<p>下面一段代码说明了代理的设置用法</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">enable_proxy = <span class="literal">True</span></span><br><span class="line">proxy_handler = urllib2.ProxyHandler({<span class="string">"http"</span> : <span class="string">'http://some-proxy.com:8080'</span>})</span><br><span class="line">null_proxy_handler = urllib2.ProxyHandler({})</span><br><span class="line"><span class="keyword">if</span> enable_proxy:</span><br><span class="line">    opener = urllib2.build_opener(proxy_handler)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    opener = urllib2.build_opener(null_proxy_handler)</span><br><span class="line">urllib2.install_opener(opener)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="Timeout-设置"><a href="#Timeout-设置" class="headerlink" title="Timeout 设置"></a>Timeout 设置</h2><p>上一节已经说过 urlopen 方法了，第三个参数就是 timeout 的设置，可以设置等待多久超时，为了解决一些网站实在响应过慢而造成的影响。</p>
<p>例如下面的代码，如果第二个参数 data 为空那么要特别指定是 timeout 是多少，写明形参，如果 data 已经传入，则不必声明。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">response = urllib2.urlopen(<span class="string">'http://www.baidu.com'</span>, timeout=<span class="number">10</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">response = urllib2.urlopen(<span class="string">'http://www.baidu.com'</span>,data, <span class="number">10</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="URLError"><a href="#URLError" class="headerlink" title="URLError"></a>URLError</h2><p>网络异常捕获</p>
<p>这里在调试程序时作用很大，有助于分析源码</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">url = <span class="string">"http://www.baidu.com/"</span></span><br><span class="line">value = {}<span class="comment">#如果提交数据中需要传参，在这里填入</span></span><br><span class="line">header = {<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span>,</span><br><span class="line">          <span class="string">'host'</span>:<span class="string">'www.baidu.com'</span>}</span><br><span class="line"><span class="comment">#头中多个数据用','相隔</span></span><br><span class="line">data = urllib.urlencode(value)</span><br><span class="line">request = urllib2.Request(url,data,header)</span><br><span class="line"><span class="comment">#异常处理</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = urllib2.urlopen(request)</span><br><span class="line"><span class="keyword">except</span> urllib2.URLError,e:</span><br><span class="line">    <span class="built_in">print</span> e.code</span><br><span class="line">    <span class="built_in">print</span> e.reason</span><br><span class="line"><span class="built_in">print</span> data</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>上边代码加入了异常捕获</p>
<h2 id="Cookie保存"><a href="#Cookie保存" class="headerlink" title="Cookie保存"></a>Cookie 保存</h2><p>Cookie，有时也用其复数形式&nbsp;<a class="link" href="https://baike.baidu.com/item/Cookies/187064">Cookies<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，指某些网站为了辨别用户身份、进行 session 跟踪而储存在用户本地终端上的数据（通常经过加密）。定义于 RFC2109 和 2965 中的都已废弃，最新取代的规范是 RFC6265&nbsp;&nbsp;。（可以叫做浏览器缓存）</p>
<p>有些网站内容时要在登陆后才能展示的，我们可以利用 Urllib2 库保存登录的 Cookie，并请求 Headers 时加入，达到获取数据的目的</p>
<h3 id="Cookielib"><a href="#Cookielib" class="headerlink" title="Cookielib"></a>Cookielib</h3><p>cookielib 模块的主要作用是提供可存储 cookie 的对象，以便于与 urllib2 模块配合使用来访问 Internet 资源。Cookielib 模块非常强大，我们可以利用本模块的 CookieJar 类的对象来捕获 cookie 并在后续连接请求时重新发送，比如可以实现模拟登录功能。该模块主要的对象有 CookieJar、FileCookieJar、MozillaCookieJar、LWPCookieJar。</p>
<p>它们的关系：CookieJar —- 派生 —-&gt;FileCookieJar  —- 派生 —–&gt;MozillaCookieJar 和 LWPCookieJar</p>
<h4 id="1-获取Cookie保存到变量"><a href="#1-获取Cookie保存到变量" class="headerlink" title="1.获取Cookie保存到变量"></a>1. 获取 Cookie 保存到变量</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> cookielib</span><br><span class="line"><span class="comment">#声明一个CookieJar对象实例来保存Cookie</span></span><br><span class="line">cookie = cookielib.CookieJar();</span><br><span class="line"><span class="comment">#利用urllib库的HTTPCookieProcessor对象来创建cookie处理器</span></span><br><span class="line">handle = urllib2.HTTPCookieProcessor(cookie)</span><br><span class="line"><span class="comment">#通过handle来个构建opener</span></span><br><span class="line">opener = urllib2.build_opener(handle)</span><br><span class="line"><span class="comment">#此处的open方法同urllib2的urlopen方法，也可以传入request</span></span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">'http://www.baidu.com'</span>)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> cookie:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">'Name = '</span>+item.name</span><br><span class="line">    <span class="built_in">print</span> <span class="string">'Value = '</span>+item.value</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095627395.webp" alt="image"></p>
<h4 id="2-保存Cookie到文件"><a href="#2-保存Cookie到文件" class="headerlink" title="2.保存Cookie到文件"></a>2. 保存 Cookie 到文件</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cookielib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置保存cookie的文件</span></span><br><span class="line">filenme = <span class="string">'cookie.txt'</span></span><br><span class="line"><span class="comment">#声明一个MozillaCookieJar对象实例来保存cookie，之后写入文件</span></span><br><span class="line">cookie = cookielib.MozillaCookieJar(filenme)</span><br><span class="line"><span class="comment">#利用urllib2库的HTTPCookieProcessor对象来创建cookie处理器</span></span><br><span class="line">handle = urllib2.HTTPCookieProcessor(cookie)</span><br><span class="line"><span class="comment">#通过handle来构建opener</span></span><br><span class="line">opener = urllib2.build_opener(handle)</span><br><span class="line"><span class="comment">#此处的open方法同urllib2的urlopen方法，也可以传入request</span></span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">'http://www.baidu.com'</span>)</span><br><span class="line"><span class="comment">#保存cookie到文件</span></span><br><span class="line">cookie.save(ignore_discard=<span class="literal">True</span>,ignore_expires=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#关于最后save方法的两个参数在此说明一下：</span></span><br><span class="line"><span class="comment">#官方解释如下：</span></span><br><span class="line"><span class="comment">#ignore_discard: save even cookies set to be discarded.</span></span><br><span class="line"><span class="comment">#ignore_expires: save even cookies that have expiredThe file is overwritten if it already exists</span></span><br><span class="line"><span class="comment">#由此可见，ignore_discard的意思是即使cookies将被丢弃也将它保存下来，</span></span><br><span class="line"><span class="comment">#ignore_expires的意思是如果在该文件中 cookies已经存在，则覆盖原文件写入，</span></span><br><span class="line"><span class="comment">#在这里，我们将这两个全部设置为True。运行之后，cookies将被保存到cookie.txt文件中</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>具体讲解都写在了注释里</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095654764.webp" alt="image"></p>
<h4 id="3-从文件获取Cookie"><a href="#3-从文件获取Cookie" class="headerlink" title="3.从文件获取Cookie"></a>3. 从文件获取 Cookie</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cookielib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建ＭozillaCookieJar实例对象</span></span><br><span class="line">cookie = cookielib.MozillaCookieJar()</span><br><span class="line"><span class="comment">#从文件中读取Ｃｏｏｋｉｅ信息到变量</span></span><br><span class="line">cookie.load(<span class="string">'cookie.txt'</span>,ignore_expires=<span class="literal">True</span>,ignore_discard=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#创建请求的request</span></span><br><span class="line">req = urllib2.Request(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line"><span class="comment">#利用urllib2的ｂuild_opener方法创建一个ｏｐｅｎｅｒ</span></span><br><span class="line">opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookie))</span><br><span class="line">response = opener.<span class="built_in">open</span>(req)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>有了 Cookie 就能对大多数网站进行操作了</p>
<p>本文写作方式以及部分内容借鉴<a class="link" href="https://cuiqingcai.com/">静觅<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>博客</p>
<p>下一节 HTML 解析，与妹子图爬取</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（二）</title>
    <url>/2018/144f4243.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>用 python 发送一个请求</p>
<p>获取百度首页源码</p>
<p>打开了我的 IDEA</p>
<span id="more"></span>

<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200519151627.png"></p>
<p>接上一篇 <a href="http://blog.tbox.fun/2018/06/python%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E4%B8%80.html">入门到放弃一</a></p>
<p>本文用到的是 python2.7 版本</p>
<p>浏览器的一次请求，输入 url 到地址栏、回车</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200519151723.png"></p>
<p>最后返回一个网页，在请求方式来讲，这是一种 get 请求</p>
<p>在一次请求发送中</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/mw690/006NPPBTly1fsa16baq4gj309b0eewgr.jpg" alt="image"></p>
<p>可以看到还向 <a class="link" href="http://www.baidu.com发送了user-agent(简称ua),host,cookie等数据/">www.baidu.com 发送了 User-Agent（简称 UA），Host，cookie 等数据<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>我们使用模拟请求工具访问</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsa19e6c61j30q50g7diu.jpg" alt="image"></p>
<p>可以看到返回的数据实际上时 HTML 代码，只是自动被浏览器解析后才变成了我们看到的网页</p>
<p>下面我们提出第一个问题</p>
<h2 id="爬虫是什么"><a href="#爬虫是什么" class="headerlink" title="爬虫是什么"></a>爬虫是什么</h2><p>如果我们把互联网比作一张大的蜘蛛网，数据便是存放于蜘蛛网的各个节点，而爬虫就是一只小蜘蛛，沿着网络抓取自己的猎物（数据）爬虫指的是：向网站发起请求，获取资源后分析并提取有用数据的程序；</p>
<p>从技术层面来说就是 通过程序模拟浏览器请求站点的行为，把站点返回的 HTML 代码 / JSON 数据 / 二进制数据（图片、视频） 爬到本地，进而提取自己需要的数据，存放起来使用；</p>
<h2 id="爬虫的流程是什么"><a href="#爬虫的流程是什么" class="headerlink" title="爬虫的流程是什么"></a>爬虫的流程是什么</h2><p>从一个普通用户的角度来看，获取网络内容的方式应该是：</p>
<p>浏览器提交请求 —–&gt; 下载网页代码 —–&gt; 浏览器把代码解析成界面</p>
<p>爬虫要做的就应该是：</p>
<p>模拟浏览器（非浏览器）请求 —–&gt; 获取数据 —–&gt; 解析代码数据提取有效信息 —–&gt; 存储</p>
<p>这么比较是不是爬虫就简单多了</p>
<p><strong>发起请求</strong></p>
<p>使用 http 库向目标站点发起请求，即发送一个 Request</p>
<p>Request 包含：请求头、请求体等</p>
<p>Request 模块缺陷：不能执行 JS 和 CSS 代码</p>
<p><strong>获取响应内容</strong></p>
<p>如果服务器能正常响应，则会得到一个 Response</p>
<p>Response 包含：html，json，图片，视频等</p>
<p><strong>解析内容</strong></p>
<p>解析 html 数据：正则表达式（RE 模块），第三方解析库如 Beautifulsoup，pyquery 等</p>
<p>解析 json 数据：json 模块</p>
<p>解析二进制数据：以 wb 的方式写入文件</p>
<p><strong>保存数据</strong></p>
<p>数据库（MySQL，Mongdb、Redis）</p>
<p>文件</p>
<h2 id="请求的数据包"><a href="#请求的数据包" class="headerlink" title="请求的数据包"></a>请求的数据包</h2><h3 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h3><p>GET、HEAD、PUT、DELETE、POST、OPTIONS<br><strong>最常用的 GET/POST</strong></p>
<p>GET：GET 可以说是最常见的，它本质就是发送一个请求来获取服务器上的某一资源。资源通过一组 HTTP 头和呈现数据（如 HTML 文本，或者图片或者视频等等）返回给客户端。GET 请求中不会包含呈现数据。</p>
<p>POST：向服务器提交数据。这个方法用途广泛，几乎所有的提交操作都是靠这个完成。</p>
<p>如果你想了解更多，左手 google，右手百度 这里不做过多解释</p>
<h3 id="请求的目标"><a href="#请求的目标" class="headerlink" title="请求的目标"></a>请求的目标</h3><p>URL，又叫全球统一资源定位符，每个资源的 URL 都是唯一的</p>
<p>例如 <a class="link" href="https://www.baidu.com/s?ie=UTF-8&amp;wd=%E5%9B%BE%E7%89%87">https://www.baidu.com/s?ie=UTF-8&amp;wd=%E5%9B%BE%E7%89%87<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>‘wd=’之后的一堆字符，其实是‘图片’两个中文被编码后的数据</p>
<h3 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h3><p>User-agent：请求头中如果没有 user-agent 客户端配置，服务端可能将你当做一个非法用户 host；cookies：cookie 用来保存登录信息</p>
<p>一般做爬虫都会加上请求头，Cookie 看目标网站的具体要求，可能还会需要一些其他头</p>
<p>Referrer：访问源至哪里来</p>
<p>User-Agent: 访问的浏览器</p>
<h3 id="请求体"><a href="#请求体" class="headerlink" title="请求体"></a>请求体</h3><p>GET 方式没有请求体，所有的数据都在 URL 中</p>
<h3 id="响应状态码"><a href="#响应状态码" class="headerlink" title="响应状态码"></a>响应状态码</h3><p>200：代表成功</p>
<p>301：代表跳转</p>
<p>404：文件不存在</p>
<p>403：无权限访问</p>
<p>502：服务器错误</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="初体验"><a href="#初体验" class="headerlink" title="初体验"></a>初体验</h3><p>怎么爬取一个网页呢，换句话说怎么才能获取到一个网站的数据呢</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">response = urllib2.urlopen(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>没错除去第一行引入，真正的代码只有两行</p>
<p>如果此时你没有安装 IDE，那么用文本编辑器将上面内容保存成 test1.py</p>
<p>一定要自己亲自打一下代码</p>
<p>运行</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">python test1.py</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://wx4.sinaimg.cn/mw690/006NPPBTly1fsa2e9ih08j30y90q5djw.jpg" alt="image"></p>
<p>后面会讲我的代码为什么多了一行</p>
<h3 id="分析源码"><a href="#分析源码" class="headerlink" title="分析源码"></a>分析源码</h3><p>第一行</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">response = urllib2.urlopen(<span class="string">"http://www.baidu.com"</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里我们调用了 urllib2 库的 urlopen 方法，urlopen 有三个参数，如下：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">urlopen(url,data,timeout)</span><br></pre></td></tr></tbody></table></figure></div>

<p>第一个参数 url 上面我们说过了，第二个参数是访问 url 时要传入的数据，第三个为超时设置（超时放弃访问）</p>
<p>第二三个参数可以为空，data 默认为空 None，timeout 默认为 socket._GLOBAL_DEFAULT_TIMEOUT</p>
<p>第一个参数是必须的，返回的值存在 <code>=</code> 左侧的变量中，存储的是 response 对象 打印：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>response 对象有个 read () 方法，可以返回获取的内容，如果我们不加 read 直接打印会怎么样</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/mw690/006NPPBTly1fsamken9quj30pc04s74m.jpg" alt="image"></p>
<p>直接打印出了该对象的描述</p>
<h3 id="构造-Request"><a href="#构造-Request" class="headerlink" title="构造 Request"></a>构造 Request</h3><p>urlopen 参数可以传入一个 request 请求，它本身就是一个 Request 类的实例，现在我们来填一下上边挖的坑，我的代码为什么多了一行</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">request = urllib2.Request(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>这就是中间构造了一个 Request 对象，运行结果一致，但是推荐这种写法</p>
<h3 id="POST-和-GET-数据传送"><a href="#POST-和-GET-数据传送" class="headerlink" title="POST 和 GET 数据传送"></a>POST 和 GET 数据传送</h3><p>前边提到了 6 中请求方式，最常用的有 post 和 get</p>
<p>很多时候我们获取数据还要进行参数的提交，例如模拟登陆，post 方式会发送数据包，而 get 方式则会把数据放在要访问的 url 中</p>
<h3 id="POST-方式"><a href="#POST-方式" class="headerlink" title="POST 方式"></a>POST 方式</h3><p>上面我们说了 data 参数是干嘛的？对了，它就是用在这里的，我们传送的数据就是这个参数 data，下面演示一下 POST 方式。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">values = {<span class="string">"username"</span>:<span class="string">"xxx"</span>,<span class="string">"password"</span>:<span class="string">"XXXX"</span>}</span><br><span class="line">data = urllib.urlencode(values)</span><br><span class="line">url = <span class="string">"https://passport.csdn.net/account/login?from=http://my.csdn.net/my/mycsdn"</span></span><br><span class="line">request = urllib2.Request(url,data)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>我们引入了 urllib 库，现在我们模拟登陆 CSDN，当然上述代码可能登陆不进去，因为 CSDN 还有个流水号的字段，没有设置全，比较复杂在这里就不写上去了，在此只是说明登录的原理。一般的登录网站一般是这种写法。</p>
<p>我们需要定义一个字典，名字为 values，参数我设置了 username 和 password，下面利用 urllib 的 urlencode 方法将字典编码，命名为 data，构建 request 时传入两个参数，url 和 data，运行程序，返回的便是 POST 后呈现的页面内容。</p>
<p>注意上面字典的定义方式还有一种，下面的写法是等价的</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">values = {}</span><br><span class="line">values[<span class="string">'username'</span>] = <span class="string">"xxx"</span></span><br><span class="line">values[<span class="string">'password'</span>] = <span class="string">"XXXX"</span></span><br><span class="line">data = urllib.urlencode(values)</span><br><span class="line">url = <span class="string">"http://passport.csdn.net/account/login?from=http://my.csdn.net/my/mycsdn"</span></span><br><span class="line">request = urllib2.Request(url,data)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>以上方法便实现了 POST 方式的传送</p>
<h3 id="GET-方式"><a href="#GET-方式" class="headerlink" title="GET 方式"></a>GET 方式</h3><p>至于 GET 方式我们可以直接把参数写到网址上面，直接构建一个带参数的 URL 出来即可。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">values={}</span><br><span class="line">values[<span class="string">'username'</span>] = <span class="string">"xxx"</span></span><br><span class="line">values[<span class="string">'password'</span>]=<span class="string">"XXXX"</span></span><br><span class="line">data = urllib.urlencode(values)</span><br><span class="line">url = <span class="string">"http://passport.csdn.net/account/login"</span></span><br><span class="line">geturl = url + <span class="string">"?"</span>+data</span><br><span class="line">request = urllib2.Request(geturl)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="built_in">print</span> response.read()</span><br></pre></td></tr></tbody></table></figure></div>

<p>你可以 print geturl，打印输出一下 url，发现其实就是原来的 url 加？然后加编码后的参数</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">http://passport.csdn.net/account/login?username=xxx&amp;password=XXXX</span><br></pre></td></tr></tbody></table></figure></div>

<p>和我们平常 GET 访问方式一模一样，这样就实现了数据的 GET 方式传送。</p>
<p>上边是我在网上找的一个例子，登不上的… 你可以自己找个网站，获取源码尝试登陆一下</p>
<p>下一节 带请求头的访问</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（五）</title>
    <url>/2018/81e23d33.html</url>
    <content><![CDATA[<p>实战项目妹子图爬取</p>
<p>多图预警</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095754947.webp" alt="image"></p>
<span id="more"></span>

<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095843435.webp" alt="image"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095932698.webp" alt="image"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415100009735.webp" alt="image"></p>
<p>就不放太多了，等下可以自己尝试一下</p>
<p>打开我们要爬去的网站，f12 打开控制台</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415100054476.webp" alt="image"></p>
<p>导入头</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br></pre></td></tr></tbody></table></figure></div>

<p>设置编码和头</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br><span class="line">url = <span class="string">'http://www.mzitu.com'</span></span><br><span class="line"><span class="comment">#头</span></span><br><span class="line">heade = {</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'Referer'</span>:<span class="string">'http://www.mzitu.com'</span>,</span><br><span class="line">}</span><br><span class="line"><span class="comment">#构造请求</span></span><br><span class="line">request = urllib2.Request(url,headers=heade)</span><br><span class="line">respons = urllib2.urlopen(request)</span><br></pre></td></tr></tbody></table></figure></div>

<p>定义存储路径</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">path = <span class="string">"/home/gwj/snap/demo/image/"</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>解析获取的页面</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(respons.read(),<span class="string">"lxml"</span>)</span><br><span class="line"><span class="built_in">print</span> soup.a</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里打印出 a 标签，lxml 是解析器，respons.read () 存储页面的内容</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415100128592.webp" alt="image"></p>
<p>由于我们要进入到每个子页面才能保存图片，这里我们要先找到最大页码，以此决定循环次数（每次打开子页面，保存图片是一个循环）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#最大页数在span标签中的第１0个</span></span><br><span class="line">page = soup.find_all(<span class="string">'a'</span>,class_ = <span class="string">'page-numbers'</span>)</span><br><span class="line">max_page = page[-<span class="number">2</span>].text</span><br></pre></td></tr></tbody></table></figure></div>

<p>解释一下 <code>soup.find()</code> 查找某一个，<code>soup.find_all</code> 查找所有的，返回一个列表</p>
<p>soup.find<a href="%E2%80%98src%E2%80%99">‘img’</a>   查找 img 的 src 链接属性</p>
<p>class_  获取目标的类名</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415100214110.webp" alt="image"></p>
<p>不同页面之间都有相似的地方</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415100236382.webp" alt="image"></p>
<p>这里存储一下这个 url，用来构建访问子页面的链接</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">same_url = <span class="string">'http://www.mzitu.com/page/'</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>循环访问子页面 格式为 page+n</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">int</span>(max_page)+<span class="number">1</span>):</span><br><span class="line">    ul = same_url+<span class="built_in">str</span>(n)</span><br><span class="line">    request1 = urllib2.Request(ul,headers=heade)</span><br><span class="line">    start_html = urllib2.urlopen(request1)</span><br><span class="line">    soup = BeautifulSoup(start_html,<span class="string">"lxml"</span>)</span><br><span class="line">    <span class="comment">#实际上时第一个class = 'postlist'的div里的所有a标签</span></span><br><span class="line">    all_a = soup.find(<span class="string">'div'</span>,class_ =<span class="string">'postlist'</span>).find_all(<span class="string">'a'</span>,target=<span class="string">'_blank'</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>访问详情页面，提取用户名，URL</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#提取用户名</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> all_a:</span><br><span class="line">    title = a.get_text() <span class="comment">#提取文本</span></span><br><span class="line">    <span class="keyword">if</span>(title!=<span class="string">''</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"准备爬取:"</span>+title)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"目录已存在"</span>)</span><br><span class="line">            flag=<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            os.makedirs(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))</span><br><span class="line">            flag=<span class="number">0</span></span><br><span class="line">        os.chdir(path + title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))</span><br><span class="line">        href = a[<span class="string">'href'</span>]</span><br><span class="line">        request2 = urllib2.Request(href,headers=heade)</span><br><span class="line">        html = urllib2.urlopen(request2)</span><br><span class="line">        mess = BeautifulSoup(html,<span class="string">"lxml"</span>)</span><br><span class="line">        pic_max = mess.find_all(<span class="string">'span'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pic_max):</span><br><span class="line">            pic_max = pic_max[<span class="number">10</span>].text <span class="comment">#最大页数</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pic_max = <span class="string">'10'</span></span><br><span class="line">        <span class="keyword">if</span>(flag == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(os.listdir(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))) &gt;= <span class="built_in">int</span>(pic_max)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'已经保存完毕，跳过'</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>上方第 18 行代码，判断数据长度是否为空，这里是记录单个妹子的图片最大页数，同时本页包含了图片的 url</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415100540823.webp" alt="image"></p>
<p>第 12 行代码，创建 path + 文件名的新目录</p>
<p>22 行，判断目录是否 已经创建，如果已经创建，则跳出本次循环</p>
<p>如有不理解可在评论区评论</p>
<p>获取图片链接</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">int</span>(pic_max)+<span class="number">1</span>):</span><br><span class="line">    pic = href+<span class="string">'/'</span>+<span class="built_in">str</span>(num)</span><br><span class="line">    request = urllib2.Request(pic,headers=heade)</span><br><span class="line">    html = urllib2.urlopen(request)</span><br><span class="line">    mess = BeautifulSoup(html,<span class="string">"lxml"</span>)</span><br><span class="line">    pic_url = mess.find(<span class="string">'img'</span>,alt = title)</span><br></pre></td></tr></tbody></table></figure></div>

<p>判断链接是否为空（防止报错）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> pic_url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    request = urllib2.Request(pic_url[<span class="string">'src'</span>],headers=heade)</span><br></pre></td></tr></tbody></table></figure></div>

<p>截取链接<code>'/</code> 后的字符作为文件名，写入文件</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">file_name = pic_url[<span class="string">'src'</span>].split(<span class="string">r'/'</span>)[-<span class="number">1</span>]</span><br><span class="line">f = <span class="built_in">open</span>(file_name,<span class="string">'wb'</span>)</span><br><span class="line">f.write(html.read())</span><br><span class="line">f.close()</span><br></pre></td></tr></tbody></table></figure></div>

<p>完整代码</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br><span class="line">url = <span class="string">'http://www.mzitu.com'</span></span><br><span class="line"><span class="comment">#头</span></span><br><span class="line">heade = {</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'Referer'</span>:<span class="string">'http://www.mzitu.com'</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">request = urllib2.Request(url,headers=heade)</span><br><span class="line"><span class="comment">#########</span></span><br><span class="line"><span class="comment">#get方式提交的另一种方法</span></span><br><span class="line"><span class="comment">#request.add_header('User-Agent','Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36')</span></span><br><span class="line"><span class="comment">#request.add_header('Referer','http://www.mzitu.com/')</span></span><br><span class="line"><span class="comment">######</span></span><br><span class="line">respons = urllib2.urlopen(request)</span><br><span class="line">path = <span class="string">"/home/gwj/snap/demo/image/"</span></span><br><span class="line"><span class="comment">#print respons.read()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#解析</span></span><br><span class="line"><span class="comment">#使用自带的html.parser解析，速度慢但通用,这里用ｌｘｍｌ解析器</span></span><br><span class="line">soup = BeautifulSoup(respons.read(),<span class="string">"lxml"</span>)</span><br><span class="line"><span class="built_in">print</span> soup.a</span><br><span class="line"><span class="comment">#最大页数在span标签中的第１0个</span></span><br><span class="line">page = soup.find_all(<span class="string">'a'</span>,class_ = <span class="string">'page-numbers'</span>)</span><br><span class="line">max_page = page[-<span class="number">2</span>].text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">same_url = <span class="string">'http://www.mzitu.com/page/'</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">int</span>(max_page)+<span class="number">1</span>):</span><br><span class="line">    ul = same_url+<span class="built_in">str</span>(n)</span><br><span class="line">    request1 = urllib2.Request(ul,headers=heade)</span><br><span class="line">    start_html = urllib2.urlopen(request1)</span><br><span class="line">    soup = BeautifulSoup(start_html,<span class="string">"lxml"</span>)</span><br><span class="line">    <span class="comment">#实际上时第一个class = 'postlist'的div里的所有a标签</span></span><br><span class="line">    all_a = soup.find(<span class="string">'div'</span>,class_ =<span class="string">'postlist'</span>).find_all(<span class="string">'a'</span>,target=<span class="string">'_blank'</span>)</span><br><span class="line">    <span class="comment">#提取用户名</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> all_a:</span><br><span class="line">        title = a.get_text() <span class="comment">#提取文本</span></span><br><span class="line">        <span class="keyword">if</span>(title!=<span class="string">''</span>):</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">"准备爬取:"</span>+title)</span><br><span class="line">            <span class="keyword">if</span>(os.path.exists(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"目录已存在"</span>)</span><br><span class="line">                flag=<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                os.makedirs(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))</span><br><span class="line">                flag=<span class="number">0</span></span><br><span class="line">            os.chdir(path + title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))</span><br><span class="line">            href = a[<span class="string">'href'</span>]</span><br><span class="line">            request2 = urllib2.Request(href,headers=heade)</span><br><span class="line">            html = urllib2.urlopen(request2)</span><br><span class="line">            mess = BeautifulSoup(html,<span class="string">"lxml"</span>)</span><br><span class="line">            pic_max = mess.find_all(<span class="string">'span'</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(pic_max):</span><br><span class="line">                pic_max = pic_max[<span class="number">10</span>].text <span class="comment">#最大页数</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                pic_max = <span class="string">'10'</span></span><br><span class="line">            <span class="keyword">if</span>(flag == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(os.listdir(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))) &gt;= <span class="built_in">int</span>(pic_max)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">'已经保存完毕，跳过'</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">int</span>(pic_max)+<span class="number">1</span>):</span><br><span class="line">                pic = href+<span class="string">'/'</span>+<span class="built_in">str</span>(num)</span><br><span class="line">                request = urllib2.Request(pic,headers=heade)</span><br><span class="line">                html = urllib2.urlopen(request)</span><br><span class="line">                mess = BeautifulSoup(html,<span class="string">"lxml"</span>)</span><br><span class="line">                pic_url = mess.find(<span class="string">'img'</span>,alt = title)</span><br><span class="line">                <span class="keyword">if</span> pic_url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    request = urllib2.Request(pic_url[<span class="string">'src'</span>],headers=heade)</span><br><span class="line"></span><br><span class="line">                html = urllib2.urlopen(request)</span><br><span class="line">                file_name = pic_url[<span class="string">'src'</span>].split(<span class="string">r'/'</span>)[-<span class="number">1</span>]</span><br><span class="line">                f = <span class="built_in">open</span>(file_name,<span class="string">'wb'</span>)</span><br><span class="line">                f.write(html.read())</span><br><span class="line">                f.close()</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"完成"</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">"第"</span>,n,<span class="string">"页完成"</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>第一次写不太完善，有问题评论</p>
<p>下一节：另一种方式爬取妹子图</p>
<p>表情包获取</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（六）</title>
    <url>/2018/e4ec76ea.html</url>
    <content><![CDATA[<p>本篇</p>
<blockquote>
<p>妹子图另一种爬取方式<br>最新表情包爬取</p>
</blockquote>
<span id="more"></span>

<h2 id="妹子图爬取"><a href="#妹子图爬取" class="headerlink" title="妹子图爬取"></a>妹子图爬取</h2><p><font color="“#FF0000”">相同的操作：</font></p>
<blockquote>
<p>第一步，打开浏览器，在地址栏输入我们的目标网址</p>
<p>第二步，打开控制台查看源码</p>
<p>第三步，尝试分析源码相同元素的规律</p>
<p>第四步，写代码解析目标文件</p>
</blockquote>
<p>这节开始还是要说一下妹子图的抓取（这里没有用多线程）</p>
<p>良心站长，以外的发现妹子图站点有一个综合页面，非常适合抓取（源码规律性强）</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsy9kfyc8yj30ux0mw0wq.jpg" alt="image"></p>
<p>和上一篇相似，我们将鼠标放在第一个超链接上，右键检查，就可以看到该链接指向的地址</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsy9oohawfj31cx0n4gxd.jpg" alt="image"></p>
<p>点击后发现，和上一个保存妹子图的页面相似，由于能直接找到链接，这里就可以简化很多步骤</p>
<p>先把要用到的包调用一下</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>为了简化代码，也让代码更美观，我们把网页请求写在了一个模块中</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">url</span>):</span><br><span class="line">    heades = {</span><br><span class="line">        <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span>,</span><br><span class="line">        <span class="string">'Referer'</span>:<span class="string">'http://www.mzitu.com'</span>,</span><br><span class="line">    }</span><br><span class="line">    req = urllib2.Request(url,headers=heades)</span><br><span class="line">    html = urllib2.urlopen(req)</span><br><span class="line">    <span class="keyword">return</span> html</span><br></pre></td></tr></tbody></table></figure></div>

<p>下载图片也可以单独写一下，注释里写的很详细</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#下载图片</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">max_span</span>):</span><br><span class="line">    <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">int</span>(max_span)+<span class="number">1</span>):  <span class="comment">#如果list空了只要十页图片</span></span><br><span class="line">        page_url = href + <span class="string">'/'</span> +<span class="built_in">str</span>(page)  <span class="comment">#专辑编号加上页码</span></span><br><span class="line">        <span class="built_in">print</span>(page_url) <span class="comment">#图片页面地址 会报错</span></span><br><span class="line"></span><br><span class="line">        img_html = request(page_url)</span><br><span class="line"></span><br><span class="line">        img_soup = BeautifulSoup(img_html,<span class="string">"lxml"</span>)</span><br><span class="line">        <span class="comment">#img_url = img_soup.find('div',class_='main-image').find('img')['src']</span></span><br><span class="line">        img_url = img_soup.find(<span class="string">'img'</span>,alt = title)</span><br><span class="line">        <span class="keyword">if</span> img_url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            img_url = img_url[<span class="string">'src'</span>]</span><br><span class="line">        <span class="comment">##print(img_url)</span></span><br><span class="line">        name = img_url[-<span class="number">9</span>:-<span class="number">4</span>]<span class="comment">##取URL 倒数第四至第九位 做图片的名字</span></span><br><span class="line">        img = request(img_url)</span><br><span class="line">        f = <span class="built_in">open</span>(name+<span class="string">'.jpg'</span>,<span class="string">'ab'</span>)<span class="comment">#写入多媒体文件必须要b这个参数</span></span><br><span class="line">        f.write(img.read())</span><br><span class="line">        f.close()</span><br></pre></td></tr></tbody></table></figure></div>

<p>设置图片保存目录</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">path = <span class="string">""</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>入口 URL</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">all_url = <span class="string">'http://www.mzitu.com/all'</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>调用一下上边定义的模块</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">start_html = request(all_url)</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里可以打印一下看看是否成功获取，如果获取成功，那就成功一半了</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(start_html.read())</span><br></pre></td></tr></tbody></table></figure></div>

<p>使用 BeautifulSoup 来解析我们获取到的网页，‘lxml’是指定的解析器</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(start_html,<span class="string">"lxml"</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>解析 a 标签</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">all_a = soup.find(<span class="string">'div'</span>,class_ =<span class="string">'all'</span>).find_all(<span class="string">'a'</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>得到 a 标签，也就有了子页面的入口了</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsya0xrwdwj30d1031t8w.jpg" alt="image"></p>
<p>我们需要访问这个页面，提取这个页面中的图片</p>
<p>但是这样我们只能得到每个页面中的一张图片</p>
<p>仔细观察发现</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsya47udojj314d0h14cg.jpg" alt="image"></p>
<p>我们找到了上一篇用到的 span 标签，提取这个循环访问就可以每张都下载下来</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> all_a:</span><br><span class="line">    title = a.get_text() <span class="comment">##取出a标签的文本</span></span><br><span class="line">    <span class="keyword">if</span> (title!=<span class="string">''</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"爬取"</span>+title)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>))):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"目录已存在"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            os.makedirs(path+title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>)) <span class="comment">##创建存放文件夹</span></span><br><span class="line">        os.chdir(path + title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>)) <span class="comment">##切换到上述文件夹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        href = a[<span class="string">'href'</span>]     <span class="comment">##取出a标签的href属性</span></span><br><span class="line">    <span class="comment"># #print(title)</span></span><br><span class="line">        <span class="built_in">print</span>(href)</span><br><span class="line">        <span class="keyword">if</span> href.find(<span class="string">"old"</span>) != -<span class="number">1</span>:</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        html = request(href)</span><br><span class="line">        html_soup = BeautifulSoup(html,<span class="string">"lxml"</span>)</span><br><span class="line">        <span class="built_in">list</span> = html_soup.find_all(<span class="string">'span'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#关键，不判断容易报错停止</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>):</span><br><span class="line">            max_span = html_soup.find_all(<span class="string">'span'</span>)[<span class="number">10</span>].get_text()<span class="comment">#＃取出所有&lt;span&gt;标签，获取第十个中文本，就是最好一个页面</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_span=<span class="string">'10'</span></span><br><span class="line">        <span class="built_in">print</span>(max_span)</span><br><span class="line">        <span class="comment">#for page in range(1,int(max_span)+1):</span></span><br><span class="line">        download(max_span)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="最新表情包"><a href="#最新表情包" class="headerlink" title="最新表情包"></a>最新表情包</h2><p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsya8os67gj31g10m57ru.jpg" alt="image"></p>
<p>经过多次寻找规律，会发现</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://wx2.sinaimg.cn/large/006NPPBTly1fsya9yg7taj30ae00ujr9.jpg" alt="image"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsyaawqi4xj30aq00xmx1.jpg" alt="image"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsyabbbkzqj30av00xjr9.jpg" alt="image"></p>
<p>有木有找到？</p>
<p>导入包</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br></pre></td></tr></tbody></table></figure></div>

<p>这次上一个有些不同，因为这一个页面规律太明显，我们提前创建了一个集合</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">PAGE_URL_LIST = []</span><br><span class="line"><span class="comment">#表情包链接列表</span></span><br><span class="line">BESE_PAGE_URL = <span class="string">"https://www.doutula.com/photo/list/?page="</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">1500</span>):</span><br><span class="line">    url = BESE_PAGE_URL + <span class="built_in">str</span>(x)</span><br><span class="line">    PAGE_URL_LIST.append(url)</span><br></pre></td></tr></tbody></table></figure></div>

<p>上边的循环次数要保证比下图中的最大页码小，不然程序运行到最后会崩溃</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i0.wp.com/tvax1.sinaimg.cn/large/006NPPBTly1fsyaegp6l6j30o30esaen.jpg" alt="image"></p>
<p>之后的代码很简单</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> page_url <span class="keyword">in</span> PAGE_URL_LIST:</span><br><span class="line">    <span class="comment">#url请求</span></span><br><span class="line">    response = requests.get(page_url)</span><br><span class="line">    <span class="comment">#使用返回的数据构建ｂｅｓｕ对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#requests对象中　response.content返回的是二进制的数值，</span></span><br><span class="line">    <span class="comment"># response.text返回的是Unicode型的数据</span></span><br><span class="line">    <span class="comment"># 也就是说，如果你想获取文本，可以通过.text</span></span><br><span class="line">    <span class="comment"># 如果你想获取图片，文件可以通过　.content</span></span><br><span class="line">    soup = BeautifulSoup(response.content,<span class="string">'lxml'</span>)</span><br><span class="line">    <span class="comment">#获取所有的标签</span></span><br><span class="line">    img_list = soup.find(<span class="string">'div'</span>,class_ = <span class="string">'page-content'</span>).find_all(<span class="string">'img'</span>,class_ = <span class="string">'img-responsive lazy image_dta'</span>)</span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> img_list:</span><br><span class="line">        title = img[<span class="string">'alt'</span>]</span><br><span class="line">        src = img[<span class="string">'data-original'</span>]</span><br><span class="line">        <span class="built_in">print</span>(title)</span><br><span class="line">        <span class="built_in">print</span>(src)</span><br><span class="line">        <span class="comment">#获取图片名称</span></span><br><span class="line">        filename = title</span><br><span class="line">        <span class="comment">#拼接路径下载</span></span><br><span class="line">        <span class="comment">#path = os.path.join("image2",filename)</span></span><br><span class="line">        z = src[-<span class="number">4</span>:]  <span class="comment">#后缀取名</span></span><br><span class="line">        path = <span class="string">'images2'</span>+ <span class="string">'/'</span> +title.strip().replace(<span class="string">'?'</span>,<span class="string">''</span>)+z</span><br><span class="line">        urllib.urlretrieve(src,path)</span><br></pre></td></tr></tbody></table></figure></div>

<p>。。。会不会太快了、、、</p>
<p>多线程抓取留到下一节</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 爬虫入门到进阶（四）</title>
    <url>/2018/ee7cf874.html</url>
    <content><![CDATA[<p><img src="https://gss1.bdstatic.com/-vo3dSag_xI4khGkpoWK1HF6hhy/baike/w%3D268/sign=e2a135117d1ed21b79c929e3956fddae/faedab64034f78f092033e1079310a55b2191ccc.jpg" alt="https://gss1.bdstatic.com/-vo3dSag_xI4khGkpoWK1HF6hhy/baike/w%3D268/sign=e2a135117d1ed21b79c929e3956fddae/faedab64034f78f092033e1079310a55b2191ccc.jpg"></p>
<p>HTML 代码解析，从获取到的源码中获取数据</p>
<p>　<span id="more"></span></p>
<p>如果想从网页中提取想要的数据，可能会有人想到正则匹配，但是正则匹配虽然强大，但是对于不熟悉的人来说比较容易出错，这里我们就要提到一个更加强大的工具 <code>Beautiful Soup</code></p>
<h2 id="Beautiful-Soup简介"><a href="#Beautiful-Soup简介" class="headerlink" title="Beautiful Soup简介"></a>Beautiful Soup 简介</h2><p>Beautiful Soup 是 python 的一个库，主要是从网页抓取数据，支持编码自动转换</p>
<h2 id="Beautiful-Soup安装"><a href="#Beautiful-Soup安装" class="headerlink" title="Beautiful Soup安装"></a>Beautiful Soup 安装</h2><p>可以利用 pip 或者 easy_install 来安装，以下两种方法均可</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">easy_install beautifulsoup4</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">pip p install beautifulsoup4</span><br></pre></td></tr></tbody></table></figure></div>

<p>如果想手动安装，可以访问下边地址</p>
<p><a class="link" href="https://pypi.org/project/beautifulsoup4/">Beautiful Soup<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>解压后执行</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo python setup.py install</span><br></pre></td></tr></tbody></table></figure></div>

<p>Beautiful Soup 支持 Python 标准库中的 HTML 解析器，还支持一些第三方的解析器，如果我们不安装它，则 Python 会使用 Python 默认的解析器，lxml 解析器更加强大，速度更快，推荐安装。</p>
<p>安装 lxml</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">pip install lxml</span><br></pre></td></tr></tbody></table></figure></div>

<table>
<thead>
<tr>
<th>解析器</th>
<th>使用方法</th>
<th>优势</th>
<th>劣势</th>
</tr>
</thead>
<tbody><tr>
<td> Python 标准库</td>
<td> BeautifulSoup(markup, “html.parser”)</td>
<td>Python 的内置标准库执行速度适中文档容错能力强</td>
<td> Python 2.7.3 or 3.2.2) 前 的版本中文档容错能力差</td>
</tr>
<tr>
<td> lxml HTML 解析器</td>
<td> BeautifulSoup(markup, “lxml”)</td>
<td> 速度快文档容错能力强</td>
<td>需要安装 C 语言库</td>
</tr>
<tr>
<td> lxml XML 解析器</td>
<td> BeautifulSoup(markup, [“lxml”, “xml”])BeautifulSoup(markup, “xml”)</td>
<td> 速度快唯一支持 XML 的解析器</td>
<td>需要安装 C 语言库</td>
</tr>
<tr>
<td> html5lib</td>
<td>BeautifulSoup(markup, “html5lib”)</td>
<td> 最好的容错性以浏览器的方式解析文档生成 HTML5 格式的文档</td>
<td>速度慢不依赖外部扩展</td>
</tr>
</tbody></table>
<p>最好的教程 <a class="link" href="http://beautifulsoup.readthedocs.io/zh_CN/latest/">官方文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>将一段文档传入 BeautifulSoup 的构造方法，就能得到一个文档的对象，可以传入一段字符串或一个文件句柄.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(<span class="built_in">open</span>(<span class="string">"index.html"</span>))</span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(<span class="string">"&lt;html&gt;data&lt;/html&gt;"</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<p>首先，文档被转换成 Unicode, 并且 HTML 的实例都被转换成 Unicode 编码</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">BeautifulSoup(<span class="string">"Sacr&amp;eacute; bleu!"</span>)</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;Sacré bleu!&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>然后，Beautiful Soup 选择最合适的解析器来解析这段文档，如果手动指定解析器那么 Beautiful Soup 会选择指定的解析器来解析文档.(参考 <a class="link" href="http://beautifulsoup.readthedocs.io/zh_CN/latest/#xml">解析成 XML<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ).</p>
<p>代码示例</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="comment">#Ｂeautiful Soup解析ＨＴＭＬ数据</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">html = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse's story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class="title" name="dromouse"&gt;&lt;b&gt;The Dormouse's story&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/elsie" class="sister" id="link1"&gt;&lt;!-- Elsie --&gt;&lt;/a&gt;,</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/lacie" class="sister" id="link2"&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/tillie" class="sister" id="link3"&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">and they lived at the bottom of a well.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">soup = BeautifulSoup(html,<span class="string">'lxml'</span>)</span><br><span class="line"><span class="comment">#从本地ＨＴＭＬ文件创建对象</span></span><br><span class="line"><span class="comment">#soup = BeautifulSoup(open('index.html'))</span></span><br><span class="line"><span class="comment">#格式化输出ｓｏｕｐ</span></span><br><span class="line"><span class="built_in">print</span> soup.prettify() <span class="comment">#格式化输出代码</span></span><br><span class="line"><span class="built_in">print</span> soup.title <span class="comment">#输出标题</span></span><br><span class="line"><span class="built_in">print</span> soup.head <span class="comment">#输出head</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">print</span> soup.name</span><br></pre></td></tr></tbody></table></figure></div>

<p>注释掉格式化代码后的结果</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095722511.webp" alt="image"></p>
<p>实战篇：</p>
<p>下一节：妹子图爬取</p>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>ssh 端口反代与内网穿透</title>
    <url>/2022/1074997287.html</url>
    <content><![CDATA[<p>ssh 端口反向代理与内网穿透</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p> 出于安全考虑公网 IP 仅暴露了内网跳板机的 22 端口，想借用 ssh 端口转发实现简易内网穿透。</p>
 <span id="more"></span>

<h2 id="内网对本地"><a href="#内网对本地" class="headerlink" title="内网对本地"></a>内网对本地</h2><p>假设服务器 (跳板机) 的 22 端口通过端口映射暴露在公网 <code>123.45.67.89:22</code></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">ssh -L 7800:127.0.0.1:7800 root@123.45.67.89 -p22</span><br></pre></td></tr></tbody></table></figure></div>

<p>本地访问 <a class="link" href="http://localhost:7800/">http://localhost:7800<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 即可转发到 <code>123.45.67.89:22:7800</code></p>
<p>可通过 ssh 将内网的 127.0.0.1:7800 转发至本机的 7800</p>
<p>对于明文传输 http 也起到了加密作用，适用于不安全的网络环境</p>
<h2 id="反向转发"><a href="#反向转发" class="headerlink" title="反向转发"></a>反向转发</h2><p>说一个场景 服务器要访问 Google，但是由于某些原因无法访问，而本机又有提个科学的工具，需要转发本地的代理供远程访问</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">ssh -R 7890:localhost:7890 root@123.45.67.89 -p22</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>然后在服务器上使用代理 <code>http://127.0.0.1:7890</code><br>具体使用见 <a href="https://blog.tbox.fun/2021/3092852125.html">常用代理设置</a></p>
<h2 id="第三方工具"><a href="#第三方工具" class="headerlink" title="第三方工具"></a>第三方工具</h2><p>以上方法在控制台断开后均停止，借助第三方工具 MobaXterm 可以实现此功能</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2022/11/16/zZtqL6.png" alt="图片仅可国内访问"></p>
<h2 id="流量代理"><a href="#流量代理" class="headerlink" title="流量代理"></a>流量代理</h2><p>使用 ssh 可以快速搭建 SOCKS5 代理，运行下面命令就可以在本机使用目标 <code>remote-host</code> 的网络上网</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">ssh -D 1080 user@remote-host</span><br></pre></td></tr></tbody></table></figure></div>

<p>可选增强：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">ssh -D 1080 -f -C -q -N user@remote-host</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><p>-f：后台运行</p>
</li>
<li><p>-C：压缩传输数据</p>
</li>
<li><p>-q：静默模式</p>
</li>
<li><p>-N：不执行远程命令，仅用于端口转发</p>
</li>
</ul>
<p>使用方法</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">curl --socks5 127.0.0.1:1080 http://example.com</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="工具生成"><a href="#工具生成" class="headerlink" title="工具生成"></a>工具生成</h2><p>针对上述命令，现增加 <a class="link" href="https://www.tbox.fun/tool/j?id=ssl">ssh 转发命令生成器<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 工具</p>
]]></content>
      <tags>
        <tag>ssh</tag>
      </tags>
  </entry>
  <entry>
    <title>ts/js 版本去除文本中空格</title>
    <url>/2021/4133971551.html</url>
    <content><![CDATA[<p>文末附上 js 版本，需求简单概括为 去除一段文本中的不可见字符，要求汉字之间无空白，英文之间多个空白合并成一个</p>
<blockquote>
<p>注 v1 和 v2 均为 typescript 代码</p>
</blockquote>
<span id="more"></span>

<h2 id="v1"><a href="#v1" class="headerlink" title="v1"></a>v1</h2><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除空格，英文之间空格不删除</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">deleteTrim</span>(<span class="params"><span class="attr">text</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> {</span><br><span class="line">  <span class="comment">// 替换掉两个空格以上的为单个空格</span></span><br><span class="line">  <span class="keyword">let</span> txtTrim = text.<span class="title function_">replace</span>(<span class="regexp">/\s{2,}/g</span>, <span class="string">" "</span>);</span><br><span class="line">  <span class="comment">// 替换掉换行tab</span></span><br><span class="line">  txtTrim = txtTrim.<span class="title function_">replace</span>(<span class="regexp">/[\r\n\t]/g</span>, <span class="string">""</span>);</span><br><span class="line">  <span class="comment">// 过滤掉除了中文、英文、数字之外的</span></span><br><span class="line">  <span class="comment">// txtTrim = txtTrim.replace(/[^\u4e00-\u9fa5\u0030-\u0039\u0061-\u007a\u0041-\u005a]+/g, "")</span></span><br><span class="line">  <span class="keyword">const</span> strArr = txtTrim.<span class="title function_">split</span>(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">let</span> lastChinese;</span><br><span class="line">  <span class="keyword">const</span> arrStr = [];</span><br><span class="line">  strArr.<span class="title function_">forEach</span>(<span class="function">(<span class="params">char</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">" "</span>) {</span><br><span class="line">      <span class="keyword">if</span> (!lastChinese) {</span><br><span class="line">        arrStr.<span class="title function_">push</span>(char);</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      arrStr.<span class="title function_">push</span>(char);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/.*[\u2E80-\u9FFF]+.*$/</span>.<span class="title function_">test</span>(char)) {</span><br><span class="line">      <span class="comment">// \u 表示unicode</span></span><br><span class="line">      lastChinese = <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      lastChinese = <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">return</span> arrStr.<span class="title function_">join</span>(<span class="string">""</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="v2"><a href="#v2" class="headerlink" title="v2"></a>v2</h2><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除空格，英文之间空格不删除</span></span><br><span class="line"><span class="comment"> * 文字开头不会出现空白字符,文末最多只保留一个空白</span></span><br><span class="line"><span class="comment"> *&nbsp;去掉所有连续的不可见，只保留一个</span></span><br><span class="line"><span class="comment"> *&nbsp;中日韩文字之间不保留任何不可见字符</span></span><br><span class="line"><span class="comment"> * 常用不可见字符包括 空格(\u0020) Backspace(\b) 制表符(\t) 换行符(\n) 垂直制表符(\v) 换页符(\f)等15种，详见isBlank方法注释</span></span><br><span class="line"><span class="comment"> * 示例</span></span><br><span class="line"><span class="comment"> * deleteTrim("&nbsp;&nbsp;你&nbsp;好1&nbsp;&nbsp;hello,\r\n&nbsp;&nbsp;world!&nbsp;&nbsp;&nbsp;")    "你好1 hello, world! "</span></span><br><span class="line"><span class="comment"> * deleteTrim("你  好")  "你好"</span></span><br><span class="line"><span class="comment"> * deleteTrim("&nbsp;&nbsp;你好&nbsp;&nbsp;")  "你好"</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">deleteTrim</span>(<span class="params"><span class="attr">text</span>?: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">undefined</span> {</span><br><span class="line">  <span class="keyword">if</span> (!text) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">let</span> lastChinese = <span class="literal">false</span>,</span><br><span class="line">    lastBlank = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">const</span> arrStr = [];</span><br><span class="line">  <span class="title class_">Array</span>.<span class="title function_">from</span>(text.<span class="title function_">trim</span>()).<span class="title function_">forEach</span>(<span class="function">(<span class="params">char</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isBlank</span>(char)) {</span><br><span class="line">      <span class="keyword">if</span> (!lastChinese &amp;&amp; !lastBlank) {</span><br><span class="line">        arrStr.<span class="title function_">push</span>(<span class="string">" "</span>);</span><br><span class="line">      }</span><br><span class="line">      lastBlank = <span class="literal">true</span>;</span><br><span class="line">      lastChinese = <span class="literal">false</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      arrStr.<span class="title function_">push</span>(char);</span><br><span class="line">      lastBlank = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/[\u2E80-\u9FFF]$/</span>.<span class="title function_">test</span>(char)) {</span><br><span class="line">        <span class="comment">// \u 表示unicode</span></span><br><span class="line">        lastChinese = <span class="literal">true</span>;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        lastChinese = <span class="literal">false</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">return</span> arrStr.<span class="title function_">join</span>(<span class="string">""</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断字符是否为不可见</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> s 单个字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isBlank</span>(<span class="params"><span class="attr">s</span>: <span class="built_in">string</span></span>): <span class="built_in">boolean</span> {</span><br><span class="line">  <span class="keyword">if</span> (s.<span class="property">length</span> &gt; <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="title class_">Error</span>(<span class="string">"只能传递单字符"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">switch</span> (s) {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u0020"</span>: <span class="comment">// 空格</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u0008"</span>: <span class="comment">// \b</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u0009"</span>: <span class="comment">// \t</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000A"</span>: <span class="comment">// \n</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000B"</span>: <span class="comment">// \v</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000C"</span>: <span class="comment">// \f</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000D"</span>: <span class="comment">// \r</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u00A0"</span>: <span class="comment">// 不换行字符，看上去和空格一样</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u2028"</span>: <span class="comment">// 行分隔符</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u2029"</span>: <span class="comment">// 段落分隔符</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\uFEFF"</span>: <span class="comment">// 字节顺序标记</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u200E"</span>: <span class="comment">// 书写标记</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u2006"</span>: <span class="comment">// 另一种编码不同的空格</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u200D"</span>: <span class="comment">//零宽连接符</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">""</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="JavaScript-版本"><a href="#JavaScript-版本" class="headerlink" title="JavaScript 版本"></a>JavaScript 版本</h2><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deleteTrim</span>(<span class="params">text</span>) {</span><br><span class="line">  <span class="keyword">if</span> (!text) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">let</span> lastChinese = <span class="literal">false</span>,</span><br><span class="line">    lastBlank = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> arrStr = [];</span><br><span class="line">  <span class="title class_">Array</span>.<span class="title function_">from</span>(text).<span class="title function_">forEach</span>(<span class="function">(<span class="params">char</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isBlank</span>(char)) {</span><br><span class="line">      <span class="keyword">if</span> (!lastChinese &amp;&amp; !lastBlank) {</span><br><span class="line">        arrStr.<span class="title function_">push</span>(<span class="string">" "</span>);</span><br><span class="line">      }</span><br><span class="line">      lastBlank = <span class="literal">true</span>;</span><br><span class="line">      lastChinese = <span class="literal">false</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      arrStr.<span class="title function_">push</span>(char);</span><br><span class="line">      lastBlank = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/[\u2E80-\u9FFF]$/</span>.<span class="title function_">test</span>(char)) {</span><br><span class="line">        <span class="comment">// \u 表示unicode</span></span><br><span class="line">        lastChinese = <span class="literal">true</span>;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        lastChinese = <span class="literal">false</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">return</span> arrStr.<span class="title function_">join</span>(<span class="string">""</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isBlank</span>(<span class="params">s</span>) {</span><br><span class="line">  <span class="keyword">if</span> (s.<span class="property">length</span> &gt; <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="title class_">Error</span>(<span class="string">"只能传递单字符"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">switch</span> (s) {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u0020"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u0008"</span>: <span class="comment">// \b</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u0009"</span>: <span class="comment">// \t</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000A"</span>: <span class="comment">// \n</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000B"</span>: <span class="comment">// \v</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000C"</span>: <span class="comment">// \f</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u000D"</span>: <span class="comment">// \r</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u00A0"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u2028"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u2029"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\uFEFF"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u200E"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u2006"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"\u200D"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">""</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>javascript</tag>
        <tag>typescript</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu+github+hexo 搭建自己的博客</title>
    <url>/2018/c067e22a.html</url>
    <content><![CDATA[<h2 id="Hexo在本地搭建一个博客"><a href="#Hexo在本地搭建一个博客" class="headerlink" title="Hexo在本地搭建一个博客"></a>Hexo 在本地搭建一个博客</h2><p>详解从部署到域名解析访问</p>
<p>新增分流访问方法</p>
<span id="more"></span>

<h3 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a><strong>安装 Hexo</strong></h3><ol>
<li><p>安装 nodejs</p>
<blockquote>
<p><a class="link" href="http://nodejs.cn/">http://nodejs.cn/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 丢个链接自己装，傻瓜式安装</p>
<p>或者命令行安装</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install nodejs</span><br></pre></td></tr></tbody></table></figure></div>


</blockquote>
</li>
<li><p>安装 git</p>
<blockquote>
<p>下载安装 <a class="link" href="https://git-scm.com/downloads">https://git-scm.com/downloads<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>命令行安装</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install git</span><br></pre></td></tr></tbody></table></figure></div>


</blockquote>
</li>
<li><p>使用 npm 安装 Hexo</p>
</li>
</ol>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装npm工具（不知道干什么用的去百度）</span></span><br><span class="line">sudo apt install npm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">为npm更换国内淘宝镜像</span></span><br><span class="line">sudo npm config set registry https://registry.npm.taobao.org</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检测是否更换成功</span></span><br><span class="line">sudo npm config list</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">全局安装n管理器(用于管理nodejs版本)</span></span><br><span class="line">sudo npm install n -g</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装最新的nodejs（stable版本）</span></span><br><span class="line">sudo n stable</span><br><span class="line">sudo node -v</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装hexo</span></span><br><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a><strong>快速开始</strong></h3><p>1 找个文件夹下打开终端，输入</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">hexo i blog //init的缩写 blog是项目名</span><br><span class="line">cd blog //切换到站点根目录</span><br><span class="line">hexo g //generetor的缩写</span><br><span class="line">hexo s //server的缩写</span><br></pre></td></tr></tbody></table></figure></div>

<p>2 打开浏览器输入 localhost:4000 查看：</p>
<p>看到页面就说明成功了，这个就是 hexo 默认的博客主题。现在你已经可以在这个主题下写博客了。</p>
<p>当然，我是不喜欢这样的，幸好，github 上有大量的主题可供选择，这里我选择使用 nexT 主题。</p>
<h3 id="选择主题–nexT"><a href="#选择主题–nexT" class="headerlink" title="选择主题–nexT"></a><strong>选择主题–nexT</strong></h3><p>1 . 在站点根目录输入</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">git clone https://github.com/iissnan/hexo-theme-next themes/next11</span><br></pre></td></tr></tbody></table></figure></div>

<p>2 . 完成后，打开 站点配置文件， 找到 theme 字段，并将其值更改为 next</p>
<blockquote>
<p>配置文件就是根目录下的_config.yml 文件</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/04/20250415093220375.webp" alt="image"></p>
</blockquote>
<p>把 landscape 改为 next</p>
<p>3 . 在终端输入</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">hexo clean  #清除缓存</span><br><span class="line">hexo g  #重新生成代码</span><br><span class="line">hexo s  #部署到本地</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">然后打开浏览器访问 localhost:4000 查看效果</span></span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415093610924.webp" alt="预览"></p>
</blockquote>
<p>nexT 主题有三种选择，这个只是最简洁的一种，我们选择最好看的那个。</p>
<blockquote>
<ul>
<li><strong>Muse</strong> - 默认 Scheme，这是 NexT 最初的版本，黑白主调，大量留白</li>
<li><strong> Mist</strong> - Muse 的紧凑版本，整洁有序的单栏外观</li>
<li><strong> Pisces</strong> - 双栏 Scheme，小家碧玉似的清新</li>
</ul>
</blockquote>
<p>4 . 配置 nexT</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415094733977.webp" alt="next主题"></p>
<p>在 站点根目录 /themes/next/_congig.yml 文件中修改</p>
</blockquote>
<p>然后重新 clean，generator，查看效果:</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415094828039.webp" alt="这里写图片描述"></p>
</blockquote>
<p>当然，你完全可以进行很多的自定义设置甚至修改源码，定制自己的主题。更多的设置请移步官方文档</p>
<blockquote>
<p><a class="link" href="http://theme-next.iissnan.com/theme-settings.html">http://theme-next.iissnan.com/theme-settings.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h2 id="将本地博客上传到github"><a href="#将本地博客上传到github" class="headerlink" title="将本地博客上传到github"></a>将本地博客上传到 github</h2><p>话不多做，直接开始。</p>
<p>1 . 注册 github 账号</p>
<blockquote>
<p><a class="link" href="https://github.com/">https://github.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 甩个链接自己看着办</p>
</blockquote>
<p>2 . 创建一个新项目</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/github/github_%E6%96%B0%E5%BB%BA.png" alt="这里写图片描述"></p>
</blockquote>
<p>3 . 按格式输入项目名称</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/github/github_%E4%BB%93%E5%BA%93.png" alt="这里写图片描述"></p>
<p>注意规范！！</p>
</blockquote>
<p>4 . 点击设置 创建一个 page</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415094931750.webp" alt="创建"></p>
</blockquote>
<hr>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095006718.webp" alt="这里写图片描述"></p>
</blockquote>
<hr>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095049738.webp" alt="这里写图片描述"></p>
</blockquote>
<p>5 . 选择一个主题，没什么用，反正马上就被覆盖掉了。。</p>
<p>这个时候访问一下你的链接，应该可以看到效果：</p>
<p>接下来将我们 Hexo 的代码部署到 github 上。</p>
<p>6 . 修改 hexo 站点的配置文件</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/github/%E9%85%8D%E7%BD%AE.png" alt="这里写图片描述"></p>
<p>deploy:<br>type: git<br>repository: <a class="link" href="mailto:git@github.com">git@github.com<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>:tsvico/tsvico.github.io.git<br>branch: master</p>
<p>// 相关地址改成自己的</p>
</blockquote>
<p>改成这样就好了，记得保存。</p>
<blockquote>
<p>注意！！！冒号的后面一定一定一定要有一个空格！！</p>
</blockquote>
<p>7 . 部署一下就好了</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">//先装个插件压压惊</span><br><span class="line">hexo d  //  部署的命令</span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p>这里可能会让你输入账号密码，如果输入后依旧上传不成功</p>
<p>你需要配置秘钥访问 github</p>
<p>由于你的本地 Git 仓库和 GitHub 仓库之间的传输是通过 SSH 加密的，所以，需要一点设置：</p>
<p>第 1 步：创建 SSH Key。在用户主目录下，看看有没有.ssh 目录，如果有，再看看这个目录下有没有 <code>id_rsa</code> 和 <code>id_rsa.pub</code> 这两个文件，如果已经有了，可直接跳到下一步。如果没有，打开 Shell（Windows 下打开 Git Bash），创建 SSH Key：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C "youremail@example.com"</span><br></pre></td></tr></tbody></table></figure></div>

<p>你需要把邮件地址换成你自己的邮件地址，然后一路回车，使用默认值即可，由于这个 Key 也不是用于军事目的，所以也无需设置密码。</p>
<p>如果一切顺利的话，可以在用户主目录里找到<code>.ssh</code> 目录，里面有 <code>id_rsa</code> 和 <code>id_rsa.pub</code> 两个文件，这两个就是 SSH Key 的秘钥对，<code>id_rsa</code> 是私钥，不能泄露出去，<code>id_rsa.pub</code> 是公钥，可以放心地告诉任何人。</p>
<p>第 2 步：登陆 GitHub，打开 “Account settings”，“SSH Keys” 页面：</p>
<p>然后，点 “Add SSH Key”，填上任意 Title，在 Key 文本框里粘贴 <code>id_rsa.pub</code> 文件的内容：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095128035.webp" alt="github-addkey-1"></p>
<p>点 “Add Key”，你就应该看到已经添加的 Key：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095149978.webp" alt="github-addkey-2"></p>
<p>为什么 GitHub 需要 SSH Key 呢？因为 GitHub 需要识别出你推送的提交确实是你推送的，而不是别人冒充的，而 Git 支持 SSH 协议，所以，GitHub 只要知道了你的公钥，就可以确认只有你自己才能推送。</p>
<p>当然，GitHub 允许你添加多个 Key。假定你有若干电脑，你一会儿在公司提交，一会儿在家里提交，只要把每台电脑的 Key 都添加到 GitHub，就可以在每台电脑上往 GitHub 推送了。</p>
<p>最后友情提示，在 GitHub 上免费托管的 Git 仓库，任何人都可以看到喔（但只有你自己才能改）。所以，不要把敏感信息放进去。</p>
</blockquote>
<p>再次访问你的网站：</p>
<blockquote>
<p><a class="link" href="https://用户名.github.io/">https:// 用户名.github.io<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>perfect！</p>
<h2 id="发布你的第一篇博客"><a href="#发布你的第一篇博客" class="headerlink" title="发布你的第一篇博客"></a>发布你的第一篇博客</h2><p>根目录下输入 ：</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">hexo new "postName"</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">hexo n 也可以</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">你自己的博客名称，名为postName.md的文件会建在目</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">录/blog/source/_posts下</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>文章编辑完成后，终端在根目录文件夹下，执行如下命令来发布:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">hexo g //生成静态页面</span><br><span class="line">hexo d //发布</span><br></pre></td></tr></tbody></table></figure></div>

<p>现在查看一下：</p>
<blockquote>
<p><a class="link" href="https://用户名.github.io/">https:// 用户名.github.io<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>已经发布上去咯。</p>
<h2 id="主题相关"><a href="#主题相关" class="headerlink" title="主题相关"></a>主题相关</h2><p>本次的教程就先到这里，这只是最基础的，对于主题，你还有更多的选择更多的设置，甚至自己写一个静态博客界面。撤了 Hexo，你还可以用其他的方式来搭建。如果你不喜欢 github 提供的域名，你可以自己买一个域名做绑定</p>
<blockquote>
<p><a class="link" href="https://hexo.io/themes/">https://hexo.io/themes/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 更多 hexo 主题</p>
<p><a class="link" href="https://www.zhihu.com/question/24422335">https://www.zhihu.com/question/24422335<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 知乎上的 hexo 主题</p>
<p>或者直接 github 搜 hexo</p>
<p><a class="link" href="https://github.com/tsvico">https://github.com/tsvico<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 我的 github</p>
<p><a class="link" href="https://tsvico.github.io/">https://tsvico.github.io/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 我的博客主页</p>
<p><a href="http://blog.tbox.fun/">http://blog.tbox.fun/</a> 这个是解析后的地址</p>
</blockquote>
<h2 id="域名绑定"><a href="#域名绑定" class="headerlink" title="域名绑定"></a>域名绑定</h2><p>首先你得有一个域名，我用的腾讯的域名，因为我是学生，可以免费使用，不过需要实名认证和备案，挺麻烦的。</p>
<p>实名认证和备案都搞定以后。到域名解析页面添加一条解析：</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/github/github_%E8%A7%A3%E6%9E%90.png" alt="这里写图片描述"></p>
</blockquote>
<p>然后到你博客 根目录 /source 目录下创建一个新文件 CNAME<br>在里面写上你刚刚配置的路径，比如我的是 blog.tbox.fun，就直接在 CNAME 文件中写上这个地址就好了。</p>
<p>然后执行以下 hexo g,hexo d，让后访问你自己的地址就可以跳转到博客了。</p>
<hr>
<p>晚间更新  </p>
<p>为了提高国内访问速度</p>
<p>采取了分流的方式将网站同时部署在 github 和 coding 上，部署过程大同小异，有两个关键点需要提一下</p>
<p>之前的 Hexo 博客目录下的站点配置文件<code>_config.yml</code> 中的部署配置为  </p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: git@github.com:tsvico/tsvico.github.io.git </span><br><span class="line">  branch: master</span><br></pre></td></tr></tbody></table></figure></div>

<p>现在更改为</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">    type: git</span><br><span class="line">    repo: </span><br><span class="line">        github: git@github.com:tsvico/tsvico.github.io.git #前边名字无所谓，自己能区分就可以</span><br><span class="line">        coding: git@git.coding.net:tsvico/tsvico.git</span><br><span class="line">    branch: master</span><br></pre></td></tr></tbody></table></figure></div>

<p>大体格式就是这个样子，注意更改  </p>
<p>解析是这样</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/github/jiexi.png" alt="image"></p>
]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 常用命令</title>
    <url>/2018/fa6c14b0.html</url>
    <content><![CDATA[<p>我常用到的一些，这里做个备份</p>
<span id="more"></span>

<h2 id="Ubuntu16-04"><a href="#Ubuntu16-04" class="headerlink" title="Ubuntu16.04"></a>Ubuntu16.04</h2><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">nvidia-settings 设置显卡</span><br><span class="line">sudo nautilus 管理员打开文件管理器</span><br><span class="line">sudo apt-get update更新软件源</span><br><span class="line">sudo apt-get upgrade 更新已安装软件</span><br><span class="line">sudo apt-get autoremove 卸载无用软件包</span><br><span class="line">sudo purge-old-kernels 删除旧内核</span><br><span class="line">sudo update-alternatives --config python 版本切换python</span><br><span class="line">cd /etc/apt/sources.list.d  查看apt列表</span><br><span class="line">source bin/activate 进入容器</span><br></pre></td></tr></tbody></table></figure></div>
<p>ps：</p>
<blockquote>
<p>删除旧内核参见我的 <a class="link" href="https://blog.csdn.net/tsvico/article/details/79942467">CSDN<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Python 版本切换同上，<a class="link" href="https://blog.csdn.net/tsvico/article/details/80165060">链接<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>这个博客创建晚于写这两篇文章，这里就不写了</p>
</blockquote>
<h3 id="pip国内的一些镜像"><a href="#pip国内的一些镜像" class="headerlink" title="pip国内的一些镜像"></a><code>pip</code> 国内的一些镜像</h3><div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"> 阿里云 http://mirrors.aliyun.com/pypi/simple/ </span><br><span class="line">  中国科技大学 https://pypi.mirrors.ustc.edu.cn/simple/ </span><br><span class="line">  豆瓣(douban) http://pypi.douban.com/simple/ </span><br><span class="line">  清华大学 https://pypi.tuna.tsinghua.edu.cn/simple/ </span><br><span class="line">  中国科学技术大学 http://pypi.mirrors.ustc.edu.cn/simple/</span><br><span class="line">修改源方法：</span><br><span class="line">临时使用： </span><br><span class="line">可以在使用pip的时候在后面加上-i参数，指定pip源 </span><br><span class="line">eg: pip install scrapy -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="软件源"><a href="#软件源" class="headerlink" title="软件源"></a>软件源</h3><p>文件在 <code>/etc/apt/sources.list</code> 目录下</p>
<p>这里是 163 源（掺杂了阿里源）</p>
<p>只适用于 Ubuntu16.04</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">deb http://mirrors.163.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main universe restricted multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main universe restricted multiverse #Added by software-properties</span><br><span class="line">deb http://security.ubuntu.com/ubuntu/ xenial-security main universe restricted multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main universe restricted multiverse</span><br><span class="line">deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial stable</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src [<span class="built_in">arch</span>=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial stable</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="开源镜像站"><a href="#开源镜像站" class="headerlink" title="开源镜像站"></a>开源镜像站</h3><p>清华大学镜像站 <a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/">https://mirrors.tuna.tsinghua.edu.cn/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>（支持 TensorFlow）</p>
<p>中科大 <a class="link" href="https://mirrors.ustc.edu.cn/">https://mirrors.ustc.edu.cn/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h3 id="查找某字符串"><a href="#查找某字符串" class="headerlink" title="查找某字符串"></a>查找某字符串</h3><div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">grep -rn "hello,world!" *</span><br></pre></td></tr></tbody></table></figure></div>

<p>* : 表示当前目录所有文件，也可以是某个文件名</p>
<p>-r 是递归查找</p>
<p>-n 是显示行号</p>
<p>-R 查找所有文件包含子目录</p>
<p>-i 忽略大小写</p>
<p>下面是一些有意思的命令行参数：</p>
<p><code>grep -i pattern files</code> ：不区分大小写地搜索。默认情况区分大小写， </p>
<p><code>grep -l pattern files </code>：只列出匹配的文件名， </p>
<p><code>grep -L pattern files </code>：列出不匹配的文件名， </p>
<p><code>rep -w pattern files </code>：只匹配整个单词，而不是字符串的一部分（如匹配‘magic’，而不是‘magical’）， </p>
<p><code>grep -C number pattern files </code>：匹配的上下文分别显示 [number] 行， </p>
<p><code>grep pattern1 | pattern2 files </code>：显示匹配 pattern1 或 pattern2 的行， </p>
<p><code>grep pattern1 files | grep pattern2 </code>：显示既匹配 pattern1 又匹配 pattern2 的行。 </p>
<p>这里还有些用于搜索的特殊符号：<br>&lt;和&gt; 分别标注单词的开始与结尾。<br>例如：<br><code>grep man * </code>会匹配 ‘Batman’、‘manic’、‘man’等， </p>
<p><code>grep '\&lt;man' * </code>匹配‘manic’和‘man’，但不是‘Batman’， </p>
<p><code>grep '\&lt;man\&gt;' </code>只匹配‘man’，而不是‘Batman’或‘manic’等其他的字符串。 </p>
<p><code>'^'</code>：指匹配的字符串在行首， <code>'$'</code>：指匹配的字符串在行尾，  </p>
]]></content>
      <tags>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu 进入 initramfs 无法开机</title>
    <url>/2018/1daf4ff7.html</url>
    <content><![CDATA[<p>背景：Ubuntu 升级内核过程中不走进度，所以强制重启了（这种方法不可取），本以为系统中有其他内核，所以无所畏惧。</p>
<p>重启后在 <code>GRUB菜单</code> -&gt;<code>Ubuntu高级功能</code> -&gt; <code>老版本内核</code> -&gt;<code>Enter</code></p>
<p>重启后发现进入系统其他内核也不能进入系统</p>
<span id="more"></span>

<p>在高级功能中选择旧内核恢复模式，同样无法出现期待的图形界面</p>
<p>发现每次进入系统，都会有一个 initramfs 在命令行最前头，察觉可能进入了这个模式，网上查资料得知，可能是由于没有正常关机导致磁盘文件损坏；死马当活马医，遂着手修复。</p>
<p>1. 输入 <code>blkid</code> 查看所有磁盘，如果你的磁盘是多分区，记录下所有的 <code>TYPE=”ext4”</code> 的分区，比如我的是 /dev/sda9,/dev/sda10,/dev/sda11;</p>
<p>2. 用 <code>fsck</code> 命令开始检查、修复（fsck 是个很好的磁盘检测修复命令）</p>
<p>输入 fsck /dev/sda9 逐个修复（因为不知道具体哪个分区坏掉了）</p>
<p>坏掉的分区会询问你是否继续，一路输入 y 就可以</p>
<p>最后 <code>reboot</code></p>
<p>接着可以正常启动了</p>
<p><code>dpkg --get-selections |grep linux-image </code>查看已有内核，</p>
<p>可以用 <code>sudo apt-get remove linux-image-4.15.0-34-generic</code> 命令进行卸载，最后的名称换成自己的</p>
<p> <code>uname -a  </code>查看当前内核</p>
<p>由于我的是安装内核命令没执行完，所以我用 <code>sudo dpkg --configure -a</code> 完成了我的安装</p>
]]></content>
      <tags>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>一个简单的 nodejs 目录迭代器</title>
    <url>/2024/320884568.html</url>
    <content><![CDATA[<p>死去的记忆突然攻击我，一份来自四年前使用递归写的遍历目录的方案发生了内存溢出，研究了一下旧代码，发现晦涩难懂，索性重写遍历方法</p>
<span id="more"></span>

<p>先简单说一下我们的需求，我们要实现一个简单的目录迭代器，这个迭代器支持 在调用 <code>.next</code> 后返回一个新路径，并要求性能够高，内存占用尽量少，同时可以支持多线程调用（Promise）</p>
<h2 id="常见的方案"><a href="#常见的方案" class="headerlink" title="常见的方案"></a>常见的方案</h2><h3 id="1-递归遍历（同步）"><a href="#1-递归遍历（同步）" class="headerlink" title="1. 递归遍历（同步）"></a>1. 递归遍历（同步）</h3><p>这是最简单且常见的方案之一。通过递归地读取目录和子目录，处理每个文件或目录。在这种方案中，常用的 fs.readdirSync 会阻塞线程，直到完成读取。</p>
<p><strong>优点：</strong></p>
<ul>
<li>简单易懂。</li>
<li>不需要复杂的控制结构。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>阻塞 I/O，性能差，尤其在文件数量较多时。</li>
<li>无法处理大规模文件系统遍历。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">"path"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">traverseSync</span> = (<span class="params"><span class="attr">dir</span>: <span class="built_in">string</span></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> items = fs.<span class="title function_">readdirSync</span>(dir);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> items) {</span><br><span class="line">    <span class="keyword">const</span> fullPath = path.<span class="title function_">join</span>(dir, item);</span><br><span class="line">    <span class="keyword">const</span> stats = fs.<span class="title function_">statSync</span>(fullPath);</span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="title function_">isDirectory</span>()) {</span><br><span class="line">      <span class="title function_">traverseSync</span>(fullPath); <span class="comment">// 递归遍历子目录</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(fullPath); <span class="comment">// 处理文件</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="2-递归遍历（异步）"><a href="#2-递归遍历（异步）" class="headerlink" title="2. 递归遍历（异步）"></a>2. 递归遍历（异步）</h3><p>为了避免阻塞主线程，可以使用异步 API（如 fs.promises.readdir）来异步读取目录内容。这种方法通过事件循环处理每一个目录，适合处理大规模文件系统。<br><strong>优点：</strong></p>
<ul>
<li>非阻塞，适合处理大规模的文件系统。</li>
<li>性能相对较高。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要处理并发问题。</li>
<li>编写代码时需要考虑异步错误处理。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">"path"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">traverseAsync</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">dir</span>: <span class="built_in">string</span></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> items = <span class="keyword">await</span> fs.<span class="property">promises</span>.<span class="title function_">readdir</span>(dir, { <span class="attr">withFileTypes</span>: <span class="literal">true</span> });</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> items) {</span><br><span class="line">    <span class="keyword">const</span> fullPath = path.<span class="title function_">join</span>(dir, item.<span class="property">name</span>);</span><br><span class="line">    <span class="keyword">if</span> (item.<span class="title function_">isDirectory</span>()) {</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">traverseAsync</span>(fullPath); <span class="comment">// 递归遍历子目录</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(fullPath); <span class="comment">// 处理文件</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="3-使用异步生成器（我的实现）"><a href="#3-使用异步生成器（我的实现）" class="headerlink" title="3. 使用异步生成器（我的实现）"></a>3. 使用异步生成器（我的实现）</h3><p>使用异步生成器 (AsyncGenerator) 是一种非常高效且灵活的遍历方案。它允许你在遍历目录时逐步返回每个文件或目录，并能够在需要时暂停或继续遍历。<br><strong>优点：</strong></p>
<ul>
<li>高效并且具有良好的内存控制。</li>
<li>可以与 <code>for-await-of</code> 循环配合使用，易于管理。</li>
<li>可以轻松暂停或控制遍历的进度（例如通过 <code>yield</code> 控制）。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要理解生成器和异步操作。</li>
<li>需要手动处理递归的异步调用。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">"path"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Context</span> {</span><br><span class="line">  <span class="attr">filePath</span>: <span class="built_in">string</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">FileTraverser</span> {</span><br><span class="line">  <span class="keyword">private</span> num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">sleep</span>(<span class="params"><span class="attr">time</span>: <span class="built_in">number</span></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="literal">true</span>);</span><br><span class="line">      }, time);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 改成异步生成器，使用 yield 来返回每个文件或目录</span></span><br><span class="line">  <span class="keyword">async</span> *<span class="title function_">traverse</span>(<span class="attr">dirname</span>: <span class="built_in">string</span>): <span class="title class_">AsyncGenerator</span>&lt;<span class="title class_">Context</span> | <span class="literal">null</span>&gt; {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">const</span> dirents = fs.<span class="title function_">readdirSync</span>(dirname, { <span class="attr">withFileTypes</span>: <span class="literal">true</span> });</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">num</span>++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">num</span> % <span class="number">500</span> === <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">sleep</span>(<span class="number">0</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> dirent <span class="keyword">of</span> dirents) {</span><br><span class="line">        <span class="keyword">const</span> filepath = path.<span class="title function_">join</span>(dirname, dirent.<span class="property">name</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">          <span class="keyword">if</span> (dirent.<span class="title function_">isDirectory</span>()) {</span><br><span class="line">            <span class="keyword">for</span> <span class="title function_">await</span> (<span class="keyword">const</span> item <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="title function_">traverse</span>(filepath)) {</span><br><span class="line">              <span class="keyword">yield</span> item;</span><br><span class="line">            }</span><br><span class="line">          } <span class="keyword">else</span> <span class="keyword">if</span> (dirent.<span class="title function_">isFile</span>()) {</span><br><span class="line">            <span class="keyword">yield</span> { <span class="attr">filePath</span>: filepath };</span><br><span class="line">          }</span><br><span class="line">        } <span class="keyword">catch</span> (e) {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">catch</span> (e) {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>调用方式</p>
<blockquote>
<p>单线程调用统计文件数</p>
</blockquote>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> traverser = <span class="keyword">new</span> <span class="title class_">FileTraverser</span>().<span class="title function_">traverse</span>(dir);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="title function_">await</span> (<span class="keyword">const</span> item <span class="keyword">of</span> traverser) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(item);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">while</span> (!canceled) {</span><br><span class="line">  <span class="keyword">const</span> { done, value } = <span class="keyword">await</span> traverser.<span class="title function_">next</span>();</span><br><span class="line">  <span class="keyword">if</span> (done) {</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 处理当前 item</span></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value.<span class="property">filePath</span>);</span><br><span class="line">    <span class="comment">// 文件数++</span></span><br><span class="line">  } <span class="keyword">catch</span> (e) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">"出错"</span>, e);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="4-广度优先遍历（BFS）"><a href="#4-广度优先遍历（BFS）" class="headerlink" title="4.广度优先遍历（BFS）"></a>4. 广度优先遍历（BFS）</h3><p>在广度优先遍历中，目录会按照层级逐层遍历，而不是递归进入深层目录。这种方法适合需要按层级处理文件的场景。这种方式需要记下所有待遍历的目录和文件，然后逐个遍历。可以简单理解为将根目录所有文件入栈，再进行出栈<br><strong>优点：</strong></p>
<ul>
<li>可以避免深递归带来的栈溢出问题。</li>
<li>在某些应用场景下，广度优先遍历是更合理的选择（例如，当需要优先处理浅层目录时）。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要使用队列或其他数据结构来存储待遍历的目录和文件。</li>
<li>对内存的需求相对较高，因为需要存储所有待处理的目录。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">"path"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">traverseBFS</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">dir</span>: <span class="built_in">string</span></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> queue = [dir]; <span class="comment">// 队列存储待遍历的目录</span></span><br><span class="line">  <span class="keyword">while</span> (queue.<span class="property">length</span> &gt; <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">const</span> currentDir = queue.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">if</span> (currentDir) {</span><br><span class="line">      <span class="keyword">const</span> items = <span class="keyword">await</span> fs.<span class="property">promises</span>.<span class="title function_">readdir</span>(currentDir, {</span><br><span class="line">        <span class="attr">withFileTypes</span>: <span class="literal">true</span>,</span><br><span class="line">      });</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> items) {</span><br><span class="line">        <span class="keyword">const</span> fullPath = path.<span class="title function_">join</span>(currentDir, item.<span class="property">name</span>);</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="title function_">isDirectory</span>()) {</span><br><span class="line">          queue.<span class="title function_">push</span>(fullPath); <span class="comment">// 将目录添加到队列</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(fullPath); <span class="comment">// 处理文件</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="实现优化"><a href="#实现优化" class="headerlink" title="实现优化"></a>实现优化</h2><p>在上面的代码中，<code>FileTraverser</code> 类通过递归方式读取目录中的文件。在每处理完 500 个文件后，通过 <code>sleep(0)</code> 使线程短暂休眠，避免阻塞主线程。然而，使用 <code>Promise</code> 实现的 <code>sleep</code> 会导致多线程调用时的不安全。</p>
<h3 id="删除-FileTraverser-的-sleep-方法"><a href="#删除-FileTraverser-的-sleep-方法" class="headerlink" title="删除 FileTraverser 的 sleep 方法"></a>删除 <code>FileTraverser</code> 的 <code>sleep</code> 方法</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">"path"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Context</span> {</span><br><span class="line">  <span class="attr">filePath</span>: <span class="built_in">string</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">FileTraverser</span> {</span><br><span class="line">  <span class="keyword">async</span> *<span class="title function_">traverse</span>(<span class="attr">dirname</span>: <span class="built_in">string</span>): <span class="title class_">AsyncGenerator</span>&lt;<span class="title class_">Context</span> | <span class="literal">null</span>&gt; {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">const</span> dirents = fs.<span class="title function_">readdirSync</span>(dirname, { <span class="attr">withFileTypes</span>: <span class="literal">true</span> });</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> dirent <span class="keyword">of</span> dirents) {</span><br><span class="line">        <span class="keyword">const</span> filepath = path.<span class="title function_">join</span>(dirname, dirent.<span class="property">name</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">          <span class="keyword">if</span> (dirent.<span class="title function_">isDirectory</span>()) {</span><br><span class="line">            <span class="keyword">for</span> <span class="title function_">await</span> (<span class="keyword">const</span> item <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="title function_">traverse</span>(filepath)) {</span><br><span class="line">              <span class="keyword">yield</span> item;</span><br><span class="line">            }</span><br><span class="line">          } <span class="keyword">else</span> <span class="keyword">if</span> (dirent.<span class="title function_">isFile</span>()) {</span><br><span class="line">            <span class="keyword">yield</span> { <span class="attr">filePath</span>: filepath };</span><br><span class="line">          }</span><br><span class="line">        } <span class="keyword">catch</span> (e) {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">catch</span> (e) {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这时会面临一个很严重的问题，这种方案当调用方处理过快时会阻塞主线程，需要在调用方中进行 <code>sleep</code></p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 单线程调用统计文件数</span></span><br><span class="line"><span class="keyword">let</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (!canceled) {</span><br><span class="line">  cnt++;</span><br><span class="line">  <span class="keyword">if</span> (cnt % <span class="number">500</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">sleep</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> { done, value } = <span class="keyword">await</span> traverser.<span class="title function_">next</span>();</span><br><span class="line">  <span class="keyword">if</span> (done) {</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 处理当前 item</span></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  } <span class="keyword">catch</span> (e) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">"出错"</span>, e);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="测试及示例"><a href="#测试及示例" class="headerlink" title="测试及示例"></a>测试及示例</h2><p>最终测试统计 C 盘文件数，用时 1 分半</p>
<p>多线程调用示例，外部 rxjs 每发送一个 next 信号，抛出一个文件</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dir 将遍历的目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> next$ 外部rxjs，在需要新的文件时发送一个next</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回遍历的结果,每次抛出一个文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">walkDir</span>(<span class="attr">dir</span>: <span class="built_in">string</span>, <span class="attr">next$</span>: <span class="title class_">Observable</span>&lt;<span class="built_in">unknown</span>&gt;): <span class="title class_">Observable</span>&lt;<span class="title class_">WalkDirItem</span>&gt; {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>&lt;<span class="title class_">WalkDirItem</span>&gt;(<span class="function"><span class="params">subscriber</span> =&gt;</span> {</span><br><span class="line">        <span class="keyword">const</span> traverser = <span class="keyword">new</span> <span class="title class_">FileTraverser</span>().<span class="title function_">traverse</span>(dir)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> processNextItem = <span class="title function_">async</span> (<span class="attr">traverser</span>: <span class="title class_">AsyncIterableIterator</span>&lt;<span class="built_in">any</span>&gt;, <span class="attr">subscriber</span>: <span class="title class_">Subscriber</span>&lt;<span class="title class_">WalkDirItem</span>&gt;): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; =&gt; {</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">const</span> { done, value } = <span class="keyword">await</span> traverser.<span class="title function_">next</span>()</span><br><span class="line">                    <span class="keyword">if</span> (!done) {</span><br><span class="line">                        subscriber.<span class="title function_">next</span>({</span><br><span class="line">                            <span class="attr">filepath</span>: value.<span class="property">filePath</span>,</span><br><span class="line">                            <span class="attr">stats</span>: fs.<span class="title function_">statSync</span>(value.<span class="property">filePath</span>)</span><br><span class="line">                        })</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        subscriber.<span class="title function_">complete</span>()</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (e) {</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">"遍历目录出错，正在重试..."</span>, e)</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">let</span> cnt = <span class="number">0</span></span><br><span class="line">        next$.<span class="title function_">subscribe</span>({</span><br><span class="line">            <span class="attr">next</span>: <span class="title function_">async</span> () =&gt; {</span><br><span class="line">                cnt++</span><br><span class="line">                <span class="keyword">if</span> (cnt % <span class="number">500</span> === <span class="number">0</span>) {</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                        <span class="title function_">processNextItem</span>(traverser, subscriber).<span class="title function_">then</span>()</span><br><span class="line">                    }, <span class="number">0</span>)</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="title function_">processNextItem</span>(traverser, subscriber).<span class="title function_">then</span>()</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p>代码整理较混乱，见谅</p>
</blockquote>
]]></content>
      <tags>
        <tag>typescript</tag>
        <tag>nodejs</tag>
      </tags>
  </entry>
  <entry>
    <title>一文接入 passKey</title>
    <url>/2024/4152515392.html</url>
    <content><![CDATA[<p>书接上回 <a href="/2024/4120651335.html">php 接入单点</a> , 之前文章中说了接入 <code>passKey</code>，但是看起来挺复杂，就先接入了单点登录，今天又查了些文章，学习了下，把 <code>passKey</code> 也啃了下来。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://cdn-fusion.imgimg.cc/i/2024/13e0f2a17f4c6196.png" alt="1723992394254.png"></p>
<span id="more"></span>

<h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><h3 id="什么是-FIDO2？"><a href="#什么是-FIDO2？" class="headerlink" title="什么是 FIDO2？"></a>什么是 FIDO2？</h3><p>FIDO2（Fast IDentity Online 2.0）是一个由 FIDO 联盟推出的开放认证标准，旨在通过公钥加密技术实现更安全、更便捷的无密码身份验证。FIDO2 标准由两个关键组件组成：</p>
<ul>
<li>WebAuthn：由 W3C 定义的 Web 认证标准，允许 Web 应用程序通过浏览器和平台级 API 进行安全的用户身份验证。</li>
<li>CTAP（客户端到认证器协议）：定义了浏览器或操作系统与认证设备（如安全密钥或生物识别传感器）之间的通信方式。</li>
</ul>
<h3 id="什么是-WebAuthn？"><a href="#什么是-WebAuthn？" class="headerlink" title="什么是 WebAuthn？"></a>什么是 WebAuthn？</h3><p>WebAuthn 是 FIDO2 标准的核心部分之一。它是一个由 W3C 标准化的 Web API，允许网站和应用程序通过浏览器注册和验证用户的公钥，并通过使用硬件认证器（如生物识别设备或安全密钥）进行身份验证。WebAuthn 消除了传统密码的使用，提高了安全性，并且使用户体验更加顺畅。</p>
<h3 id="什么是Passkey"><a href="#什么是Passkey" class="headerlink" title="什么是Passkey"></a>什么是 Passkey</h3><p>Passkey 是 FIDO2 和 WebAuthn 技术的具体实现形式，它代表了一种无密码的用户身份验证方式。Passkey 本质上是基于 FIDO2 标准的公钥凭证，但它被设计得更加用户友好，通常与设备集成，比如手机或笔记本中的生物识别传感器。用户可以通过指纹、面部识别或设备 PIN 码来完成身份验证，无需记忆或输入复杂的密码。</p>
<h3 id="三者的关系"><a href="#三者的关系" class="headerlink" title="三者的关系"></a>三者的关系</h3><ul>
<li>FIDO2 是整个无密码认证体系的框架和标准，规定了如何使用公钥加密进行身份验证。</li>
<li>WebAuthn 是 FIDO2 框架中的 Web API，定义了浏览器与服务器之间的交互方式，支持多种认证方式。</li>
<li>Passkey 是基于 FIDO2 和 WebAuthn 的具体应用形式，它让用户可以通过生物识别等方式轻松、安全地进行无密码登录。</li>
</ul>
<p>总结来说，Passkey 是 FIDO2 和 WebAuthn 在实际应用中的一种具象化的表现，它利用了这些标准所提供的技术，旨在提供更安全、更便捷的身份验证体验。</p>
<pre class="mermaid">mindmap
  root((FIDO2))
    WebAuthn
      W3C标准
      Web API
      浏览器与服务器交互
    CTAP
      客户端到认证器协议
      设备与认证器通信
    Passkey
      基于FIDO2标准
      结合WebAuthn和CTAP
      无密码身份验证
      支持生物识别和设备集成</pre>
<h2 id="查阅资料"><a href="#查阅资料" class="headerlink" title="查阅资料"></a>查阅资料</h2><p>相关资料较少，先是看了<a class="link" href="https://liaoxuefeng.com/blogs/all/2023-08-15-what-is-passkey/index.html">一文搞懂 Passkey<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, 让我对 passkey 有了初步的认识，然后看了 <a class="link" href="https://liaoxuefeng.com/blogs/all/2023-08-16-passkey-dev/index.html">Passkey 开发指南<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，感觉还是懂了点什么，但是还是有点模糊，于是我找到了 <a class="link" href="https://github.com/lbuchs/WebAuthn">lbuchs/WebAuthn<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>这款 PHP WebAuthn （FIDO2） 服务器库。通过阅读示例代码，开始着手进行开发。</p>
<p>开发过程一波 N 折，由于资料较少，认证流程理不清，最后看到了这篇文章 <a class="link" href="https://juejin.cn/post/7304265842953601061">WebAuthn 在 php 中的实践<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，对我启发很大，现在终于明白了整体流程。<br>简单来说就是：</p>
<ul>
<li>认证器注册<ul>
<li>通过接口 <code>a1</code> 获取注册凭证，拿凭证调用浏览器 <code>navigator.credentials.create</code></li>
<li>拿认证结果调用 <code>a2</code>，<code>a2</code> 校验并保存凭证信息，以供后续使用</li>
</ul>
</li>
<li>认证器登录<ul>
<li>通过接口 <code>b1</code> 获取登录凭证，拿凭证调用浏览器 <code>navigator.credentials.get</code></li>
<li>拿结果调用 <code>b2</code>，<code>b2</code> 校验凭证并进行登录</li>
</ul>
</li>
</ul>
<h2 id="开始开发"><a href="#开始开发" class="headerlink" title="开始开发"></a>开始开发</h2><p>接入 WebAuthn，首先需要安装一个 PHP WebAuthn 库，我选择的是 lbuchs/WebAuthn。该库提供了简单易用的 API，支持 FIDO2 标准的无密码认证。</p>
<ol>
<li>安装依赖<br>使用 Composer 安装 lbuchs/webauthn 库：</li>
</ol>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">composer require lbuchs/webauthn</span><br></pre></td></tr></tbody></table></figure></div>

<p>安装完成后，可以在项目中引用这个库，进行 WebAuthn 的开发。</p>
<ol start="2">
<li>配置 WebAuthn 服务器<br>在服务器端，我们需要配置 WebAuthn 服务来处理认证请求。以下是初始化 WebAuthn 对象的代码：</li>
</ol>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">lbuchs</span>\<span class="title">WebAuthn</span>\<span class="title">WebAuthnException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项</span></span><br><span class="line"><span class="variable">$rpName</span> = <span class="string">'工具牛'</span>;</span><br><span class="line"><span class="variable">$rpId</span> = <span class="string">'localhost'</span>;</span><br><span class="line"><span class="variable">$origin</span> = <span class="string">'http://localhost'</span>;</span><br><span class="line"><span class="variable">$user_name</span> = <span class="string">"tsvico"</span>;</span><br><span class="line"><span class="variable">$user_mail</span> = <span class="string">"xxxx@xx.com"</span>;</span><br><span class="line"><span class="variable">$user_nick</span> = <span class="string">"tsvico"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWebAuthnInstance</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> lbuchs\WebAuthn\<span class="title function_ invoke__">WebAuthn</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>WebAuthn 构造函数的参数分别是：应用名称、RP ID（也就是你的域名）和 origin（通常是网站的 URL），由于我的登录仅仅我自己使用，就将用户写死在代码里了。</p>
<ol start="3">
<li><p>注册流程 (后台页面)<br>在用户注册阶段，我们需要让用户的浏览器生成一个新的认证器凭证，然后将其发送到服务器进行验证和保存。</p>
<ul>
<li><p>生成注册信息</p>
<p>首先，我们需要生成一个 challenge 并返回给客户端。challenge 是一个临时生成的随机字符串，用于防止重放攻击。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>) </span>{</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$user_name</span>, <span class="variable">$user_mail</span>, <span class="variable">$user_nick</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$createArgs</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getCreateArgs</span>(<span class="variable">$user_name</span>, <span class="variable">$user_mail</span>, <span class="variable">$user_nick</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意顺序，必须先获取参数，再请求getChallenge</span></span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getChallenge</span>();</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>] = <span class="variable">$challenge</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$createArgs</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>处理注册请求<br>用户在前端使用 <code>navigator.credentials.create</code> 方法生成凭证后，浏览器会返回凭证信息。我们需要将这些信息发送到服务器进行验证和保存：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyRegistration</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">'php://input'</span>)), <span class="literal">null</span>, <span class="number">512</span>, JSON_THROW_ON_ERROR);</span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>];</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$user_name</span>, <span class="variable">$user_mail</span>, <span class="variable">$user_nick</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="variable">$clientDataJSON</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;clientDataJSON) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;clientDataJSON) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$attestationObject</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;attestationObject) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;attestationObject) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">processCreate</span>(<span class="variable">$clientDataJSON</span>, <span class="variable">$attestationObject</span>, <span class="variable">$challenge</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span>-&gt;userMail = <span class="variable">$user_mail</span>;</span><br><span class="line">        <span class="variable">$data</span>-&gt;userName = <span class="variable">$user_name</span>;</span><br><span class="line">        <span class="variable">$data</span>-&gt;userNick = <span class="variable">$user_nick</span>;</span><br><span class="line">        <span class="title function_ invoke__">saveAuthenticator</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'注册成功'</span>]);</span><br><span class="line">    } <span class="keyword">catch</span> (WebAuthnException <span class="variable">$e</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'注册失败: '</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()]);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p>在这里，processCreate 方法用于验证浏览器传递过来的凭证数据，并返回认证器信息。接着我们可以将这些信息保存到数据库中，以便用户后续使用。</p>
</li>
<li><p>登录流程（登录页）<br>在用户登录时，我们需要从服务器获取一个登录挑战并发送到客户端，然后使用 navigator.credentials.get 方法进行认证。</p>
</li>
</ol>
<ul>
<li>生成登录挑战<br>和注册过程类似，我们需要先生成一个 <code>challenge</code> 并返回给客户端：</li>
</ul>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authenticate</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$authenticators</span> = <span class="title function_ invoke__">loadAuthenticators</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ids</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$user_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$authenticators</span>) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$authenticators</span>)) {</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$authenticators</span> <span class="keyword">as</span> <span class="variable">$reg</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$reg</span>-&gt;userName === <span class="variable">$user_name</span>) {</span><br><span class="line">                <span class="variable">$ids</span>[] = <span class="variable">$reg</span>-&gt;credentialId;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$ids</span>) === <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'no registrations in session for userId '</span> . <span class="variable">$user_name</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支持 usb、nfc、ble、</span></span><br><span class="line">    <span class="variable">$getArgs</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getGetArgs</span>(<span class="variable">$ids</span>, <span class="number">60</span> * <span class="number">4</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getChallenge</span>();</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>] = <span class="variable">$challenge</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$getArgs</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>处理登录请求<br>用户使用浏览器生成凭证后，将凭证信息发送到服务器进行验证：</li>
</ul>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyAuthentication</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">'php://input'</span>)), <span class="literal">null</span>, <span class="number">512</span>, JSON_THROW_ON_ERROR);</span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// Extract the necessary fields from the input data</span></span><br><span class="line">        <span class="variable">$clientDataJSON</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;clientDataJSON) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;clientDataJSON) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$authenticatorData</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;authenticatorData) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;authenticatorData) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$signature</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;signature) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;signature) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$userHandle</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;userHandle) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;userHandle) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$id</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;id) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;id) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$credentialPublicKey</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$authenticators</span> = <span class="title function_ invoke__">loadAuthenticators</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$authenticators</span>)) {</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$authenticators</span> <span class="keyword">as</span> <span class="variable">$reg</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$reg</span>-&gt;credentialId === <span class="variable">$id</span>) {</span><br><span class="line">                    <span class="variable">$credentialPublicKey</span> = <span class="variable">$reg</span>-&gt;credentialPublicKey;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$userHandle</span> !== <span class="variable">$reg</span>-&gt;userName) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'userId doesnt match (is '</span> . <span class="variable">$userHandle</span> . <span class="string">' but expect '</span> . <span class="variable">$reg</span>-&gt;userName . <span class="string">')'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$credentialPublicKey</span> === <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'Public Key for credential ID not found!'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">processGet</span>(<span class="variable">$clientDataJSON</span>, <span class="variable">$authenticatorData</span>, <span class="variable">$signature</span>, <span class="variable">$credentialPublicKey</span>, <span class="variable">$challenge</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> =  [<span class="string">"nick"</span> =&gt; <span class="variable">$reg</span>-&gt;userName, <span class="string">"email"</span> =&gt; <span class="variable">$reg</span>-&gt;userMail];</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">'user'</span>] = <span class="variable">$user</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'认证成功'</span>]);</span><br><span class="line">    } <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'认证失败: '</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()]);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>在这里，<code>processGet</code> 方法用于验证用户的登录凭证。如果验证成功，我们就可以让用户登录系统。</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>为了省事，全放一个文件里了 <code>webauthn.php</code></p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">lbuchs</span>\<span class="title">WebAuthn</span>\<span class="title">WebAuthnException</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">'Content-type:application/json;charset=utf-8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项</span></span><br><span class="line"><span class="variable">$rpName</span> = <span class="string">'工具牛'</span>;</span><br><span class="line"><span class="variable">$rpId</span> = <span class="string">'localhost'</span>;</span><br><span class="line"><span class="variable">$origin</span> = <span class="string">'http://localhost'</span>;</span><br><span class="line"><span class="variable">$user_name</span> = <span class="string">"tsvico"</span>;</span><br><span class="line"><span class="variable">$user_mail</span> = <span class="string">"xx@xx.com"</span>;</span><br><span class="line"><span class="variable">$user_nick</span> = <span class="string">"tsvico"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWebAuthnInstance</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> lbuchs\WebAuthn\<span class="title function_ invoke__">WebAuthn</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serializeFieldsToBase64</span>(<span class="params"><span class="variable">$objects</span>, <span class="variable">$fieldNames</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$objects</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">'Expected an array of objects.'</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$objects</span> <span class="keyword">as</span> <span class="variable">$object</span>) {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$fieldNames</span> <span class="keyword">as</span> <span class="variable">$fieldName</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$object</span>-&gt;<span class="variable">$fieldName</span>)) {</span><br><span class="line">                <span class="variable">$object</span>-&gt;<span class="variable">$fieldName</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$object</span>-&gt;<span class="variable">$fieldName</span>));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$objects</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unserializeFieldsFromBase64</span>(<span class="params"><span class="variable">$objects</span>, <span class="variable">$fieldNames</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$objects</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">'Expected an array of objects.'</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$objects</span> <span class="keyword">as</span> &amp;<span class="variable">$object</span>) {</span><br><span class="line">        <span class="variable">$object</span> = (<span class="keyword">object</span>) <span class="variable">$object</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$fieldNames</span> <span class="keyword">as</span> <span class="variable">$fieldName</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$object</span>-&gt;<span class="variable">$fieldName</span>)) {</span><br><span class="line">                <span class="variable">$object</span>-&gt;<span class="variable">$fieldName</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$object</span>-&gt;<span class="variable">$fieldName</span>));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$objects</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载本地存储的认证信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadAuthenticators</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$fieldNames</span> = [<span class="string">'credentialId'</span>, <span class="string">'AAGUID'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$authenticatorsFile</span> = <span class="keyword">__DIR__</span> . <span class="string">'/aaa.db'</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$authenticatorsFile</span>)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">unserializeFieldsFromBase64</span>(<span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$authenticatorsFile</span>), <span class="literal">true</span>), <span class="variable">$fieldNames</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存认证信息到本地存储</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveAuthenticator</span>(<span class="params"><span class="variable">$authenticator</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$fieldNames</span> = [<span class="string">'credentialId'</span>, <span class="string">'AAGUID'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$authenticators</span> = <span class="title function_ invoke__">loadAuthenticators</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$authenticators</span>[] = <span class="variable">$authenticator</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span> . <span class="string">'/aaa.db'</span>, <span class="title function_ invoke__">json_encode</span>(<span class="title function_ invoke__">serializeFieldsToBase64</span>(<span class="variable">$authenticators</span>, <span class="variable">$fieldNames</span>), JSON_PRETTY_PRINT));</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="literal">false</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Failed to write file. Error: "</span> . <span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">error_get_last</span>(), <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findAuthenticator</span>(<span class="params"><span class="variable">$credId</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$authenticators</span> = <span class="title function_ invoke__">loadAuthenticators</span>();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$authenticators</span> <span class="keyword">as</span> <span class="variable">$authenticator</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$authenticator</span>[<span class="string">'userName'</span>] === <span class="variable">$credId</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$authenticator</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理不同的接口请求</span></span><br><span class="line"><span class="variable">$requestMethod</span> = <span class="variable">$_SERVER</span>[<span class="string">'REQUEST_METHOD'</span>];</span><br><span class="line"><span class="variable">$requestUri</span> = <span class="variable">$_SERVER</span>[<span class="string">'REQUEST_URI'</span>];</span><br><span class="line"><span class="variable">$requestPath</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$requestUri</span>, PHP_URL_QUERY);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取注册信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$requestMethod</span> === <span class="string">'POST'</span> &amp;&amp; <span class="variable">$requestPath</span> === <span class="string">'/register'</span>) {</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'user'</span>])) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请先登录'</span>]);</span><br><span class="line">        <span class="keyword">die</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="title function_ invoke__">register</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">} <span class="keyword">elseif</span> (<span class="variable">$requestMethod</span> === <span class="string">'POST'</span> &amp;&amp; <span class="variable">$requestPath</span> === <span class="string">'/verifyRegistration'</span>) {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存注册信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'user'</span>])) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请先登录'</span>]);</span><br><span class="line">        <span class="keyword">die</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="title function_ invoke__">verifyRegistration</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">} <span class="keyword">elseif</span> (<span class="variable">$requestMethod</span> === <span class="string">'POST'</span> &amp;&amp; <span class="variable">$requestPath</span> === <span class="string">'/authenticate'</span>) {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取验证信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_ invoke__">authenticate</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">} <span class="keyword">elseif</span> (<span class="variable">$requestMethod</span> === <span class="string">'POST'</span> &amp;&amp; <span class="variable">$requestPath</span> === <span class="string">'/verifyAuthentication'</span>) {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_ invoke__">verifyAuthentication</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">404</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'接口不存在,当前地址'</span> . <span class="variable">$requestPath</span>]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取注册信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$user_name</span>, <span class="variable">$user_mail</span>, <span class="variable">$user_nick</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$createArgs</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getCreateArgs</span>(<span class="variable">$user_name</span>, <span class="variable">$user_mail</span>, <span class="variable">$user_nick</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意顺序，必须先获取参数，再请求getChallenge</span></span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getChallenge</span>();</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>] = <span class="variable">$challenge</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$createArgs</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证保存注册信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyRegistration</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">'php://input'</span>)), <span class="literal">null</span>, <span class="number">512</span>, JSON_THROW_ON_ERROR);</span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>];</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$user_name</span>, <span class="variable">$user_mail</span>, <span class="variable">$user_nick</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="variable">$clientDataJSON</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;clientDataJSON) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;clientDataJSON) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$attestationObject</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;attestationObject) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;attestationObject) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">processCreate</span>(<span class="variable">$clientDataJSON</span>, <span class="variable">$attestationObject</span>, <span class="variable">$challenge</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span>-&gt;userMail = <span class="variable">$user_mail</span>;</span><br><span class="line">        <span class="variable">$data</span>-&gt;userName = <span class="variable">$user_name</span>;</span><br><span class="line">        <span class="variable">$data</span>-&gt;userNick = <span class="variable">$user_nick</span>;</span><br><span class="line">        <span class="title function_ invoke__">saveAuthenticator</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'注册成功'</span>]);</span><br><span class="line">    } <span class="keyword">catch</span> (WebAuthnException <span class="variable">$e</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'注册失败: '</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()]);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取验证信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authenticate</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$authenticators</span> = <span class="title function_ invoke__">loadAuthenticators</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ids</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$user_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$authenticators</span>) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$authenticators</span>)) {</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$authenticators</span> <span class="keyword">as</span> <span class="variable">$reg</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$reg</span>-&gt;userName === <span class="variable">$user_name</span>) {</span><br><span class="line">                <span class="variable">$ids</span>[] = <span class="variable">$reg</span>-&gt;credentialId;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$ids</span>) === <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'no registrations in session for userId '</span> . <span class="variable">$user_name</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支持 usb、nfc、ble、</span></span><br><span class="line">    <span class="variable">$getArgs</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getGetArgs</span>(<span class="variable">$ids</span>, <span class="number">60</span> * <span class="number">4</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">getChallenge</span>();</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>] = <span class="variable">$challenge</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$getArgs</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyAuthentication</span>(<span class="params"><span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$webAuthn</span> = <span class="title function_ invoke__">getWebAuthnInstance</span>(<span class="variable">$rpName</span>, <span class="variable">$rpId</span>, <span class="variable">$origin</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">'php://input'</span>)), <span class="literal">null</span>, <span class="number">512</span>, JSON_THROW_ON_ERROR);</span><br><span class="line">    <span class="variable">$challenge</span> = <span class="variable">$_SESSION</span>[<span class="string">'webauthn_challenge'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// Extract the necessary fields from the input data</span></span><br><span class="line">        <span class="variable">$clientDataJSON</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;clientDataJSON) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;clientDataJSON) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$authenticatorData</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;authenticatorData) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;authenticatorData) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$signature</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;signature) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;signature) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$userHandle</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;userHandle) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;userHandle) : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$id</span> = !<span class="keyword">empty</span>(<span class="variable">$data</span>-&gt;id) ? <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>-&gt;id) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$credentialPublicKey</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$authenticators</span> = <span class="title function_ invoke__">loadAuthenticators</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$authenticators</span>)) {</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$authenticators</span> <span class="keyword">as</span> <span class="variable">$reg</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$reg</span>-&gt;credentialId === <span class="variable">$id</span>) {</span><br><span class="line">                    <span class="variable">$credentialPublicKey</span> = <span class="variable">$reg</span>-&gt;credentialPublicKey;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$userHandle</span> !== <span class="variable">$reg</span>-&gt;userName) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'userId doesnt match (is '</span> . <span class="variable">$userHandle</span> . <span class="string">' but expect '</span> . <span class="variable">$reg</span>-&gt;userName . <span class="string">')'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$credentialPublicKey</span> === <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'Public Key for credential ID not found!'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$webAuthn</span>-&gt;<span class="title function_ invoke__">processGet</span>(<span class="variable">$clientDataJSON</span>, <span class="variable">$authenticatorData</span>, <span class="variable">$signature</span>, <span class="variable">$credentialPublicKey</span>, <span class="variable">$challenge</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> =  [<span class="string">"nick"</span> =&gt; <span class="variable">$reg</span>-&gt;userName, <span class="string">"email"</span> =&gt; <span class="variable">$reg</span>-&gt;userMail];</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">'user'</span>] = <span class="variable">$user</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'认证成功'</span>]);</span><br><span class="line">    } <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">'error'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'认证失败: '</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()]);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>前端代码<br>login.html，按钮 ID 为 <code>login-webauthn</code></p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">PublicKeyCredential</span>) {</span><br><span class="line">  $(<span class="string">"#login-webauthn"</span>).<span class="title function_">remove</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$(<span class="string">"#login-webauthn"</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">let</span> btn = $(<span class="variable language_">this</span>);</span><br><span class="line">  btn.<span class="title function_">attr</span>(<span class="string">"disabled"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求认证参数</span></span><br><span class="line">  <span class="title function_">fetch</span>(<span class="string">"../oidc/webauthn?/authenticate"</span>, {</span><br><span class="line">    <span class="attr">method</span>: <span class="string">"POST"</span>,</span><br><span class="line">  })</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">getArgs</span>) =&gt;</span> {</span><br><span class="line">      <span class="title function_">recursiveBase64StrToArrayBuffer</span>(getArgs);</span><br><span class="line"></span><br><span class="line">      navigator.<span class="property">credentials</span></span><br><span class="line">        .<span class="title function_">get</span>(getArgs)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">assertion</span>) =&gt;</span> {</span><br><span class="line">          <span class="comment">// 认证成功，发送到后端验证</span></span><br><span class="line">          <span class="keyword">let</span> clientDataJSON = <span class="title function_">arrayBufferToBase64</span>(</span><br><span class="line">            assertion.<span class="property">response</span>.<span class="property">clientDataJSON</span></span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">let</span> authenticatorData = <span class="title function_">arrayBufferToBase64</span>(</span><br><span class="line">            assertion.<span class="property">response</span>.<span class="property">authenticatorData</span></span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">let</span> signature = <span class="title function_">arrayBufferToBase64</span>(assertion.<span class="property">response</span>.<span class="property">signature</span>);</span><br><span class="line">          <span class="keyword">let</span> rawId = <span class="title function_">arrayBufferToBase64</span>(assertion.<span class="property">rawId</span>);</span><br><span class="line">          <span class="keyword">let</span> userHandle = <span class="title function_">arrayBufferToBase64</span>(assertion.<span class="property">response</span>.<span class="property">userHandle</span>);</span><br><span class="line"></span><br><span class="line">          <span class="title function_">fetch</span>(<span class="string">"../oidc/webauthn?/verifyAuthentication"</span>, {</span><br><span class="line">            <span class="attr">method</span>: <span class="string">"POST"</span>,</span><br><span class="line">            <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span><br><span class="line">              <span class="attr">id</span>: rawId,</span><br><span class="line">              <span class="attr">clientDataJSON</span>: clientDataJSON,</span><br><span class="line">              <span class="attr">authenticatorData</span>: authenticatorData,</span><br><span class="line">              <span class="attr">signature</span>: signature,</span><br><span class="line">              <span class="attr">userHandle</span>: userHandle,</span><br><span class="line">            }),</span><br><span class="line">            <span class="attr">cache</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">          })</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> {</span><br><span class="line">              <span class="keyword">if</span> (res.<span class="property">error</span> === <span class="number">0</span>) {</span><br><span class="line">                <span class="title function_">notify</span>(<span class="string">"认证成功"</span>);</span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">"./"</span>;</span><br><span class="line">              } <span class="keyword">else</span> {</span><br><span class="line">                <span class="title function_">notify</span>(res.<span class="property">msg</span>);</span><br><span class="line">              }</span><br><span class="line">              btn.<span class="title function_">attr</span>(<span class="string">"disabled"</span>, <span class="literal">false</span>);</span><br><span class="line">              btn.<span class="title function_">text</span>(<span class="string">"使用验证器"</span>);</span><br><span class="line">            });</span><br><span class="line">        })</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">          <span class="title function_">notify</span>(<span class="string">"认证失败"</span>);</span><br><span class="line">          btn.<span class="title function_">attr</span>(<span class="string">"disabled"</span>, <span class="literal">false</span>);</span><br><span class="line">          btn.<span class="title function_">text</span>(<span class="string">"Passkey"</span>);</span><br><span class="line">        });</span><br><span class="line">    })</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">      <span class="title function_">notify</span>(<span class="string">"认证失败"</span>);</span><br><span class="line">      btn.<span class="title function_">attr</span>(<span class="string">"disabled"</span>, <span class="literal">false</span>);</span><br><span class="line">      btn.<span class="title function_">text</span>(<span class="string">"Passkey"</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure></div>

<p>后台</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">neWebauthn</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">PublicKeyCredential</span>) {</span><br><span class="line">    <span class="title function_">notify</span>(<span class="string">"您的浏览器不支持 WebAuthn"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="title function_">fetch</span>(<span class="string">"../oidc/webauthn?/register"</span>, {</span><br><span class="line">    <span class="attr">method</span>: <span class="string">"POST"</span>,</span><br><span class="line">  })</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">getArgs</span>) =&gt;</span> {</span><br><span class="line">      <span class="title function_">recursiveBase64StrToArrayBuffer</span>(getArgs);</span><br><span class="line">      navigator.<span class="property">credentials</span></span><br><span class="line">        .<span class="title function_">create</span>(getArgs)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">cred</span>) =&gt;</span> {</span><br><span class="line">          <span class="keyword">const</span> authenticatorAttestationResponse = {</span><br><span class="line">            <span class="attr">transports</span>: cred.<span class="property">response</span>.<span class="property">getTransports</span></span><br><span class="line">              ? cred.<span class="property">response</span>.<span class="title function_">getTransports</span>()</span><br><span class="line">              : <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">clientDataJSON</span>: cred.<span class="property">response</span>.<span class="property">clientDataJSON</span></span><br><span class="line">              ? <span class="title function_">arrayBufferToBase64</span>(cred.<span class="property">response</span>.<span class="property">clientDataJSON</span>)</span><br><span class="line">              : <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">attestationObject</span>: cred.<span class="property">response</span>.<span class="property">attestationObject</span></span><br><span class="line">              ? <span class="title function_">arrayBufferToBase64</span>(cred.<span class="property">response</span>.<span class="property">attestationObject</span>)</span><br><span class="line">              : <span class="literal">null</span>,</span><br><span class="line">          };</span><br><span class="line">          <span class="title function_">fetch</span>(<span class="string">"../oidc/webauthn?/verifyRegistration"</span>, {</span><br><span class="line">            <span class="attr">method</span>: <span class="string">"POST"</span>,</span><br><span class="line">            <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(authenticatorAttestationResponse),</span><br><span class="line">            <span class="attr">cache</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">          })</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> {</span><br><span class="line">              <span class="keyword">if</span> (res.<span class="property">error</span> === <span class="number">0</span>) {</span><br><span class="line">                <span class="title function_">notify</span>(<span class="string">"认证成功"</span>);</span><br><span class="line">              } <span class="keyword">else</span> {</span><br><span class="line">                <span class="title function_">notify</span>(res.<span class="property">msg</span>);</span><br><span class="line">              }</span><br><span class="line">            });</span><br><span class="line">        })</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">          <span class="title function_">notify</span>(<span class="string">"认证失败"</span>);</span><br><span class="line">        });</span><br><span class="line">    })</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">      <span class="title function_">notify</span>(<span class="string">"认证失败"</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过 WebAuthn 和 FIDO2 的支持，我们可以轻松实现无密码的身份认证。本文介绍了从注册到登录的完整流程，并提供了相关的 PHP 代码示例。通过这些步骤，你可以在自己的项目中接入 Passkey，提高系统的安全性和用户体验。</p>
<p>完整代码参考 <code>lbuchs/WebAuthn</code> 官方仓库。如果你对 WebAuthn 或 FIDO2 标准有进一步的兴趣，可以查看 W3C 的 WebAuthn 标准文档。</p>
]]></content>
      <tags>
        <tag>passKey</tag>
        <tag>WebAuthn</tag>
      </tags>
  </entry>
  <entry>
    <title>不开启 Hyper-V 在 Windows Server 安装 Docker</title>
    <url>/2022/1965296212.html</url>
    <content><![CDATA[<p>教程来自于<a class="link" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/quick-start/set-up-environment?tabs=Windows-Server">微软文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，本篇博客仅作记录 (翻译)</p>
<p>不开启 Hyper-V 在 Windows Server 安装 Docker</p>
<span id="more"></span>

<p>要在 <code>Windows Server</code> 上安装 <code>Docker</code>，可以使用 Microsoft 发布的 OneGet 提供程序 PowerShell 模块，称为 <code>DockerMicrosoftProvider</code>。此提供程序在 Windows 中启用容器功能并安装 Docker 引擎和客户端。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>以命令行打开 <code>PowerShell</code> 会话并从 <code>PowerShell Gallery</code> 安装 <code>Docker-Microsoft PackageManagement Provider </code>。</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> <span class="literal">-Name</span> DockerMsftProvider <span class="literal">-Repository</span> PSGallery <span class="literal">-Force</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>如果系统提示你安装 <code>NuGet</code> 提供程序，请键入 <code>Y</code> 以安装它。</p>
<p>如果您在打开 PowerShell 库时遇到错误，您可能需要将 <code>PowerShell</code> 客户端使用的 TLS 版本设置为 TLS 1.2。为此，请运行以下命令：</p>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Set the TLS version used by the PowerShell client to TLS 1.2.</span></span><br><span class="line">[<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.SecurityProtocolType</span>]::Tls12;</span><br></pre></td></tr></tbody></table></figure></div>

<ol start="2">
<li>使用 <code>PackageManagement PowerShell</code> 模块安装最新版本的 <code>Docker</code>。</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Package</span> <span class="literal">-Name</span> docker <span class="literal">-ProviderName</span> DockerMsftProvider</span><br></pre></td></tr></tbody></table></figure></div>

<p>当 PowerShell 询问您是否信任包源 “DockerDefault” 时，键入 A 以继续安装。</p>
<ol start="3">
<li>安装完成后，重新启动计算机。</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Restart-Computer</span> <span class="literal">-Force</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>如果您想稍后更新 Docker：</p>
<ol>
<li>使用以下命令检查安装的版本：</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Get-Package</span> <span class="literal">-Name</span> Docker <span class="literal">-ProviderName</span> DockerMsftProvider</span><br></pre></td></tr></tbody></table></figure></div>

<ol start="2">
<li>使用以下命令查找当前版本：</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Find-Package</span> <span class="literal">-Name</span> Docker <span class="literal">-ProviderName</span> DockerMsftProvider</span><br></pre></td></tr></tbody></table></figure></div>

<ol start="3">
<li>当您准备好升级时，运行以下命令：</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Package</span> <span class="literal">-Name</span> Docker <span class="literal">-ProviderName</span> DockerMsftProvider <span class="literal">-Update</span> <span class="literal">-Force</span></span><br></pre></td></tr></tbody></table></figure></div>

<ol start="4">
<li>最后，运行以下命令启动 Docker：</li>
</ol>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Start-Service</span> Docker</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>为 Mp3 写入 Tag</title>
    <url>/2018/1a961af7.html</url>
    <content><![CDATA[<p>浅谈如何使用代码为 MP3 文件写入 ID3Tags</p>
<span id="more"></span>

<p><code>存音</code>上线了也有小半年了，完善了诸多功能，最开始就烦恼的专辑图片写入迟迟搞不定。开始时借鉴 <a class="link" href="https://www.jianshu.com/p/c4385114e55f">https://www.jianshu.com/p/c4385114e55f<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>这篇文章，写入了 ID3v1 标签，不过只有歌名和歌手，勉强够用。现在功能也完善的差不多了，应一些酷友的要求，也为了自己尽善尽美，开始重新看 <code>ID3</code> 标签写入</p>
<p>存音 <a class="link" href="https://www.coolapk.com/apk/179796">https://www.coolapk.com/apk/179796<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h3 id="一路风雨"><a href="#一路风雨" class="headerlink" title="一路风雨"></a>一路风雨</h3><p>在酷安上发现了一款名为<code>音乐标签编辑器</code>的应用，本来做着解包的打算，后来想想还是尊重原作者，只拿这款 app 测试我的标签写入成功与否</p>
<p>重新找到了 <a class="link" href="https://www.jianshu.com/p/c4385114e55f">https://www.jianshu.com/p/c4385114e55f<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 这篇文章，看了一下 ID3V2 的写入方式，发现这里的代码有一些问题，做着在博客上也说了，对于已经存在的 Tag 不能修改</p>
<p>拿着代码对照着一些文章 <a class="link" href="https://blog.csdn.net/studywithallofyou/article/details/7738785">https://blog.csdn.net/studywithallofyou/article/details/7738785<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1akhky-g1.webp" alt="image.png"></p>
<p>诸如此类，说实话可能正如这个作者所讲，找到的干货真不多</p>
<h3 id="小转折"><a href="#小转折" class="headerlink" title="小转折"></a>小转折</h3><p>由于专辑图写入迟迟不成功，衍生出了找一些框架的念头，在 google 上搜到了名为 <strong>Rey-MusicPlayer</strong> 的一款播放器，有修改标签功能，看了下开源源码，找到如下代码</p>
<p><a class="link" href="https://github.com/reyanshmishra/Rey-MusicPlayer/blob/master/app/src/main/java/com/reyansh/audio/audioplayer/free/TagEditor/Id3TagEditorActivity.java">https://github.com/reyanshmishra/Rey-MusicPlayer/blob/master/app/src/main/java/com/reyansh/audio/audioplayer/free/TagEditor/Id3TagEditorActivity.java<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1anit9-p0.webp" alt="image.png"></p>
<p>我只能说很 nice！</p>
<p>由此再次找到了一个专门写标签的工具包 <a class="link" href="https://gitee.com/wittyneko/jaudiotagger">jaudiotagger<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，支持 mp3 flac 等格式歌曲标签 id3 读取与写入，简直爽的不行，根据一些官方 demo 成功写入图片</p>
<p>相关源码已经在上文给出，还请有兴趣的朋友一同讨论</p>
]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>为历史文章添加 updated</title>
    <url>/2025/3421175541.html</url>
    <content><![CDATA[<p>由于我的博客迁移到了 <code>redefine</code>, 在些许配置上有差异性，比如 <code>next</code> 主题中版权声明是写作 <code>copyright: true</code>，但是在 <code>redefine</code> 这么写版权部分只会显示一个 <code>true</code>，我在某次提交统一删除了 <code>copyright: true</code>，但是此行为导致所有文章的修改日期变成提交的时间，所以使用脚本为所有文章添加上 <code>updated</code></p>
<span id="more"></span>
<p>更新日期从某个提交中文件的最后修改日期为准，使用以下命令获取最后修改日期，格式采用 <code>yyyy-MM-dd HH:mm:ss</code></p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">git log -1 --format="%cd" --date="format:%Y-%m-%d %H:%M:%S" &lt;commit_hash&gt; -- &lt;目录路径&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>在 <code>source</code> 目录下创建 <code>fix.sh</code>，其中 <code>aaaaaaaaaaaaaaaccccccc</code> 是我具体到某次提交 id</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span>=<span class="string">"_posts"</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `<span class="built_in">ls</span> <span class="variable">${dir}</span> | grep <span class="string">'.md'</span>`;<span class="keyword">do</span></span><br><span class="line">    content=$(<span class="built_in">cat</span> <span class="variable">${dir}</span>/<span class="variable">${file}</span>| <span class="built_in">head</span> -n 10 | grep <span class="string">'date: '</span>)</span><br><span class="line">    datestr=$(git <span class="built_in">log</span> -1 --format=<span class="string">"%cd"</span> --<span class="built_in">date</span>=<span class="string">"format:%Y-%m-%d %H:%M:%S"</span> aaaaaaaaaaaaaaaccccccc <span class="string">"<span class="variable">${dir}</span>/<span class="variable">${file}</span>"</span>)</span><br><span class="line">    newcontent=<span class="string">"updated: "</span><span class="variable">$datestr</span></span><br><span class="line">    sed -i <span class="string">"/<span class="variable">$content</span>/a\\<span class="variable">$newcontent</span>"</span> <span class="variable">${dir}</span>/<span class="variable">${file}</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>修改 <code>scaffolds/post.md</code>，添加 <code>updated: {{ date }}</code><br>为以后的文章添加上默认的修改日期（等于创建日期）</p>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Cloudflare Workers 构建免费图床：控制 R2 成本并使用缓存</title>
    <url>/2025/2622120444.html</url>
    <content><![CDATA[<p>Cloudflare R2 确实是个好东西，10GB 免费空间加上每月一千万次免费 Class B 操作，比某 AWS 不知道高到哪里去了。但是有个坑：<strong>公开存储桶的请求次数是不设防的</strong>。万一有人恶意刷你的桶，或者你的资源突然火了被疯狂访问，账单能直接让你破产。</p>
<span id="more"></span>
<blockquote>
<p>如何用 Cloudflare Worker 给 R2 图床加个安全阀</p>
</blockquote>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>其实原理很简单：<strong>用 Worker 当中间人</strong>。把存储桶设为私有，然后通过 Worker 来代理访问。这样有两个好处：</p>
<ol>
<li>Worker 免费版每天 10 万次请求限制成了天然防火墙</li>
<li>还能顺手加个缓存，减少实际访问 R2 的次数</li>
</ol>
<h2 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h2><h3 id="第一步：创建R2存储桶"><a href="#第一步：创建R2存储桶" class="headerlink" title="第一步：创建R2存储桶"></a>第一步：创建 R2 存储桶</h3><ol>
<li>进 Cloudflare 控制台</li>
<li>找到 R2 页面</li>
<li>点” 创建存储桶”</li>
<li> 起个名字（比如 <code>my-private-bucket</code>）</li>
<li><strong>重要</strong>：别勾选” 公开访问”</li>
</ol>
<h3 id="第二步：创建Worker"><a href="#第二步：创建Worker" class="headerlink" title="第二步：创建Worker"></a>第二步：创建 Worker</h3><p>参考地址 <a class="link" href="https://linux.do/t/topic/516311">使用 Cloudflare Worker 的免费账户限制 R2 的支出（新版本更新使用 D1 数据库限制次数)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fetch</span>(<span class="params">request, env</span>) {</span><br><span class="line">    <span class="keyword">const</span> path = <span class="built_in">decodeURIComponent</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(request.<span class="property">url</span>).<span class="property">pathname</span>.<span class="title function_">slice</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!path) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Not Found"</span>, { <span class="attr">status</span>: <span class="number">404</span> });</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">const</span> file = <span class="keyword">await</span> env.<span class="property">OPCT</span>.<span class="title function_">get</span>(path);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!file) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Not Found"</span>, { <span class="attr">status</span>: <span class="number">404</span> });</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> headers = <span class="keyword">new</span> <span class="title class_">Headers</span>();</span><br><span class="line">      headers.<span class="title function_">set</span>(<span class="string">'Content-Type'</span>, file.<span class="property">httpMetadata</span>?.<span class="property">contentType</span> || <span class="string">'application/octet-stream'</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(file.<span class="property">body</span>, { headers });</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Server Error"</span>, { <span class="attr">status</span>: <span class="number">500</span> });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="第三步：绑定资源"><a href="#第三步：绑定资源" class="headerlink" title="第三步：绑定资源"></a>第三步：绑定资源</h3><ol>
<li>在 Worker 设置里找到” 资源绑定”</li>
<li> 添加新绑定：<ul>
<li>变量名：<code>OPCT</code>（随便起，但代码里要用一样的）</li>
<li>类型：R2 存储桶</li>
<li>选择你刚创建的存储桶</li>
</ul>
</li>
</ol>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><strong>Worker 位置</strong>：保持默认就行，选” 智能路由” 反而可能把请求都路由到存储桶所在区域</li>
</ol>
<h2 id="为什么需要缓存"><a href="#为什么需要缓存" class="headerlink" title="为什么需要缓存"></a>为什么需要缓存</h2><p>最开始我用的无缓存版本，在讨论帖<a class="link" href="https://linux.do/t/topic/542054">我使用 CloudflareWorker 做地球图片后端，我试图使用 Cloudflare 缓存但 cf-cache-status 字段缺失没有缓存<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>中发现我的图床也一样，响应头里没有 <code>cf-cache-status</code>，说明完全没走缓存。查了<a class="link" href="https://developers.cloudflare.com/workers/runtime-apis/cache/">文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>才知道要用 <code>caches.default</code> 这个 API。加了缓存之后：</p>
<ol>
<li>重复请求不会打到 R2</li>
<li> 响应速度更快 </li>
</ol>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fetch</span>(<span class="params">request, env</span>) {</span><br><span class="line">    <span class="keyword">const</span> path = <span class="built_in">decodeURIComponent</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(request.<span class="property">url</span>).<span class="property">pathname</span>.<span class="title function_">slice</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!path) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Not Found"</span>, { <span class="attr">status</span>: <span class="number">404</span> });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get cache instance</span></span><br><span class="line">    <span class="keyword">const</span> cache = caches.<span class="property">default</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// First try to get from cache</span></span><br><span class="line">      <span class="keyword">let</span> response = <span class="keyword">await</span> cache.<span class="title function_">match</span>(request);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (response) {</span><br><span class="line">        <span class="keyword">return</span> response; <span class="comment">// Return cached response if found</span></span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// If not in cache, get from OPCT</span></span><br><span class="line">      <span class="keyword">const</span> file = <span class="keyword">await</span> env.<span class="property">OPCT</span>.<span class="title function_">get</span>(path);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!file) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Not Found"</span>, { <span class="attr">status</span>: <span class="number">404</span> });</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Create response with proper headers</span></span><br><span class="line">      <span class="keyword">const</span> headers = <span class="keyword">new</span> <span class="title class_">Headers</span>();</span><br><span class="line">      headers.<span class="title function_">set</span>(<span class="string">'Content-Type'</span>, file.<span class="property">httpMetadata</span>?.<span class="property">contentType</span> || <span class="string">'application/octet-stream'</span>);</span><br><span class="line">      <span class="comment">// Set cache control headers (adjust TTL as needed)</span></span><br><span class="line">      headers.<span class="title function_">set</span>(<span class="string">'Cache-Control'</span>, <span class="string">'public, max-age=3600'</span>); <span class="comment">// 1 hour cache [^1]</span></span><br><span class="line">      </span><br><span class="line">      response = <span class="keyword">new</span> <span class="title class_">Response</span>(file.<span class="property">body</span>, { headers });</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Store in cache for future requests</span></span><br><span class="line">      <span class="keyword">await</span> cache.<span class="title function_">put</span>(request, response.<span class="title function_">clone</span>()); <span class="comment">// [^2]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> response;</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Server Error"</span>, { <span class="attr">status</span>: <span class="number">500</span> });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h2><p>看到有人用 D1 数据库做访问次数限制 <a class="link" href="https://linux.do/t/topic/516311">使用 Cloudflare Worker 的免费账户限制 R2 的支出（新版本更新使用 D1 数据库限制次数)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ，适合更精细的控制。但我觉得对于普通用途，Worker 的每日 10 万次限制 + 缓存已经够用了</p>
<h2 id="进一步优化缓存-20250805"><a href="#进一步优化缓存-20250805" class="headerlink" title="进一步优化缓存(20250805)"></a>进一步优化缓存 (20250805)</h2><ul>
<li>设置响应头 <div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line">headers.<span class="title function_">set</span>(<span class="string">'Cache-Control'</span>, <span class="string">'public, max-age=2592000'</span>);</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>缓存键根据 URL<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> cacheKey = <span class="keyword">new</span> <span class="title class_">Request</span>(request.<span class="property">url</span>, { <span class="attr">method</span>: <span class="string">"GET"</span> });</span><br><span class="line"><span class="keyword">let</span> response = <span class="keyword">await</span> cache.<span class="title function_">match</span>(cacheKey);</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>非 get 不响应 <div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (request.<span class="property">method</span> !== <span class="string">'GET'</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Method Not Allowed"</span>, { <span class="attr">status</span>: <span class="number">405</span> });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
完整版代码 <div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fetch</span>(<span class="params">request, env</span>) {</span><br><span class="line">    <span class="comment">// 仅允许 GET 请求</span></span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">method</span> !== <span class="string">'GET'</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Method Not Allowed"</span>, { <span class="attr">status</span>: <span class="number">405</span> });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取请求路径（忽略 query 参数）</span></span><br><span class="line">    <span class="keyword">const</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(request.<span class="property">url</span>);</span><br><span class="line">    <span class="keyword">const</span> path = <span class="built_in">decodeURIComponent</span>(url.<span class="property">pathname</span>.<span class="title function_">slice</span>(<span class="number">1</span>)); <span class="comment">// 去掉开头的 '/'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!path) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Not Found"</span>, { <span class="attr">status</span>: <span class="number">404</span> });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取默认缓存实例</span></span><br><span class="line">    <span class="keyword">const</span> cache = caches.<span class="property">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用忽略 query 参数的 URL 构建缓存 key</span></span><br><span class="line">    <span class="keyword">const</span> cacheKeyUrl = <span class="string">`<span class="subst">${url.origin}</span><span class="subst">${url.pathname}</span>`</span>; <span class="comment">// 不包含 search/query</span></span><br><span class="line">    <span class="keyword">const</span> cacheKey = <span class="keyword">new</span> <span class="title class_">Request</span>(cacheKeyUrl, { <span class="attr">method</span>: <span class="string">"GET"</span> });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 先尝试从缓存获取响应</span></span><br><span class="line">      <span class="keyword">let</span> response = <span class="keyword">await</span> cache.<span class="title function_">match</span>(cacheKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (response) {</span><br><span class="line">        <span class="keyword">return</span> response; <span class="comment">// 缓存命中，直接返回</span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果缓存未命中，则从 KV 存储中获取数据</span></span><br><span class="line">      <span class="keyword">const</span> file = <span class="keyword">await</span> env.<span class="property">OPCT</span>.<span class="title function_">get</span>(path);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!file) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Not Found"</span>, { <span class="attr">status</span>: <span class="number">404</span> });</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置响应头</span></span><br><span class="line">      <span class="keyword">const</span> headers = <span class="keyword">new</span> <span class="title class_">Headers</span>();</span><br><span class="line">      headers.<span class="title function_">set</span>(<span class="string">'Content-Type'</span>, file.<span class="property">httpMetadata</span>?.<span class="property">contentType</span> || <span class="string">'application/octet-stream'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置缓存控制头，客户端也可缓存 1 个月</span></span><br><span class="line">      headers.<span class="title function_">set</span>(<span class="string">'Cache-Control'</span>, <span class="string">'public, max-age=2592000'</span>); <span class="comment">// 1 个月缓存</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构造响应对象</span></span><br><span class="line">      response = <span class="keyword">new</span> <span class="title class_">Response</span>(file.<span class="property">body</span>, { headers });</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将响应缓存以供后续请求使用</span></span><br><span class="line">      <span class="keyword">await</span> cache.<span class="title function_">put</span>(cacheKey, response.<span class="title function_">clone</span>());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> response;</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">"Server Error"</span>, { <span class="attr">status</span>: <span class="number">500</span> });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a class="link" href="https://linux.do/t/topic/516311">使用 Cloudflare Worker 的免费账户限制 R2 的支出（新版本更新使用 D1 数据库限制次数)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://linux.do/t/topic/542054">我使用 CloudflareWorker 做地球图片后端，我试图使用 Cloudflare 缓存但 cf-cache-status 字段缺失没有缓存<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://linux.do/t/topic/296435">使用 Cloudflare Workers 中的 Cache API 来全局缓存，减少 KV 的读写，可跨 worker 缓存<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ol>
]]></content>
      <tags>
        <tag>cloudflare</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Gradle Kotlin DSL 打包普通 Jar</title>
    <url>/2021/753509184.html</url>
    <content><![CDATA[<p>gradle 和 kotlin 一直是我比较常用的组合方式，也算是稍微新一点都技术选型，国内相关使用资料并没有 maven 的普遍，<code>Gradle Kotlin DSL</code> 也都是一些外文资料，本篇介绍一下普通项目的打包配置。</p>
<p>官方文档 <a class="link" href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">https://docs.gradle.org/current/userguide/kotlin_dsl.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><em><span id="more"></span></em></p>
<p>在项目没有引用 <code>springboot</code> 的情况下，是无法使用 springboot 为我们准备好的 <code>bootJar</code> 的，打包也需要自己配置</p>
<p>如果直接运行 gradle jar ，会发现打包成功，但是无法运行，只有一个空包，运行提示 <code>xxx.jar中没有主清单属性</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/image-20210509112708478.png" alt="image-20210509112708478"></p>
<center><font size="3">普通打包方式</font></center>

<p>我们在 <code>build.gradle.kts</code> 中为打包加上主清单，注意：使用 kotlin 需要在 <code>main</code> 方法所在文件名最后加上 <code>Kt</code></p>
<div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">tasks.jar {</span><br><span class="line">    <span class="comment">// enabled = true</span></span><br><span class="line">    manifest {</span><br><span class="line">        attributes(mapOf(<span class="string">"Main-Class"</span> to <span class="string">"com.xx.xx.ci.MainKt"</span>))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>继续执行打包，运行后发现一些错误信息，大意是没有将相关 jar 包打入当前包</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://z3.ax1x.com/2021/05/09/gJhpKx.png" alt="image-20210509113644408"></p>
<p>最终配置，这个配置不仅可以将当前程序的依赖打入 jar，还能将依赖 jar 的依赖打入，也就实现了将<code>嵌套依赖</code>打入最终包中</p>
<div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">tasks.jar {</span><br><span class="line">    <span class="comment">// enabled = true</span></span><br><span class="line">    manifest {</span><br><span class="line">        attributes(mapOf(<span class="string">"Main-Class"</span> to <span class="string">"com.xx.xx.ci.MainKt"</span>))</span><br><span class="line">    }</span><br><span class="line">    from(configurations.runtimeClasspath.<span class="keyword">get</span>().map {</span><br><span class="line">        <span class="keyword">if</span> (it.isDirectory) it <span class="keyword">else</span> zipTree(it)</span><br><span class="line">    })</span><br><span class="line">    <span class="keyword">val</span> sourcesMain = sourceSets.main.<span class="keyword">get</span>()</span><br><span class="line">    sourcesMain.allSource.forEach { println(<span class="string">"add from sources: <span class="subst">${it.name}</span>"</span>) }</span><br><span class="line">    from(sourcesMain.output)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>gradle</tag>
        <tag>kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>使用免费域名进行 cloudflare 优选</title>
    <url>/2024/1340794587.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Cloudflare SaaS 相关文章大家也都阅读过不少了，原理也很清楚了。众所周知开启 Cloudflare SaaS 回源优选需要两个域名。一般情况下我们手里只有一个主域名，而且主域名托管 Cloudflare 上还不想放到国内（DNSPOD）域名服务上，所以能不能保持主域名 Cloudflare 托管，再白嫖一个免费域名情况下开启 cf 优选呢</p>
<p>正常情况下每个子域名优选都将消耗一个备用域名，用免费域名可以优选 N 个子域名了 [/spoiler]</p>
<span id="more"></span>

<blockquote>
<p>本文章仅发布在 <a class="link" href="https://linux.do/t/topic/121316">linux.do<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h2 id="正文开始"><a href="#正文开始" class="headerlink" title="正文开始"></a>正文开始</h2><h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><ul>
<li>第一步：白嫖域名<br>参考 <a class="link" href="https://linux.do/t/topic/26864">https://linux.do/t/topic/26864<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>我用的是 <code>cloudns.be</code> 域名，也托管到了 <code>cloudflare</code></li>
<li>第二步：搭建一个网站<br>我的网站搭建在 serv00 上</li>
<li>第三步：将域名托管到 cf 上，如图所示<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky5AIK.png" alt="image|690x113"></li>
</ul>
<h3 id="开始教程"><a href="#开始教程" class="headerlink" title="开始教程"></a>开始教程</h3><p>此时，我们拥有两个域名</p>
<ul>
<li><code>xxxx.fun</code> &lt;– 作为 我们的访问域名，也就是自定义主机名，稍后我们访问此域名来访问网站</li>
<li><code>xxxxx.cloudns.be</code> &lt;– 作为 我们的回源域名，也就是当我们访问 <code>xxxx.fun</code> 时，cloudflare 在内部回源的域名</li>
</ul>
<ol>
<li>添加 DNS 解析 <code>cdn.xxxxx.cloudns.be</code>，解析值填源 IP</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky5VPO.png" alt="image|690x307"></p>
<ol start="2">
<li><p> 打开 <code>xxxxx.cloudns.be</code> 的自定义主机名功能（默认你已经开启了 saas 功能）<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky5ZGD.png" alt="image|690x461"></p>
</li>
<li><p>添加回退源 <code>cdn.xxxxx.cloudns.be</code></p>
</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky5eRe.png" alt="image|690x311"></p>
<ol start="4">
<li><p>添加自定义主机名 (这里是添加的主域名，也就是 <code>xxxx.fun</code>)<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky5uMd.png" alt="image|690x262"></p>
</li>
<li><p>验证域名所有权 (<code>xxxx.fun</code>)<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky5lZt.png" alt="image|690x294"></p>
</li>
</ol>
<p>目前为止，Cloudflare 上的操作已基本完成 6. 打开 DNSPOD、添加二级域名 (<code>cname.xxxx.fun</code>)</p>
<blockquote>
<p>这里在 Cloudflare 上操作下验证就行，并添加 cname.xxxx.fun NS 记录 f1g1ns1.dnspod.net</p>
</blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky51dP.png" alt="image|626x500"></p>
<ol start="7">
<li><p>在 DNSPOD 上添加记录<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky53If.png" alt="image|690x243"></p>
</li>
<li><p>然后在 cf 上添加主域名的解析就 OK 了<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky7bNt.png" alt="image|690x178"></p>
</li>
<li><p>ping 测试<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky7q4P.png" alt="image|690x358"></p>
</li>
</ol>
<h2 id="错误排查"><a href="#错误排查" class="headerlink" title="错误排查"></a>错误排查</h2><h3 id="重定向次数过多"><a href="#重定向次数过多" class="headerlink" title="重定向次数过多"></a>重定向次数过多</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/06/27/pky7X38.png" alt="image|690x323"></p>
]]></content>
      <tags>
        <tag>cloudflare</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Markdown 编辑你的博客</title>
    <url>/2018/fedfaceb.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Markdown 是一种可以使用普通文本编辑器编写的标记语言，通过简单的标记语法，它可以使普通文本内容具有一定的格式。Markdown 的语法简洁明了、学习容易，而且功能比纯文本更强，因此有很多人用它写博客。世界上最流行的博客平台 <a class="link" href="https://baike.baidu.com/item/WordPress">WordPress<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>和大型 CMS 如 <a class="link" href="https://baike.baidu.com/item/Joomla">Joomla<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>、<a class="link" href="https://baike.baidu.com/item/Drupal">Drupal<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>、github 都能很好的支持 Markdown。完全采用 Markdown 编辑器的博客平台有 <a class="link" href="https://baike.baidu.com/item/Ghost/17013737">Ghost<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>和 <a class="link" href="https://baike.baidu.com/item/Typecho">Typecho<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。  </p>
<p>常用工具：  马克飞象、Typora</p>
<span id="more"></span>

<p>Markdown 和 HTML 代码能相互转换  </p>
<p>支持直接插入 HTML 代码</p>
<p>部分内容摘自百度百科</p>
<h2 id="使用指南"><a href="#使用指南" class="headerlink" title="使用指南"></a>使用指南</h2><h3 id="常用语法"><a href="#常用语法" class="headerlink" title="常用语法"></a>常用语法</h3><p>最常见的 Markdown 格式选项和键盘快捷键 [3]  :</p>
<table>
<thead>
<tr>
<th>输出后的效果</th>
<th> Markdown</th>
<th> 快捷键</th>
</tr>
</thead>
<tbody><tr>
<td> Bold</td>
<td><strong>text</strong></td>
<td>Ctrl/+ B</td>
</tr>
<tr>
<td><em>Emphasize</em></td>
<td><em>text</em></td>
<td>Ctrl/+ I</td>
</tr>
<tr>
<td>Strike-through</td>
<td><del>text</del></td>
<td>Ctrl + Alt + U</td>
</tr>
<tr>
<td>Link</td>
<td><a href="http://">title</a></td>
<td>Ctrl/+ K</td>
</tr>
<tr>
<td>Inline Code</td>
<td><code>code</code></td>
<td>Ctrl/ + Shift + K</td>
</tr>
<tr>
<td>Image</td>
<td><code>![alt](http://)</code></td>
<td>Ctrl/ + Shift + I</td>
</tr>
<tr>
<td>List</td>
<td>* item</td>
<td>Ctrl + L</td>
</tr>
<tr>
<td>Blockquote</td>
<td>&gt; quote</td>
<td>Ctrl + Q</td>
</tr>
<tr>
<td>H1</td>
<td># Heading</td>
<td></td>
</tr>
<tr>
<td>H2</td>
<td>## Heading</td>
<td>Ctrl/ + H</td>
</tr>
<tr>
<td>H3</td>
<td>### Heading</td>
<td>Ctrl/+ H (x2)</td>
</tr>
</tbody></table>
<h3 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h3><p>标题能显示出文章的结构。行首插入 1-6 个 # ，每增加一个 # 表示更深入层次的内容，对应到标题的深度由 1-6 阶。</p>
<ul>
<li>H1 :<strong># Header 1</strong></li>
<li>H2 :<strong>## Header 2</strong></li>
<li>H3 :<strong>### Header 3</strong></li>
<li>H4 :<strong>#### Header 4</strong></li>
<li>H5 :<strong>##### Header 5</strong></li>
<li>H6 :<strong>###### Header 6</strong></li>
</ul>
<h3 id="文本样式"><a href="#文本样式" class="headerlink" title="文本样式"></a>文本样式</h3><p>（带 “*” 星号的文本样式，在原版 Markdown 标准中不存在，但在其大部分衍生标准中被添加）</p>
<ul>
<li>链接 :<a href="URL">Title</a> <code>[Title](URL)</code></li>
<li>加粗 :<em><strong>*Bold</strong></em>* <code>***\*Bold****</code></li>
<li>斜体字 :<em>Italics</em> <code>*ltalic*</code></li>
<li>***** 删除线 :<del>text</del> <code>~~text~~</code></li>
<li>***** 高亮 :==text== <code>==text==</code></li>
<li>段落：段落之间空一行</li>
<li>换行符：一行结束时输入两个空格</li>
<li>列表 :* 添加星号成为一个新的列表项。</li>
<li>引用 :<em>&gt; 引用内容</em>  <code>&gt; 引用内容</code></li>
<li>内嵌代码 : <code>alert('Hello World');</code></li>
<li>画水平线 (HR) :——–</li>
</ul>
<h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>使用 Markdown 将图像插入文章，你需要在 Markdown 编辑器输入<img lazyload="" src="/images/loading.svg" data-src="/%E5%9B%BE%E7%89%87%E9%93%BE%E6%8E%A5" alt="图片介绍"> 。<img lazyload="" src="/images/loading.svg" data-src="https://ooo.0o0.ooo/2018/06/12/5b1f7101b7cfb.jpg"> 这时在预览面板中会自动创建一个图像上传框。你可以从电脑桌面拖放图片 (.png, .gif, .jpg) 到上传框，或者点击图片上传框使用标准的图像上传方式。 如果你想通过链接插入网络上已经存在的图片，只要单击图片上传框的左下角的 “链接” 图标，这时就会呈现图像 URL 的输入框。想给图片添加一个标题，你需要做的是将标题文本插图中的方括中</p>
<h3 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h3><p><strong>脚注不存在于标准 Markdown 中。</strong></p>
<p>使用这样的占位符号可以将脚注添加到文本中:[^. 另外，你可以使用 “n” 而不是数字的 [^n] 所以你可以不必担心使用哪个号码。在您的文章的结尾，你可以如下图所示定义匹配的注脚，URL 将变成链接:</p>
<h3 id="写代码"><a href="#写代码" class="headerlink" title="写代码"></a>写代码</h3><p>添加内嵌代码可以使用一对回勾号 <code>alert('Hello World')</code>. 对于插入代码，Ghost 支持标准的 Markdown 代码和 GitHub Flavored Markdown (GFM) [4]  。标准 Markdown 基于缩进代码行或者 4 个空格位:</p>
<p>GFM 使用三个回勾号 ```</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>链接</p>
<p>列表格式</p>
<p>使用 Markdown 引用文本：</p>
<h2 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h2><p>编辑</p>
<p>常用的 Markdown 编辑器</p>
<ul>
<li><p>OSX</p>
<p>VSCode</p>
<p><a class="link" href="https://baike.baidu.com/item/Atom/17542770">Atom<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://baike.baidu.com/item/Byword">Byword<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://baike.baidu.com/item/Mou">Mou<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Typora</p>
<p>MacDown</p>
<p>RStudio</p>
</li>
<li><p>Linux</p>
<p>VSCode</p>
<p><a class="link" href="https://baike.baidu.com/item/Atom/17542770">Atom<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Typora</p>
<p>ReText</p>
<p>UberWriter</p>
<p>RStudio</p>
</li>
<li><p>Windows</p>
<p>VSCode</p>
<p><a class="link" href="https://baike.baidu.com/item/Atom/17542770">Atom<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://baike.baidu.com/item/MarkdownPad">MarkdownPad<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Miu</p>
<p>Typora</p>
<p>RStudio</p>
</li>
<li><p>iOS</p>
<p><a class="link" href="https://baike.baidu.com/item/Byword">Byword<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
<li><p>浏览器插件</p>
<p>MaDo (Chrome)</p>
<p>Marxico（Chrome）</p>
<p>马克飞象</p>
</li>
<li><p>高级应用</p>
<p>Sublime Text 2 + MarkdownEditing</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>narkdown</tag>
      </tags>
  </entry>
  <entry>
    <title>使用坚果云备份 serv00</title>
    <url>/2024/4181424588.html</url>
    <content><![CDATA[<p>Serv00 是一家来自波兰的主机服务提供商，因提供 10 年免费的虚拟主机火爆全网。<br>此文章是讲如何备份 Serv00 上部署的网站</p>
<span id="more"></span>
<p>参考<br><a class="link" href="https://mailberry.com.cn/2024/04/serv00-cron-jobs-backup/">https://mailberry.com.cn/2024/04/serv00-cron-jobs-backup/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<ol>
<li>打开<a class="link" href="https://www.jianguoyun.com/d/home">坚果云<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，创建  目录 <code>backup/serv00</code><br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/11/05/pAsuoFK.png" alt="image|369x58, 75%"></li>
<li>点击头像 - 账户信息 - 安全信息 生成 webdav 账号密码<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/11/05/pAsubSe.png" alt="image|690x364, 75%"><hr></li>
<li>在 serv00 中创建一个 backup.sh</li>
</ol>
<blockquote>
<p>目录按实际更改  </p>
</blockquote>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"开始压缩"</span></span><br><span class="line">tar -cvzf /home/tsvico/tbox-$(<span class="built_in">date</span> +%F).tar.gz /home/tsvico/domains/xxxx/public_html/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"开始上传"</span></span><br><span class="line">curl -u username:password -T /home/tsvico/tbox-$(<span class="built_in">date</span> +%F).tar.gz -s -w %{http_code} https://dav.jianguoyun.com/dav/backup/serv00/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"删除备份文件"</span></span><br><span class="line"><span class="built_in">rm</span> /home/tsvico/tbox-$(<span class="built_in">date</span> +%F).tar.gz</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"删除远程备份文件"</span></span><br><span class="line">curl -X DELETE -u <span class="string">"username：password"</span> -s -o /dev/null -w <span class="string">"%{http_code}"</span> <span class="string">"https://dav.jianguoyun.com/dav/backup/serv00/tbox-<span class="subst">$(date -v -2d +%F)</span>.tar.gz"</span></span><br></pre></td></tr></tbody></table></figure></div>
<ol start="4">
<li>serv00 面板添加定时任务<br><img lazyload="" src="/images/loading.svg" data-src="https://s21.ax1x.com/2024/11/05/pAsuqQH.png" alt="image|690x413"></li>
</ol>
]]></content>
      <tags>
        <tag>serv00</tag>
      </tags>
  </entry>
  <entry>
    <title>修复 Hexo-NexT 不蒜子统计被广告拦截</title>
    <url>/2024/1137257936.html</url>
    <content><![CDATA[<p>卜蒜子统计插件默认的 js 地址已经在广告拦截名单里了，导致统计异常。  </p>
<p>借鉴<a class="link" href="https://blog.cubestone.wang/2024/04/04/hexo-next-busuanzi-fix/">在 Hexo 的 NexT 主题里不蒜子统计问题修复<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>修改方法，并使用 <code>patch-package</code> 实现自动化打补丁</p>
<span id="more"></span>

<blockquote>
<p><a class="link" href="https://blog.cubestone.wang/2024/04/04/hexo-next-busuanzi-fix/">在 Hexo 的 NexT 主题里不蒜子统计问题修复<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>原文修改描述</p>
</blockquote>
<p>修改 <code>node_modules/hexo-theme-next/layout/_third-party/statistics/busuanzi-counter.njk</code> 文件为如下内容：</p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tbody><tr><td class="code"><pre><span class="line">{%- if theme.busuanzi_count.enable %}</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">defer</span> <span class="attr">src</span>=<span class="string">"https://vercount.one/js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">{%- endif %}</span><br></pre></td></tr></tbody></table></figure></div>
<p>启用 NexT 配置中的 style: source/_data/styles.styl，在文件中添加如下内容来覆盖默认行为：</p>
<div class="code-container" data-rel="Css"><figure class="iseeu highlight css"><table><tbody><tr><td class="code"><pre><span class="line"><span class="selector-id">#busuanzi_container_page_pv</span> {</span><br><span class="line">    <span class="attribute">display</span>: inline;</span><br><span class="line">}</span><br><span class="line"><span class="selector-class">.busuanzi-count</span> <span class="selector-id">#busuanzi_container_site_uv</span> {</span><br><span class="line">    <span class="attribute">display</span>: inline;</span><br><span class="line">}</span><br><span class="line"><span class="selector-class">.busuanzi-count</span> <span class="selector-id">#busuanzi_container_site_pv</span> {</span><br><span class="line">    <span class="attribute">display</span>: inline;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="自动补丁"><a href="#自动补丁" class="headerlink" title="自动补丁"></a>自动补丁</h2><p>安装 <code>patch-package</code></p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">npm i patch-package --save-dev</span><br></pre></td></tr></tbody></table></figure></div>
<p>因为前边我们已经修改过 <code>node_module</code> 中的代码，现在直接获取补丁就可以，会在 <code>patches</code> 目录下生成补丁文件 <code>hexo-theme-next+8.20.0.patch</code></p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">npx patch-package hexo-theme-next</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>package.json</code> 的 script 中添加如下字段及内容</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"postinstall"</span><span class="punctuation">:</span><span class="string">"patch-package"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>执行 <code>npm ci</code><br>执行完毕后查看 <code>node_modules/hexo-theme-next/layout/_third-party/statistics/busuanzi-counter.njk</code> 是否为修改后的代码</p>
]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
      </tags>
  </entry>
  <entry>
    <title>修改 java 编译后的.class 文件</title>
    <url>/2021/2209964910.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>修改.class 文件，使用压缩工具替换 jar 中原文件</p>
<span id="more"></span>

<h2 id="反编译查看-class"><a href="#反编译查看-class" class="headerlink" title="反编译查看.class"></a>反编译查看.class</h2><p>可以使用 IDEA，也可以使用 <a class="link" href="https://github.com/skylot/jadx/releases">jadx<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>、<code>jd-gui</code></p>
<h2 id="利用jclasslib修改变量"><a href="#利用jclasslib修改变量" class="headerlink" title="利用jclasslib修改变量"></a>利用 jclasslib 修改变量</h2><p>下载地址  <a class="link" href="https://github.com/ingokegel/jclasslib/releases">jclasslib/releases<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>写文章时用的是 5.8 版本，参考的文章地址是 <a class="link" href="https://www.cnblogs.com/zhengwang/p/class.html">class 文件直接修改_反编译修改 class 文件变量<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>不过我用的这个版本已经没有 <code>org.gjt.jclasslib.structures.CPInfo</code> 这个包，并且看源码像是用 <code>kotlin</code> 写的<br>使用步骤</p>
<ol>
<li>在 build.gradle 中添加 <div class="code-container" data-rel="Gradle"><figure class="iseeu highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">plugins {</span><br><span class="line">    id <span class="string">'java'</span></span><br><span class="line">    id <span class="string">"org.jetbrains.kotlin.jvm"</span> version <span class="string">"1.4.20"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
<li>代码 <div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.DataInput;</span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.gjt.jclasslib.io.ClassFileWriter;</span><br><span class="line"><span class="keyword">import</span> org.gjt.jclasslib.structures.ClassFile;</span><br><span class="line"><span class="keyword">import</span> org.gjt.jclasslib.structures.Constant;</span><br><span class="line"><span class="keyword">import</span> org.gjt.jclasslib.structures.InvalidByteCodeException;</span><br><span class="line"><span class="keyword">import</span> org.gjt.jclasslib.structures.constants.ConstantUtf8Info;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> tsvico</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">"C:\\Users\\gwjwi\\Downloads\\xxx.class"</span>;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath);</span><br><span class="line">        } <span class="keyword">catch</span> (FileNotFoundException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> fis != <span class="literal">null</span>;</span><br><span class="line">        <span class="type">DataInput</span> <span class="variable">di</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(fis);</span><br><span class="line">        <span class="type">ClassFile</span> <span class="variable">cf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassFile</span>();</span><br><span class="line">        cf.read(di);</span><br><span class="line">        Constant[] infos = cf.getConstantPool();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> infos.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) {</span><br><span class="line">            <span class="keyword">if</span> (infos[i] != <span class="literal">null</span>) {</span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">553</span>){</span><br><span class="line">                    <span class="type">ConstantUtf8Info</span> <span class="variable">uInfo</span> <span class="operator">=</span> (ConstantUtf8Info)infos[i];</span><br><span class="line">                    <span class="comment">// uInfo.setBytes("Admin123".getBytes()); </span></span><br><span class="line">                    uInfo.setString(<span class="string">"2099-12-17"</span>);</span><br><span class="line">                    infos[i]=uInfo;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        cf.setConstantPool(infos);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            fis.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            ClassFileWriter.writeToFile(f, cf);</span><br><span class="line">        } <span class="keyword">catch</span> (InvalidByteCodeException | IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
</ol>
<p>重新打开字节码文件，发现修改成功。</p>
<p>网上看到使用 <code>jbe</code> 可以直接修改，未能成功</p>
<h2 id="利用javassist"><a href="#利用javassist" class="headerlink" title="利用javassist"></a>利用 javassist</h2><p>最新地址 <a class="link" href="https://github.com/jboss-javassist/javassist/releases">javassist/releases<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>网上有很多相关介绍和教程</p>
<ul>
<li><a class="link" href="https://juejin.cn/post/6844903957223981063">例 1<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://www.cnblogs.com/rickiyang/p/11336268.html">例 2<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<p>这里只提供解决思路，没有具体教程，因为我要修改的是内部静态变量，所以没用这个方法。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>利用 jd-gui.exe 或者 jadx 打开一个 jar 包，另存为项目，可以看到所有的 java 源代码，这种方法仅供参考不建议使用，因为可能会遇到无法重新打包的问题<br>相关文章<br><a class="link" href="https://blog.csdn.net/qq_35868412/article/details/88145217">修改 jar 包中的源码，将 jar 包反编译重新生成一个 jar 包<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>修改默认对象转换成 json 的转换器为 FastJSON？</title>
    <url>/2019/2cda66bd.html</url>
    <content><![CDATA[<p>网有很多关于该部分的内容，但大部分都是教怎返回 json 字符串而不是通过配置实现返回 json 格式的对象。而在现实开发中，大部分都用 ajax 来请求后端，而得到对象的 json 数据，比如微信小程序和 angularjs 等。废话有的多，下面开始，在此仅作整合参考。</p>
<h4 id="1-肯定是引入所需要的jar包"><a href="#1-肯定是引入所需要的jar包" class="headerlink" title="1.肯定是引入所需要的jar包"></a>1. 肯定是引入所需要的 jar 包</h4><p>我自己用的是阿里的 <code>FastJson</code>，网上还有很多用 <code>jackson</code><br>maven 依赖如下：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tbody><tr><td class="code"><pre><span class="line">!--fastjson--&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<span id="more"></span>

<h4 id="2-在springmvc的配置文件springmvc-xml中添加如下代码"><a href="#2-在springmvc的配置文件springmvc-xml中添加如下代码" class="headerlink" title="2.在springmvc的配置文件springmvc.xml中添加如下代码"></a>2. 在 springmvc 的配置文件 springmvc.xml 中添加如下代码</h4><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--springmvc 3.1之前版本不支持这种写法,注意看你springmvc的.xsd的约束文件版本--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:message-converters</span></span></span><br><span class="line"><span class="tag">                <span class="attr">register-defaults</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 避免IE执行AJAX时,返回JSON出现下载文件 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- FastJson --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"fastJsonHttpMessageConverter"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">class</span>=<span class="string">"com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 这里顺序不能反，一定先写text/html,不然ie下出现下载提示 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"features"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">value-type</span>=<span class="string">"com.alibaba.fastjson.serializer.SerializerFeature"</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 避免循环引用 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>DisableCircularReferenceDetect<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 是否输出值为null的字段 --&gt;</span></span><br><span class="line">                         <span class="tag">&lt;<span class="name">value</span>&gt;</span>WriteMapNullValue<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                         <span class="comment">&lt;!---&gt;</span></span><br><span class="line"><span class="comment">                         &lt;value&gt;QuoteFieldNames&lt;/value&gt;</span></span><br><span class="line"><span class="comment">                        &lt;!-- 数值字段如果为null,输出为0,而非null --&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- &lt;value&gt;WriteNullNumberAsZero&lt;/value&gt;--&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 字符类型字段如果为null,输出为"",而非null --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>WriteNullStringAsEmpty<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- List字段如果为null,输出为[],而非null --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>WriteNullListAsEmpty<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- Boolean字段如果为null,输出为false,而非null --&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--  &lt;value&gt;WriteNullBooleanAsFalse&lt;/value&gt;--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>至于其中更多 value 及其用法参考 <a class="link" href="https://blog.csdn.net/u010246789/article/details/52539576">fastJson 的 SerializerFeature 属性<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span> <span class="attr">conversion-service</span>=<span class="string">"conversionService"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:message-converters</span></span></span><br><span class="line"><span class="tag">                <span class="attr">register-defaults</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 避免IE执行AJAX时,返回JSON出现下载文件 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- FastJson --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"fastJsonHttpMessageConverter"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">class</span>=<span class="string">"com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 这里顺序不能反，一定先写text/html,不然ie下出现下载提示 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"features"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">value-type</span>=<span class="string">"com.alibaba.fastjson.serializer.SerializerFeature"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>WriteNullStringAsEmpty<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>WriteNullListAsEmpty<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>WriteMapNullValue<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>QuoteFieldNames<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">    //转换器</span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"conversionService"</span>     </span></span><br><span class="line"><span class="tag"> <span class="attr">class</span>=<span class="string">"org.springframework.format.support.FormattingConversionServiceFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"converters"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"dateConvert"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="配置完成，只要在controller层需要返回json格式的对象的方法加上-ResponseBody注解即可"><a href="#配置完成，只要在controller层需要返回json格式的对象的方法加上-ResponseBody注解即可" class="headerlink" title="配置完成，只要在controller层需要返回json格式的对象的方法加上@ResponseBody注解即可"></a>配置完成，只要在 controller 层需要返回 json 格式的对象的方法加上 @ResponseBody 注解即可</h4><p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2019/10/30/TW4AceHCsIRjOxy.png"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2019/10/30/cx3I4FPYkpeBDSb.png"></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>关于 cloudflare 的 CacheRules 相关踩坑记录</title>
    <url>/2025/497882046.html</url>
    <content><![CDATA[<p>大善人的缓存挺好用，在我一次错误配置后，导致网站后台被缓存不用登录就能访问 😱，然后就研究了下缓存</p>
<span id="more"></span>

<ol>
<li>如果是使用了 cf 优选，缓存配置要在回退域名上才能生效</li>
<li>我先前一直以为缓存是命中即返回，即命中一个规则其他规则就不看了（WAF 好像是这样的？），实际了解后发现根据缓存规则 文档的介绍，冲突的设置后边的将会覆盖之前的，那么就应该这么配置： 缓存所有应该在顺序 1，不缓存应该放在最后<blockquote>
<p>缓存规则是可堆叠的。这意味着可以将多个匹配规则组合起来并应用于同一请求。例如，如果多个缓存规则匹配同一个 URL，则这些缓存规则中设置的功能将按顺序全部应用。如果多个匹配规则为同一设置设置了一个值，则最后一个匹配规则中的值将生效</p>
</blockquote>
</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2025/03/22/U1MLNdgqCAZIcYp.png" alt="图片"></p>
]]></content>
      <tags>
        <tag>cloudflare</tag>
      </tags>
  </entry>
  <entry>
    <title>关于 javaweb 连接远程数据库的一些问题</title>
    <url>/2018/63a96b21.html</url>
    <content><![CDATA[<p>javaweb 连接远程数据库出了点小问题，记录一下解决过程</p>
<span id="more"></span>

<h3 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h3><p>使用 javaweb 连接数据库，包成功导入，连接不成功，页面无任何显示</p>
<h3 id="解决顺序"><a href="#解决顺序" class="headerlink" title="解决顺序"></a>解决顺序</h3><h4 id="查看数据库是否支持外网连接"><a href="#查看数据库是否支持外网连接" class="headerlink" title="查看数据库是否支持外网连接"></a>查看数据库是否支持外网连接</h4><p>在本地使用数据库管理软件直接连接远程数据库，查看是否成功</p>
<p>如果不成功可以按照以下方法任意一种解决</p>
<p>1. 修改 my.cnf 配置文件</p>
<blockquote>
<p>找到 <code>bind-address = 127.0.0.1</code> 这一句，然后在前面加个 #号注释掉，保存退出</p>
</blockquote>
<p>2. 服务端开启远程访问</p>
<blockquote>
<p><strong>先在服务器中通过命令行方式登录 mysql：</strong></p>
<p><strong>mysql -uroot -p 密码</strong></p>
<p><strong>2、执行 use mysql;</strong></p>
<p>**3、执行 grant all privileges on *.* toroot@’%’ identified by ‘密码’; **</p>
<p><strong>4、执行 flush privileges;</strong></p>
<p><strong>注：以上步骤 2、3、4 中命令后么的分号也是命令的一部分，执行的时候不要漏掉。密码处请设置 mysql 的密码。</strong></p>
</blockquote>
<p>把上面命令中<code>密码</code>改为你的密码，如果你使用了 phpstudy，可以在其他菜单选项 - MySQL 工具 - MySQL 命令行 中执行 2,3,4 步骤开启</p>
<p>注：使用腾讯云等云服务器的注意要开启相应外网访问的端口访问权限</p>
<h4 id="导入包问题"><a href="#导入包问题" class="headerlink" title="导入包问题"></a>导入包问题</h4><p>上面设置成功好可以测试一波，查看是否成功连接。</p>
<p>如果还不成功，并且报错 <code>java.lang.ClassNotFoundException: com.mysql.jdbc.Driver</code>，那可能导入包出问题了。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/19vano-n1.webp" alt="image.png"></p>
<p>我之前已经导入成功了，但是依旧错误，后来了解到<br><code>在java项目中，只需要引入mysql-connector-java-xxx-bin.jar就可以运行java项目。在web项目中，当Class.forName(“om.mysql.jdbc.Driver”);时eclipse/IDEA是不会去查找字符串，不会去查找驱动的。所以只需要把mysql-connector-java-xxx-bin.jar拷贝到tomcat下lib目录就可以了。</code></p>
<p>将这个 jar 文件放入到工程的 web/WEB-INF/lib 中，再进行导入就可以</p>
]]></content>
      <tags>
        <tag>java</tag>
        <tag>javaweb</tag>
      </tags>
  </entry>
  <entry>
    <title>初识 TensorFlow</title>
    <url>/2018/562ba3dc.html</url>
    <content><![CDATA[<p>TensorFlow 是<a class="link" href="https://baike.baidu.com/item/%E8%B0%B7%E6%AD%8C">谷歌<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>基于 DistBelief 进行研发的第二代<a class="link" href="https://baike.baidu.com/item/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/9180">人工智能<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link" href="https://baike.baidu.com/item/%E5%AD%A6%E4%B9%A0%E7%B3%BB%E7%BB%9F">学习系统<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，其命名来源于本身的运行原理。Tensor（张量）意味着 N 维数组，Flow（流）意味着基于数据流图的计算，TensorFlow 为张量从流图的一端流动到另一端计算过程。TensorFlow 是将复杂的数据结构传输至人工智能神经网中进行分析和处理过程的系统。</p>
<p>TensorFlow 可被用于<a class="link" href="https://baike.baidu.com/item/%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB">语音识别<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>或<a class="link" href="https://baike.baidu.com/item/%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB">图像识别<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>等多项机器学习和深度学习领域，对 2011 年开发的深度学习基础架构 DistBelief 进行了各方面的改进，它可在小到一部智能手机、大到数千台数据中心服务器的各种设备上运行。TensorFlow 完全开源，任何人都可以用。</p>
<span id="more"></span>

<h3 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h3><h2 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h2><p>TensorFlow Python API 依赖 Python 2.7 版本.</p>
<p>在 Linux 和 Mac 下最简单的安装方式，是使用 <a class="link" href="https://pypi.python.org/pypi/pip">pip<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 安装.</p>
<p>为了简化安装步骤，建议使用 virtualenv</p>
<h3 id="Ubuntu-Linux"><a href="#Ubuntu-Linux" class="headerlink" title="Ubuntu/Linux"></a>Ubuntu/Linux</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line"># 仅使用 CPU 的版本</span><br><span class="line">$ pip install https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.5.0-cp27-none-linux_x86_64.whl</span><br><span class="line"></span><br><span class="line"># 开启 GPU 支持的版本 (安装该版本的前提是已经安装了 CUDA sdk)</span><br><span class="line">$ pip install https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.5.0-cp27-none-linux_x86_64.whl</span><br></pre></td></tr></tbody></table></figure></div>

<p> 安装过程中可能会报错，你可以下载上边连接中文件然后本地安装</p>
<p><code>sudo pip install 下载文件的路径</code></p>
<p>如果提示权限不足请添加 <code>sudo</code> </p>
<p>也可以使用镜像安装</p>
<p>mac os x 系统请看官方文档</p>
<p><code>这里推荐</code></p>
<h2 id="基于-VirtualEnv-的安装"><a href="#基于-VirtualEnv-的安装" class="headerlink" title="基于 VirtualEnv 的安装"></a>基于 VirtualEnv 的安装</h2><p>我们推荐使用 <a class="link" href="https://pypi.python.org/pypi/virtualenv">virtualenv<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 创建一个隔离的容器，来安装 TensorFlow. 这是可选的，但是这样做能使排查安装问题变得更容易.</p>
<p>首先，安装所有必备工具:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line"># 在 Linux 上:</span><br><span class="line">$ sudo apt-get install python-pip python-dev python-virtualenv</span><br><span class="line"></span><br><span class="line"># 在 Mac 上:</span><br><span class="line">$ sudo easy_install pip  # 如果还没有安装 pip</span><br><span class="line">$ sudo pip install --upgrade virtualenv</span><br></pre></td></tr></tbody></table></figure></div>

<p>接下来，建立一个全新的 virtualenv 环境。为了将环境建在 <code>~/tensorflow</code> 目录下，执行:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$ virtualenv --system-site-packages ~/tensorflow</span><br><span class="line">$ cd ~/tensorflow</span><br></pre></td></tr></tbody></table></figure></div>

<p>然后，激活 virtualenv:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$ source bin/activate  # 如果使用 bash</span><br><span class="line">$ source bin/activate.csh  # 如果使用 csh</span><br><span class="line">(tensorflow)$  # 终端提示符应该发生变化</span><br></pre></td></tr></tbody></table></figure></div>

<p>在 virtualenv 内，安装 TensorFlow:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">(tensorflow)$ pip install --upgrade &lt;$url_to_binary.whl&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p>上边最后是一个 URL 或者路径</p>
<p>接下来，使用类似命令运行 TensorFlow 程序:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">(tensorflow)$ cd tensorflow/models/image/mnist</span><br><span class="line">(tensorflow)$ python convolutional.py</span><br><span class="line"></span><br><span class="line"># 当使用完 TensorFlow</span><br><span class="line">(tensorflow)$ deactivate  # 停用 virtualenv</span><br><span class="line"></span><br><span class="line">$  # 你的命令提示符会恢复原样</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="安装成功"><a href="#安装成功" class="headerlink" title="安装成功"></a>安装成功</h2><h3 id="运行-TensorFlow"><a href="#运行-TensorFlow" class="headerlink" title="运行 TensorFlow"></a>运行 TensorFlow</h3><p>打开一个 python 终端:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line">$ python</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hello = tf.constant(<span class="string">'Hello, TensorFlow!'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sess = tf.Session()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> sess.run(hello)</span><br><span class="line">Hello, TensorFlow!</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = tf.constant(<span class="number">10</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = tf.constant(<span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> sess.run(a+b)</span><br><span class="line"><span class="number">42</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>python</tag>
        <tag>tensorflow</tag>
      </tags>
  </entry>
  <entry>
    <title>原生 Js 代替 jquery 操作 DOM</title>
    <url>/2019/a51e1dea.html</url>
    <content><![CDATA[<h2 id="原生Js代替jquery操作DOM"><a href="#原生Js代替jquery操作DOM" class="headerlink" title="原生Js代替jquery操作DOM"></a>原生 Js 代替 jquery 操作 DOM</h2><p>转载自 GitHub <a class="link" href="https://github.com/nefe/You-Dont-Need-jQuery/blob/master/README.zh-CN.md">You Don’t Need jQuery<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>注 ： 只保留了简体中文</p>
<span id="more"></span>

<blockquote>
<p>前端发展很快，现代浏览器原生 API 已经足够好用。我们并不需要为了操作 DOM、Event 等再学习一下 jQuery 的<br>API。同时由于 React、Angular、Vue 等框架的流行，直接操作 DOM 不再是好的模式，jQuery<br>使用场景大大减少。本项目总结了大部分 jQuery API 替代的方法，暂时只支持 IE10 以上浏览器。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#translations">Translations</a></li>
<li><a href="#query-selector">Query Selector</a></li>
<li><a href="#css--style">CSS &amp; Style</a></li>
<li><a href="#dom-manipulation">DOM Manipulation</a></li>
<li><a href="#ajax">Ajax</a></li>
<li><a href="#events">Events</a></li>
<li><a href="#utilities">Utilities</a></li>
<li><a href="#promises">Promises</a></li>
<li><a href="#animation">Animation</a></li>
<li><a href="#alternatives">Alternatives</a></li>
<li><a href="#browser-support">Browser Support</a><br>.</li>
</ol>
<h2 id="Query-Selector"><a href="#Query-Selector" class="headerlink" title="Query Selector"></a>Query Selector</h2><p>常用的 class、id、属性 选择器都可以使用 <code>document.querySelector</code> 或 <code>document.querySelectorAll</code> 替代。区别是</p>
<ul>
<li><code>document.querySelector</code> 返回第一个匹配的 Element</li>
<li><code>document.querySelectorAll</code> 返回所有匹配的 Element 组成的 NodeList。它可以通过 <code>[].slice.call()</code> 把它转成 Array</li>
<li> 如果匹配不到任何 Element，jQuery 返回空数组 <code>[]</code>，但 <code>document.querySelector</code> 返回 <code>null</code>，注意空指针异常。当找不到时，也可以使用 <code>||</code> 设置默认的值，如 <code>document.querySelectorAll(selector) || []</code></li>
</ul>
<blockquote>
<p>注意：<code>document.querySelector</code> 和 <code>document.querySelectorAll</code> 性能很<strong>差</strong>。如果想提高性能，尽量使用 <code>document.getElementById</code>、<code>document.getElementsByClassName</code> 或 <code>document.getElementsByTagName</code>。</p>
</blockquote>
<ul>
<li><p><a href="#1.0">1.0</a> <a name="1.0"></a> 选择器查询</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'selector'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'selector'</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.1">1.1</a> <a name="1.1"></a> class 查询</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'.class'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.class'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">'class'</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.2">1.2</a> <a name="1.2"></a> id 查询</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'#id'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'#id'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'id'</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.3">1.3</a> <a name="1.3"></a> 属性查询</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'a[target=_blank]'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'a[target=_blank]'</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.4">1.4</a> <a name="1.4"></a> 后代查询</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">find</span>(<span class="string">'li'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="title function_">querySelectorAll</span>(<span class="string">'li'</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.5">1.5</a> <a name="1.5"></a> 兄弟及上下元素</p>
<ul>
<li><p>兄弟元素</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">siblings</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native - latest, Edge13+</span></span><br><span class="line">[...el.<span class="property">parentNode</span>.<span class="property">children</span>].<span class="title function_">filter</span>(<span class="function">(<span class="params">child</span>) =&gt;</span></span><br><span class="line">  child !== el</span><br><span class="line">);</span><br><span class="line"><span class="comment">// Native (alternative) - latest, Edge13+</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="title function_">from</span>(el.<span class="property">parentNode</span>.<span class="property">children</span>).<span class="title function_">filter</span>(<span class="function">(<span class="params">child</span>) =&gt;</span></span><br><span class="line">  child !== el</span><br><span class="line">);</span><br><span class="line"><span class="comment">// Native - IE10+</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">filter</span>.<span class="title function_">call</span>(el.<span class="property">parentNode</span>.<span class="property">children</span>, <span class="function">(<span class="params">child</span>) =&gt;</span></span><br><span class="line">  child !== el</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>上一个元素</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">prev</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">previousElementSibling</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>下一个元素</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// next</span></span><br><span class="line">$el.<span class="title function_">next</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">nextElementSibling</span>;</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#1.6">1.6</a> <a name="1.6"></a> Closest</p>
<p>Closest 获得匹配选择器的第一个祖先元素，从当前元素开始沿 DOM 树向上。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">closest</span>(queryString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native - Only latest, NO IE</span></span><br><span class="line">el.<span class="title function_">closest</span>(selector);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native - IE10+</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">closest</span>(<span class="params">el, selector</span>) {</span><br><span class="line">  <span class="keyword">const</span> matchesSelector = el.<span class="property">matches</span> || el.<span class="property">webkitMatchesSelector</span> || el.<span class="property">mozMatchesSelector</span> || el.<span class="property">msMatchesSelector</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (el) {</span><br><span class="line">    <span class="keyword">if</span> (matchesSelector.<span class="title function_">call</span>(el, selector)) {</span><br><span class="line">      <span class="keyword">return</span> el;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      el = el.<span class="property">parentElement</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.7">1.7</a> <a name="1.7"></a> Parents Until</p>
<p>获取当前每一个匹配元素集的祖先，不包括匹配元素的本身。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">parentsUntil</span>(selector, filter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parentsUntil</span>(<span class="params">el, selector, filter</span>) {</span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line">  <span class="keyword">const</span> matchesSelector = el.<span class="property">matches</span> || el.<span class="property">webkitMatchesSelector</span> || el.<span class="property">mozMatchesSelector</span> || el.<span class="property">msMatchesSelector</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// match start from parent</span></span><br><span class="line">  el = el.<span class="property">parentElement</span>;</span><br><span class="line">  <span class="keyword">while</span> (el &amp;&amp; !matchesSelector.<span class="title function_">call</span>(el, selector)) {</span><br><span class="line">    <span class="keyword">if</span> (!filter) {</span><br><span class="line">      result.<span class="title function_">push</span>(el);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">if</span> (matchesSelector.<span class="title function_">call</span>(el, filter)) {</span><br><span class="line">        result.<span class="title function_">push</span>(el);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    el = el.<span class="property">parentElement</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.8">1.8</a> <a name="1.8"></a> Form</p>
<ul>
<li><p>Input/Textarea</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'#my-input'</span>).<span class="title function_">val</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'#my-input'</span>).<span class="property">value</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>获取 e.currentTarget 在 <code>.radio</code> 中的数组索引</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'.radio'</span>).<span class="title function_">index</span>(e.<span class="property">currentTarget</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">indexOf</span>.<span class="title function_">call</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.radio'</span>), e.<span class="property">currentTarget</span>);</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#1.9">1.9</a> <a name="1.9"></a> Iframe Contents</p>
<p>jQuery 对象的 iframe <code>contents()</code> 返回的是 iframe 内的 <code>document</code></p>
<ul>
<li><p>Iframe contents</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$iframe.<span class="title function_">contents</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">iframe.<span class="property">contentDocument</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Iframe Query</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$iframe.<span class="title function_">contents</span>().<span class="title function_">find</span>(<span class="string">'.css'</span>);</span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">iframe.<span class="property">contentDocument</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.css'</span>);</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#1.10">1.10</a> <a name="1.10"></a> 获取 body</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'body'</span>);</span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#1.11">1.11</a> <a name="1.11"></a> 获取或设置属性</p>
<ul>
<li><p>获取属性</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">attr</span>(<span class="string">'foo'</span>);</span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="title function_">getAttribute</span>(<span class="string">'foo'</span>);</span><br></pre></td></tr></tbody></table></figure></div></li>
<li><p>设置属性</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery, note that this works in memory without change the DOM</span></span><br><span class="line">$el.<span class="title function_">attr</span>(<span class="string">'foo'</span>, <span class="string">'bar'</span>);</span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="title function_">setAttribute</span>(<span class="string">'foo'</span>, <span class="string">'bar'</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>获取 <code>data-</code> 属性</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">data</span>(<span class="string">'foo'</span>);</span><br><span class="line"><span class="comment">// Native (use `getAttribute`)</span></span><br><span class="line">el.<span class="title function_">getAttribute</span>(<span class="string">'data-foo'</span>);</span><br><span class="line"><span class="comment">// Native (use `dataset` if only need to support IE 11+)</span></span><br><span class="line">el.<span class="property">dataset</span>[<span class="string">'foo'</span>];</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="CSS-Style"><a href="#CSS-Style" class="headerlink" title="CSS &amp; Style"></a>CSS &amp; Style</h2><ul>
<li><p><a href="#2.1">2.1</a> <a name="2.1"></a> CSS</p>
<ul>
<li><p>Get style</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">css</span>(<span class="string">"color"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="comment">// 注意：此处为了解决当 style 值为 auto 时，返回 auto 的问题</span></span><br><span class="line"><span class="keyword">const</span> win = el.<span class="property">ownerDocument</span>.<span class="property">defaultView</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// null 的意思是不返回伪类元素</span></span><br><span class="line">win.<span class="title function_">getComputedStyle</span>(el, <span class="literal">null</span>).<span class="property">color</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Set style</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">css</span>({ <span class="attr">color</span>: <span class="string">"#ff0011"</span> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">color</span> = <span class="string">'#ff0011'</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Get/Set Styles</p>
<p>注意，如果想一次设置多个 style，可以参考 oui-dom-utils 中 <a class="link" href="https://github.com/oneuijs/oui-dom-utils/blob/master/src/index.js#L194">setStyles<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 方法</p>
</li>
<li><p>Add class</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">addClass</span>(className);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">classList</span>.<span class="title function_">add</span>(className);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Remove class</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">removeClass</span>(className);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">classList</span>.<span class="title function_">remove</span>(className);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>has class</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">hasClass</span>(className);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">classList</span>.<span class="title function_">contains</span>(className);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Toggle class</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">toggleClass</span>(className);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">classList</span>.<span class="title function_">toggle</span>(className);</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#2.2">2.2</a> <a name="2.2"></a> Width &amp; Height</p>
<p>Width 与 Height 获取方法相同，下面以 Height 为例：</p>
<ul>
<li><p>Window height</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// window height</span></span><br><span class="line">$(<span class="variable language_">window</span>).<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 含 scrollbar</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">document</span>.<span class="property">documentElement</span>.<span class="property">clientHeight</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不含 scrollbar，与 jQuery 行为一致</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Document height</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">const</span> body = <span class="variable language_">document</span>.<span class="property">body</span>;</span><br><span class="line"><span class="keyword">const</span> html = <span class="variable language_">document</span>.<span class="property">documentElement</span>;</span><br><span class="line"><span class="keyword">const</span> height = <span class="title class_">Math</span>.<span class="title function_">max</span>(</span><br><span class="line">  body.<span class="property">offsetHeight</span>,</span><br><span class="line">  body.<span class="property">scrollHeight</span>,</span><br><span class="line">  html.<span class="property">clientHeight</span>,</span><br><span class="line">  html.<span class="property">offsetHeight</span>,</span><br><span class="line">  html.<span class="property">scrollHeight</span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Element height</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getHeight</span>(<span class="params">el</span>) {</span><br><span class="line">  <span class="keyword">const</span> styles = <span class="variable language_">this</span>.<span class="title function_">getComputedStyle</span>(el);</span><br><span class="line">  <span class="keyword">const</span> height = el.<span class="property">offsetHeight</span>;</span><br><span class="line">  <span class="keyword">const</span> borderTopWidth = <span class="built_in">parseFloat</span>(styles.<span class="property">borderTopWidth</span>);</span><br><span class="line">  <span class="keyword">const</span> borderBottomWidth = <span class="built_in">parseFloat</span>(styles.<span class="property">borderBottomWidth</span>);</span><br><span class="line">  <span class="keyword">const</span> paddingTop = <span class="built_in">parseFloat</span>(styles.<span class="property">paddingTop</span>);</span><br><span class="line">  <span class="keyword">const</span> paddingBottom = <span class="built_in">parseFloat</span>(styles.<span class="property">paddingBottom</span>);</span><br><span class="line">  <span class="keyword">return</span> height - borderBottomWidth - borderTopWidth - paddingTop - paddingBottom;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 精确到整数（border-box 时为 height - border 值，content-box 时为 height + padding 值）</span></span><br><span class="line">el.<span class="property">clientHeight</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 精确到小数（border-box 时为 height 值，content-box 时为 height + padding + border 值）</span></span><br><span class="line">el.<span class="title function_">getBoundingClientRect</span>().<span class="property">height</span>;</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#2.3">2.3</a> <a name="2.3"></a> Position &amp; Offset</p>
<ul>
<li><p>Position</p>
<p>获得匹配元素相对父元素的偏移</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">position</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">{ <span class="attr">left</span>: el.<span class="property">offsetLeft</span>, <span class="attr">top</span>: el.<span class="property">offsetTop</span> }</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Offset</p>
<p>获得匹配元素相对文档的偏移</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">offset</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getOffset</span> (<span class="params">el</span>) {</span><br><span class="line">  <span class="keyword">const</span> box = el.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">top</span>: box.<span class="property">top</span> + <span class="variable language_">window</span>.<span class="property">pageYOffset</span> - <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">clientTop</span>,</span><br><span class="line">    <span class="attr">left</span>: box.<span class="property">left</span> + <span class="variable language_">window</span>.<span class="property">pageXOffset</span> - <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">clientLeft</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#2.4">2.4</a> <a name="2.4"></a> Scroll Top</p>
<p>获取元素滚动条垂直位置。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="variable language_">window</span>).<span class="title function_">scrollTop</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">(<span class="variable language_">document</span>.<span class="property">documentElement</span> &amp;&amp; <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">scrollTop</span>) || <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollTop</span>;</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="DOM-Manipulation"><a href="#DOM-Manipulation" class="headerlink" title="DOM Manipulation"></a>DOM Manipulation</h2><ul>
<li><p><a href="#3.1">3.1</a> <a name="3.1"></a> Remove</p>
<p>从 DOM 中移除元素。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">remove</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(el);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.2">3.2</a> <a name="3.2"></a> Text</p>
<ul>
<li><p>Get text</p>
<p>返回指定元素及其后代的文本内容。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">text</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">textContent</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Set text</p>
<p>设置元素的文本内容。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">text</span>(string);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">textContent</span> = string;</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#3.3">3.3</a> <a name="3.3"></a> HTML</p>
<ul>
<li><p>Get HTML</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">html</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">innerHTML</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>Set HTML</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">html</span>(htmlString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">innerHTML</span> = htmlString;</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
</li>
<li><p><a href="#3.4">3.4</a> <a name="3.4"></a> Append</p>
<p>Append 插入到子节点的末尾</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">append</span>(<span class="string">"&lt;div id='container'&gt;hello&lt;/div&gt;"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (HTML string)</span></span><br><span class="line">el.<span class="title function_">insertAdjacentHTML</span>(<span class="string">'beforeend'</span>, <span class="string">'&lt;div id="container"&gt;Hello World&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (Element)</span></span><br><span class="line">el.<span class="title function_">appendChild</span>(newEl);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.5">3.5</a> <a name="3.5"></a> Prepend</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">prepend</span>(<span class="string">"&lt;div id='container'&gt;hello&lt;/div&gt;"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (HTML string)</span></span><br><span class="line">el.<span class="title function_">insertAdjacentHTML</span>(<span class="string">'afterbegin'</span>, <span class="string">'&lt;div id="container"&gt;Hello World&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (Element)</span></span><br><span class="line">el.<span class="title function_">insertBefore</span>(newEl, el.<span class="property">firstChild</span>);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.6">3.6</a> <a name="3.6"></a> insertBefore</p>
<p>在选中元素前插入新节点</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$newEl.<span class="title function_">insertBefore</span>(queryString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (HTML string)</span></span><br><span class="line">el.<span class="title function_">insertAdjacentHTML</span>(<span class="string">'beforebegin '</span>, <span class="string">'&lt;div id="container"&gt;Hello World&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (Element)</span></span><br><span class="line"><span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(selector);</span><br><span class="line"><span class="keyword">if</span> (el.<span class="property">parentNode</span>) {</span><br><span class="line">  el.<span class="property">parentNode</span>.<span class="title function_">insertBefore</span>(newEl, el);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.7">3.7</a> <a name="3.7"></a> insertAfter</p>
<p>在选中元素后插入新节点</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$newEl.<span class="title function_">insertAfter</span>(queryString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (HTML string)</span></span><br><span class="line">el.<span class="title function_">insertAdjacentHTML</span>(<span class="string">'afterend'</span>, <span class="string">'&lt;div id="container"&gt;Hello World&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native (Element)</span></span><br><span class="line"><span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(selector);</span><br><span class="line"><span class="keyword">if</span> (el.<span class="property">parentNode</span>) {</span><br><span class="line">  el.<span class="property">parentNode</span>.<span class="title function_">insertBefore</span>(newEl, el.<span class="property">nextSibling</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.8">3.8</a> <a name="3.8"></a> is</p>
<p>如果匹配给定的选择器，返回 true</p>
  <div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">is</span>(selector);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="title function_">matches</span>(selector);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.9">3.9</a> <a name="3.9"></a> clone</p>
<p>深拷贝被选元素。（生成被选元素的副本，包含子节点、文本和属性。）</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//jQuery</span></span><br><span class="line">$el.<span class="title function_">clone</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Native</span></span><br><span class="line">el.<span class="title function_">cloneNode</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//深拷贝添加参数‘true’</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.10">3.10</a> <a name="3.10"></a> empty</p>
<p>移除所有子节点</p>
</li>
</ul>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//jQuery</span></span><br><span class="line">$el.<span class="title function_">empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Native</span></span><br><span class="line">el.<span class="property">innerHTML</span> = <span class="string">''</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><a href="#3.11">3.11</a> <a name="3.11"></a> wrap</li>
</ul>
<p> 把每个被选元素放置在指定的 HTML 结构中。</p>
 <div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//jQuery</span></span><br><span class="line">$(<span class="string">".inner"</span>).<span class="title function_">wrap</span>(<span class="string">'&lt;div class="wrapper"&gt;&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Native</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>.<span class="title function_">call</span>(<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'.inner'</span>), <span class="function">(<span class="params">el</span>) =&gt;</span> {</span><br><span class="line">   <span class="keyword">const</span> wrapper = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">'div'</span>);</span><br><span class="line">   wrapper.<span class="property">className</span> = <span class="string">'wrapper'</span>;</span><br><span class="line">   el.<span class="property">parentNode</span>.<span class="title function_">insertBefore</span>(wrapper, el);</span><br><span class="line">   el.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(el);</span><br><span class="line">   wrapper.<span class="title function_">appendChild</span>(el);</span><br><span class="line">});</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><p><a href="#3.12">3.12</a> <a name="3.12"></a> unwrap</p>
<p>移除被选元素的父元素的 DOM 结构</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">'.inner'</span>).<span class="title function_">unwrap</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>.<span class="title function_">call</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.inner'</span>), <span class="function">(<span class="params">el</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">let</span> elParentNode = el.<span class="property">parentNode</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(elParentNode !== <span class="variable language_">document</span>.<span class="property">body</span>) {</span><br><span class="line">          elParentNode.<span class="property">parentNode</span>.<span class="title function_">insertBefore</span>(el, elParentNode)</span><br><span class="line">          elParentNode.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(elParentNode)</span><br><span class="line">      }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.13">3.13</a> <a name="3.13"></a> replaceWith</p>
<p>用指定的元素替换被选的元素</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//jQuery</span></span><br><span class="line">$(<span class="string">'.inner'</span>).<span class="title function_">replaceWith</span>(<span class="string">'&lt;div class="outer"&gt;&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Native</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>.<span class="title function_">call</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.inner'</span>),<span class="function">(<span class="params">el</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> outer = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">"div"</span>);</span><br><span class="line">  outer.<span class="property">className</span> = <span class="string">"outer"</span>;</span><br><span class="line">  el.<span class="property">parentNode</span>.<span class="title function_">insertBefore</span>(outer, el);</span><br><span class="line">  el.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(el);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#3.14">3.14</a> <a name="3.14"></a> simple parse</p>
<p>解析 HTML/SVG/XML 字符串</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="string">`&lt;ol&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;a&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;b&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ol&gt;</span></span><br><span class="line"><span class="string">&lt;ol&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;c&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;d&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ol&gt;`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">range = <span class="variable language_">document</span>.<span class="title function_">createRange</span>();</span><br><span class="line">parse = range.<span class="property">createContextualFragment</span>.<span class="title function_">bind</span>(range);</span><br><span class="line"></span><br><span class="line"><span class="title function_">parse</span>(<span class="string">`&lt;ol&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;a&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;b&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ol&gt;</span></span><br><span class="line"><span class="string">&lt;ol&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;c&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;d&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ol&gt;`</span>);</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h2><p><a class="link" href="https://fetch.spec.whatwg.org/">Fetch API<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 是用于替换 XMLHttpRequest 处理 ajax 的新标准，Chrome 和 Firefox 均支持，旧浏览器可以使用 polyfills 提供支持。</p>
<p>IE9+ 请使用 <a class="link" href="http://github.com/github/fetch">github/fetch<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，IE8+ 请使用 <a class="link" href="https://github.com/camsong/fetch-ie8/">fetch-ie8<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，JSONP 请使用 <a class="link" href="https://github.com/camsong/fetch-jsonp">fetch-jsonp<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<ul>
<li><p><a href="#4.1">4.1</a> <a name="4.1"></a> 从服务器读取数据并替换匹配元素的内容。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(selector).<span class="title function_">load</span>(url, completeCallback)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> {</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(selector).<span class="property">innerHTML</span> = data</span><br><span class="line">}).<span class="title function_">then</span>(completeCallback)</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h2><p>完整地替代命名空间和事件代理，链接到 <a class="link" href="https://github.com/oneuijs/oui-dom-events">https://github.com/oneuijs/oui-dom-events<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<ul>
<li><p><a href="#5.0">5.0</a> <a name="5.0"></a> Document ready by <code>DOMContentLoaded</code></p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(eventHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="comment">// 检测 DOMContentLoaded 是否已完成</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">readyState</span> !== <span class="string">'loading'</span>) {</span><br><span class="line">  <span class="title function_">eventHandler</span>();</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'DOMContentLoaded'</span>, eventHandler);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#5.1">5.1</a> <a name="5.1"></a> 使用 on 绑定事件</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">on</span>(eventName, eventHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="title function_">addEventListener</span>(eventName, eventHandler);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#5.2">5.2</a> <a name="5.2"></a> 使用 off 解绑事件</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">off</span>(eventName, eventHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="title function_">removeEventListener</span>(eventName, eventHandler);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#5.3">5.3</a> <a name="5.3"></a> Trigger</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$(el).<span class="title function_">trigger</span>(<span class="string">'custom-event'</span>, {<span class="attr">key1</span>: <span class="string">'data'</span>});</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">CustomEvent</span>) {</span><br><span class="line">  <span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">'custom-event'</span>, {<span class="attr">detail</span>: {<span class="attr">key1</span>: <span class="string">'data'</span>}});</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  <span class="keyword">const</span> event = <span class="variable language_">document</span>.<span class="title function_">createEvent</span>(<span class="string">'CustomEvent'</span>);</span><br><span class="line">  event.<span class="title function_">initCustomEvent</span>(<span class="string">'custom-event'</span>, <span class="literal">true</span>, <span class="literal">true</span>, {<span class="attr">key1</span>: <span class="string">'data'</span>});</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">el.<span class="title function_">dispatchEvent</span>(event);</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h2><p>大部分实用工具都能在 native API 中找到。其他高级功能可以选用专注于该领域的稳定性和性能都更好的库来代替，推荐 <a class="link" href="https://lodash.com/">lodash<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<ul>
<li><p><a href="#6.1">6.1</a> <a name="6.1"></a> 基本工具</p>
<ul>
<li>isArray</li>
</ul>
<p>检测参数是不是数组。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">isArray</span>(range);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="title function_">isArray</span>(range);</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>isWindow</li>
</ul>
<p>检测参数是不是 window。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">isWindow</span>(obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isWindow</span>(<span class="params">obj</span>) {</span><br><span class="line">  <span class="keyword">return</span> obj !== <span class="literal">null</span> &amp;&amp; obj !== <span class="literal">undefined</span> &amp;&amp; obj === obj.<span class="property">window</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>inArray</li>
</ul>
<p>在数组中搜索指定值并返回索引 (找不到则返回 -1)。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">inArray</span>(item, array);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">array.<span class="title function_">indexOf</span>(item) &gt; -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6-way</span></span><br><span class="line">array.<span class="title function_">includes</span>(item);</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>isNumeric</li>
</ul>
<p>检测传入的参数是不是数字。<br>Use <code>typeof</code> to decide the type or the <code>type</code> example for better accuracy.</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">isNumeric</span>(item);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isNumeric</span>(<span class="params">n</span>) {</span><br><span class="line">  <span class="keyword">return</span> !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(n)) &amp;&amp; <span class="built_in">isFinite</span>(n);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>isFunction</li>
</ul>
<p>检测传入的参数是不是 JavaScript 函数对象。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">isFunction</span>(item);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">item</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'function'</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">var</span> type = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">toString</span>(item);</span><br><span class="line">  <span class="keyword">return</span> type === <span class="string">'[object Function]'</span> || type === <span class="string">'[object GeneratorFunction]'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>isEmptyObject</li>
</ul>
<p>检测对象是否为空 (包括不可枚举属性).</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">isEmptyObject</span>(obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isEmptyObject</span>(<span class="params">obj</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="property">length</span> === <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>isPlainObject</li>
</ul>
<p>检测是不是扁平对象 (使用 “{}” 或 “new Object” 创建).</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">isPlainObject</span>(obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isPlainObject</span>(<span class="params">obj</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">typeof</span> (obj) !== <span class="string">'object'</span> || obj.<span class="property">nodeType</span> || obj !== <span class="literal">null</span> &amp;&amp; obj !== <span class="literal">undefined</span> &amp;&amp; obj === obj.<span class="property">window</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (obj.<span class="property">constructor</span> &amp;&amp;</span><br><span class="line">      !<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(obj.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">'isPrototypeOf'</span>)) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>extend</li>
</ul>
<p>合并多个对象的内容到第一个对象。<br>object.assign 是 ES6 API，也可以使用 <a class="link" href="https://github.com/ljharb/object.assign">polyfill<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">extend</span>({}, defaultOpts, opts);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">assign</span>({}, defaultOpts, opts);</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>trim</li>
</ul>
<p>移除字符串头尾空白。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">trim</span>(string);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">string.<span class="title function_">trim</span>();</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>map</li>
</ul>
<p>将数组或对象转化为包含新内容的数组。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">map</span>(array, <span class="function">(<span class="params">value, index</span>) =&gt;</span> {</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">array.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> {</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>each</li>
</ul>
<p>轮询函数，可用于平滑的轮询对象和数组。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">each</span>(array, <span class="function">(<span class="params">index, value</span>) =&gt;</span> {</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">array.<span class="title function_">forEach</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> {</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>grep</li>
</ul>
<p>找到数组中符合过滤函数的元素。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">grep</span>(array, <span class="function">(<span class="params">value, index</span>) =&gt;</span> {</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">array.<span class="title function_">filter</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> {</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>type</li>
</ul>
<p>检测对象的 JavaScript [Class] 内部类型。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">type</span>(obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">type</span>(<span class="params">item</span>) {</span><br><span class="line">  <span class="keyword">const</span> reTypeOf = <span class="regexp">/(?:^\[object\s(.*?)\]$)/</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(item)</span><br><span class="line">    .<span class="title function_">replace</span>(reTypeOf, <span class="string">'$1'</span>)</span><br><span class="line">    .<span class="title function_">toLowerCase</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>merge</li>
</ul>
<p>合并第二个数组内容到第一个数组。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">merge</span>(array1, array2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="comment">// 使用 concat，不能去除重复值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">...args</span>) {</span><br><span class="line">  <span class="keyword">return</span> [].<span class="title function_">concat</span>(...args)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6，同样不能去除重复值</span></span><br><span class="line">array1 = [...array1, ...array2]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Set，可以去除重复值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">...args</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Set</span>([].<span class="title function_">concat</span>(...args)))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>now</li>
</ul>
<p>返回当前时间的数字呈现。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>proxy</li>
</ul>
<p>传入函数并返回一个新函数，该函数绑定指定上下文。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">proxy</span>(fn, context);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">fn.<span class="title function_">bind</span>(context);</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>makeArray</li>
</ul>
<p>类数组对象转化为真正的 JavaScript 数组。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">makeArray</span>(arrayLike);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(arrayLike);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6-way</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="title function_">from</span>(arrayLike);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#6.2">6.2</a> <a name="6.2"></a> 包含</p>
<p>检测 DOM 元素是不是其他 DOM 元素的后代.</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">contains</span>(el, child);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el !== child &amp;&amp; el.<span class="title function_">contains</span>(child);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#6.3">6.3</a> <a name="6.3"></a> Globaleval</p>
<p>全局执行 JavaScript 代码。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">globaleval</span>(code);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Globaleval</span>(<span class="params">code</span>) {</span><br><span class="line">  <span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">'script'</span>);</span><br><span class="line">  script.<span class="property">text</span> = code;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script).<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(script);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use eval, but context of eval is current, context of $.Globaleval is global.</span></span><br><span class="line"><span class="built_in">eval</span>(code);</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#6.4">6.4</a> <a name="6.4"></a> 解析</p>
<ul>
<li>parseHTML</li>
</ul>
<p>解析字符串为 DOM 节点数组.</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">parseHTML</span>(htmlString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parseHTML</span>(<span class="params">string</span>) {</span><br><span class="line">  <span class="keyword">const</span> context = <span class="variable language_">document</span>.<span class="property">implementation</span>.<span class="title function_">createHTMLDocument</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the base href for the created document so any parsed elements with URLs</span></span><br><span class="line">  <span class="comment">// are based on the document's URL</span></span><br><span class="line">  <span class="keyword">const</span> base = context.<span class="title function_">createElement</span>(<span class="string">'base'</span>);</span><br><span class="line">  base.<span class="property">href</span> = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>;</span><br><span class="line">  context.<span class="property">head</span>.<span class="title function_">appendChild</span>(base);</span><br><span class="line"></span><br><span class="line">  context.<span class="property">body</span>.<span class="property">innerHTML</span> = string;</span><br><span class="line">  <span class="keyword">return</span> context.<span class="property">body</span>.<span class="property">children</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>parseJSON</li>
</ul>
<p>传入格式正确的 JSON 字符串并返回 JavaScript 值.</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">parseJSON</span>(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">parse</span>(str);</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h2><p>Promise 代表异步操作的最终结果。jQuery 用它自己的方式处理 promises，原生 JavaScript 遵循 <a class="link" href="http://promises-aplus.github.io/promises-spec/">Promises/A+<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 标准实现了最小 API 来处理 promises。</p>
<ul>
<li><p><a href="#7.1">7.1</a> <a name="7.1"></a> done, fail, always</p>
<p><code>done</code> 会在 promise 解决时调用，<code>fail</code> 会在 promise 拒绝时调用，<code>always</code> 总会调用。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$promise.<span class="title function_">done</span>(doneCallback).<span class="title function_">fail</span>(failCallback).<span class="title function_">always</span>(alwaysCallback)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">promise.<span class="title function_">then</span>(doneCallback, failCallback).<span class="title function_">then</span>(alwaysCallback, alwaysCallback)</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#7.2">7.2</a> <a name="7.2"></a> when</p>
<p><code>when</code> 用于处理多个 promises。当全部 promises 被解决时返回，当任一 promise 被拒绝时拒绝。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">when</span>($promise1, $promise2).<span class="title function_">done</span>(<span class="function">(<span class="params">promise1Result, promise2Result</span>) =&gt;</span> {</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([$promise1, $promise2]).<span class="title function_">then</span>([promise1Result, promise2Result] =&gt; {});</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#7.3">7.3</a> <a name="7.3"></a> Deferred</p>
<p>Deferred 是创建 promises 的一种方式。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncFunc</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> defer = <span class="keyword">new</span> $.<span class="title class_">Deferred</span>();</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">true</span>) {</span><br><span class="line">      defer.<span class="title function_">resolve</span>(<span class="string">'some_value_computed_asynchronously'</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      defer.<span class="title function_">reject</span>(<span class="string">'failed'</span>);</span><br><span class="line">    }</span><br><span class="line">  }, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> defer.<span class="title function_">promise</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncFunc</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">'some_value_computed_asynchronously'</span>);</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="title function_">reject</span>(<span class="string">'failed'</span>);</span><br><span class="line">      }</span><br><span class="line">    }, <span class="number">1000</span>);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deferred way</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defer</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> deferred = {};</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    deferred.<span class="property">resolve</span> = resolve;</span><br><span class="line">    deferred.<span class="property">reject</span> = reject;</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  deferred.<span class="property">promise</span> = <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> deferred;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncFunc</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> defer = <span class="title function_">defer</span>();</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">true</span>) {</span><br><span class="line">      defer.<span class="title function_">resolve</span>(<span class="string">'some_value_computed_asynchronously'</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      defer.<span class="title function_">reject</span>(<span class="string">'failed'</span>);</span><br><span class="line">    }</span><br><span class="line">  }, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> defer.<span class="title function_">promise</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h2><ul>
<li><p><a href="#8.1">8.1</a> <a name="8.1"></a> Show &amp; Hide</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">show</span>();</span><br><span class="line">$el.<span class="title function_">hide</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="comment">// 更多 show 方法的细节详见 https://github.com/oneuijs/oui-dom-utils/blob/master/src/index.js#L363</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">display</span> = <span class="string">''</span>|<span class="string">'inline'</span>|<span class="string">'inline-block'</span>|<span class="string">'inline-table'</span>|<span class="string">'block'</span>;</span><br><span class="line">el.<span class="property">style</span>.<span class="property">display</span> = <span class="string">'none'</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.2">8.2</a> <a name="8.2"></a> Toggle</p>
<p>显示或隐藏元素。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">toggle</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">if</span> (el.<span class="property">ownerDocument</span>.<span class="property">defaultView</span>.<span class="title function_">getComputedStyle</span>(el, <span class="literal">null</span>).<span class="property">display</span> === <span class="string">'none'</span>) {</span><br><span class="line">  el.<span class="property">style</span>.<span class="property">display</span> = <span class="string">''</span>|<span class="string">'inline'</span>|<span class="string">'inline-block'</span>|<span class="string">'inline-table'</span>|<span class="string">'block'</span>;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  el.<span class="property">style</span>.<span class="property">display</span> = <span class="string">'none'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.3">8.3</a> <a name="8.3"></a> FadeIn &amp; FadeOut</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">fadeIn</span>(<span class="number">3000</span>);</span><br><span class="line">$el.<span class="title function_">fadeOut</span>(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">'opacity 3s'</span>;</span><br><span class="line"><span class="comment">// fadeIn</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">'1'</span>;</span><br><span class="line"><span class="comment">// fadeOut</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">'0'</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.4">8.4</a> <a name="8.4"></a> FadeTo</p>
<p>调整元素透明度。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">fadeTo</span>(<span class="string">'slow'</span>,<span class="number">0.15</span>);</span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">'opacity 3s'</span>; <span class="comment">// 假设 'slow' 等于 3 秒</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">'0.15'</span>;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.5">8.5</a> <a name="8.5"></a> FadeToggle</p>
<p>动画调整透明度用来显示或隐藏。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">fadeToggle</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">'opacity 3s'</span>;</span><br><span class="line"><span class="keyword">const</span> { opacity } = el.<span class="property">ownerDocument</span>.<span class="property">defaultView</span>.<span class="title function_">getComputedStyle</span>(el, <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">if</span> (opacity === <span class="string">'1'</span>) {</span><br><span class="line">  el.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">'0'</span>;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  el.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">'1'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.6">8.6</a> <a name="8.6"></a> SlideUp &amp; SlideDown</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">slideUp</span>();</span><br><span class="line">$el.<span class="title function_">slideDown</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">const</span> originHeight = <span class="string">'100px'</span>;</span><br><span class="line">el.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">'height 3s'</span>;</span><br><span class="line"><span class="comment">// slideUp</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">height</span> = <span class="string">'0px'</span>;</span><br><span class="line"><span class="comment">// slideDown</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">height</span> = originHeight;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.7">8.7</a> <a name="8.7"></a> SlideToggle</p>
<p>滑动切换显示或隐藏。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">slideToggle</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line"><span class="keyword">const</span> originHeight = <span class="string">'100px'</span>;</span><br><span class="line">el.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">'height 3s'</span>;</span><br><span class="line"><span class="keyword">const</span> { height } = el.<span class="property">ownerDocument</span>.<span class="property">defaultView</span>.<span class="title function_">getComputedStyle</span>(el, <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">parseInt</span>(height, <span class="number">10</span>) === <span class="number">0</span>) {</span><br><span class="line">  el.<span class="property">style</span>.<span class="property">height</span> = originHeight;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span> {</span><br><span class="line"> el.<span class="property">style</span>.<span class="property">height</span> = <span class="string">'0px'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><a href="#8.8">8.8</a> <a name="8.8"></a> Animate</p>
<p>执行一系列 CSS 属性动画。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$el.<span class="title function_">animate</span>({ params }, speed);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native</span></span><br><span class="line">el.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">'all '</span> + speed;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(params).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span></span><br><span class="line">  el.<span class="property">style</span>[key] = params[key];</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 回到顶部</a></strong></p>
<h2 id="Alternatives"><a href="#Alternatives" class="headerlink" title="Alternatives"></a>Alternatives</h2><ul>
<li><a class="link" href="http://youmightnotneedjquery.com/">你可能不需要 jQuery (You Might Not Need jQuery)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> - 如何使用原生 JavaScript 实现通用事件，元素，ajax 等用法。</li>
<li><a class="link" href="http://github.com/npm-dom">npm-dom<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 以及 <a class="link" href="http://github.com/webmodules">webmodules<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> - 在 NPM 上提供独立 DOM 模块的组织</li>
</ul>
<h2 id="Browser-Support"><a href="#Browser-Support" class="headerlink" title="Browser Support"></a>Browser Support</h2><table>
<thead>
<tr>
<th><img lazyload="" src="/images/loading.svg" data-src="https://raw.github.com/alrra/browser-logos/master/src/chrome/chrome_48x48.png" alt="Chrome"></th>
<th><img lazyload="" src="/images/loading.svg" data-src="https://raw.github.com/alrra/browser-logos/master/src/firefox/firefox_48x48.png" alt="Firefox"></th>
<th><img lazyload="" src="/images/loading.svg" data-src="https://raw.github.com/alrra/browser-logos/master/src/archive/internet-explorer_9-11/internet-explorer_9-11_48x48.png" alt="IE"></th>
<th><img lazyload="" src="/images/loading.svg" data-src="https://raw.github.com/alrra/browser-logos/master/src/opera/opera_48x48.png" alt="Opera"></th>
<th><img lazyload="" src="/images/loading.svg" data-src="https://raw.github.com/alrra/browser-logos/master/src/safari/safari_48x48.png" alt="Safari"></th>
</tr>
</thead>
<tbody><tr>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>10+ ✔</td>
<td>Latest ✔</td>
<td>6.1+ ✔</td>
</tr>
</tbody></table>
]]></content>
      <tags>
        <tag>js</tag>
        <tag>html</tag>
      </tags>
  </entry>
  <entry>
    <title>双网口飞牛 NAS 设置二级路由</title>
    <url>/2025/3600149751.html</url>
    <content><![CDATA[<p>手里闲置了一台工控机（装了飞牛 NAS），双网口，就想着能不能利用一下搞个旁路由给电脑，第二个网口当交换机，电脑连接第二个网口，初步方案是将两个网口都通过 docker 的 macvlan 映射给 openwrt，但是尝试后发现无论怎么修改电脑最多可以获取 DHCP 下发的 IP，但是无法上网。折腾一番后放弃第二个网口当交换机，直接第二网口接我电脑，当我电脑的主路由，并配置 <code>DMZ</code> 模式，全部请求都转发到我电脑</p>
<span id="more"></span>
<p><a class="link" href="https://zhwebsite.com/2024/01/28/%E5%9F%BA%E4%BA%8Edebian-12%EF%BC%8C%E5%88%A9%E7%94%A8docker%E7%9A%84openwrt%E6%90%AD%E5%BB%BA/">https://zhwebsite.com/2024/01/28/%E5%9F%BA%E4%BA%8Edebian-12%EF%BC%8C%E5%88%A9%E7%94%A8docker%E7%9A%84openwrt%E6%90%AD%E5%BB%BA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><p>查看当前 IP <code>ip a</code></p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">gwj@nas:~$ ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:e8:4c:69:1b:44 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.20.0.60/16 brd 10.20.255.255 scope global dynamic noprefixroute enp1s0</span><br><span class="line">       valid_lft 83427sec preferred_lft 83427sec</span><br><span class="line">3: enp2s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:e8:4c:69:1b:45 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::af03:82d3:bd66:1c89/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: tailscale0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1280 qdisc pfifo_fast state UNKNOWN group default qlen 500</span><br><span class="line">    link/none</span><br><span class="line">    inet 100.64.0.6/32 scope global tailscale0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fd7a:115c:a1e0::601:e449/128 scope global</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::267f:ca1c:f8d5:975b/64 scope link stable-privacy</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:69:a6:f4:57 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="开启网卡混杂模式"><a href="#开启网卡混杂模式" class="headerlink" title="开启网卡混杂模式"></a>开启网卡混杂模式</h3><p>给这俩网口开启网卡混杂模式</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ip link set enp1s0 promisc on</span><br><span class="line">ip link set enp2s0 promisc on</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="docker-配置"><a href="#docker-配置" class="headerlink" title="docker 配置"></a>docker 配置</h2><p>这里 openwrt 使用的是 <code>zzsrv/openwrt</code> 这个镜像，功能较为精简，且仍在更新 <a class="link" href="https://github.com/zzsrv/OpenWrt-Docker">基于 ImmortalWrt OpenWrt-24.10 (每日更新)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/05/08/p3grd-ie.webp" alt="image.png"></p>
<p><code>openwrt</code> <code>docker-compose.yml</code> 配置如下</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">openwrt:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zzsrv/openwrt:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">openwrt</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">macwan:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">10.20</span><span class="number">.0</span><span class="number">.120</span></span><br><span class="line">      <span class="attr">maclan:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">10.30</span><span class="number">.0</span><span class="number">.124</span></span><br><span class="line">    <span class="comment">#volumes:</span></span><br><span class="line">    <span class="comment">#  - ./etc:/etc</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">/sbin/init</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">macwan:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">macvlan</span></span><br><span class="line">    <span class="attr">driver_opts:</span></span><br><span class="line">      <span class="attr">parent:</span> <span class="string">enp1s0</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">10.20</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">          <span class="attr">gateway:</span> <span class="number">10.20</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">maclan:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">macvlan</span></span><br><span class="line">    <span class="attr">driver_opts:</span></span><br><span class="line">      <span class="attr">parent:</span> <span class="string">enp2s0</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">10.30</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>这里可以使用 飞牛自带的 UI 启动 <code>docker compose</code>，也可以使用如下命令启动 (启动过程中断网为正常现象)</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">docker compose up -d --build --remove-orphans</span><br></pre></td></tr></tbody></table></figure></div>

<p>网上很多教程都是使用 <code>docker run</code> 运行，网卡也是使用 <code>docker network create</code> 方式去创建，不如使用 <code>docker compose</code>，所有配置均在配置文件中，方便日后调整维护</p>
<p>以上配置中 <code>enp1s0</code> 是我接上级路由的网卡记为 <code>macwan</code>，<code>enp2s0</code> 是我接电脑的网卡记为 <code>maclan</code>, 这两个的网段及 IP 随便配置，不影响后边 openwrt 使用</p>
<h2 id="配置网络接口"><a href="#配置网络接口" class="headerlink" title="配置网络接口"></a>配置网络接口</h2><p>进入 docker 修改静态 IP</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it openwrt bash</span><br><span class="line">vim /etc/config/network</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">config interface 'loopback'</span><br><span class="line"> option proto 'static'</span><br><span class="line"> option ipaddr '127.0.0.1'</span><br><span class="line"> option netmask '255.0.0.0'</span><br><span class="line"> option device 'lo'</span><br><span class="line"></span><br><span class="line">config globals 'globals'</span><br><span class="line"> option packet_steering '1'</span><br><span class="line"></span><br><span class="line">config interface 'lan'</span><br><span class="line"> option proto 'dhcp'</span><br><span class="line"> option device 'eth1'</span><br><span class="line"> option peerdns '0'</span><br><span class="line"> option delegate '0'</span><br><span class="line"> list dns '192.168.100.1'</span><br><span class="line"></span><br><span class="line">config interface 'lan1'</span><br><span class="line"> option proto 'static'</span><br><span class="line"> option device 'eth0'</span><br><span class="line"> option ipaddr '192.168.22.1'</span><br><span class="line"> option netmask '255.255.255.0'</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里配置了两个 lan，<code>lan</code> 连接上级路由，通过 DHCP 获取上级 IP，我给 <code>lan</code> 设置防火墙区域为 <code>wan</code>（对于当前 openwrt，此接口等同于连接上级的 wan），<code>lan1</code> 开启 DHCP 给笔记本，ip 段为 <code>192.168.22.0/24</code>，防火墙区域设置为 <code>lan</code>（对于当前 openwrt，此接口等同于 lan）</p>
<blockquote>
<p>上面 eth0、eth1 可能会因环境的不同而改变，建议先使用 <code>ip a</code> 查看 <code>10.20.0.120</code>(上面 docker compose 配置的地址) 绑定的是哪个网口，这个就是 <code>lan</code></p>
</blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/05/08/oqkeu-nu.webp" alt="接口展示"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/05/08/rdkta-67.webp" alt="防火墙配置"></p>
<h3 id="重启网络"><a href="#重启网络" class="headerlink" title="重启网络"></a>重启网络</h3><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></tbody></table></figure></div>

<p>电脑插到工控机的空闲网口上，查看是否已经获取到 IP，访问 <code>192.168.22.1</code> 访问后台，调整其他配置（openclash 等）</p>
<h2 id="固化配置"><a href="#固化配置" class="headerlink" title="固化配置"></a>固化配置</h2><p>为了防止每次新建 docker 都会导致配置丢失，在第一次配置成功后需要拷贝配置文件到 docker 外，并修改 <code>docker-compose.yml</code></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">gwj@nas:~$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                  COMMAND        CREATED        STATUS             PORTS     NAMES</span><br><span class="line">9a0e40b4bb44   zzsrv/openwrt:latest   <span class="string">"/sbin/init"</span>   45 hours ago   Up About an hour             openwrt</span><br></pre></td></tr></tbody></table></figure></div>

<p>打开 <code>docker-compose.yml</code> 所在目录，复制 <code>/etc</code> 到当前目录</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用上边命令的docker id</span></span><br><span class="line">docker <span class="built_in">cp</span> 9a0e40b4bb44:/etc .</span><br></pre></td></tr></tbody></table></figure></div>

<p>取消上面 docker-compose.yml 的注释部分</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./etc:/etc</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>修改后需要重新构建 docker</p>
<h2 id="开启端口转发（DMZ）"><a href="#开启端口转发（DMZ）" class="headerlink" title="开启端口转发（DMZ）"></a>开启端口转发（DMZ）</h2><p>网络 — 防火墙 — 端口转发<br><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/05/08/otlwc-yx.webp" alt="image.png"></p>
<h2 id="启动后自动开启网卡混杂"><a href="#启动后自动开启网卡混杂" class="headerlink" title="启动后自动开启网卡混杂"></a>启动后自动开启网卡混杂</h2><p>由于每次启动系统后网卡混杂模式都会失效，设置启动后自动开启混杂模式<br>参考 <a class="link" href="https://u.sb/debian-rc-local/">Debian 12 解决 /etc/rc.local 开机启动问题<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>由于某些软件并没有增加开启启动的服务，很多时候需要手工添加，一般我们都是推荐使用 systemd 写个系统服务，但是对于一些简单的脚本或者懒人来说，添加命令到 /etc/rc.local 文件更方便，但是自从 Debian 9 开始，Debian 默认不带 /etc/rc.local 文件，而 rc.local 服务却还是自带的：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">gwj@nas:~$ <span class="built_in">cat</span> /lib/systemd/system/rc-local.service</span><br><span class="line"><span class="comment">#  SPDX-License-Identifier: LGPL-2.1-or-later</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This unit gets pulled automatically into multi-user.target by</span></span><br><span class="line"><span class="comment"># systemd-rc-local-generator if /etc/rc.local is executable.</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=/etc/rc.local Compatibility</span><br><span class="line">Documentation=man:systemd-rc-local-generator(8)</span><br><span class="line">ConditionFileIsExecutable=/etc/rc.local</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RemainAfterExit=<span class="built_in">yes</span></span><br><span class="line">GuessMainPID=no</span><br></pre></td></tr></tbody></table></figure></div>

<p>并且默认情况下这个服务还是关闭的状态：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">gwj@nas:~$ systemctl status rc-local</span><br><span class="line">● rc-local.service - /etc/rc.local Compatibility</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/rc-local.service; static)</span><br><span class="line">    Drop-In: /usr/lib/systemd/system/rc-local.service.d</span><br><span class="line">             └─debian.conf</span><br><span class="line">     Active: inactive (dead)</span><br><span class="line">       Docs: man:systemd-rc-local-generator(8)</span><br></pre></td></tr></tbody></table></figure></div>

<p>为了解决这个问题，我们需要手工添加一个 /etc/rc.local 文件：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/rc.local</span></span><br><span class="line"><span class="string">#!/bin/sh -e</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># rc.local</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># This script is executed at the end of each multiuser runlevel.</span></span><br><span class="line"><span class="string"># Make sure that the script will "exit 0" on success or any other</span></span><br><span class="line"><span class="string"># value on error.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># In order to enable or disable this script just change the execution</span></span><br><span class="line"><span class="string"># bits.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># By default this script does nothing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ip link set enp1s0 promisc on</span></span><br><span class="line"><span class="string">ip link set enp2s0 promisc on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">exit 0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>然后赋予权限：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /etc/rc.local</span><br></pre></td></tr></tbody></table></figure></div>

<p>接着启动 rc-local 服务：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> --now rc-local</span><br></pre></td></tr></tbody></table></figure></div>

<p>此时可能会弹出警告：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">The unit files have no installation config (WantedBy=, RequiredBy=, Also=,</span><br><span class="line">Alias= settings <span class="keyword">in</span> the [Install] section, and DefaultInstance= <span class="keyword">for</span> template</span><br><span class="line">units). This means they are not meant to be enabled using systemctl.</span><br><span class="line"> </span><br><span class="line">Possible reasons <span class="keyword">for</span> having this kind of units are:</span><br><span class="line">• A unit may be statically enabled by being symlinked from another unit<span class="string">'s</span></span><br><span class="line"><span class="string">  .wants/ or .requires/ directory.</span></span><br><span class="line"><span class="string">• A unit'</span>s purpose may be to act as a helper <span class="keyword">for</span> some other unit <span class="built_in">which</span> has</span><br><span class="line">  a requirement dependency on it.</span><br><span class="line">• A unit may be started when needed via activation (socket, path, timer,</span><br><span class="line">  D-Bus, udev, scripted systemctl call, ...).</span><br><span class="line">• In <span class="keyword">case</span> of template units, the unit is meant to be enabled with some</span><br><span class="line">  instance name specified.</span><br></pre></td></tr></tbody></table></figure></div>

<p>无视警告，因为这个服务没有任何依赖的系统服务，只是开机启动 <code>/etc/rc.local</code> 脚本而已。</p>
<p>再次查看状态：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">gwj@nas:~$ systemctl status rc-local.service </span><br><span class="line">● rc-local.service - /etc/rc.local Compatibility</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/rc-local.service; enabled-runtime; vendor preset: enabled)</span><br><span class="line">    Drop-In: /usr/lib/systemd/system/rc-local.service.d</span><br><span class="line">             └─debian.conf</span><br><span class="line">     Active: active (exited) since Thu 2022-01-27 18:52:43 UTC; 10s ago</span><br><span class="line">       Docs: man:systemd-rc-local-generator(8)</span><br><span class="line">    Process: 541 ExecStart=/etc/rc.local start (code=exited, status=0/SUCCESS)</span><br><span class="line">        CPU: 3ms</span><br><span class="line"></span><br><span class="line">Jan 27 18:52:43 debian systemd[1]: Starting /etc/rc.local Compatibility...</span><br><span class="line">Jan 27 18:52:43 debian systemd[1]: Started /etc/rc.local Compatibility.</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>openwrt</tag>
      </tags>
  </entry>
  <entry>
    <title>在此的第一篇博客 —— 学习总结</title>
    <url>/2018/800985a.html</url>
    <content><![CDATA[<p>本篇文章内容陈旧，已经不支持查看</p>
<span id="more"></span>

<ul>
<li><p><code>友情提示</code>，如果度盘下载较慢推荐 <a class="link" href="https://pandownload.com/">Pan Download<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
<li><p>手机端推荐使用　山寨云</p>
<p>本篇介绍一些曾经做的项目和学习书籍</p>
</li>
</ul>
<h1 id="c-c"><a href="#c-c" class="headerlink" title="c/c++"></a>c/c++</h1><div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cout&lt;&lt;<span class="string">"hello friend"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="PDF"><a href="#PDF" class="headerlink" title="PDF"></a>PDF</h5><p>c++ Primer Plus 第六版中文版 - 密码 xd49 <a class="link" href="https://pan.baidu.com/s/15gp-WD18Ya8u-AISkdwFCA">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>c++ 编程思想 <a class="link" href="http://www.tbox.fun/study/#">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<blockquote>
<ul>
<li><input disabled="" type="checkbox"> 扩展<br>Windows 程序设计（第五版珍藏版）<a class="link" href="http://www.tbox.fun/study/#">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>c++ 基础知识及 MFC <img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/c%2B%2B%20ppt%20%E8%AF%BE%E4%BB%B6.PNG" alt="image"><br><a class="link" href="http://www.tbox.fun/study/#">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><input disabled="" type="checkbox"> opencv 图形库</li>
</ul>
</blockquote>
<h5 id="video"><a href="#video" class="headerlink" title="video"></a>video</h5><p>智播客 c++ （未观看） <a class="link" href="http://www.tbox.fun/study/#">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>雷霆战机 <a class="link" href="http://www.tbox.fun/study/#">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>拼图 <a class="link" href="http://www.tbox.fun/study/#">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="完成的项目"><a href="#完成的项目" class="headerlink" title="完成的项目"></a>完成的项目</h5><ul>
<li>项目 打字游戏<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E6%89%93%E5%AD%97.jpeg" alt="image"><br><a class="link" href="https://blog.csdn.net/tsvico/article/details/76697027">源码地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li>项目 贪吃蛇<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E8%B4%AA%E5%90%83%E8%9B%87.jpg" alt="image"><br><a class="link" href="https://github.com/tsvico/Retro-Snaker">源码地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li>Win32 飞机大战<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/flyplay.jpeg" alt="image"><br><a class="link" href="https://blog.csdn.net/tsvico/article/details/78077440">源码地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li>打砖块<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E6%89%93%E7%A0%96%E5%9D%97.jpeg" alt="image"><br><a class="link" href="https://blog.csdn.net/tsvico/article/details/78248380">源码地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li>学生点名系统<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E7%82%B9%E5%90%8D.jpg" alt="image"><br>源码地址 未上传</li>
<li>坦克大战 同上</li>
<li>推箱子<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E6%8E%A8%E7%AE%B1%E5%AD%90%E5%9B%BE%E5%BD%A2.jpg" alt="image"><br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E6%8E%A8%E7%AE%B1%E5%AD%902.jpg" alt="image"></li>
<li>五子棋 （核心功能未实现）<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/%E4%BA%94%E5%AD%90%E6%A3%8B.jpg" alt="image"><br>源码地址</li>
</ul>
<h5 id="手机编程"><a href="#手机编程" class="headerlink" title="手机编程"></a>手机编程</h5><p>C4droid、终端</p>
<h5 id="推荐工具"><a href="#推荐工具" class="headerlink" title="推荐工具"></a>推荐工具</h5><p>vc6、vs2012+</p>
<h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><blockquote>
<h5 id="学习网站"><a href="#学习网站" class="headerlink" title="学习网站"></a>学习网站</h5><p>how2j （建议注册）<a class="link" href="http://ttvip.top/">点击访问<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h5 id="video-1"><a href="#video-1" class="headerlink" title="video"></a>video</h5><p>智播客 27 天 Java 入门 <a class="link" href="http://www.tbox.fun/study/#">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="推荐-IDE"><a href="#推荐-IDE" class="headerlink" title="推荐 IDE"></a>推荐 IDE</h5><p>eclipse、IntelliJ IDEA（<del>破解服务器 <a class="link" href="http://idea.ttvip.top:1027/">http://idea.ttvip.top:1027<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></del>）</p>
<p>IDEA 已入正（学生认证），破解服务器已经关闭</p>
<h5 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h5><p>作者学习时间尚短，还没写过<br>他山之石：Java 计算器 <a class="link" href="http://www.tbox.fun/study/#">点击下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h1 id="JavaWeb"><a href="#JavaWeb" class="headerlink" title="JavaWeb"></a>JavaWeb</h1><p>学习中</p>
<hr>
<h1 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h1><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> echo "hello 朋友！";</span><br><span class="line"> //最好有HTML基础</span><br><span class="line"> ?&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="PDF-1"><a href="#PDF-1" class="headerlink" title="PDF"></a>PDF</h5><p>无（推荐网易云课堂视频）</p>
<h5 id="新手推荐程序"><a href="#新手推荐程序" class="headerlink" title="新手推荐程序"></a>新手推荐程序</h5><p>phpstudy</p>
<h5 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h5><p>thinkphp 框架</p>
<p>禅道框架（企业项目管理）</p>
<h5 id="项目-1"><a href="#项目-1" class="headerlink" title="项目"></a>项目</h5><ul>
<li>注册登录系统（防注入、密码三重加密、防止 sql 注入）</li>
<li>小米论坛自动签到</li>
<li> ip 获取</li>
<li>动态课程表</li>
</ul>
<hr>
<blockquote>
<h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1></blockquote>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"hello friend"</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="学习网站-1"><a href="#学习网站-1" class="headerlink" title="学习网站"></a>学习网站</h5><p><a class="link" href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000">廖雪峰老师相关课程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="相关项目-亲手实践并整理）"><a href="#相关项目-亲手实践并整理）" class="headerlink" title="相关项目 (亲手实践并整理）"></a>相关项目 (亲手实践并整理）</h5><ul>
<li>网站模拟登陆</li>
<li> Cookie 保存</li>
<li> Beautiful Soup 解析 HTML 数据</li>
<li>爬虫抓取妹子图</li>
<li>爬虫抓取表情包</li>
<li>多线程抓取表情包</li>
<li>以上项目源码 <a class="link" href="https://github.com/tsvico/python_Reptilian">点击访问<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<hr>
<h1 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h1><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">"你好 朋友"</span>,Toast.LENGTH_SHORT).show();</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="PDF-2"><a href="#PDF-2" class="headerlink" title="PDF"></a>PDF</h5><ul>
<li>第一行代码 Android 第二版 <a class="link" href="https://pan.lanzou.com/i0dmzfa">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li>Android 进阶：艺术探索（我还没看）<a class="link" href="https://pan.baidu.com/s/1hrE9sY4">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<h5 id="video-2"><a href="#video-2" class="headerlink" title="video"></a>video</h5><p><a class="link" href="https://pan.baidu.com/s/1kU792sR">黑马教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="实践项目"><a href="#实践项目" class="headerlink" title="实践项目"></a>实践项目</h5><p>存音 APP <a class="link" href="https://www.coolapk.com/apk/179796">下载试用<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="IDE"><a href="#IDE" class="headerlink" title="IDE"></a>IDE</h5><p>android studio<br>手机编程尝试 aide</p>
<hr>
<h1 id="Qt-UI"><a href="#Qt-UI" class="headerlink" title="Qt/UI"></a>Qt/UI</h1><ul>
<li>初学</li>
</ul>
<h5 id="PDF-3"><a href="#PDF-3" class="headerlink" title="PDF"></a>PDF</h5><p>Qt 教程及软件 (超级浅显易懂_非常适合初学者) <a class="link" href="http://www.tbox.fun/study/#">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="项目-2"><a href="#项目-2" class="headerlink" title="项目"></a>项目</h5><ul>
<li>人脸识别<br>基于 c++、seetaface 引擎、qt 绘制 UI<br><img lazyload="" src="/images/loading.svg" data-src="http://updata-1253372089.cossh.myqcloud.com/image/faceid.png" alt="image"></li>
</ul>
<h1 id="黑客资源"><a href="#黑客资源" class="headerlink" title="黑客资源"></a>黑客资源</h1><blockquote>
<p>友情提示，仅供学习交流，请勿进行违法活动</p>
<p><a class="link" href="https://pan.baidu.com/s/1eWwJVaVopSwkYVosr0X5xQ">中国黑客组织网站入侵系列教程 - 密码 y8wd<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://pan.baidu.com/s/1KgcqGAMDmS1J7wOBITTWuw">中国红盟学生组专用工具包 5.0 - 密码 6yps<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://pan.baidu.com/s/1kzn9d7qYua9Ta6Um_tJe4g">红盟学生组专用工具 6.0 - 密码 mety<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://pan.baidu.com/s/1gUFclVsmmG16yxhp-o8aOA">四款远控工具（不免杀）- 密码 yzqw<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://pan.baidu.com/s/1YUdwygvV0X6F99PkCp_EWw">渗透、免杀、抓鸡、挂马系列教程 - 密码 7bs6<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
]]></content>
      <tags>
        <tag>java</tag>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>增加文章时效性检测及更新时间修复</title>
    <url>/2024/1160155932.html</url>
    <content><![CDATA[<p>近期查看历史文章时，发现有篇文章是 2018 年写的关于百度云网盘的，现在看来应该是已经失效了，如果增加时效性提示应该会更好一些，于是有了这篇文章</p>
<span id="more"></span>

<h2 id="添加时效性检测-js"><a href="#添加时效性检测-js" class="headerlink" title="添加时效性检测 js"></a>添加时效性检测 js</h2><h3 id="添加注入器"><a href="#添加注入器" class="headerlink" title="添加注入器"></a>添加注入器</h3><p>Hexo 提供了 <a class="link" href="https://hexo.io/zh-cn/api/injector">注入器（Injector）<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，可以将指定的静态代码片段注入到生成的静态页面中。</p>
<p>参考网上的文章，在根目录创建 <code>scripts</code> 文件夹，并创建 <code>injector.js</code> 文件，并添加如下代码</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//注入文章过期提示</span></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">injector</span>.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">"body_end"</span>,</span><br><span class="line">  <span class="string">`&lt;script src="/js/outdate.js"&gt;&lt;/script&gt;`</span>,</span><br><span class="line">  <span class="string">"post"</span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>body_end 代表注入到文章开头。<br>由于注入的代码有点长，我们就用一个 Javascript 文件单独处理，作为注入的代码片段引入<br>-post 代表只注入到文章详情页面中。</li>
</ul>
<h3 id="添加静态代码片段"><a href="#添加静态代码片段" class="headerlink" title="添加静态代码片段"></a>添加静态代码片段</h3><p>在 Hexo 的 source 目录下新建 js 文件夹，新建一个名为 outdate.js 的文件，添加以下代码：</p>
<div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">  <span class="comment">//不同的日期显示不同的样式，200 天为黄色提示，400天为红色提示，可以自己定义。</span></span><br><span class="line">  <span class="keyword">let</span> warningDay = <span class="number">200</span>;</span><br><span class="line">  <span class="keyword">let</span> errorDay = <span class="number">400</span>;</span><br><span class="line">  <span class="comment">// 确保能够获取到文章时间以及在文章详情页</span></span><br><span class="line">  <span class="keyword">let</span> times = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">"time"</span>);</span><br><span class="line">  <span class="keyword">if</span> (times.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">let</span> posts = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">"post-body"</span>);</span><br><span class="line">  <span class="keyword">if</span> (posts.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> updateTime = times[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">const</span> createTime = times[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取系统当前的时间</span></span><br><span class="line">  <span class="keyword">let</span> pubTime = <span class="keyword">new</span> <span class="title class_">Date</span>(</span><br><span class="line">    updateTime ? updateTime.<span class="property">dateTime</span> : createTime.<span class="property">dateTime</span></span><br><span class="line">  ); <span class="comment">/* 文章更新时间戳 */</span></span><br><span class="line">  <span class="keyword">let</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>(); <span class="comment">/* 当前时间戳 */</span></span><br><span class="line">  <span class="keyword">let</span> interval = <span class="built_in">parseInt</span>(now - pubTime);</span><br><span class="line">  <span class="keyword">let</span> days = <span class="built_in">parseInt</span>(interval / <span class="number">86400000</span>);</span><br><span class="line">  <span class="comment">/* 发布时间超过指定时间（毫秒） */</span></span><br><span class="line">  <span class="comment">//note warning 以及 note danger 是 Next 主题的自定义模板语法，如果使用其他主题，请自行更改样式以达到最佳显示效果</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    interval &gt; warningDay * <span class="number">3600</span> * <span class="number">24</span> * <span class="number">1000</span> &amp;&amp;</span><br><span class="line">    interval &lt; errorDay * <span class="number">3600</span> * <span class="number">24</span> * <span class="number">1000</span></span><br><span class="line">  ) {</span><br><span class="line">    posts[<span class="number">0</span>].<span class="property">innerHTML</span> =</span><br><span class="line">      <span class="string">'&lt;div class="note warning"&gt;'</span> +</span><br><span class="line">      <span class="string">"&lt;h5&gt;文章时效性提示&lt;/h5&gt;&lt;p&gt;这篇文章最后更新于 "</span> +</span><br><span class="line">      days +</span><br><span class="line">      <span class="string">" 天前，部分信息可能已发生改变，请注意甄别。&lt;/p&gt;"</span> +</span><br><span class="line">      <span class="string">"&lt;/div&gt;"</span> +</span><br><span class="line">      posts[<span class="number">0</span>].<span class="property">innerHTML</span>;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (interval &gt;= errorDay * <span class="number">3600</span> * <span class="number">24</span> * <span class="number">1000</span>) {</span><br><span class="line">    posts[<span class="number">0</span>].<span class="property">innerHTML</span> =</span><br><span class="line">      <span class="string">'&lt;div class="note danger"&gt;'</span> +</span><br><span class="line">      <span class="string">"&lt;h5&gt;文章时效性提示&lt;/h5&gt;&lt;p&gt;这篇文章最后更新于 "</span> +</span><br><span class="line">      days +</span><br><span class="line">      <span class="string">" 天前，部分信息可能已发生改变，请注意甄别。&lt;/p&gt;"</span> +</span><br><span class="line">      <span class="string">"&lt;/div&gt;"</span> +</span><br><span class="line">      posts[<span class="number">0</span>].<span class="property">innerHTML</span>;</span><br><span class="line">  }</span><br><span class="line">})();</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里在原文基础上调整了代码，优先获取文章更新日期，其次是文章创建日期，此时我们的旧文章就有了时效性提示了</p>
<h2 id="确保文章时间正确"><a href="#确保文章时间正确" class="headerlink" title="确保文章时间正确"></a>确保文章时间正确</h2><p>时效性提示是有了，但是怎么保证文章日期的正确性呢，我们是用 git 管理的文章，可以采用 git 更新日期来解决这一问题</p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>在 CI checkout 代码时，使用文件最后一次涉及的 commit 时间作为文件的修改时间，进行 mtime 的恢复。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/action.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">  <span class="comment"># 如果使用的是GithubAction的actions/checkout，记得加上下面的内容，对仓库历史进行完整的签出</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># 恢复文件修改时间</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restore</span> <span class="string">file</span> <span class="string">modification</span> <span class="string">time</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">find</span> <span class="string">source/_posts</span> <span class="string">-name</span> <span class="string">'*.md'</span> <span class="string">|</span> <span class="string">while</span> <span class="string">read</span> <span class="string">file;</span> <span class="string">do</span> <span class="string">touch</span> <span class="string">-d</span> <span class="string">"$(git log -1 --pretty="</span><span class="string">@%ct"</span> <span class="string">--</span> <span class="string">$file)"</span> <span class="string">$file;</span> <span class="string">done</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h3><div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出需要恢复修改时间的文件</span></span><br><span class="line">find source/_posts -name '*.md'</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">循环</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 git <span class="built_in">log</span> -- <span class="variable">$file</span> 得到该文件最后修改的commit 并且使用pretty选项获取时间戳</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="built_in">touch</span> -d 来将文件的atime以及mtime修改为commit的时间戳</span></span><br><span class="line">while read file; do touch -d "$(git log -1 --pretty="@%ct" -- $file)" $file; done</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a class="link" href="https://qianfanguojin.top/2022/09/07/Hexo%E5%8D%9A%E5%AE%A2%E8%BF%9B%E9%98%B6%EF%BC%9A%E4%B8%BA-Next-%E4%B8%BB%E9%A2%98%E7%9A%84-Hexo-%E5%8D%9A%E5%AE%A2%E5%86%85%E5%AE%B9%E6%B7%BB%E5%8A%A0%E6%96%87%E7%AB%A0%E8%BF%87%E6%9C%9F-%E6%97%B6%E6%95%88%E6%8F%90%E7%A4%BA/">Hexo 博客进阶：为 Next 主题的 Hexo 博客内容添加文章过期 / 时效提示<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://blog.csdn.net/sinat_34930640/article/details/124089320">修复 gitCI 中文件的创建时间与修改时间<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>套壳 webview</title>
    <url>/2018/b59da4ac.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ul>
<li>现在很多 <code>App</code> 里都内置了 Web 网页（<code>Hybrid App</code>），比如说很多电商平台，淘宝、京东、聚划算等等，</li>
<li>那么这种该如何实现呢？其实这是 <code>Android</code> 里一个叫 <code>WebView</code> 组件实现</li>
<li>今天，我将献上一份全面介绍 <code>WebView</code> 的常见用法。</li>
</ul>
<p>转载自 <a class="link" href="https://www.jianshu.com/p/3c94ae673e2a">https://www.jianshu.com/p/3c94ae673e2a<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<span id="more"></span>

<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1ah2qb-h8.webp" alt="image.png"></p>
<h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p><code>WebView</code> 是一个基于 <code>webkit</code> 引擎、展现 <code>web</code> 页面的控件。</p>
<blockquote>
<p>Android 的 Webview 在低版本和高版本采用了不同的 webkit 版本内核，4.4 后直接使用了 Chrome。</p>
</blockquote>
<h3 id="2-作用"><a href="#2-作用" class="headerlink" title="2.作用"></a>2. 作用</h3><ul>
<li>显示和渲染 Web 页面</li>
<li>直接使用 html 文件（网络上或本地 assets 中）作布局</li>
<li>可和 JavaScript 交互调用</li>
</ul>
<blockquote>
<p>WebView 控件功能强大，除了具有一般 View 的属性和设置外，还可以对 url 请求、页面加载、渲染、页面交互进行强大的处理。</p>
</blockquote>
<h3 id="3-使用介绍"><a href="#3-使用介绍" class="headerlink" title="3. 使用介绍"></a>3. 使用介绍</h3><h4 id="3-1-Webview-常用方法"><a href="#3-1-Webview-常用方法" class="headerlink" title="3.1 Webview 常用方法"></a>3.1 Webview 常用方法</h4><h5 id="3-1-1-加载-URL"><a href="#3-1-1-加载-URL" class="headerlink" title="3.1.1 加载 URL"></a>3.1.1 加载 URL</h5><p>加载方式根据资源分为三种</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//方式1. 加载一个网页：</span></span><br><span class="line">  webView.loadUrl(<span class="string">"http://www.google.com/"</span>);</span><br><span class="line">  <span class="comment">//方式2：加载apk包中的html页面</span></span><br><span class="line">  webView.loadUrl(<span class="string">"file:///android_asset/test.html"</span>);</span><br><span class="line">  <span class="comment">//方式3：加载手机本地的html页面</span></span><br><span class="line">   webView.loadUrl(<span class="string">"content://com.android.htmlfileprovider/sdcard/test.html"</span>);</span><br><span class="line"> <span class="comment">// 方式4： 加载 HTML 页面的一小段内容</span></span><br><span class="line">  WebView.loadData(String data, String mimeType, String encoding)</span><br><span class="line"><span class="comment">// 参数说明：</span></span><br><span class="line"><span class="comment">// 参数1：需要截取展示的内容</span></span><br><span class="line"><span class="comment">// 内容里不能出现 ’#’, ‘%’, ‘\’ , ‘?’ 这四个字符，若出现了需用 %23, %25, %27, %3f 对应来替代，否则会出现异常</span></span><br><span class="line"><span class="comment">// 参数2：展示内容的类型</span></span><br><span class="line"><span class="comment">// 参数3：字节码</span></span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="3-1-2-Webview-的状态"><a href="#3-1-2-Webview-的状态" class="headerlink" title="3.1.2 Webview 的状态"></a>3.1.2 Webview 的状态</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//激活WebView为活跃状态，能正常执行网页的响应</span></span><br><span class="line">webView.onResume() ；</span><br><span class="line"></span><br><span class="line"><span class="comment">//当页面被失去焦点被切换到后台不可见状态，需要执行onPause</span></span><br><span class="line"><span class="comment">//通过onPause动作通知内核暂停所有的动作，比如DOM的解析、plugin的执行、JavaScript执行。</span></span><br><span class="line">webView.onPause()；</span><br><span class="line"></span><br><span class="line"><span class="comment">//当应用程序(存在webview)被切换到后台时，这个方法不仅仅针对当前的webview而是全局的全应用程序的webview</span></span><br><span class="line"><span class="comment">//它会暂停所有webview的layout，parsing，javascripttimer。降低CPU功耗。</span></span><br><span class="line">webView.pauseTimers()</span><br><span class="line"><span class="comment">//恢复pauseTimers状态</span></span><br><span class="line">webView.resumeTimers()；</span><br><span class="line"></span><br><span class="line"><span class="comment">//销毁Webview</span></span><br><span class="line"><span class="comment">//在关闭了Activity时，如果Webview的音乐或视频，还在播放。就必须销毁Webview</span></span><br><span class="line"><span class="comment">//但是注意：webview调用destory时,webview仍绑定在Activity上</span></span><br><span class="line"><span class="comment">//这是由于自定义webview构建时传入了该Activity的context对象</span></span><br><span class="line"><span class="comment">//因此需要先从父容器中移除webview,然后再销毁webview:</span></span><br><span class="line">rootLayout.removeView(webView);</span><br><span class="line">webView.destroy();</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="3-1-3-关于前进-后退网页"><a href="#3-1-3-关于前进-后退网页" class="headerlink" title="3.1.3 关于前进/后退网页"></a>3.1.3 关于前进 / 后退网页</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//是否可以后退</span></span><br><span class="line">Webview.canGoBack()</span><br><span class="line"><span class="comment">//后退网页</span></span><br><span class="line">Webview.goBack()</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否可以前进</span></span><br><span class="line">Webview.canGoForward()</span><br><span class="line"><span class="comment">//前进网页</span></span><br><span class="line">Webview.goForward()</span><br><span class="line"></span><br><span class="line"><span class="comment">//以当前的index为起始点前进或者后退到历史记录中指定的steps</span></span><br><span class="line"><span class="comment">//如果steps为负数则为后退，正数则为前进</span></span><br><span class="line">Webview.goBackOrForward(intsteps)</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见用法：Back 键控制网页后退</strong></p>
<ul>
<li>问题：在不做任何处理前提下 ，浏览网页时点击系统的 “Back” 键，整个 Browser 会调用 finish () 而结束自身</li>
<li>目标：点击返回后，是网页回退而不是推出浏览器</li>
<li>解决方案：在当前 Activity 中处理并消费掉该 Back 事件 </li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode, KeyEvent event)</span> {</span><br><span class="line">    <span class="keyword">if</span> ((keyCode == KEYCODE_BACK) &amp;&amp; mWebView.canGoBack()) {</span><br><span class="line">        mWebView.goBack();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onKeyDown(keyCode, event);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="3-1-4-清除缓存数据"><a href="#3-1-4-清除缓存数据" class="headerlink" title="3.1.4 清除缓存数据"></a>3.1.4 清除缓存数据</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//清除网页访问留下的缓存</span></span><br><span class="line"><span class="comment">//由于内核缓存是全局的因此这个方法不仅仅针对webview而是针对整个应用程序.</span></span><br><span class="line">Webview.clearCache(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//清除当前webview访问的历史记录</span></span><br><span class="line"><span class="comment">//只会webview访问历史记录里的所有记录除了当前访问记录</span></span><br><span class="line">Webview.clearHistory()；</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个api仅仅清除自动完成填充的表单数据，并不会清除WebView存储到本地的数据</span></span><br><span class="line">Webview.clearFormData()；</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="3-2-常用工具类"><a href="#3-2-常用工具类" class="headerlink" title="3.2 常用工具类"></a>3.2 常用工具类</h4><h5 id="3-2-1-WebSettings-类"><a href="#3-2-1-WebSettings-类" class="headerlink" title="3.2.1 WebSettings 类"></a>3.2.1 WebSettings 类</h5><ul>
<li>作用：对 WebView 进行配置和管理</li>
<li>配置步骤 &amp; 常见方法：</li>
</ul>
<p><strong>配置步骤 1：添加访问网络权限</strong>（AndroidManifest.xml）</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">&lt;uses-permission android:name="android.permission.INTERNET"/&gt;</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>配置步骤 2：生成一个 WebView 组件（有两种方式）</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//方式1：直接在在Activity中生成</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//方法2：在Activity的layout文件里添加webview控件：</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webview</span> <span class="operator">=</span> (WebView) findViewById(R.id.webView1);</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>配置步骤 3：进行配置 - 利用 WebSettings 子类</strong>（常见方法）</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//声明WebSettings子类</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> webView.getSettings();</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果访问的页面中要与Javascript交互，则webview必须设置支持Javascript</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 若加载的 html 里有JS 在执行动画等操作，会造成资源浪费（CPU、电量）</span></span><br><span class="line"><span class="comment">// 在 onStop 和 onResume 里分别把 setJavaScriptEnabled() 给设置成 false 和 true 即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//支持插件</span></span><br><span class="line">webSettings.setPluginsEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置自适应屏幕，两者合用</span></span><br><span class="line">webSettings.setUseWideViewPort(<span class="literal">true</span>); <span class="comment">//将图片调整到适合webview的大小</span></span><br><span class="line">webSettings.setLoadWithOverviewMode(<span class="literal">true</span>); <span class="comment">// 缩放至屏幕的大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//缩放操作</span></span><br><span class="line">webSettings.setSupportZoom(<span class="literal">true</span>); <span class="comment">//支持缩放，默认为true。是下面那个的前提。</span></span><br><span class="line">webSettings.setBuiltInZoomControls(<span class="literal">true</span>); <span class="comment">//设置内置的缩放控件。若为false，则该WebView不可缩放</span></span><br><span class="line">webSettings.setDisplayZoomControls(<span class="literal">false</span>); <span class="comment">//隐藏原生的缩放控件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//其他细节操作</span></span><br><span class="line">webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK); <span class="comment">//关闭webview中缓存</span></span><br><span class="line">webSettings.setAllowFileAccess(<span class="literal">true</span>); <span class="comment">//设置可以访问文件</span></span><br><span class="line">webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>); <span class="comment">//支持通过JS打开新窗口</span></span><br><span class="line">webSettings.setLoadsImagesAutomatically(<span class="literal">true</span>); <span class="comment">//支持自动加载图片</span></span><br><span class="line">webSettings.setDefaultTextEncodingName(<span class="string">"utf-8"</span>);<span class="comment">//设置编码格式</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见用法：设置 WebView 缓存</strong></p>
<ul>
<li>当加载 html 页面时，WebView 会在 /data/data/ 包名目录下生成 database 与 cache 两个文件夹</li>
<li>请求的 URL 记录保存在 WebViewCache.db，而 URL 的内容是保存在 WebViewCache 文件夹下</li>
<li>是否启用缓存：</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//优先使用缓存:</span></span><br><span class="line">WebView.getSettings().setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);</span><br><span class="line">        <span class="comment">//缓存模式如下：</span></span><br><span class="line">        <span class="comment">//LOAD_CACHE_ONLY: 不使用网络，只读取本地缓存数据</span></span><br><span class="line">        <span class="comment">//LOAD_DEFAULT: （默认）根据cache-control决定是否从网络上取数据。</span></span><br><span class="line">        <span class="comment">//LOAD_NO_CACHE: 不使用缓存，只从网络获取数据.</span></span><br><span class="line">        <span class="comment">//LOAD_CACHE_ELSE_NETWORK，只要本地有，无论是否过期，或者no-cache，都使用缓存中的数据。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//不使用缓存:</span></span><br><span class="line">WebView.getSettings().setCacheMode(WebSettings.LOAD_NO_CACHE);</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>结合使用（离线加载）</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (NetStatusUtil.isConnected(getApplicationContext())) {</span><br><span class="line">    webSettings.setCacheMode(WebSettings.LOAD_DEFAULT);<span class="comment">//根据cache-control决定是否从网络上取数据。</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);<span class="comment">//没网，则从本地获取，即离线加载</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">webSettings.setDomStorageEnabled(<span class="literal">true</span>); <span class="comment">// 开启 DOM storage API 功能</span></span><br><span class="line">webSettings.setDatabaseEnabled(<span class="literal">true</span>);   <span class="comment">//开启 database storage API 功能</span></span><br><span class="line">webSettings.setAppCacheEnabled(<span class="literal">true</span>);<span class="comment">//开启 Application Caches 功能</span></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">cacheDirPath</span> <span class="operator">=</span> getFilesDir().getAbsolutePath() + APP_CACAHE_DIRNAME;</span><br><span class="line">webSettings.setAppCachePath(cacheDirPath); <span class="comment">//设置  Application Caches 缓存目录</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>注意：</strong>&nbsp; 每个 Application 只调用一次 WebSettings.setAppCachePath ()，WebSettings.setAppCacheMaxSize ()</p>
<h5 id="3-2-2-WebViewClient-类"><a href="#3-2-2-WebViewClient-类" class="headerlink" title="3.2.2 WebViewClient 类"></a>3.2.2 WebViewClient 类</h5><ul>
<li>作用：处理各种通知 &amp; 请求事件</li>
<li>常见方法：</li>
</ul>
<p><strong>常见方法 1：shouldOverrideUrlLoading ()</strong></p>
<ul>
<li>作用：打开网页时不调用系统浏览器， 而是在本 WebView 中显示；在网页上的所有加载都经过这个方法，这个函数我们可以做很多操作。</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//步骤1. 定义Webview组件</span></span><br><span class="line"><span class="type">Webview</span> <span class="variable">webview</span> <span class="operator">=</span> (WebView) findViewById(R.id.webView1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//步骤2. 选择加载方式</span></span><br><span class="line">  <span class="comment">//方式1. 加载一个网页：</span></span><br><span class="line">  webView.loadUrl(<span class="string">"http://www.google.com/"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//方式2：加载apk包中的html页面</span></span><br><span class="line">  webView.loadUrl(<span class="string">"file:///android_asset/test.html"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//方式3：加载手机本地的html页面</span></span><br><span class="line">   webView.loadUrl(<span class="string">"content://com.android.htmlfileprovider/sdcard/test.html"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//步骤3. 复写shouldOverrideUrlLoading()方法，使得打开网页时不调用系统浏览器， 而是在本WebView中显示</span></span><br><span class="line">    webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>(){</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> {</span><br><span class="line">          view.loadUrl(url);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      }</span><br><span class="line">  });</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 2：onPageStarted ()</strong></p>
<ul>
<li>作用：开始载入页面调用的，我们可以设定一个 loading 的页面，告诉用户程序在等待网络响应。</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>(){</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> {</span><br><span class="line">        <span class="comment">//设定加载开始的操作</span></span><br><span class="line">     }</span><br><span class="line"> });</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 3：onPageFinished ()</strong></p>
<ul>
<li>作用：在页面加载结束时调用。我们可以关闭 loading 条，切换程序动作。</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>(){</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageFinished</span><span class="params">(WebView view, String url)</span> {</span><br><span class="line">        <span class="comment">//设定加载结束的操作</span></span><br><span class="line">     }</span><br><span class="line"> });</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 4：onLoadResource ()</strong></p>
<ul>
<li>作用：在加载页面资源时会调用，每一个资源（比如图片）的加载都会调用一次。</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>(){</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLoadResource</span><span class="params">(WebView view, String url)</span> {</span><br><span class="line">         <span class="comment">//设定加载资源的操作</span></span><br><span class="line">      }</span><br><span class="line">  });</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 5：onReceivedError（）</strong></p>
<ul>
<li>作用：加载页面的服务器出现错误时（如 404）调用。</li>
</ul>
<blockquote>
<p>App 里面使用 webview 控件的时候遇到了诸如 404 这类的错误的时候，若也显示浏览器里面的那种错误提示页面就显得很丑陋了，那么这个时候我们的 app 就需要加载一个本地的错误提示页面，即 webview 如何加载一个本地的页面</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//步骤1：写一个html文件（error_handle.html），用于出错时展示给用户看的提示页面</span></span><br><span class="line"><span class="comment">//步骤2：将该html文件放置到代码根目录的assets文件夹下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//步骤3：复写WebViewClient的onRecievedError方法</span></span><br><span class="line"><span class="comment">//该方法传回了错误码，根据错误类型可以进行不同的错误分类处理</span></span><br><span class="line">    webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>(){</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedError</span><span class="params">(WebView view, <span class="type">int</span> errorCode, String description, String failingUrl)</span>{</span><br><span class="line"><span class="keyword">switch</span>(errorCode)</span><br><span class="line">                {</span><br><span class="line">                <span class="keyword">case</span> HttpStatus.SC_NOT_FOUND:</span><br><span class="line">                    view.loadUrl(<span class="string">"file:///android_assets/error_handle.html"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 6：onReceivedSslError ()</strong></p>
<ul>
<li>作用：处理 https 请求</li>
</ul>
<blockquote>
<p>webView 默认是不处理 https 请求的，页面显示空白，需要进行如下设置：</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() {</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedSslError</span><span class="params">(WebView view, SslErrorHandler handler, SslError error)</span> {</span><br><span class="line">           handler.proceed();    <span class="comment">//表示等待证书响应</span></span><br><span class="line">       <span class="comment">// handler.cancel();      //表示挂起连接，为默认方式</span></span><br><span class="line">       <span class="comment">// handler.handleMessage(null);    //可做其他处理</span></span><br><span class="line">       }</span><br><span class="line">   });</span><br><span class="line"></span><br><span class="line"><span class="comment">// 特别注意：5.1以上默认禁止了https和http混用，以下方式是开启</span></span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span><br><span class="line">mWebView.getSettings().setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="3-2-3-WebChromeClient-类"><a href="#3-2-3-WebChromeClient-类" class="headerlink" title="3.2.3 WebChromeClient 类"></a>3.2.3 WebChromeClient 类</h5><ul>
<li>作用：辅助 WebView 处理 Javascript 的对话框，网站图标，网站标题等等。</li>
<li>常见使用：</li>
</ul>
<p><strong>常见方法 1： onProgressChanged（）</strong></p>
<ul>
<li>作用：获得网页的加载进度并显示 </li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>(){</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgressChanged</span><span class="params">(WebView view, <span class="type">int</span> newProgress)</span> {</span><br><span class="line">          <span class="keyword">if</span> (newProgress &lt; <span class="number">100</span>) {</span><br><span class="line">              <span class="type">String</span> <span class="variable">progress</span> <span class="operator">=</span> newProgress + <span class="string">"%"</span>;</span><br><span class="line">              progress.setText(progress);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">        }</span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 2： onReceivedTitle（）</strong></p>
<ul>
<li>作用：获取 Web 页中的标题</li>
</ul>
<blockquote>
<p>每个网页的页面都有一个标题，比如 <a class="link" href="https://www.baidu.com/">www.baidu.com<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>这个页面的标题即 “百度一下，你就知道”，那么如何知道当前 webview 正在加载的页面的 title 并进行设置呢？</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>(){</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedTitle</span><span class="params">(WebView view, String title)</span> {</span><br><span class="line">       titleview.setText(title)；</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 3： onJsAlert（）</strong></p>
<ul>
<li>作用：支持 javascript 的警告框</li>
</ul>
<blockquote>
<p>一般情况下在 Android 中为 Toast，在文本里面加入 \n 就可以换行</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() {</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span>  {</span><br><span class="line">   <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>)</span><br><span class="line">           .setTitle(<span class="string">"JsAlert"</span>)</span><br><span class="line">           .setMessage(message)</span><br><span class="line">           .setPositiveButton(<span class="string">"OK"</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() {</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> {</span><br><span class="line">                   result.confirm();</span><br><span class="line">               }</span><br><span class="line">           })</span><br><span class="line">           .setCancelable(<span class="literal">false</span>)</span><br><span class="line">           .show();</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           }</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 4： onJsConfirm（）</strong></p>
<ul>
<li>作用：支持 javascript 的确认框 </li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsConfirm</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> {</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>)</span><br><span class="line">            .setTitle(<span class="string">"JsConfirm"</span>)</span><br><span class="line">            .setMessage(message)</span><br><span class="line">            .setPositiveButton(<span class="string">"OK"</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> {</span><br><span class="line">                    result.confirm();</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .setNegativeButton(<span class="string">"Cancel"</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> {</span><br><span class="line">                    result.cancel();</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .setCancelable(<span class="literal">false</span>)</span><br><span class="line">            .show();</span><br><span class="line"><span class="comment">// 返回布尔值：判断点击时确认还是取消</span></span><br><span class="line"><span class="comment">// true表示点击了确认；false表示点击了取消；</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>常见方法 5： onJsPrompt（）</strong></p>
<ul>
<li>作用：支持 javascript 输入框</li>
</ul>
<p>点击确认返回输入框中的值，点击取消返回 null。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsPrompt</span><span class="params">(WebView view, String url, String message, String defaultValue, <span class="keyword">final</span> JsPromptResult result)</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">EditText</span> <span class="variable">et</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EditText</span>(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">    et.setText(defaultValue);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>)</span><br><span class="line">            .setTitle(message)</span><br><span class="line">            .setView(et)</span><br><span class="line">            .setPositiveButton(<span class="string">"OK"</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> {</span><br><span class="line">                    result.confirm(et.getText().toString());</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .setNegativeButton(<span class="string">"Cancel"</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> {</span><br><span class="line">                    result.cancel();</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .setCancelable(<span class="literal">false</span>)</span><br><span class="line">            .show();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="3-3-Webview-与-JavaScript-的交互"><a href="#3-3-Webview-与-JavaScript-的交互" class="headerlink" title="3.3 Webview 与 JavaScript 的交互"></a>3.3 Webview 与 JavaScript 的交互</h4><p><a href="http://blog.tbox.fun/2018/ce16bff8.html">http://blog.tbox.fun/2018/ce16bff8.html</a></p>
<h4 id="3-4-注意事项：避免内存泄露"><a href="#3-4-注意事项：避免内存泄露" class="headerlink" title="3.4 注意事项：避免内存泄露"></a>3.4 注意事项：避免内存泄露</h4><h5 id="3-4-1-不在-xml-中定义-Webview-，而是在需要的时候在-Activity-中创建，并且-Context-使用-getApplicationgContext"><a href="#3-4-1-不在-xml-中定义-Webview-，而是在需要的时候在-Activity-中创建，并且-Context-使用-getApplicationgContext" class="headerlink" title="3.4.1 不在 xml 中定义 Webview ，而是在需要的时候在 Activity 中创建，并且 Context 使用 getApplicationgContext()"></a>3.4.1 不在 xml 中定义 Webview ，而是在需要的时候在 Activity 中创建，并且 Context 使用 getApplicationgContext ()</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">LinearLayout.<span class="type">LayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayout</span>.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">        mWebView = <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        mWebView.setLayoutParams(params);</span><br><span class="line">        mLayout.addView(mWebView);</span><br></pre></td></tr></tbody></table></figure></div>

<h5 id="3-4-2-在-Activity-销毁（-WebView-）的时候，先让-WebView-加载-null-内容，然后移除-WebView，再销毁-WebView，最后置空"><a href="#3-4-2-在-Activity-销毁（-WebView-）的时候，先让-WebView-加载-null-内容，然后移除-WebView，再销毁-WebView，最后置空" class="headerlink" title="3.4.2 在 Activity 销毁（ WebView ）的时候，先让 WebView 加载 null 内容，然后移除 WebView，再销毁 WebView，最后置空"></a>3.4.2 在 Activity 销毁（ WebView ）的时候，先让 WebView 加载 null 内容，然后移除 WebView，再销毁 WebView，最后置空</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (mWebView != <span class="literal">null</span>) {</span><br><span class="line">            mWebView.loadDataWithBaseURL(<span class="literal">null</span>, <span class="string">""</span>, <span class="string">"text/html"</span>, <span class="string">"utf-8"</span>, <span class="literal">null</span>);</span><br><span class="line">            mWebView.clearHistory();</span><br><span class="line"></span><br><span class="line">            ((ViewGroup) mWebView.getParent()).removeView(mWebView);</span><br><span class="line">            mWebView.destroy();</span><br><span class="line">            mWebView = <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="4-实例"><a href="#4-实例" class="headerlink" title="4. 实例"></a>4. 实例</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">4.</span> 实例</span><br><span class="line">目标：实现显示“www.baidu.com”、获取其标题、提示加载开始 &amp; 结束和获取加载进度</span><br><span class="line">具体实现：</span><br><span class="line">步骤<span class="number">1</span>：添加访问网络权限</span><br><span class="line"></span><br><span class="line">这是前提！这是前提！这是前提！</span><br><span class="line"></span><br><span class="line">AndroidManifest.xml</span><br><span class="line"></span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.INTERNET"</span>/&gt;</span><br><span class="line">步骤<span class="number">2</span>：主布局</span><br><span class="line">activity_main.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    xmlns:tools=<span class="string">"http://schemas.android.com/tools"</span></span><br><span class="line">    android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">    android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line"></span><br><span class="line">    android:paddingBottom=<span class="string">"@dimen/activity_vertical_margin"</span></span><br><span class="line">    android:paddingLeft=<span class="string">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">    android:paddingRight=<span class="string">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">    android:paddingTop=<span class="string">"@dimen/activity_vertical_margin"</span></span><br><span class="line">    tools:context=<span class="string">"com.example.carson_ho.webview_demo.MainActivity"</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &lt;!-- 获取网站的标题--&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=<span class="string">"@+id/title"</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        android:text=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--开始加载提示--&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=<span class="string">"@+id/text_beginLoading"</span></span><br><span class="line">        android:layout_below=<span class="string">"@+id/title"</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        android:text=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--获取加载进度--&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_below=<span class="string">"@+id/text_beginLoading"</span></span><br><span class="line">        android:id=<span class="string">"@+id/text_Loading"</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        android:text=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--结束加载提示--&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_below=<span class="string">"@+id/text_Loading"</span></span><br><span class="line">        android:id=<span class="string">"@+id/text_endLoading"</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        android:text=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--显示网页区域--&gt;</span><br><span class="line">    &lt;WebView</span><br><span class="line">        android:id=<span class="string">"@+id/webView1"</span></span><br><span class="line">        android:layout_below=<span class="string">"@+id/text_endLoading"</span></span><br><span class="line">        android:layout_width=<span class="string">"fill_parent"</span></span><br><span class="line">        android:layout_height=<span class="string">"fill_parent"</span></span><br><span class="line">        android:layout_marginTop=<span class="string">"10dp"</span> /&gt;</span><br><span class="line">&lt;/RelativeLayout&gt;</span><br><span class="line"></span><br><span class="line">步骤<span class="number">3</span>：根据需要实现的功能从而使用相应的子类及其方法（注释很清楚了）</span><br><span class="line">MainActivity.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.carson_ho.webview_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.KeyEvent;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebChromeClient;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebSettings;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> {</span><br><span class="line">    WebView mWebview;</span><br><span class="line">    WebSettings mWebSettings;</span><br><span class="line">    TextView beginLoading,endLoading,loading,mtitle;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> {</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mWebview = (WebView) findViewById(R.id.webView1);</span><br><span class="line">        beginLoading = (TextView) findViewById(R.id.text_beginLoading);</span><br><span class="line">        endLoading = (TextView) findViewById(R.id.text_endLoading);</span><br><span class="line">        loading = (TextView) findViewById(R.id.text_Loading);</span><br><span class="line">        mtitle = (TextView) findViewById(R.id.title);</span><br><span class="line"></span><br><span class="line">        mWebSettings = mWebview.getSettings();</span><br><span class="line"></span><br><span class="line">        mWebview.loadUrl(<span class="string">"http://www.baidu.com/"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置不用系统浏览器打开,直接显示在当前Webview</span></span><br><span class="line">        mWebview.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> {</span><br><span class="line">                view.loadUrl(url);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置WebChromeClient类</span></span><br><span class="line">        mWebview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取网站标题</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedTitle</span><span class="params">(WebView view, String title)</span> {</span><br><span class="line">                System.out.println(<span class="string">"标题在这里"</span>);</span><br><span class="line">                mtitle.setText(title);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取加载进度</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgressChanged</span><span class="params">(WebView view, <span class="type">int</span> newProgress)</span> {</span><br><span class="line">                <span class="keyword">if</span> (newProgress &lt; <span class="number">100</span>) {</span><br><span class="line">                    <span class="type">String</span> <span class="variable">progress</span> <span class="operator">=</span> newProgress + <span class="string">"%"</span>;</span><br><span class="line">                    loading.setText(progress);</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (newProgress == <span class="number">100</span>) {</span><br><span class="line">                    <span class="type">String</span> <span class="variable">progress</span> <span class="operator">=</span> newProgress + <span class="string">"%"</span>;</span><br><span class="line">                    loading.setText(progress);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置WebViewClient类</span></span><br><span class="line">        mWebview.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() {</span><br><span class="line">            <span class="comment">//设置加载前的函数</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> {</span><br><span class="line">                System.out.println(<span class="string">"开始加载了"</span>);</span><br><span class="line">                beginLoading.setText(<span class="string">"开始加载了"</span>);</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置结束加载函数</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageFinished</span><span class="params">(WebView view, String url)</span> {</span><br><span class="line">                endLoading.setText(<span class="string">"结束加载了"</span>);</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击返回上一页面而不是退出浏览器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode, KeyEvent event)</span> {</span><br><span class="line">        <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; mWebview.canGoBack()) {</span><br><span class="line">            mWebview.goBack();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onKeyDown(keyCode, event);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//销毁Webview</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (mWebview != <span class="literal">null</span>) {</span><br><span class="line">            mWebview.loadDataWithBaseURL(<span class="literal">null</span>, <span class="string">""</span>, <span class="string">"text/html"</span>, <span class="string">"utf-8"</span>, <span class="literal">null</span>);</span><br><span class="line">            mWebview.clearHistory();</span><br><span class="line"></span><br><span class="line">            ((ViewGroup) mWebview.getParent()).removeView(mWebview);</span><br><span class="line">            mWebview.destroy();</span><br><span class="line">            mWebview = <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1aisng-g2.webp" alt="image.png"></p>
]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>如何在 Linux 上安装最新 NVIDIA 驱动 -- 转载 + 跳坑经验</title>
    <url>/2019/18e77cfa.html</url>
    <content><![CDATA[<p>好久没更 blog 了，在忙一些项目啥的，之前从 Ubuntu16.04 更新到 Ubuntu18.04，N 卡驱动掉了…. 费尽心思安好了。这次 gnome 出问题了，卸载 gnome 重装后发现 n 卡驱动又掉了…</p>
<p>结果无论是用源安装，还是官网下载 *.run 文件都是安装失败，从源安装会发现显示安装成功，但是 <code>nvidia-smi</code> 运行失败，运行 **.run 安装则是缺少什么.drm，具体忘记了。来回折腾十多次，最后在这篇文章中收到启发，禁用了自带的 <code>nouveau</code>，重启成功运行（此方法是在安装完成后 N 卡不正常工作后使用的）</p>
<span id="more"></span>

<p>解决方法写在前边</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> gedit /etc/modprobe.d/nvidia-graphics-drivers.conf</span><br><span class="line"><span class="comment">#如果文件为空说明安装失败，重来吧少年</span></span><br><span class="line"><span class="comment">#在文件最后加上一句</span></span><br><span class="line">options nvidia_drm modeset=1</span><br><span class="line"><span class="comment">#保存关闭后运行</span></span><br><span class="line"><span class="built_in">sudo</span> update-initramfs -u</span><br><span class="line">然后重启</span><br></pre></td></tr></tbody></table></figure></div>

<p>以下是原文</p>
<p>你的桌面系统有 Nvidia 显卡吗？那么你应该很需要安装最新版驱动，尤其是当你还是个游戏爱好者的时候。众所周知，<a class="link" href="https://linuxstory.org/tag/linux/">Linux<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 上的 <strong>Nvidia 驱动</strong>真的很折腾人，安装最新版驱动也是一项艰巨的任务。不过 <a class="link" href="https://linuxstory.org/tag/linux/">Linux<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 用户还是很幸运的，因为还有一些第三方 <strong>PPA</strong> 来跟进 Nvidia 驱动的更新，它可以帮助我们很方便地安装最新版驱动。这个 <a class="link" href="https://linuxstory.org/tag/ppa/">PPA<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 现在还在测试阶段，不过它已经可以帮助我们让 Nvidia 驱动工作起来了。</p>
<p>本篇教程会用简单的几个步骤来说明<strong>如何在 Linux 上安装 Nvidia 驱动</strong>。</p>
<h4 id="Step-1-确认最近驱动支持你的显卡"><a href="#Step-1-确认最近驱动支持你的显卡" class="headerlink" title="Step.1 确认最近驱动支持你的显卡"></a>Step.1 确认最近驱动支持你的显卡</h4><p>a. 访问该 <a class="link" href="https://launchpad.net/~graphics-drivers/+archive/ubuntu/ppa">PPA 主页<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，然后核查驱动版本。截止 2017 年 11 月 26 日，此时的最新版本为 ‘nvidia-387’ (387.34)。<br>b. 核查该最新驱动是否支持你的显卡。点击该<a class="link" href="http://www.nvidia.com/object/unix.html">链接<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，找到对应驱动版本，即可查询到支持设备列表。切记不要查询到比 PPA 中最新版本还要新的版本。</p>
<h4 id="Step-2-移除旧驱动"><a href="#Step-2-移除旧驱动" class="headerlink" title="Step.2 移除旧驱动"></a>Step.2 移除旧驱动</h4><p>如果你的显卡是被支持的，那么就继续吧。现在移除你以前在系统里安装的 Nvidia 驱动。命令如下：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get purge nvidia* </span><br></pre></td></tr></tbody></table></figure></div>

<p><em>译者注：部分 Debian 系发行版版本可能不支持 apt-get purge ，可尝试使用 apt-get remove –purge 或 apt-get autoremove –purge 替代</em></p>
<h4 id="Step-3-添加驱动-PPA"><a href="#Step-3-添加驱动-PPA" class="headerlink" title="Step.3 添加驱动 PPA"></a>Step.3 添加驱动 PPA</h4><p>继续，我们现在需要添加显卡驱动的 PPA ：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Add the graphics-driver PPA</span></span><br><span class="line"><span class="built_in">sudo</span> add-apt-repository ppa:graphics-drivers</span><br><span class="line"><span class="comment"># And update</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update </span><br></pre></td></tr></tbody></table></figure></div>

<p><em>译者注：译者测试平台 CBPP 9（基于 Debian 9 ），要使用 add-apt-repository ，需要先安装 software-properties-common</em></p>
<h4 id="Step-4-安装（启用）最新-Nvidia-显卡驱动"><a href="#Step-4-安装（启用）最新-Nvidia-显卡驱动" class="headerlink" title="Step.4 安装（启用）最新 Nvidia 显卡驱动"></a>Step.4 安装（启用）最新 Nvidia 显卡驱动</h4><p>执行一下命令安装支持你的显卡的最新驱动：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install nvidia-387 </span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="Step-5-重启电脑以使新驱动生效"><a href="#Step-5-重启电脑以使新驱动生效" class="headerlink" title="Step.5 重启电脑以使新驱动生效"></a>Step.5 重启电脑以使新驱动生效</h4><p>你可以确认安装后的驱动状态是否正常：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">lsmod | grep nvidia </span><br></pre></td></tr></tbody></table></figure></div>

<p>如果没有输出，说明安装有问题。也可能是因为该驱动在你的系统驱动数据库中未被启用。你可以运行下面的命令检验开源驱动 nouveau 是否在运行。如果没有显示，说明你的安装是没问题的。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">lsmod | grep nouveau </span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="Step-6-避免自动升级以防破坏驱动"><a href="#Step-6-避免自动升级以防破坏驱动" class="headerlink" title="Step.6 避免自动升级以防破坏驱动"></a>Step.6 避免自动升级以防破坏驱动</h4><p>有两种方法可以避免自动升级：</p>
<p>a. 从软件源里移除显卡驱动 PPA 。不同发行版这步的操作有所不同。在 <a class="link" href="https://linuxstory.org/tag/ubuntu/">Ubuntu<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 里，找到你的软件源配置，移除所有显卡驱动 PPA 。<br>b. 或者通过禁用次要更新。输入一下命令即可：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-mark hold nvidia-387 </span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="Step-7-移除"><a href="#Step-7-移除" class="headerlink" title="Step.7 移除"></a>Step.7 移除</h4><p>如果新驱动运行出问题了，你可以很容易地移除它：</p>
<p>a. 按上面的讲述方法移除显卡驱动 PPA 。<br>b. 输入一下命令完全移除驱动</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get purge nvidia* </span><br></pre></td></tr></tbody></table></figure></div>

<p>c. 重启电脑以使开源驱动 nouveau 生效。</p>
<p>原文地址</p>
<p><a class="link" href="https://linuxstory.org/how-to-install-latest-nvidia-drivers-in-linux/">https://linuxstory.org/how-to-install-latest-nvidia-drivers-in-linux/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>ubuntu</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>宝塔自建 bitwarden 密码管理器</title>
    <url>/2022/2406815975.html</url>
    <content><![CDATA[<h1 id="宝塔自建-bitwarden-密码管理器"><a href="#宝塔自建-bitwarden-密码管理器" class="headerlink" title="宝塔自建 bitwarden 密码管理器"></a>宝塔自建 bitwarden 密码管理器</h1><blockquote>
<p>我们生活在被数字包围的世界里。为了证明你是你，你对某个资源拥有所有权。那么就需要密码。最常用的各种网站，还别说银行密码信用卡等等。市面上虽然有 1Password 等优秀商业方案，但是要付费。主流浏览器 Chrome，Firefox 等也提供原生的密码保存方案。 但是， 密码毕竟是个人数据， 自部署（self-hosted）是最佳方案 <a class="link" href="https://www.zhihu.com/question/58299407/answer/2147233885">免费密码管理器 bitwarden 的实际使用体验如何<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<span id="more"></span>

<ul>
<li><p>更新 2025.07.16</p>
<ul>
<li>增加自动备份</li>
</ul>
</li>
<li><p>更新 2022.09.17</p>
<ul>
<li>调整反代细节</li>
<li>增加时区可选参数</li>
</ul>
</li>
<li><p>更新 2022.08.02</p>
<ul>
<li>增加自启动</li>
</ul>
</li>
<li><p>更新 2022.07.31</p>
<ul>
<li>新增 fail2ban 配置</li>
</ul>
</li>
<li><p>更新 2022.07.30</p>
<ul>
<li>docker 新增日志、时区配置</li>
</ul>
</li>
<li><p>更新 2024.07.28</p>
<ul>
<li>新增 docker compose 配置</li>
</ul>
</li>
</ul>
<hr>
<p>使用宝塔面板 容易备份 容易管理</p>
<h2 id="新建站点"><a href="#新建站点" class="headerlink" title="新建站点"></a>新建站点</h2><p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/kQTpdZLS5cy7KC3.png" alt="image-20220726130235301"></p>
<p>新建站点，PHP 版本<code>纯静态</code>，不创建数据库，同时将根目录复制</p>
<p>点击新建好的站点，为新站点申请 SSL (站点无 SSL 将影响功能使用，内网使用可查看此文章 绕过 <a class="link" href="https://zhuanlan.zhihu.com/p/342571670">bitwarden 无 ssl 情况导入密码<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>)</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/ujKh5M9eTHdpyCY.png" alt="image-20220726134115108"></p>
<h2 id="新建-docker"><a href="#新建-docker" class="headerlink" title="新建 docker"></a>新建 docker</h2><p>从宝塔自带的软件商店搜索 docker 并安装</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/L3vyFeTqY7iAsCk.png" alt="image-20220726130524617"></p>
<blockquote>
<p>bitwarden_rs 是一个用于本地搭建 Bitwarden 服务器的第三方开源 Docker 项目。</p>
<p>bitwarden_rs 使用 Rust 编写，并改用 SQLite 数据库（现在也支持 MySQL 和 PostgreSQL），相对于官方版使用 MSSQL 数据库要求至少 2GB 内存，运行 bitwarden_rs 时只需要 10M 内存，可以说对硬件基本没有要求</p>
<p><a class="link" href="https://github.com/dani-garcia/vaultwarden/wiki">wiki<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>安装后点击设置 - 镜像管理 填入 <code>vaultwarden/server:latest</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/lr1WvekYmsyGU2I.png" alt="image-20220726141349121"></p>
<p>新建 docker，添加端口和目录映射，目录一定要选刚才创建网站的目录</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/hpSGaOKbmjDy8HE.png" alt="image-20220726155447695"></p>
<h2 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h2><p>打开 <code>配置文件</code> 添加 <code>websocket</code> 配置 (不配置此项可能不会及时自动同步)</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/Z4UypIlqnSDVC2r.png" alt="image-20220726162429100"></p>
<div class="code-container" data-rel="Nginx"><figure class="iseeu highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> vaultwarden-ws {</span><br><span class="line">  <span class="attribute">zone</span> vaultwarden-ws <span class="number">64k</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">127.0.0.1:3012</span>;</span><br><span class="line">  <span class="attribute">keepalive</span> <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>打开 站点 - 反向代理</p>
<p>随便添加一个，因为后边还要手动调整</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/BvZxzot1MO7LRa9.png" alt="image-20220726161532649"></p>
<p>添加完成后点击 配置文件 ，手动编辑</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/c8bJgGpRC5AjNdD.png" alt="image-20220726161617967"></p>
<p>覆盖粘贴如下内容</p>
<blockquote>
<p>注意： 如果手动点击 <code>状态(运行中)</code> 按钮，自定义的配置文件内容会被宝塔修改，需要重新点配置文件，再覆盖粘贴一次</p>
</blockquote>
<div class="code-container" data-rel="Nginx"><figure class="iseeu highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#PROXY-START/</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> / {</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:5814;</span><br><span class="line">        <span class="attribute">proxy_http_version</span>    <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span>    <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade            <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection         <span class="string">"upgrade"</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host               <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP          <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For    <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto  <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Host   <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Port   <span class="variable">$server_port</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /notifications/hub {</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://vaultwarden-ws;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /notifications/hub/negotiate {</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:5814;</span><br><span class="line">    }</span><br><span class="line"><span class="comment">#PROXY-END/</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>保存即可，此时访问网址已经可以看到相关页面了，<strong>注册一个账号作为使用的主账号</strong>，可以导出 chrome 浏览器以前保存过的密码，然后导入到 Bitwarden</p>
<h2 id="调整-docker"><a href="#调整-docker" class="headerlink" title="调整 docker"></a>调整 docker</h2><p>由于我是自己用的，所以还需要禁用注册</p>
<p>停止并删除 docker 管理器上的容器，因为需要用命令行去重新创建一个</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/J79XhHQfkbc8NDA.png" alt="image-20220726174128767"></p>
<p>打开系统命令行</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">docker run -d --name Bitwarden \</span><br><span class="line">  -e ADMIN_TOKEN=yigefuzademima \</span><br><span class="line">  -e SIGNUPS_ALLOWED=<span class="literal">false</span> \</span><br><span class="line">  -e WEBSOCKET_ENABLED=<span class="literal">true</span> \</span><br><span class="line">  -e LOG_FILE=/data/vaultwarden.log \</span><br><span class="line">  -e TZ=<span class="string">"Asia/Shanghai"</span> \</span><br><span class="line">  -v /www/wwwroot/目录/:/data/ \</span><br><span class="line">  -p 5814:80 \</span><br><span class="line">  -p 3012:3012 \</span><br><span class="line">  vaultwarden/server:latest</span><br></pre></td></tr></tbody></table></figure></div>

<p>使用 <code>ADMIN_TOKEN=密码</code>环境变量来设置一个超级密码，密码具体自定义，一定要复杂一些</p>
<p>使用 <code>SIGNUPS_ALLOWED=false</code> 来关闭注册</p>
<p>使用 <code>WEBSOCKET_ENABLED</code> 开启 <code>websocket</code></p>
<p><code>-v /www/wwwroot/xxx.xxx.com/:/data/ \</code> 中 <code>/www/wwwroot/xxx.xxx.com/</code> 换为第一步新建站点、第二部新建 docker 选的的路径，这样不会丢失上一步注册的用户数据</p>
<p><code>LOG_FILE</code> 指定日志输出路径</p>
<p><code>TZ</code> 指定时区，方便查看日志 不修改无法使用 <code>fail2ban</code></p>
<blockquote>
<p>可用时区挂载替换此项 -v /etc/localtime:/etc/localtime</p>
</blockquote>
<p>执行完成后刷新 docker 管理器会发现又重新出现了一个容器</p>
<p>设置容器自启动 (可选)</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 自启动</span></span><br><span class="line">docker update --restart=always Bitwarden</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="定时备份"><a href="#定时备份" class="headerlink" title="定时备份"></a>定时备份</h2><p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/26/9bznaTsNM7ZSUgA.png" alt="image-20220726211409346"></p>
<p>使用宝塔的计划任务，定时备份网址数据到服务器本地 / 腾讯云 COS</p>
<p>也可选择备份目录，因为我们选择了网站目录作为数据根目录，所以效果是一样的</p>
<h2 id="各版本客户端下载地址"><a href="#各版本客户端下载地址" class="headerlink" title="各版本客户端下载地址"></a>各版本客户端下载地址</h2><p><a class="link" href="https://bitwarden.com/download/">bitwarden<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="fail2ban-配置"><a href="#fail2ban-配置" class="headerlink" title="fail2ban 配置"></a>fail2ban 配置</h2><p>使用 fail2ban 可以保护登录，<a class="link" href="https://github.com/dani-garcia/vaultwarden/wiki/Fail2Ban-Setup">官方文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>软件商店搜索 fail2 进行安装</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/30/QgKbSqjLu76E9vp.png" alt="image-20220730215318900"></p>
<p>（可选）为 <code>fail2ban-regex</code> 建立软连接</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ln -s /www/server/panel/pyenv/bin/fail2ban-regex /usr/bin/fail2ban-regex</span><br></pre></td></tr></tbody></table></figure></div>

<p>除了用于 bitwarden 的防护，还可以保护 ssh</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/30/5nkKPrCIzcfQwgd.png" alt="image-20220730215641035"></p>
<h3 id="创建规则"><a href="#创建规则" class="headerlink" title="创建规则"></a>创建规则</h3><p>使用文件管理打开 <code>/etc/fail2ban/filter.d</code> 目录</p>
<p>创建文件 <code>vaultwarden.conf</code> 内容如下</p>
<div class="code-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">[INCLUDES]</span></span><br><span class="line"><span class="attr">before</span> = <span class="string">common.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Definition]</span></span><br><span class="line"><span class="attr">failregex</span> = <span class="string">^.*Username or password is incorrect\. Try again\. IP: &lt;ADDR&gt;\. Username:.*$</span></span><br><span class="line"><span class="attr">ignoreregex</span> =<span class="string"></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>创建文件 <code>vaultwarden-admin.conf</code></p>
<div class="code-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">[INCLUDES]</span></span><br><span class="line"><span class="attr">before</span> = <span class="string">common.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Definition]</span></span><br><span class="line"><span class="attr">failregex</span> = <span class="string">^.*Invalid admin token\. IP: &lt;ADDR&gt;.*$</span></span><br><span class="line"><span class="attr">ignoreregex</span> =<span class="string"></span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="启用规则"><a href="#启用规则" class="headerlink" title="启用规则"></a>启用规则</h3><p>打开文件 <code>/etc/fail2ban/jail.local</code></p>
<p>加入如下内容，其中 <code>logpath</code> 指定的是真实日志地址，和 <code>LOG_FILE</code> 指定的路径是对应的关系</p>
<div class="code-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">[vaultwarden]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">filter</span> = <span class="string">vaultwarden</span></span><br><span class="line"><span class="attr">port</span> = <span class="string">80,443</span></span><br><span class="line"><span class="attr">banaction</span> = <span class="string">%(banaction_allports)s</span></span><br><span class="line"><span class="comment">#action = iptables-allports[name=vaultwarden]</span></span><br><span class="line"><span class="attr">maxretry</span> = <span class="string">3</span></span><br><span class="line"><span class="attr">findtime</span> = <span class="string">86400</span></span><br><span class="line"><span class="attr">bantime</span> = <span class="string">259200</span></span><br><span class="line"><span class="attr">logpath</span> = <span class="string">/www/wwwroot/目录/vaultwarden.log</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">[vaultwarden-admin]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">port</span> = <span class="string">80,443</span></span><br><span class="line"><span class="attr">filter</span> = <span class="string">vaultwarden-admin</span></span><br><span class="line"><span class="attr">banaction</span> = <span class="string">%(banaction_allports)s</span></span><br><span class="line"><span class="comment">#action = iptables-allports[name=vaultwardenAdm]</span></span><br><span class="line"><span class="attr">maxretry</span> = <span class="string">3</span></span><br><span class="line"><span class="attr">findtime</span> = <span class="string">86400</span></span><br><span class="line"><span class="attr">bantime</span> = <span class="string">259200</span></span><br><span class="line"><span class="attr">logpath</span> = <span class="string">/www/wwwroot/目录/vaultwarden.log</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>重启服务</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/30/145gRZxjrmQ6DEA.png" alt="image-20220730220418245"></p>
<p>可以使用命令查看启动状态</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">fail2ban-client status vaultwarden</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="⚠️-使用宝塔-fail2ban-面板查看封禁用户"><a href="#⚠️-使用宝塔-fail2ban-面板查看封禁用户" class="headerlink" title="⚠️ 使用宝塔 fail2ban 面板查看封禁用户"></a>⚠️ 使用宝塔 fail2ban 面板查看封禁用户</h3><blockquote>
<p>☣️[警告], 此操作不可逆，可能会对宝塔 fail2ban 造成损害，且只能在线查看，不支持配置</p>
</blockquote>
<p>此操作是为了方便查看封禁信息</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2022/07/30/zRKfyx6uSI79jBF.png" alt="image-20220730174305590"></p>
<p>使用宝塔打开 <code>/www/server/panel/plugin/fail2ban/config.json</code></p>
<p>填入</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"sshd"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"act"</span><span class="punctuation">:</span> <span class="string">"true"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"port"</span><span class="punctuation">:</span> <span class="string">"22"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"maxretry"</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"findtime"</span><span class="punctuation">:</span> <span class="number">86400</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"bantime"</span><span class="punctuation">:</span> <span class="number">259200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"dir"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"vaultwarden"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"act"</span><span class="punctuation">:</span> <span class="string">"true"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"port"</span><span class="punctuation">:</span> <span class="string">"80,443"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"maxretry"</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"findtime"</span><span class="punctuation">:</span> <span class="number">86400</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"bantime"</span><span class="punctuation">:</span> <span class="number">259200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"dir"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"vaultwarden-admin"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"act"</span><span class="punctuation">:</span> <span class="string">"true"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"port"</span><span class="punctuation">:</span> <span class="string">"80,443"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"maxretry"</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"findtime"</span><span class="punctuation">:</span> <span class="number">86400</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"bantime"</span><span class="punctuation">:</span> <span class="number">259200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"dir"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="docker-compose-配置"><a href="#docker-compose-配置" class="headerlink" title="docker-compose 配置"></a>docker-compose 配置</h2><p>新建 <code>docker-compose.yml</code> 文件，粘贴此配置信息</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">bitwarden:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">Bitwarden</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># admin密钥，自行修改</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ADMIN_TOKEN=SSF</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SIGNUPS_ALLOWED=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WEBSOCKET_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">LOG_FILE=/data/vaultwarden.log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"./bitwarden/:/data/"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"80:80"</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"vaultwarden/server:latest-alpine"</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>更新并启动</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">docker-compose up -d --build --remove-orphans</span><br><span class="line"><span class="comment"># 新版本docker 自带命令 docker compose</span></span><br><span class="line"><span class="comment"># docker compose up -d --build --remove-orphans</span></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="使用-vaultwarden-backup-进行备份"><a href="#使用-vaultwarden-backup-进行备份" class="headerlink" title="使用 vaultwarden-backup 进行备份"></a>使用 vaultwarden-backup 进行备份</h2><p>使用 <code>vaultwarden-backup</code>，将 <code>Bitwarden</code> 加密备份到云盘上</p>
<div class="code-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">bitwarden:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">bitwarden</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ADMIN_TOKEN=AAA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SIGNUPS_ALLOWED=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ENABLE_WEBSOCKET=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">LOG_FILE=/data/vaultwarden.log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">LOG_LEVEL=info</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"./bitwarden/:/data/"</span></span><br><span class="line">    <span class="comment">#ports:</span></span><br><span class="line">    <span class="comment">#- '127.0.0.1:5814:80'</span></span><br><span class="line">    <span class="comment">#- '127.0.0.1:3012:3012'</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment">#image: 'vaultwarden/server:testing-alpine'</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"vaultwarden/server:latest-alpine"</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my_net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">backup:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ttionya/vaultwarden-backup:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">bitwarden-backup</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># 备份时间，每天8点</span></span><br><span class="line">      <span class="attr">CRON:</span> <span class="string">"0 20 * * *"</span></span><br><span class="line">      <span class="comment">#   ZIP_ENABLE: 'TRUE'</span></span><br><span class="line">      <span class="comment"># 这里是设置密码，需要自行修改</span></span><br><span class="line">      <span class="attr">ZIP_PASSWORD:</span> <span class="string">"112233"</span></span><br><span class="line">      <span class="attr">ZIP_TYPE:</span> <span class="string">"7z"</span></span><br><span class="line">      <span class="comment">#   BACKUP_FILE_SUFFIX: '%Y%m%d'</span></span><br><span class="line">      <span class="attr">BACKUP_KEEP_DAYS:</span> <span class="number">3</span></span><br><span class="line">      <span class="comment">#   MAIL_SMTP_ENABLE: 'FALSE'</span></span><br><span class="line">      <span class="comment">#   MAIL_SMTP_VARIABLES: ''</span></span><br><span class="line">      <span class="comment">#   MAIL_TO: ''</span></span><br><span class="line">      <span class="comment">#   MAIL_WHEN_SUCCESS: 'TRUE'</span></span><br><span class="line">      <span class="comment">#   MAIL_WHEN_FAILURE: 'TRUE'</span></span><br><span class="line">      <span class="attr">TIMEZONE:</span> <span class="string">"Asia/Shanghai"</span></span><br><span class="line">      <span class="comment"># 通用备份完成通知（无论成功/失败）,这里是备份到飞书</span></span><br><span class="line">      <span class="attr">PING_URL:</span> <span class="string">"https://open.feishu.cn/open-apis/bot/v2/hook/1"</span></span><br><span class="line">      <span class="attr">PING_URL_CURL_OPTIONS:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">        -H "Content-Type: application/json"</span></span><br><span class="line"><span class="string">        -d '{"msg_type":"text","content":{"title":"%{subject}","text":"%{content}"}}'</span></span><br><span class="line"><span class="string"></span>      <span class="comment"># 可选：区分成功/失败状态的通知</span></span><br><span class="line">      <span class="attr">PING_URL_WHEN_SUCCESS:</span> <span class="string">"https://open.feishu.cn/open-apis/bot/v2/hook/"</span></span><br><span class="line">      <span class="attr">PING_URL_WHEN_SUCCESS_CURL_OPTIONS:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">        -H "Content-Type: application/json"</span></span><br><span class="line"><span class="string">        -d '{"msg_type":"text","content":{"text":"✅ Backup succeeded"}}'</span></span><br><span class="line"><span class="string"></span>      <span class="attr">PING_URL_WHEN_FAILURE:</span> <span class="string">"https://open.feishu.cn/open-apis/bot/v2/hook/"</span></span><br><span class="line">      <span class="attr">PING_URL_WHEN_FAILURE_CURL_OPTIONS:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">        -H "Content-Type: application/json"</span></span><br><span class="line"><span class="string">        -d '{"msg_type":"text","content":{"text":"❌ Backup failed"}}'</span></span><br><span class="line"><span class="string"></span>    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./bitwarden:/bitwarden/data/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./backup/:/config/</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my_net</span></span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>docker</tag>
        <tag>bitwarden</tag>
      </tags>
  </entry>
  <entry>
    <title>将 gradle 缓存转换为本地 maven 仓库及上传到 nexus</title>
    <url>/2024/4019968114.html</url>
    <content><![CDATA[<p>gradle 将 maven 仓库中的所有依赖库下载到本地缓存文件夹中。但是此缓存文件夹不可移植。如果我们将此缓存文件夹从我们的 PC 传输到另一台 PC，gradle 将无法识别 gradle 缓存的复制版本。同时我们无法简单的做到将缓存的 gradle 上传到 nexus 中</p>
<span id="more"></span>

<p>事情的起因是我依赖的 <code>https://artifacts.alfresco.com/nexus/content/repositories/</code> 突然需要进行 <code>HTTP Basic</code> 认证，导致我的打包脚本无法正常执行，所以我要将本地缓存的相关包转移到 nexus 中去</p>
<h2 id="将-gradle-cache-转换为-maven-local"><a href="#将-gradle-cache-转换为-maven-local" class="headerlink" title="将 gradle cache 转换为 maven local"></a>将 gradle cache 转换为 maven local</h2><p>通过搜索 github，找到了 <a class="link" href="https://github.com/sinsongdev/gradle-cash-to-maven-repo">gradle-cash-to-maven-repo<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>通过此代码（python3）可以很方便将 gradle cache 转换为 maven local</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># File name: gradle_cache_to_repo.py</span></span><br><span class="line"><span class="comment"># Author by: ksh (sinsongdev@gmail.com)</span></span><br><span class="line"><span class="comment"># History:</span></span><br><span class="line"><span class="comment"># [2019/05/31 11:27 AM] Created.</span></span><br><span class="line"><span class="comment"># [2020/12/25 10:22 AM] "Cannot create a file when that file already exists" error fix.</span></span><br><span class="line"><span class="comment"># [2022/04/07 20:24 PM] Windows file path length limitation error fix.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Function: Convert android gradle cache into local maven repository.</span></span><br><span class="line"><span class="comment">#           This local maven repository can be used in gradle offline build directly instead of gradle cache.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> shutil <span class="keyword">import</span> copyfile</span><br><span class="line"></span><br><span class="line">logging = <span class="literal">False</span></span><br><span class="line">src = <span class="string">"E:/android/gradle_home/caches/modules-2/files-2.1/"</span></span><br><span class="line">dst = <span class="string">"E:/android/gradle_local_repo/"</span></span><br><span class="line"></span><br><span class="line">group_count = <span class="number">0</span></span><br><span class="line">artifect_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getTransformedPath</span>(<span class="params">path</span>):</span><br><span class="line">    transformedPath = path.replace(<span class="string">"/"</span>, <span class="string">"\\"</span>)</span><br><span class="line">    transformedPath = <span class="string">"\\\\?\\"</span> + transformedPath</span><br><span class="line">    <span class="keyword">return</span> transformedPath</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">makedirs</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">        os.makedirs(path)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">processGroup</span>(<span class="params">group</span>):</span><br><span class="line">    <span class="keyword">global</span> group_count</span><br><span class="line">    group_count = group_count + <span class="number">1</span></span><br><span class="line">    group_dir = group.replace(<span class="string">"."</span>, <span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">if</span> (logging):</span><br><span class="line">        <span class="built_in">print</span>(group_dir)</span><br><span class="line">    makedirs(dst + group_dir)</span><br><span class="line"></span><br><span class="line">    artifects = os.listdir(src + group)</span><br><span class="line">    <span class="keyword">for</span> artifect <span class="keyword">in</span> artifects:</span><br><span class="line">        processArtifect(group, group_dir, artifect)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">processArtifect</span>(<span class="params">group, group_dir, artifect</span>):</span><br><span class="line">    <span class="keyword">global</span> artifect_count</span><br><span class="line">    artifect_count = artifect_count + <span class="number">1</span></span><br><span class="line">    artifect_dir = dst + group_dir + <span class="string">"/"</span> + artifect</span><br><span class="line">    makedirs(artifect_dir)</span><br><span class="line">    <span class="keyword">if</span> (logging):</span><br><span class="line">        <span class="built_in">print</span>(artifect)</span><br><span class="line"></span><br><span class="line">    src_artifect_dir = src + group + <span class="string">"/"</span> + artifect</span><br><span class="line">    versions = os.listdir(src_artifect_dir)</span><br><span class="line">    <span class="keyword">for</span> version <span class="keyword">in</span> versions:</span><br><span class="line">        processVersion(group, artifect, artifect_dir, version)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">processVersion</span>(<span class="params">group, artifect, artifect_dir, version</span>):</span><br><span class="line">    version_dir = artifect_dir + <span class="string">"/"</span> + version</span><br><span class="line">    makedirs(version_dir)</span><br><span class="line">    <span class="keyword">if</span> (logging):</span><br><span class="line">        <span class="built_in">print</span>(version)</span><br><span class="line"></span><br><span class="line">    src_version_dir = src + group + <span class="string">"/"</span> + artifect + <span class="string">"/"</span> + version</span><br><span class="line">    hashs = os.listdir(src_version_dir)</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">hash</span> <span class="keyword">in</span> hashs:</span><br><span class="line">        hash_dir = src_version_dir + <span class="string">"/"</span> + <span class="built_in">hash</span></span><br><span class="line">        files = os.listdir(hash_dir)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            src_file_path = hash_dir + <span class="string">"/"</span> + file</span><br><span class="line">            dst_file_path = version_dir + <span class="string">"/"</span> + file</span><br><span class="line"></span><br><span class="line">            src_file_path = getTransformedPath(src_file_path)</span><br><span class="line">            dst_file_path = getTransformedPath(dst_file_path)</span><br><span class="line"></span><br><span class="line">            copyfile(src_file_path, dst_file_path)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">groups = os.listdir(src)</span><br><span class="line"><span class="keyword">for</span> group <span class="keyword">in</span> groups:</span><br><span class="line">    processGroup(group)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Done!"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Total %d groups"</span>%(group_count))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Total %d artifects"</span>%(artifect_count))</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="maven-本地仓库同步上传到-nexus-远程仓库"><a href="#maven-本地仓库同步上传到-nexus-远程仓库" class="headerlink" title="maven 本地仓库同步上传到 nexus 远程仓库"></a>maven 本地仓库同步上传到 nexus 远程仓库</h2><p><a class="link" href="https://blog.csdn.net/lizz861109/article/details/124948236">maven 本地仓库同步上传到 nexus 远程仓库<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://tsvico.lanzouw.com/iBfmt25i3zcb">备份<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># copy and run this script to the root of the repository directory containing files</span></span><br><span class="line"><span class="comment"># this script attempts to exclude uploading itself explicitly so the script name is important</span></span><br><span class="line"><span class="comment"># Get command line params</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">":r:u:p:"</span> opt; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">        r) REPO_URL=<span class="string">"<span class="variable">$OPTARG</span>"</span></span><br><span class="line">        ;;</span><br><span class="line">        u) USERNAME=<span class="string">"<span class="variable">$OPTARG</span>"</span></span><br><span class="line">        ;;</span><br><span class="line">        p) PASSWORD=<span class="string">"<span class="variable">$OPTARG</span>"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">find . -<span class="built_in">type</span> f -not -path <span class="string">'./mavenimport\.sh*'</span> -not -path <span class="string">'*/\.*'</span> -not -path <span class="string">'*/\^archetype\-catalog\.xml*'</span> -not -path <span class="string">'*/\^maven\-metadata\-local*\.xml'</span> -not -path <span class="string">'*/\^maven\-metadata\-deployment*\.xml'</span> | sed <span class="string">"s|^\./||"</span> | xargs -I <span class="string">'{}'</span> curl -u <span class="string">"<span class="variable">$USERNAME</span>:<span class="variable">$PASSWORD</span>"</span> -X PUT -v -T {} <span class="variable">${REPO_URL}</span>{} ;</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -u 用户名</span></span><br><span class="line"><span class="comment"># -p 密码</span></span><br><span class="line"><span class="comment"># -r 远程仓库路径</span></span><br><span class="line"><span class="built_in">cd</span> 转换后路径</span><br><span class="line">./mavenimport.sh -u admin -p admin123 -r http://nexus.lizz.com/repository/lizz_test</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>常用代理设置</title>
    <url>/2021/3092852125.html</url>
    <content><![CDATA[<blockquote>
<p>常用代理设置</p>
<p>以本机安装 <code>clash</code> 为例，混合代理地址 127.0.0.1:7890</p>
</blockquote>
<span id="more"></span>

<h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><ul>
<li><p>设置代理</p>
  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># http代理</span></span><br><span class="line">git config --global http.proxy http://127.0.0.1:7890</span><br><span class="line">git config --global https.proxy http://127.0.0.1:7890</span><br></pre></td></tr></tbody></table></figure></div>

  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># socks5代理(可选)</span></span><br><span class="line">git config --global http.proxy <span class="string">"socks5://127.0.0.1:7890"</span></span><br><span class="line">git config --global https.proxy <span class="string">"socks5://127.0.0.1:7890"</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>取消代理</p>
  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">git config --global --<span class="built_in">unset</span> http.proxy</span><br><span class="line">git config --global --<span class="built_in">unset</span> https.proxy</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h2 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h2><ul>
<li><p>设置代理</p>
  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># http代理</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=<span class="string">"http://127.0.0.1:7890"</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=<span class="string">"http://127.0.0.1:7890"</span></span><br></pre></td></tr></tbody></table></figure></div>

  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># socks5代理</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=<span class="string">"socks5://127.0.0.1:7890"</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=<span class="string">"socks5://127.0.0.1:7890"</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>取消代理</p>
  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">unset</span> http_proxy</span><br><span class="line"><span class="built_in">unset</span> https_proxy</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>永久生效</p>
<p>修改 <code>~/.bashrc</code> 或者 <code>~/.zshrc</code> 文件</p>
</li>
</ul>
<h2 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h2><ul>
<li><p>设置代理</p>
  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># http代理</span></span><br><span class="line"><span class="built_in">set</span> http_proxy=http://127.0.0.1:7890</span><br><span class="line"><span class="built_in">set</span> https_proxy=http://127.0.0.1:7890</span><br></pre></td></tr></tbody></table></figure></div>

  <div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># socks5代理</span></span><br><span class="line"><span class="built_in">set</span> http_proxy=socks5://127.0.0.1:7890</span><br><span class="line"><span class="built_in">set</span> https_proxy=socks5://127.0.0.1:7890</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>取消代理</p>
  <div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> http_proxy=</span><br><span class="line"><span class="built_in">set</span> https_proxy=</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h2 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h2><div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable">$Env:http_proxy</span>=<span class="string">"http://127.0.0.1:7890"</span>;</span><br><span class="line"><span class="variable">$Env:https_proxy</span>=<span class="string">"http://127.0.0.1:7890"</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>PowerShell</code> 关于终端的代理是临时命令，重启终端就会失效，如果想要永久设置代理，可以使用使用自定义配置<br>在 PowerShell 窗口中运行如下指令：</p>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(<span class="built_in">Test-Path</span> <span class="literal">-Path</span> <span class="variable">$PROFILE</span> )) { <span class="built_in">New-Item</span> <span class="literal">-Type</span> File <span class="literal">-Path</span> <span class="variable">$PROFILE</span> <span class="literal">-Force</span> }</span><br><span class="line">notepad <span class="variable">$PROFILE</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>默认会使用记事本打开一个文件，在文件中加入上面设置代理的命令，保存关闭即可。</p>
<h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><ul>
<li><p>设置代理</p>
  <div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># http代理</span></span><br><span class="line">npm config <span class="built_in">set</span> proxy http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br><span class="line">npm config <span class="built_in">set</span> https<span class="literal">-proxy</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>取消代理</p>
  <div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">npm config delete proxy</span><br><span class="line">npm config delete https<span class="literal">-proxy</span></span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h2 id="yarn"><a href="#yarn" class="headerlink" title="yarn"></a>yarn</h2><ul>
<li><p>设置代理</p>
  <div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># http代理</span></span><br><span class="line">yarn config <span class="built_in">set</span> proxy http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br><span class="line">yarn config <span class="built_in">set</span> https<span class="literal">-proxy</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>取消代理</p>
  <div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">yarn config delete proxy</span><br><span class="line">yarn config delete https<span class="literal">-proxy</span></span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
]]></content>
      <tags>
        <tag>proxy</tag>
      </tags>
  </entry>
  <entry>
    <title>常用正则以及正则学习（整理）</title>
    <url>/2020/b59f7188.html</url>
    <content><![CDATA[<p>正则总是学了忘，忘了学，每次用到不得不求助于搜索引擎，记录一下语法规则以及常用的正则</p>
<span id="more"></span>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在正文开始前，先推荐一个网站，是 git 上的一个开源项目，如果喜欢可以给作者一个 <code>Star</code> , 网站截图如下</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200613125224.png" alt="正则大全"></p>
<blockquote>
<p>有关地址</p>
<p><a class="link" href="https://any86.github.io/any-rule/">https://any86.github.io/any-rule/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>git 地址 <a class="link" href="https://github.com/any86/any-rule">https://github.com/any86/any-rule<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h2 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h2><h3 id="字符组"><a href="#字符组" class="headerlink" title="字符组"></a>字符组</h3><p>可以使用 <code>[]</code> 来寻找一组字符</p>
<p>例如 <code>/p[aeiou]t/g</code> 匹配一个 p，后跟一个元音，然后是一个 t</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvGyxH.png" alt="tvGyxH.png"></p>
<p>更直观的匹配方式 <code>/[a-z]/g</code> 和 <code>/[A-Za-z0-9_-]/g</code></p>
<p>当然括号中也可以表示否定含义，例如 <code>/p[^aeiou]t/g</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvGjoV.png" alt="tvGjoV.png"></p>
<hr>
<h3 id="预定义类"><a href="#预定义类" class="headerlink" title="预定义类"></a>预定义类</h3><ul>
<li><p><code>\d</code> 表示匹配数字 0-9，等价于 <code>[0-9]</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200613154421.png"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200613154509.png"></p>
</li>
<li><p><code>\D</code> 是 <code>\d</code> 的反面，相当于 <code>[^0-9]</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/hexo20200613154552.png"></p>
</li>
<li><p><code>\w</code> 匹配单词字符</p>
<ul>
<li>小写字母 a-z</li>
<li> 大写字母 A-Z</li>
<li> 数字 0-9</li>
<li> 下划线 _</li>
<li>等价于 <code>[a-zA-Z0-9_]</code></li>
</ul>
</li>
<li><p><code>\W</code> 匹配非单词字符 等价于 <code>[^a-zA-Z0-9_]</code></p>
</li>
<li><p><code>.</code> 等价于 <code>[^\r\n]</code> 除了回车和换行之外的所有字符</p>
</li>
<li><p><code>\s</code> 匹配空白字符，支持大部分的如下字符</p>
<ul>
<li>空格、\t、回车</li>
</ul>
</li>
<li><p><code>\S</code> 匹配所有非空字符</p>
</li>
<li><p>当我们想匹配一些有特殊含义的字符时，比如 <code>|</code>、<code>[,]</code>、<code>+</code>、<code>.</code>、<code>^</code> 等等，需要对其使用 <code>\</code> 转义字符，避免正则表达式的识别</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvYi9S.png" alt="tvYi9S.png"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvYl3F.png" alt="tvYl3F.png"></p>
</li>
</ul>
<h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><ul>
<li><p><code>/g</code> global, 表示全文匹配</p>
</li>
<li><p><code>/i</code> ignore 表示忽略大小写</p>
</li>
<li><p><code>/m</code> 多行匹配</p>
<blockquote>
<p>修饰符可以组合使用 例如 <code>/gi</code></p>
<p><a href="https://imgchr.com/i/tv3x00"><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tv3x00.png" alt="tv3x00.png"></a></p>
</blockquote>
</li>
</ul>
<h3 id="捕获组"><a href="#捕获组" class="headerlink" title="捕获组"></a>捕获组</h3><h4 id="捕获组用（…）表示"><a href="#捕获组用（…）表示" class="headerlink" title="捕获组用（…）表示"></a>捕获组用（…）表示</h4><ul>
<li><p><code>/a(bcd)e/g</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvYj8U.png" alt="tvYj8U.png"></p>
<h4 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h4><p>回溯允许引用之前捕获的子字符串。</p>
<p>匹配第一组可以使用 <code>\1</code>，匹配第二组可以使用 <code>\2</code>，依此类推</p>
<p><code>/([abc])×\1×\1/g</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvtPV1.png" alt="tvtPV1.png"></p>
</li>
</ul>
<h3 id="量词（表示匹配内容的个数）"><a href="#量词（表示匹配内容的个数）" class="headerlink" title="量词（表示匹配内容的个数）"></a>量词（表示匹配内容的个数）</h3><ul>
<li><p><code>?</code> 出现 0/1 次 eg: <code>/a?/g</code></p>
</li>
<li><p><code>+</code>: 匹配 1 个或多个标记 eg:<code>/a+/g</code></p>
</li>
<li><p><code>*</code>: 出现任意次</p>
</li>
<li><p><code>{n}</code>: 出现 n 次</p>
<blockquote>
<p>匹配大写的六个字符的十六进制颜色代码</p>
<p><code>/#[0-9A-F]{6}/g</code></p>
</blockquote>
</li>
<li><p><code>{n,m}</code>: 出现了 n-m 次</p>
</li>
<li><p><code>{n,}</code>: 出现了至少 n 次</p>
</li>
</ul>
<h4 id="贪婪模式的注意事项"><a href="#贪婪模式的注意事项" class="headerlink" title="贪婪模式的注意事项"></a>贪婪模式的注意事项</h4><p>正则表达式默认使用贪婪模式。在贪婪模式下，会尽可能多的匹配符合要求的字符。</p>
<ul>
<li><p><code>/".*"/g</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/195qpi-an.webp" alt="image.png"></p>
<p>在<strong>重复操作符（？，*，+，…）</strong>后面添加 <code>？</code>，可以让匹配变 “懒”。</p>
</li>
<li><p><code>/".*?"/g</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvd8Ts.png" alt="tvd8Ts.png"></p>
<p>在这里，这也可以通过使用 <code>[^"]</code> 代替。</p>
</li>
<li><p><code>/"[^"]*"/g</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s1.ax1x.com/2020/06/13/tvdD0J.png" alt="tvdD0J.png"></p>
</li>
</ul>
<h3 id="匹配位置"><a href="#匹配位置" class="headerlink" title="匹配位置"></a>匹配位置</h3><ul>
<li>行首 <code>^</code> ，在 <code>[]</code> 中表示取反</li>
<li>行尾 <code>$</code></li>
<li>字边界 <code>\b</code>，字边界锚点 <code>\b</code>，匹配字符和非词字符之间存在的假想不可见字符。</li>
</ul>
<h3 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h3><p>零宽断言可用于验证条件，而不匹配任何文本。</p>
<ul>
<li><p>先行断言（lookhead)</p>
<ul>
<li><p>正向 <code>(?=…)</code></p>
<pre><code>&gt; `/_(?=[aeiou])/g`
</code></pre>
</li>
<li><p>负向<code>（?!…)</code></p>
</li>
</ul>
</li>
<li><p>先行断言（lookbehind)</p>
<ul>
<li>正向 <code>(?&lt;=…)</code></li>
<li>负向<code>（?&lt;!…)</code></li>
</ul>
</li>
</ul>
<h2 id="常用正则（例子）"><a href="#常用正则（例子）" class="headerlink" title="常用正则（例子）"></a>常用正则（例子）</h2><h3 id="带引号的字符串"><a href="#带引号的字符串" class="headerlink" title="带引号的字符串"></a><strong>带引号的字符串</strong></h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/([<span class="string">'"])(?:(?!\1).)*\1/g;</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="百分比"><a href="#百分比" class="headerlink" title="百分比"></a>百分比</h3><p><code>/^(?:100(?:\.0+)?|\d?\d(?:\.\d+)?)%$/g</code></p>
<h3 id="火车车次"><a href="#火车车次" class="headerlink" title="火车车次"></a>火车车次</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[<span class="title class_">GCDZTSPKXLY1</span>-<span class="number">9</span>]\d{<span class="number">1</span>,<span class="number">4</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="手机机身码-IMEI"><a href="#手机机身码-IMEI" class="headerlink" title="手机机身码(IMEI)"></a>手机机身码 (IMEI)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\d{<span class="number">15</span>,<span class="number">17</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="必须带端口号的网址-或-ip"><a href="#必须带端口号的网址-或-ip" class="headerlink" title="必须带端口号的网址(或 ip)"></a>必须带端口号的网址 (或 ip)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^((ht|f)tps?:\/\/)?[\w-]+(\.[\w-]+)+:\d{<span class="number">1</span>,<span class="number">5</span>}\/?$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="网址-url-支持端口和”-参数”和”-参数"><a href="#网址-url-支持端口和”-参数”和”-参数" class="headerlink" title="网址(url,支持端口和”?+参数”和”#+参数)"></a>网址 (url, 支持端口和”?+ 参数” 和”#+ 参数)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(((ht|f)tps?):\/\/)?[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:<span class="regexp">/~+#-]*[\w@?^=%&amp;/~+#-])?$/</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="统一社会信用代码"><a href="#统一社会信用代码" class="headerlink" title="统一社会信用代码"></a>统一社会信用代码</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[<span class="number">0</span>-9A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NPQRTUWXY</span>]{<span class="number">2</span>}\d{<span class="number">6</span>}[<span class="number">0</span>-9A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NPQRTUWXY</span>]{<span class="number">10</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="迅雷链接"><a href="#迅雷链接" class="headerlink" title="迅雷链接"></a>迅雷链接</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^thunderx?:\/\/[a-zA-Z\d]+=$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="ed2k-链接-宽松匹配"><a href="#ed2k-链接-宽松匹配" class="headerlink" title="ed2k 链接(宽松匹配)"></a>ed2k 链接 (宽松匹配)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^<span class="attr">ed2k</span>:\/\/\|file\|.+\|\/$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="磁力链接-宽松匹配"><a href="#磁力链接-宽松匹配" class="headerlink" title="磁力链接(宽松匹配)"></a>磁力链接 (宽松匹配)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^<span class="attr">magnet</span>:\?xt=<span class="attr">urn</span>:<span class="attr">btih</span>:[<span class="number">0</span>-9a-fA-F]{<span class="number">40</span>,}.*$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:\d{<span class="number">1</span>,<span class="number">2</span>}|<span class="number">1</span>\d\d|<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d|<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])(?:\.(?:\d{<span class="number">1</span>,<span class="number">2</span>}|<span class="number">1</span>\d\d|<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d|<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])){<span class="number">3</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="linux”隐藏文件”路径"><a href="#linux”隐藏文件”路径" class="headerlink" title="linux”隐藏文件”路径"></a>linux” 隐藏文件” 路径</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\/(?:[^<span class="regexp">/]+\/)*\.[^/]*/</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="linux-文件夹路径"><a href="#linux-文件夹路径" class="headerlink" title="linux 文件夹路径"></a>linux 文件夹路径</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\/(?:[^<span class="regexp">/]+\/)*$/</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="linux-文件路径"><a href="#linux-文件路径" class="headerlink" title="linux 文件路径"></a>linux 文件路径</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\/(?:[^<span class="regexp">/]+\/)*[^/]+$/</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="window”文件夹”路径"><a href="#window”文件夹”路径" class="headerlink" title="window”文件夹”路径"></a>window” 文件夹” 路径</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-zA-Z]:\\(?:\w+\\?)*$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="window-下”文件”路径"><a href="#window-下”文件”路径" class="headerlink" title="window 下”文件”路径"></a>window 下” 文件” 路径</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-zA-Z]:\\(?:\w+\\)*\w+\.\w+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="股票代码-A-股"><a href="#股票代码-A-股" class="headerlink" title="股票代码(A 股)"></a>股票代码 (A 股)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(s[hz]|S[<span class="variable constant_">HZ</span>])(<span class="number">000</span>[\d]{<span class="number">3</span>}|<span class="number">002</span>[\d]{<span class="number">3</span>}|<span class="number">300</span>[\d]{<span class="number">3</span>}|<span class="number">600</span>[\d]{<span class="number">3</span>}|<span class="number">60</span>[\d]{<span class="number">4</span>})$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="大于等于-0-小于等于-150-支持小数位出现-5-如-145-5-用于判断考卷分数"><a href="#大于等于-0-小于等于-150-支持小数位出现-5-如-145-5-用于判断考卷分数" class="headerlink" title="大于等于 0, 小于等于 150, 支持小数位出现 5, 如 145.5, 用于判断考卷分数"></a>大于等于 0, 小于等于 150, 支持小数位出现 5, 如 145.5, 用于判断考卷分数</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^<span class="number">150</span>$|^(?:\d|[<span class="number">1</span>-<span class="number">9</span>]\d|<span class="number">1</span>[<span class="number">0</span>-<span class="number">4</span>]\d)(?:<span class="number">.5</span>)?$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="html-注释"><a href="#html-注释" class="headerlink" title="html 注释"></a>html 注释</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^&lt;!--[\s\S]*?--&gt;$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="md5-格式-32-位"><a href="#md5-格式-32-位" class="headerlink" title="md5 格式(32 位)"></a>md5 格式 (32 位)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^([a-f\d]{<span class="number">32</span>}|[A-F\d]{<span class="number">32</span>})$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="版本号-version-格式必须为-X-Y-Z"><a href="#版本号-version-格式必须为-X-Y-Z" class="headerlink" title="版本号(version)格式必须为 X.Y.Z"></a>版本号 (version) 格式必须为 X.Y.Z</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\d+(?:\.\d+){<span class="number">2</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="视频-video-链接地址（视频格式可按需增删）"><a href="#视频-video-链接地址（视频格式可按需增删）" class="headerlink" title="视频(video)链接地址（视频格式可按需增删）"></a>视频 (video) 链接地址（视频格式可按需增删）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^https?:\/\/(.+\/)+.+(\.(swf|avi|flv|mpg|rm|mov|wav|asf|3gp|mkv|rmvb|mp4))$/i;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="图片-image-链接地址（图片格式可按需增删）"><a href="#图片-image-链接地址（图片格式可按需增删）" class="headerlink" title="图片(image)链接地址（图片格式可按需增删）"></a>图片 (image) 链接地址（图片格式可按需增删）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^https?:\/\/(.+\/)+.+(\.(gif|png|jpg|jpeg|webp|svg|psd|bmp|tif))$/i;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="24-小时制时间（HH-mm-ss）"><a href="#24-小时制时间（HH-mm-ss）" class="headerlink" title="24 小时制时间（HH:mm:ss）"></a>24 小时制时间（HH:mm:ss）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:[<span class="number">01</span>]\d|<span class="number">2</span>[<span class="number">0</span>-<span class="number">3</span>]):[<span class="number">0</span>-<span class="number">5</span>]\<span class="attr">d</span>:[<span class="number">0</span>-<span class="number">5</span>]\d$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="12-小时制时间（hh-mm-ss）"><a href="#12-小时制时间（hh-mm-ss）" class="headerlink" title="12 小时制时间（hh:mm:ss）"></a>12 小时制时间（hh:mm:ss）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:<span class="number">1</span>[<span class="number">0</span>-<span class="number">2</span>]|<span class="number">0</span>?[<span class="number">1</span>-<span class="number">9</span>]):[<span class="number">0</span>-<span class="number">5</span>]\<span class="attr">d</span>:[<span class="number">0</span>-<span class="number">5</span>]\d$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="base64-格式"><a href="#base64-格式" class="headerlink" title="base64 格式"></a>base64 格式</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\s*<span class="attr">data</span>:(?:[a-z]+\/[a-z0-<span class="number">9</span>-+.]+(?:;[a-z-]+=[a-z0-<span class="number">9</span>-]+)?)?(?:;base64)?,([a-z0-<span class="number">9</span>!$&amp;<span class="string">',()*+;=\-._~:@/?%\s]*?)\s*$/i;</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="数字-货币金额（支持负数、千分位分隔符）"><a href="#数字-货币金额（支持负数、千分位分隔符）" class="headerlink" title="数字/货币金额（支持负数、千分位分隔符）"></a>数字 / 货币金额（支持负数、千分位分隔符）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^-?\d+(,\d{<span class="number">3</span>})*(\.\d{<span class="number">1</span>,<span class="number">2</span>})?$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="数字-货币金额-只支持正数、不支持校验千分位分隔符"><a href="#数字-货币金额-只支持正数、不支持校验千分位分隔符" class="headerlink" title="数字/货币金额 (只支持正数、不支持校验千分位分隔符)"></a>数字 / 货币金额 (只支持正数、不支持校验千分位分隔符)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/(?:^[<span class="number">1</span>-<span class="number">9</span>]([<span class="number">0</span>-<span class="number">9</span>]+)?(?:\.[<span class="number">0</span>-<span class="number">9</span>]{<span class="number">1</span>,<span class="number">2</span>})?$)|(?:^(?:<span class="number">0</span>){<span class="number">1</span>}$)|(?:^[<span class="number">0</span>-<span class="number">9</span>]\.[<span class="number">0</span>-<span class="number">9</span>](?:[<span class="number">0</span>-<span class="number">9</span>])?$)/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="银行卡号（10-到-30-位-覆盖对公-私账户-参考微信支付）"><a href="#银行卡号（10-到-30-位-覆盖对公-私账户-参考微信支付）" class="headerlink" title="银行卡号（10 到 30 位, 覆盖对公/私账户, 参考微信支付）"></a>银行卡号（10 到 30 位，覆盖对公 / 私账户，参考<a class="link" href="https://pay.weixin.qq.com/wiki/doc/api/xiaowei.php?chapter=22_1">微信支付<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span>-<span class="number">9</span>]\d{<span class="number">9</span>,<span class="number">29</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="中文姓名"><a href="#中文姓名" class="headerlink" title="中文姓名"></a>中文姓名</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:[\u4e00-\u9fa5·]{<span class="number">2</span>,<span class="number">16</span>})$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="英文姓名"><a href="#英文姓名" class="headerlink" title="英文姓名"></a>英文姓名</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/(^[a-zA-Z]{<span class="number">1</span>}[a-zA-Z\s]{<span class="number">0</span>,<span class="number">20</span>}[a-zA-Z]{<span class="number">1</span>}$)/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="车牌号-新能源"><a href="#车牌号-新能源" class="headerlink" title="车牌号(新能源)"></a>车牌号 (新能源)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领 A-Z]{<span class="number">1</span>}[A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-Z]{<span class="number">1</span>}(([<span class="number">0</span>-<span class="number">9</span>]{<span class="number">5</span>}[<span class="variable constant_">DF</span>])|([<span class="variable constant_">DF</span>][A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-<span class="variable constant_">Z0</span>-<span class="number">9</span>][<span class="number">0</span>-<span class="number">9</span>]{<span class="number">4</span>}))$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="车牌号-非新能源"><a href="#车牌号-非新能源" class="headerlink" title="车牌号(非新能源)"></a>车牌号 (非新能源)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领 A-Z]{<span class="number">1</span>}[A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-Z]{<span class="number">1</span>}[A-<span class="variable constant_">Z0</span>-<span class="number">9</span>]{<span class="number">4</span>}[A-<span class="variable constant_">Z0</span>-<span class="number">9</span>挂学警港澳]{<span class="number">1</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="车牌号-新能源-非新能源"><a href="#车牌号-新能源-非新能源" class="headerlink" title="车牌号(新能源+非新能源)"></a>车牌号 (新能源 + 非新能源)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领 A-Z]{<span class="number">1</span>}[A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-Z]{<span class="number">1</span>}(?:(?:[<span class="number">0</span>-<span class="number">9</span>]{<span class="number">5</span>}[<span class="variable constant_">DF</span>])|(?:[<span class="variable constant_">DF</span>](?:[A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-<span class="variable constant_">Z0</span>-<span class="number">9</span>])[<span class="number">0</span>-<span class="number">9</span>]{<span class="number">4</span>})))|(?:[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领 A-Z]{<span class="number">1</span>}[A-Z]{<span class="number">1</span>}[A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-<span class="variable constant_">Z0</span>-<span class="number">9</span>]{<span class="number">4</span>}[A-<span class="variable constant_">HJ</span>-<span class="variable constant_">NP</span>-<span class="variable constant_">Z0</span>-<span class="number">9</span> 挂学警港澳]{<span class="number">1</span>})$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="手机号-mobile-phone-中国-严谨-根据工信部-2019-年最新公布的手机号段"><a href="#手机号-mobile-phone-中国-严谨-根据工信部-2019-年最新公布的手机号段" class="headerlink" title="手机号(mobile phone)中国(严谨), 根据工信部 2019 年最新公布的手机号段"></a>手机号 (mobile phone) 中国 (严谨), 根据工信部 2019 年最新公布的手机号段</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:(?:\+|<span class="number">00</span>)<span class="number">86</span>)?<span class="number">1</span>(?:(?:<span class="number">3</span>[\d])|(?:<span class="number">4</span>[<span class="number">5</span>-<span class="number">7</span>|<span class="number">9</span>])|(?:<span class="number">5</span>[<span class="number">0</span>-<span class="number">3</span>|<span class="number">5</span>-<span class="number">9</span>])|(?:<span class="number">6</span>[<span class="number">5</span>-<span class="number">7</span>])|(?:<span class="number">7</span>[<span class="number">0</span>-<span class="number">8</span>])|(?:<span class="number">8</span>[\d])|(?:<span class="number">9</span>[<span class="number">1</span>|<span class="number">8</span>|<span class="number">9</span>]))\d{<span class="number">8</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="手机号-mobile-phone-中国-宽松-只要是-13-14-15-16-17-18-19-开头即可"><a href="#手机号-mobile-phone-中国-宽松-只要是-13-14-15-16-17-18-19-开头即可" class="headerlink" title="手机号(mobile phone)中国(宽松), 只要是 13,14,15,16,17,18,19 开头即可"></a>手机号 (mobile phone) 中国 (宽松), 只要是 13,14,15,16,17,18,19 开头即可</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:(?:\+|<span class="number">00</span>)<span class="number">86</span>)?<span class="number">1</span>[<span class="number">3</span>-<span class="number">9</span>]\d{<span class="number">9</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="手机号-mobile-phone-中国-最宽松-只要是-1-开头即可-如果你的手机号是用来接收短信-优先建议选择这一条"><a href="#手机号-mobile-phone-中国-最宽松-只要是-1-开头即可-如果你的手机号是用来接收短信-优先建议选择这一条" class="headerlink" title="手机号(mobile phone)中国(最宽松), 只要是 1 开头即可, 如果你的手机号是用来接收短信, 优先建议选择这一条"></a>手机号 (mobile phone) 中国 (最宽松), 只要是 1 开头即可，如果你的手机号是用来接收短信，优先建议选择这一条</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:(?:\+|<span class="number">00</span>)<span class="number">86</span>)?<span class="number">1</span>\d{<span class="number">10</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="date-日期"><a href="#date-日期" class="headerlink" title="date(日期)"></a>date (日期)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\d{<span class="number">4</span>}(-)(<span class="number">1</span>[<span class="number">0</span>-<span class="number">2</span>]|<span class="number">0</span>?\d)\<span class="number">1</span>([<span class="number">0</span>-<span class="number">2</span>]\d|\d|<span class="number">30</span>|<span class="number">31</span>)$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="email-邮箱"><a href="#email-邮箱" class="headerlink" title="email(邮箱)"></a>email (邮箱)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(([^<span class="language-xml"><span class="tag">&lt;&gt;</span>()[\]\\.,;:\s@"]+(\.[^<span class="tag">&lt;&gt;</span>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="座机-tel-phone-电话-国内-如-0341-86091234"><a href="#座机-tel-phone-电话-国内-如-0341-86091234" class="headerlink" title="座机(tel phone)电话(国内),如: 0341-86091234"></a>座机 (tel phone) 电话 (国内), 如: 0341-86091234</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\d{<span class="number">3</span>}-\d{<span class="number">8</span>}$|^\d{<span class="number">4</span>}-\d{<span class="number">7</span>,<span class="number">8</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="身份证号-1-代-15-位数字"><a href="#身份证号-1-代-15-位数字" class="headerlink" title="身份证号(1 代,15 位数字)"></a>身份证号 (1 代，15 位数字)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span>-<span class="number">9</span>]\d{<span class="number">7</span>}(?:<span class="number">0</span>\d|<span class="number">10</span>|<span class="number">11</span>|<span class="number">12</span>)(?:<span class="number">0</span>[<span class="number">1</span>-<span class="number">9</span>]|[<span class="number">1</span>-<span class="number">2</span>][\d]|<span class="number">30</span>|<span class="number">31</span>)\d{<span class="number">3</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="身份证号-2-代-18-位数字-最后一位是校验位-可能为数字或字符-X"><a href="#身份证号-2-代-18-位数字-最后一位是校验位-可能为数字或字符-X" class="headerlink" title="身份证号(2 代,18 位数字),最后一位是校验位,可能为数字或字符 X"></a>身份证号 (2 代，18 位数字), 最后一位是校验位，可能为数字或字符 X</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span>-<span class="number">9</span>]\d{<span class="number">5</span>}(?:<span class="number">18</span>|<span class="number">19</span>|<span class="number">20</span>)\d{<span class="number">2</span>}(?:<span class="number">0</span>[<span class="number">1</span>-<span class="number">9</span>]|<span class="number">10</span>|<span class="number">11</span>|<span class="number">12</span>)(?:<span class="number">0</span>[<span class="number">1</span>-<span class="number">9</span>]|[<span class="number">1</span>-<span class="number">2</span>]\d|<span class="number">30</span>|<span class="number">31</span>)\d{<span class="number">3</span>}[\dXx]$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="身份证号-支持-1-2-代-15-位-18-位数字"><a href="#身份证号-支持-1-2-代-15-位-18-位数字" class="headerlink" title="身份证号, 支持 1/2 代(15 位/18 位数字)"></a>身份证号，支持 1/2 代 (15 位 / 18 位数字)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/(^\d{<span class="number">8</span>}(<span class="number">0</span>\d|<span class="number">10</span>|<span class="number">11</span>|<span class="number">12</span>)([<span class="number">0</span>-<span class="number">2</span>]\d|<span class="number">30</span>|<span class="number">31</span>)\d{<span class="number">3</span>}$)|(^\d{<span class="number">6</span>}(<span class="number">18</span>|<span class="number">19</span>|<span class="number">20</span>)\d{<span class="number">2</span>}(<span class="number">0</span>[<span class="number">1</span>-<span class="number">9</span>]|<span class="number">10</span>|<span class="number">11</span>|<span class="number">12</span>)([<span class="number">0</span>-<span class="number">2</span>]\d|<span class="number">30</span>|<span class="number">31</span>)\d{<span class="number">3</span>}(\d|X|x)$)/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="护照（包含香港、澳门）"><a href="#护照（包含香港、澳门）" class="headerlink" title="护照（包含香港、澳门）"></a>护照（包含香港、澳门）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/(^[<span class="title class_">EeKkGgDdSsPpHh</span>]\d{<span class="number">8</span>}$)|(^(([<span class="title class_">Ee</span>][a-fA-F])|([<span class="title class_">DdSsPp</span>][<span class="title class_">Ee</span>])|([<span class="title class_">Kk</span>][<span class="title class_">Jj</span>])|([<span class="title class_">Mm</span>][<span class="title class_">Aa</span>])|(<span class="number">1</span>[<span class="number">45</span>]))\d{<span class="number">7</span>}$)/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="帐号是否合法-字母开头，允许-5-16-字节，允许字母数字下划线组合"><a href="#帐号是否合法-字母开头，允许-5-16-字节，允许字母数字下划线组合" class="headerlink" title="帐号是否合法(字母开头，允许 5-16 字节，允许字母数字下划线组合"></a>帐号是否合法 (字母开头，允许 5-16 字节，允许字母数字下划线组合</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-zA-Z]\w{<span class="number">4</span>,<span class="number">15</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="中文-汉字"><a href="#中文-汉字" class="headerlink" title="中文/汉字"></a>中文 / 汉字</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:[\u3400-\u4DB5\u4E00-\u9FEA\uFA0E\uFA0F\uFA11\uFA13\uFA14\uFA1F\uFA21\uFA23\uFA24\uFA27-\uFA29]|[\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879][\uDC00-\uDFFF]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0])+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="小数"><a href="#小数" class="headerlink" title="小数"></a>小数</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\d+\.\d+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\d{<span class="number">1</span>,}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="html-标签-宽松匹配"><a href="#html-标签-宽松匹配" class="headerlink" title="html 标签(宽松匹配)"></a>html 标签 (宽松匹配)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/&lt;(\w+)[^&gt;]*&gt;(.*?<span class="language-xml">&lt;\/\1&gt;</span>)?/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="qq-号格式正确"><a href="#qq-号格式正确" class="headerlink" title="qq 号格式正确"></a>qq 号格式正确</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span>-<span class="number">9</span>][<span class="number">0</span>-<span class="number">9</span>]{<span class="number">4</span>,<span class="number">10</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="数字和字母组成"><a href="#数字和字母组成" class="headerlink" title="数字和字母组成"></a>数字和字母组成</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[A-<span class="title class_">Za</span>-z0-<span class="number">9</span>]+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="英文字母"><a href="#英文字母" class="headerlink" title="英文字母"></a>英文字母</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-zA-Z]+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="小写英文字母组成"><a href="#小写英文字母组成" class="headerlink" title="小写英文字母组成"></a>小写英文字母组成</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-z]+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="大写英文字母"><a href="#大写英文字母" class="headerlink" title="大写英文字母"></a>大写英文字母</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[A-Z]+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="密码强度校验，最少-6-位，包括至少-1-个大写字母，1-个小写字母，1-个数字，1-个特殊字符"><a href="#密码强度校验，最少-6-位，包括至少-1-个大写字母，1-个小写字母，1-个数字，1-个特殊字符" class="headerlink" title="密码强度校验，最少 6 位，包括至少 1 个大写字母，1 个小写字母，1 个数字，1 个特殊字符"></a>密码强度校验，最少 6 位，包括至少 1 个大写字母，1 个小写字母，1 个数字，1 个特殊字符</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^\S*(?=\S{<span class="number">6</span>,})(?=\S*\d)(?=\S*[A-Z])(?=\S*[a-z])(?=\S*[!@#$%^&amp;*? ])\S*$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="用户名校验，4-到-16-位（字母，数字，下划线，减号）"><a href="#用户名校验，4-到-16-位（字母，数字，下划线，减号）" class="headerlink" title="用户名校验，4 到 16 位（字母，数字，下划线，减号）"></a>用户名校验，4 到 16 位（字母，数字，下划线，减号）</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-zA-<span class="variable constant_">Z0</span>-9_-]{<span class="number">4</span>,<span class="number">16</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="ip-v4"><a href="#ip-v4" class="headerlink" title="ip-v4"></a>ip-v4</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(?:(?:<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>]|<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>][<span class="number">0</span>-<span class="number">9</span>]|[<span class="number">01</span>]?[<span class="number">0</span>-<span class="number">9</span>][<span class="number">0</span>-<span class="number">9</span>]?)\.){<span class="number">3</span>}(?:<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>]|<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>][<span class="number">0</span>-<span class="number">9</span>]|[<span class="number">01</span>]?[<span class="number">0</span>-<span class="number">9</span>][<span class="number">0</span>-<span class="number">9</span>]?)$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="ip-v6"><a href="#ip-v6" class="headerlink" title="ip-v6"></a>ip-v6</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^((([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">7</span>}[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">6</span>}:[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">5</span>}:([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:)?[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">4</span>}:([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">2</span>}[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">3</span>}:([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">3</span>}[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">2</span>}:([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">4</span>}[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">6</span>}((\<span class="title function_">b</span>((<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])|(<span class="number">1</span>\d{<span class="number">2</span>})|(<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d)|(\d{<span class="number">1</span>,<span class="number">2</span>}))\b)\.){<span class="number">3</span>}(\<span class="title function_">b</span>((<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])|(<span class="number">1</span>\d{<span class="number">2</span>})|(<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d)|(\d{<span class="number">1</span>,<span class="number">2</span>}))\b))|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">5</span>}:((\<span class="title function_">b</span>((<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])|(<span class="number">1</span>\d{<span class="number">2</span>})|(<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d)|(\d{<span class="number">1</span>,<span class="number">2</span>}))\b)\.){<span class="number">3</span>}(\<span class="title function_">b</span>((<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])|(<span class="number">1</span>\d{<span class="number">2</span>})|(<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d)|(\d{<span class="number">1</span>,<span class="number">2</span>}))\b))|(::([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">5</span>}((\<span class="title function_">b</span>((<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])|(<span class="number">1</span>\d{<span class="number">2</span>})|(<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d)|(\d{<span class="number">1</span>,<span class="number">2</span>}))\b)\.){<span class="number">3</span>}(\<span class="title function_">b</span>((<span class="number">25</span>[<span class="number">0</span>-<span class="number">5</span>])|(<span class="number">1</span>\d{<span class="number">2</span>})|(<span class="number">2</span>[<span class="number">0</span>-<span class="number">4</span>]\d)|(\d{<span class="number">1</span>,<span class="number">2</span>}))\b))|([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}::([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">5</span>}[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(::([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">0</span>,<span class="number">6</span>}[<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>})|(([<span class="number">0</span>-9A-<span class="title class_">Fa</span>-f]{<span class="number">1</span>,<span class="number">4</span>}:){<span class="number">1</span>,<span class="number">7</span>}:))$/i;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="16-进制颜色"><a href="#16-进制颜色" class="headerlink" title="16 进制颜色"></a>16 进制颜色</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^#?([a-fA-<span class="variable constant_">F0</span>-<span class="number">9</span>]{<span class="number">6</span>}|[a-fA-<span class="variable constant_">F0</span>-<span class="number">9</span>]{<span class="number">3</span>})$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="微信号-wx-，6-至-20-位，以字母开头，字母，数字，减号，下划线"><a href="#微信号-wx-，6-至-20-位，以字母开头，字母，数字，减号，下划线" class="headerlink" title="微信号(wx)，6 至 20 位，以字母开头，字母，数字，减号，下划线"></a>微信号 (wx)，6 至 20 位，以字母开头，字母，数字，减号，下划线</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[a-zA-Z][-_a-zA-<span class="variable constant_">Z0</span>-<span class="number">9</span>]{<span class="number">5</span>,<span class="number">19</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="邮政编码-中国"><a href="#邮政编码-中国" class="headerlink" title="邮政编码(中国)"></a>邮政编码 (中国)</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^(<span class="number">0</span>[<span class="number">1</span>-<span class="number">7</span>]|<span class="number">1</span>[<span class="number">0</span>-<span class="number">356</span>]|<span class="number">2</span>[<span class="number">0</span>-<span class="number">7</span>]|<span class="number">3</span>[<span class="number">0</span>-<span class="number">6</span>]|<span class="number">4</span>[<span class="number">0</span>-<span class="number">7</span>]|<span class="number">5</span>[<span class="number">1</span>-<span class="number">7</span>]|<span class="number">6</span>[<span class="number">1</span>-<span class="number">7</span>]|<span class="number">7</span>[<span class="number">0</span>-<span class="number">5</span>]|<span class="number">8</span>[<span class="number">013</span>-<span class="number">6</span>])\d{<span class="number">4</span>}$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="中文和数字"><a href="#中文和数字" class="headerlink" title="中文和数字"></a>中文和数字</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^((?:[\u3400-\u4DB5\u4E00-\u9FEA\uFA0E\uFA0F\uFA11\uFA13\uFA14\uFA1F\uFA21\uFA23\uFA24\uFA27-\uFA29]|[\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879][\uDC00-\uDFFF]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0])|(\d))+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="不能包含字母"><a href="#不能包含字母" class="headerlink" title="不能包含字母"></a>不能包含字母</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^[^A-<span class="title class_">Za</span>-z]*$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="java-包名"><a href="#java-包名" class="headerlink" title="java 包名"></a>java 包名</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^([a-zA-<span class="variable constant_">Z_</span>][a-zA-<span class="variable constant_">Z0</span>-9_]*)+([.][a-zA-<span class="variable constant_">Z_</span>][a-zA-<span class="variable constant_">Z0</span>-9_]*)+$/;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="mac-地址"><a href="#mac-地址" class="headerlink" title="mac 地址"></a>mac 地址</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/^((([a-f0-<span class="number">9</span>]{<span class="number">2</span>}:){<span class="number">5</span>})|(([a-f0-<span class="number">9</span>]{<span class="number">2</span>}-){<span class="number">5</span>}))[a-f0-<span class="number">9</span>]{<span class="number">2</span>}$/i;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="匹配连续重复的字符"><a href="#匹配连续重复的字符" class="headerlink" title="匹配连续重复的字符"></a>匹配连续重复的字符</h3><div class="code-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">/(.)\<span class="number">1</span>+/;</span><br></pre></td></tr></tbody></table></figure></div>

<p>学习于 <a class="link" href="https://juejin.im/post/5eb4285e6fb9a0434d70a3de?utm_source=gold_browser_extension#heading-13">https://juejin.im/post/5eb4285e6fb9a0434d70a3de?utm_source=gold_browser_extension#heading-13<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>regular</tag>
      </tags>
  </entry>
  <entry>
    <title>构建多服务 springboot</title>
    <url>/2021/3232640826.html</url>
    <content><![CDATA[<p>问题背景</p>
<blockquote>
<p>如何在一套系统系统中开启多个端口面向不同服务对象</p>
</blockquote>
<p>当然，这里说的不是 springboot 多个监听端口的启动，而是在一套其他启动多个 springboot，分别运行在不同端口，各自有不同的逻辑</p>
<span id="more"></span>

<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>下面我们来看 <code>org.springframework.boot.builder</code> 中的 <code>SpringApplicationBuilder</code>, 这里为我们提供了这种实现方法</p>
<blockquote>
<p>Builder for SpringApplication and ApplicationContext instances with convenient fluent API and context hierarchy support. Simple example of a context hierarchy:<br>new SpringApplicationBuilder(ParentConfig.class).child(ChildConfig.class).run(args);</p>
<p>Another common use case is setting active profiles and default properties to set up the environment for an application:<br>new SpringApplicationBuilder(Application.class).profiles(“server”)<br>.properties(“transport=local”).run(args);</p>
<p>If your needs are simpler, consider using the static convenience methods in SpringApplication instead.</p>
<p>SpringApplication 和 ApplicationContext 实例的构建器，具有便利的流利的 API 和上下文层次结构支持。 上下文层次结构的简单示例</p>
</blockquote>
<p>这样的多启动器是具有上下文的，可以定义一个无 web 的父 springboot，以及多个子 springboot</p>
<p>比如</p>
<h3 id="启动器配置"><a href="#启动器配置" class="headerlink" title="启动器配置"></a>启动器配置</h3><div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> {</span><br><span class="line">    SpringApplicationBuilder()</span><br><span class="line">        .parent(CoreApplication::<span class="keyword">class</span>.java).web(WebApplicationType.NONE)</span><br><span class="line">        .child(WebApplication::<span class="keyword">class</span>.java).web(WebApplicationType.SERVLET)</span><br><span class="line">        .sibling(WorkApplication::<span class="keyword">class</span>.java).web(WebApplicationType.SERVLET)</span><br><span class="line">        .run(*args)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>WebApplicationType</code> 是一个枚举类，有三个可选项</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An enumeration of possible types of web application.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Brian Clozel</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">WebApplicationType</span> {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The application should not run as a web application and should not start an</span></span><br><span class="line"><span class="comment">	 * embedded web server.</span></span><br><span class="line"><span class="comment">	 * 该应用程序不应作为Web应用程序运行，也不应启动嵌入式Web服务器。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NONE,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The application should run as a servlet-based web application and should start an</span></span><br><span class="line"><span class="comment">	 * embedded servlet web server.</span></span><br><span class="line"><span class="comment">	 * 该应用程序应作为基于Servlet的Web应用程序运行，并应启动嵌入式Servlet Web服务器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	SERVLET,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The application should run as a reactive web application and should start an</span></span><br><span class="line"><span class="comment">	 * embedded reactive web server.</span></span><br><span class="line"><span class="comment">	 * 该应用程序应作为反应式Web应用程序运行，并应启动嵌入式反应式Web服务器。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	REACTIVE;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="多个-SpringApplication-实例"><a href="#多个-SpringApplication-实例" class="headerlink" title="多个 SpringApplication 实例"></a>多个 SpringApplication 实例</h3><h4 id="CoreApplication-父"><a href="#CoreApplication-父" class="headerlink" title="CoreApplication 父"></a>CoreApplication 父</h4><div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(<span class="string">"com.xx.xx.core"</span>,<span class="string">"com.xx.xx.common"</span>)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoreApplication</span></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="WebApplication（子-1）"><a href="#WebApplication（子-1）" class="headerlink" title="WebApplication（子 1）"></a>WebApplication（子 1）</h4><div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(<span class="string">"com.xxx.xxx.web"</span>)</span></span><br><span class="line"><span class="meta">@PropertySource(<span class="string">"classpath:application-web.properties"</span>)</span></span><br><span class="line"><span class="comment">// Servlet、Filter、Listener 可以直接通过 @WebServlet、@WebFilter、@WebListener 注解自动注册，无需其他代码。</span></span><br><span class="line"><span class="comment">// @ServletComponentScan</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebApplication</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><code>application-web.properties</code></p>
<div class="code-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="WorkApplication（子-2）"><a href="#WorkApplication（子-2）" class="headerlink" title="WorkApplication（子 2）"></a>WorkApplication（子 2）</h4><div class="code-container" data-rel="Kotlin"><figure class="iseeu highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span>  <span class="comment">// 缓存</span></span><br><span class="line"><span class="meta">@EnableScheduling</span>  <span class="comment">// 定时任务</span></span><br><span class="line"><span class="meta">@ComponentScan(<span class="string">"com.xxx.xxx.work"</span>)</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@PropertySource(<span class="string">"classpath:application-work.properties"</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkApplication</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><code>application-work.properties</code></p>
<div class="code-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">12563</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="文件结构图"><a href="#文件结构图" class="headerlink" title="文件结构图"></a>文件结构图</h3><ul>
<li><p>项目结构图</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/19/LDPJ7mKNRaWlqG3.png" alt="image-20210519145256076"></p>
</li>
<li><p>配置文件结构图</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/05/19/KphBbsAMZRDYLxe.png" alt="image-20210519145323613"></p>
</li>
</ul>
<p>两个子 SpringApplication 是同级关系，继承于主的 <code>yml</code> 配置</p>
]]></content>
      <tags>
        <tag>java</tag>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>利用、&amp; 快速多类型过滤</title>
    <url>/2021/2229810732.html</url>
    <content><![CDATA[<p>实际开发中我们经常会遇到根据类型筛选的功能，如下图所示，一般在后台处理中会根据选择的类型进行查询<br><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting2021022510212913.png" alt="多类型选择"><br>但是有时会遇到被筛选结果中包含多个标签类型，这样就无法使用简单的标签匹配筛选了，这里分享一种<strong>效率较高</strong>的查询方式</p>
<span id="more"></span>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting20210225102521204.png" alt="多个类型"></p>
<h3 id="创建标签数字生成器"><a href="#创建标签数字生成器" class="headerlink" title="创建标签数字生成器"></a>创建标签数字生成器</h3><p>ps: 示例代码使用的 typescript，其他语言逻辑类似</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> ifTag 标签数组</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="title class_">CovtagTobit</span>(<span class="attr">ifTags</span>: <span class="title class_">IFileTag</span>[]): <span class="built_in">number</span> {</span><br><span class="line">        <span class="keyword">let</span> tagBitSetnum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> ifTags !== <span class="string">"object"</span>) {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(ifTags)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">        ifTags?.<span class="title function_">forEach</span>(<span class="function"><span class="params">ifTag</span> =&gt;</span> {</span><br><span class="line">   <span class="comment">//tagBitSet 的值应为2^n</span></span><br><span class="line">            <span class="keyword">let</span> tagBitSet = <span class="number">0</span></span><br><span class="line">            <span class="keyword">switch</span> (ifTag.<span class="property">type</span>) {</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"TYPE1"</span>: {</span><br><span class="line">                    <span class="comment">// 标签1</span></span><br><span class="line">                    tagBitSet = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"TYPE2"</span>: {</span><br><span class="line">                    <span class="comment">// 标签2</span></span><br><span class="line">                    tagBitSet = <span class="number">2</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"TYPE3"</span>: {</span><br><span class="line">                    <span class="comment">// 标签3</span></span><br><span class="line">                    tagBitSet = <span class="number">4</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"TYPE4"</span>: {</span><br><span class="line">                    <span class="comment">// 标签4</span></span><br><span class="line">                    tagBitSet = <span class="number">8</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"TYPE5"</span>: {</span><br><span class="line">                    <span class="comment">// 标签5</span></span><br><span class="line">                    tagBitSet = <span class="number">16</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"TYPE6"</span>: {</span><br><span class="line">                    <span class="comment">// 标签6</span></span><br><span class="line">                    tagBitSet = <span class="number">32</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                }</span><br><span class="line">                <span class="attr">default</span>: {</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(ifTag.<span class="property">type</span>, <span class="string">"标签类型转换传参不正确,应为..."</span>)</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            tagBitSetnum = tagBitSetnum | tagBitSet</span><br><span class="line">        })</span><br><span class="line">        <span class="keyword">return</span> tagBitSetnum</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p>如果有代码相关问题可以打开 F12 控制台实验相关内容</p>
</blockquote>
<p>多种类型经过 <code>CovtagTobit</code> 方法会生成一个数字，比如 <code>TYPE1、TYPE2、TYPE3</code><br><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting20210225103856447.png" alt="在这里插入图片描述"><br>将 7 这个数字存储到数据库某一字段中，这个数字即为类型的转换值</p>
<h3 id="查询结果"><a href="#查询结果" class="headerlink" title="查询结果"></a>查询结果</h3><p>前台搜索时，用同样的方法再次计算一次 Bit 值<br>示例：比如想要查询 <code>TYPE1、TYPE2</code><br><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting20210225104130249.png" alt="在这里插入图片描述"><br>将计算出的 3 传入查询条件调用中<br>具体的 SQL 查询伪代码，将查出所有包含 <code>TYPE1、TYPE2</code> 的结果</p>
<div class="code-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"># tagbit是结果的存储字段(上方示例中<span class="number">7</span>的存储位置)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1 <span class="keyword">where</span> (tagbit <span class="operator">&amp;</span> <span class="number">3</span>) <span class="operator">!=</span> <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>注：转载请标明出处，如有错误还望不吝赐教</p>
]]></content>
      <tags>
        <tag>typescript</tag>
      </tags>
  </entry>
  <entry>
    <title>数组合并、查找、排序</title>
    <url>/2020/c7866024.html</url>
    <content><![CDATA[<ul>
<li>数十万很大的两个有序数组找出相同数据</li>
<li>把以下两个有序的整形数组拼接成一个新的有序数组，并返回该数组</li>
</ul>
<span id="more"></span>

<h1 id="数十万很大的两个有序数组找出相同数据"><a href="#数十万很大的两个有序数组找出相同数据" class="headerlink" title="数十万很大的两个有序数组找出相同数据"></a>数十万很大的两个有序数组找出相同数据</h1><blockquote>
<p>根据有序的特性针对性遍历，代码可能会有一些问题，还望大佬指正</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数十万很大的两个有序数组找出相同数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayEqual</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">int</span>[] m = {<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">16</span>};</span><br><span class="line">        <span class="type">int</span>[] n = {<span class="number">3</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">15</span>};</span><br><span class="line">        Search(m, n);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Search</span><span class="params">(<span class="type">int</span>[] m, <span class="type">int</span>[] n)</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">minLength</span> <span class="operator">=</span> Math.min(m.length, n.length);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; minLength || i &lt; minLength) {</span><br><span class="line">            <span class="keyword">if</span> (m[i] == n[j]) {</span><br><span class="line">                System.out.println(m[i]);</span><br><span class="line">                i++;</span><br><span class="line">                j++;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (m[i] &lt; n[j]) {</span><br><span class="line">                i++;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                j++;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h1 id="把以下两个有序的整形数组拼接成一个新的有序数组-并返回该数组"><a href="#把以下两个有序的整形数组拼接成一个新的有序数组-并返回该数组" class="headerlink" title="把以下两个有序的整形数组拼接成一个新的有序数组, 并返回该数组"></a>把以下两个有序的整形数组拼接成一个新的有序数组，并返回该数组</h1><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">arraySort</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">int</span> arrayA[] = {<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">71</span>, <span class="number">81</span>};</span><br><span class="line">        <span class="type">int</span> arrayB[] = {<span class="number">2</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">19</span>, <span class="number">32</span>, <span class="number">55</span>, <span class="number">57</span>, <span class="number">100</span>};</span><br><span class="line">        System.out.println(Arrays.toString(sumArray(arrayA,arrayB)));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] sumArray(<span class="type">int</span>[] a, <span class="type">int</span>[] b) {</span><br><span class="line">        <span class="comment">// 定义一个新数组，长度为两个数组长度之和</span></span><br><span class="line">        <span class="type">int</span>[] result = <span class="keyword">new</span> <span class="title class_">int</span>[a.length + b.length];</span><br><span class="line">        <span class="comment">//i:a数组下标    j：b数组下标  k：新数组下标</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>, k = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//按位循环比较两个数组，较小元素的放入新数组，下标加一（注意，较大元素对应的下标不加一），直到某一个下标等于数组长度时退出循环</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; a.length &amp;&amp; j &lt; b.length) {</span><br><span class="line">            <span class="keyword">if</span> (a[i] &lt;= b[j]) {</span><br><span class="line">                result[k++] = a[i++];</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                result[k++] = b[j++];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">/* 后面连个while循环是用来保证两个数组比较完之后剩下的一个数组里的元素能顺利传入 *</span></span><br><span class="line"><span class="comment">         * 此时较短数组已经全部放入新数组，较长数组还有部分剩余，最后将剩下的部分元素放入新数组，大功告成*/</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; a.length) {</span><br><span class="line">            result[k++] = a[i++];</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span> (j &lt; b.length) {</span><br><span class="line">            result[k++] = b[j++];</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

]]></content>
      <tags>
        <tag>java</tag>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>汇编学习之路</title>
    <url>/2018/e36c0d6c.html</url>
    <content><![CDATA[<p>写一些汇编基础，做个记录<br>包括输入输出、字符显示、字符判断等</p>
<span id="more"></span>
<p>输入输出先干为敬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">MOV AH,1 ;输入字符</span><br><span class="line">INT 21H ；输入后回显，键入字符的ascll送入AL</span><br><span class="line">MOV DL,AL</span><br><span class="line">MOV AH,2</span><br><span class="line">INT 21H ;输出输入的字符</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><p>对于一个汇编程序有三段：数据段、堆栈段、代码段<br>初始化程序</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mov AX,DATAS</span><br><span class="line">mov DS,AX </span><br></pre></td></tr></tbody></table></figure></div>
<p>为什么需要这个，因为 <code>mov</code> 无法实现将立即数传入段寄存器，但是 <code>mov</code> 可以将立即数传入通用寄存器<br>汇编语言程序中，数据的输入时以字符形式的 0~9 输入时对应的 <code>ASCII码</code>减掉 30H 存入主存中的，输出时是加上 30H<br>输出外设上的，比如十六进制 A，主存中是 0AH，加上 37H 变成了 41H。因为主存中存的就是 41H，所以可以直接输出带外设上</p>
<h3 id="21H基本功能模块"><a href="#21H基本功能模块" class="headerlink" title="21H基本功能模块"></a>21H 基本功能模块</h3><h4 id="1-从键盘上输入一个字符"><a href="#1-从键盘上输入一个字符" class="headerlink" title="1 从键盘上输入一个字符"></a>1 从键盘上输入一个字符</h4><p>AH=01H  AL = 输入自负的 ASCII 码值<br>举例</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">MOV AH,01H</span><br><span class="line">INT 21H</span><br></pre></td></tr></tbody></table></figure></div>
<h4 id="2-向显示器输出一个字符"><a href="#2-向显示器输出一个字符" class="headerlink" title="2 向显示器输出一个字符"></a>2 向显示器输出一个字符</h4><p>入口参数  AH=02H,DL=’输出字符串码’<br>举例</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">MOV DL,'C'</span><br><span class="line">MOV AH,02H</span><br><span class="line">INT 21H</span><br></pre></td></tr></tbody></table></figure></div>
<h4 id="3-向显示器-输出一个字符串"><a href="#3-向显示器-输出一个字符串" class="headerlink" title="3 向显示器 输出一个字符串"></a>3 向显示器 输出一个字符串</h4><p>AH = 09H<br>DS = 欲输出字符串的段地址   DX = 欲输出字符串的 偏移地址 </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">MOV  DX , OFFSET STRING  </span><br><span class="line">MOV  AH, 09H;  </span><br><span class="line">INT 21H</span><br></pre></td></tr></tbody></table></figure></div>
<p>完整代码:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">DATAS SEGMENT</span><br><span class="line">    STRING DB 'HELLO WORLD!';数据段  </span><br><span class="line">DATAS ENDS</span><br><span class="line"></span><br><span class="line">STACKS SEGMENT </span><br><span class="line">    DW 256 DUP(?)</span><br><span class="line">STACKS ENDS</span><br><span class="line">CODES SEGMENT</span><br><span class="line">    ASSUME CS:CODES,DS:DATAS</span><br><span class="line">START:</span><br><span class="line">    MOV AX ,DATAS</span><br><span class="line">    MOV DS, AX   ;这里开始初始化</span><br><span class="line">    ;此处输入代码段代码</span><br><span class="line">    MOV DX, OFFSET STRING</span><br><span class="line">    MOV AH ,09H</span><br><span class="line">    INT 21H</span><br><span class="line">    MOV AH,4CH</span><br><span class="line">    INT 21H</span><br><span class="line">CODES ENDS</span><br><span class="line">    END START</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="判断大小"><a href="#判断大小" class="headerlink" title="判断大小"></a>判断大小</h3><p><code>CMP</code>    比较.(两操作数作减法，仅修改标志位，不回送结果).<br> <code>JA/JNBE</code> 不小于或不等于时转移.<br><code> JAE/JNB</code> 大于或等于转移.<br> <code>JB/JNAE</code> 小于转移.<br> <code>JBE/JNA</code> 小于或等于转移.<br>以上四条，测试无符号整数运算的结果 (标志 C 和 Z).<br> <code>JG/JNLE</code> 大于转移.<br> <code>JGE/JNL</code> 大于或等于转移.<br> <code>JL/JNGE </code>小于转移.<br> <code>JLE/JNG</code> 小于或等于转移.<br>以上四条，测试带符号整数运算的结果 (标志 S,O 和 Z). </p>
<h2 id="十六进制输出"><a href="#十六进制输出" class="headerlink" title="十六进制输出"></a>十六进制输出</h2><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">START:</span><br><span class="line">    MOV   AX, DATA</span><br><span class="line">    MOV   DS, AX</span><br><span class="line"> </span><br><span class="line">    MOV   BX, X</span><br><span class="line">    CALL  LISTBX     ;显示</span><br><span class="line">    MOV   DL, 'H'</span><br><span class="line">    INT   21H</span><br><span class="line"> </span><br><span class="line">EXIT:   </span><br><span class="line">    MOV   AH, 4CH</span><br><span class="line">    INT   21H</span><br><span class="line">;=============================</span><br><span class="line">LISTBX:</span><br><span class="line">    MOV   CX, 0404H</span><br><span class="line">WR1:MOV   AH, 2</span><br><span class="line">    ROL   BX, CL</span><br><span class="line">    MOV   DL, BL</span><br><span class="line">    AND   DL, 15</span><br><span class="line">    CMP   DL, 10</span><br><span class="line">    JB    WR2</span><br><span class="line">    ADD   DL, 7</span><br><span class="line">WR2:ADD   DL, '0'</span><br><span class="line">    INT   21H</span><br><span class="line">    DEC   CH</span><br><span class="line">    JNZ   WR1</span><br><span class="line">    RET</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="比较两个数字大小（完整代码）"><a href="#比较两个数字大小（完整代码）" class="headerlink" title="比较两个数字大小（完整代码）"></a>比较两个数字大小（完整代码）</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">DATA SEGMENT</span><br><span class="line">  DATA1 DB'比较无符号数据大小！',0DH,0AH,'$'</span><br><span class="line">  DATA3 DB'cx中的较大数为',0DH,0AH,'$'</span><br><span class="line">  ;DATA4 DW'','$'</span><br><span class="line">  </span><br><span class="line">DATA ENDS</span><br><span class="line">CODE SEGMENT</span><br><span class="line">  ASSUME CS:CODE,DS:DATA  ; 说明代码段、数据段</span><br><span class="line">  </span><br><span class="line">Start:MOV AX,DATA</span><br><span class="line">       MOV DS,AX   ;给DS赋值段</span><br><span class="line">       MOV DX,OFFSET DATA1</span><br><span class="line">       MOV AH,9</span><br><span class="line">       INT 21H   ;显示提示”</span><br><span class="line">       mov DX,OFFSET DATA3</span><br><span class="line">       mov AH,9</span><br><span class="line">       INT 21H</span><br><span class="line">Start1:</span><br><span class="line">       mov AX,12ABH</span><br><span class="line">       mov BX,4CBAH</span><br><span class="line">       CMP AX,BX</span><br><span class="line">       JAE Next</span><br><span class="line">       XCHG AX,BX</span><br><span class="line">Next:</span><br><span class="line">       MOV CX,AX</span><br><span class="line">Start2:</span><br><span class="line">		;下边是输出代码</span><br><span class="line">       ;mov   DATA4,CX</span><br><span class="line">       MOV   BX,CX</span><br><span class="line">       CALL  LISTBX     ;显示</span><br><span class="line">       MOV   DL,'H'</span><br><span class="line">       INT   21H</span><br><span class="line"></span><br><span class="line">EXIT:</span><br><span class="line">       MOV   AH, 4CH</span><br><span class="line">       INT   21H</span><br><span class="line">;=============================</span><br><span class="line">LISTBX:</span><br><span class="line">        MOV CX, 0404H</span><br><span class="line">WR1:    MOV AH, 2</span><br><span class="line">        ROL BX, CL</span><br><span class="line">        MOV DL, BL</span><br><span class="line">        AND DL, 15</span><br><span class="line">        CMP DL, 10</span><br><span class="line">        JB  WR2</span><br><span class="line">        ADD DL, 7</span><br><span class="line">WR2:</span><br><span class="line">        ADD DL, '0'</span><br><span class="line">        INT 21H</span><br><span class="line">        DEC CH</span><br><span class="line">        JNZ WR1</span><br><span class="line">        RET</span><br><span class="line">CODE ENDS</span><br><span class="line">  END Start</span><br></pre></td></tr></tbody></table></figure></div>
<h2 id="压缩BCD码加减法"><a href="#压缩BCD码加减法" class="headerlink" title="压缩BCD码加减法"></a>压缩 BCD 码加减法</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">; 8086汇编</span><br><span class="line">; 16位的压缩型BCD码的加减运算 </span><br><span class="line">; BUF = BCD1 + BCD2 - BCD3 </span><br><span class="line">; 加法 1234 + 7890 = 9124</span><br><span class="line">; 减法 9124 - 5659 = 3465</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DATA SEGMENT</span><br><span class="line">BCD1 DW 1234H ;其中34是低8位</span><br><span class="line">BCD2 DW 7890H ;其中90是低8位 </span><br><span class="line">BCD3 DW 5659H ;其中59是低8位 </span><br><span class="line">BUF DW 0</span><br><span class="line">DATA ENDS</span><br><span class="line">CODE SEGMENT </span><br><span class="line">ASSUME CS:CODE,DS:DATA</span><br><span class="line">START: </span><br><span class="line">MOV AX,DATA</span><br><span class="line">MOV DS,AX </span><br><span class="line"></span><br><span class="line">CLC ;清除CF,因后面涉及进位标志CF</span><br><span class="line">MOV AL,BYTE PTR BCD1</span><br><span class="line">ADD AL,BYTE PTR BCD2 ;不带进位的加法</span><br><span class="line">DAA ;DAA是压缩BCD加法的调整指令 </span><br><span class="line">MOV DL,AL</span><br><span class="line">MOV AL,BYTE PTR BCD1+1</span><br><span class="line">ADC AL,BYTE PTR BCD2+1 ;ADC是带进位的加法指令</span><br><span class="line">DAA ;DAA是压缩BCD加法的调整指令 </span><br><span class="line">MOV DH,AL</span><br><span class="line">SUB DL,BYTE PTR BCD3 ;不带进位的减法 </span><br><span class="line">MOV AL,DL</span><br><span class="line">DAS ;DAS是压缩BCD减法的调整指令</span><br><span class="line">MOV DL,AL</span><br><span class="line">SBB DH,BYTE PTR BCD3+1 ;SBB是带借位的减法指令 </span><br><span class="line">MOV AL,DH</span><br><span class="line">DAS ;DAS是压缩BCD减法的调整指令</span><br><span class="line">MOV DH,AL </span><br><span class="line">MOV BUF,DX ;将最后结果存入BUF</span><br><span class="line"></span><br><span class="line">MOV AX,4C00H</span><br><span class="line">INT 21H</span><br><span class="line">CODE ENDS </span><br><span class="line">END START</span><br></pre></td></tr></tbody></table></figure></div>

<p>7/3 号，写个简单的，同样是<code>压缩BCD码</code>加法</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">DATA SEGMENT</span><br><span class="line">DATA ENDS</span><br><span class="line">CODE SEGMENT</span><br><span class="line">  ASSUME CS:CODE,DS:DATA  ; 说明代码段、数据段</span><br><span class="line"></span><br><span class="line">Start:MOV AX,DATA</span><br><span class="line">       MOV DS,AX   ;给DS赋值段</span><br><span class="line">Start1:</span><br><span class="line">      MOV AX,6698H</span><br><span class="line">      MOV BX,2877H</span><br><span class="line">      ADD AL,BL</span><br><span class="line">      DAA</span><br><span class="line">      MOV CL,AL</span><br><span class="line">      MOV AL,AH</span><br><span class="line">      ADC AL,BH</span><br><span class="line">      DAA</span><br><span class="line">      MOV AH,AL</span><br><span class="line">      MOV AL,CL</span><br><span class="line">      MOV AH,4CH</span><br><span class="line">      INT 21H</span><br><span class="line">CODE ENDS</span><br><span class="line">  END Start</span><br></pre></td></tr></tbody></table></figure></div>

<p>记一下：数据寄存器 AX、BX、CX、DX，每个数据寄存器都是 16 位，但是又可以把高、低 8 位分别作为两个独立的 8 位寄存器来用。高 8 位分别记作 AH、BH、CH、DH，低 8 位分别记作 AL、BL、CL、DL。例如 AX 可以当做两个 8 位寄存器 AH、AL 来用</p>
<p><code>8086/8088</code>CPU 的 14 个寄存器除了这四个 16 位可以分别当做两个 8 位，其他都不能</p>
]]></content>
      <tags>
        <tag>汇编</tag>
      </tags>
  </entry>
  <entry>
    <title>电脑实现小爱语音关机</title>
    <url>/2024/1104496865.html</url>
    <content><![CDATA[<p>目前使用的是<a class="link" href="https://wequ.net/cn/">神秘鸭<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>来实现关机的，免费版本足够我的日常使用，不过我在几次失灵后，就决定自己实现一个，一般是在电脑断网后再重新连接网络就会失灵，而且<code>神秘鸭</code>接入的是<code>巴法云</code>，巴法云在 APP 没找到设备在线状态，不利于远程查看是否开机（偶尔会使用 <code>tailscale</code> 远程组网控制电脑），网上没有找到满意的版本，决定基于 <code>TypeScript</code> 实现一个 nodejs 版本的关机程序，以下是开发过程</p>
<span id="more"></span>

<h2 id="开发过程"><a href="#开发过程" class="headerlink" title="开发过程"></a>开发过程</h2><ol>
<li>新建开发目录 </li>
</ol>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> blinker-js-shoutdown</span><br></pre></td></tr></tbody></table></figure></div>

<ol start="2">
<li>引入 <code>blinker-js</code></li>
</ol>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> blinker-js-shoutdown</span><br><span class="line">git <span class="built_in">clone</span> add https://github.com/blinker-iot/blinker-js.git</span><br><span class="line"><span class="built_in">mkdir</span> src</span><br></pre></td></tr></tbody></table></figure></div>

<p>我们的程序主要放在 <code>src</code> 目录中，主程序文件为 <code>index.ts</code></p>
<ol start="3">
<li>参考点灯文档，获取 key<br><a class="link" href="https://diandeng.tech/doc/javascript-support">文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ol>
<p>我准备以灯的方式接入，这样可以将控制亮度映射被调整音量</p>
<p>通过调试发现，在 windows 上点灯连接服务器有时会触发超时，在 <code>index.ts</code> 中设置全局超时时间</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"><span class="keyword">import</span> https <span class="keyword">from</span> <span class="string">"https"</span>;</span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"http"</span>;</span><br><span class="line"></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">timeout</span> = <span class="number">30</span> * <span class="number">1000</span>; <span class="comment">// 30s</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">httpsAgent</span> = <span class="keyword">new</span> https.<span class="title class_">Agent</span>({ <span class="attr">keepAlive</span>: <span class="literal">true</span> });</span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">httpAgent</span> = <span class="keyword">new</span> http.<span class="title class_">Agent</span>({ <span class="attr">keepAlive</span>: <span class="literal">true</span> });</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<ol start="4">
<li>关机实现<br>关机我们可以借助 <code>shutdown</code> 系统命令<br>写一个函数 </li>
</ol>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">shutdownWindow</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">let</span> command = <span class="title function_">exec</span>(<span class="string">"shutdown -s -t 00"</span>, <span class="keyword">function</span> (<span class="params">err, stdout, stderr</span>) {</span><br><span class="line">    <span class="keyword">if</span> (err || stderr) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"shutdown failed"</span> + err + stderr);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  command.<span class="property">stdin</span>.<span class="title function_">end</span>();</span><br><span class="line">  command.<span class="title function_">on</span>(<span class="string">"close"</span>, <span class="keyword">function</span> (<span class="params">code</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"shutdown"</span>, code);</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ol start="5">
<li><p>音量调节实现<br>音量调节我们使用 <code>loudness</code>，安装 <code>npm i loudness --save</code></p>
</li>
<li><p>完整代码<br>目前发现已知问题，点灯的官方库不能及时响应小爱音箱，总是提示 “要操作的设备出问题了”，但是实际上又是可以控制的</p>
</li>
</ol>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">BlinkerDevice</span> } <span class="keyword">from</span> <span class="string">"../lib/blinker"</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">ButtonWidget</span>, <span class="title class_">NumberWidget</span>, <span class="title class_">RangeWidget</span> } <span class="keyword">from</span> <span class="string">"../lib/widget"</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">Miot</span>, <span class="variable constant_">VA_TYPE</span>, <span class="variable constant_">MI_LIGHT_MODE</span> } <span class="keyword">from</span> <span class="string">"../lib/voice-assistant"</span>;</span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"><span class="keyword">import</span> https <span class="keyword">from</span> <span class="string">"https"</span>;</span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"http"</span>;</span><br><span class="line"><span class="keyword">import</span> { exec } <span class="keyword">from</span> <span class="string">"child_process"</span>;</span><br><span class="line"><span class="keyword">import</span> loudness <span class="keyword">from</span> <span class="string">"loudness"</span>;</span><br><span class="line"></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">timeout</span> = <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 30s</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">httpsAgent</span> = <span class="keyword">new</span> https.<span class="title class_">Agent</span>({</span><br><span class="line">  <span class="attr">keepAlive</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">maxSockets</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">maxFreeSockets</span>: <span class="number">100</span>,</span><br><span class="line">});</span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">httpAgent</span> = <span class="keyword">new</span> http.<span class="title class_">Agent</span>({</span><br><span class="line">  <span class="attr">keepAlive</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">maxSockets</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">maxFreeSockets</span>: <span class="number">100</span>,</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> authkey = process.<span class="property">env</span>.<span class="property">AUTHKEY</span>;</span><br><span class="line"><span class="keyword">if</span> (!authkey) {</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">"AUTHKEY 未配置，请检查环境变量"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">const</span> device = <span class="keyword">new</span> <span class="title class_">BlinkerDevice</span>(authkey, {</span><br><span class="line">  <span class="attr">protocol</span>: <span class="string">"mqtts"</span>, <span class="comment">// 可选协议mqtt/mqtts/ws/wss</span></span><br><span class="line">  <span class="attr">webSocket</span>: <span class="literal">false</span>, <span class="comment">// 是否开启本地webSocket，默认开启</span></span><br><span class="line">  <span class="attr">sourceCheck</span>: <span class="literal">true</span>, <span class="comment">// 是否开启来源检查，默认开启</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> miot = device.<span class="title function_">addVoiceAssistant</span>(<span class="keyword">new</span> <span class="title class_">Miot</span>(<span class="variable constant_">VA_TYPE</span>.<span class="property">LIGHT</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册组件</span></span><br><span class="line"><span class="comment">// 关机按钮</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">shoutdownButton</span>: <span class="title class_">ButtonWidget</span> = device.<span class="title function_">addWidget</span>(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">ButtonWidget</span>(<span class="string">"btn-abc"</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 关机次数</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">number1</span>: <span class="title class_">NumberWidget</span> = device.<span class="title function_">addWidget</span>(<span class="keyword">new</span> <span class="title class_">NumberWidget</span>(<span class="string">"num-abc"</span>));</span><br><span class="line"><span class="comment">// 音量</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">sound</span>: <span class="title class_">RangeWidget</span> = device.<span class="title function_">addWidget</span>(<span class="keyword">new</span> <span class="title class_">RangeWidget</span>(<span class="string">"ran-xax"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> soundValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rgb2int</span>(<span class="params"><span class="attr">r</span>: <span class="built_in">number</span>, <span class="attr">g</span>: <span class="built_in">number</span>, <span class="attr">b</span>: <span class="built_in">number</span></span>) {</span><br><span class="line">  <span class="keyword">return</span> (<span class="number">0xff</span> &lt;&lt; <span class="number">24</span>) | (r &lt;&lt; <span class="number">16</span>) | (g &lt;&lt; <span class="number">8</span>) | b;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">int2rgb</span>(<span class="params"><span class="attr">value</span>: <span class="built_in">number</span></span>) {</span><br><span class="line">  <span class="keyword">let</span> r = (value &amp; <span class="number">0xff0000</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">let</span> g = (value &amp; <span class="number">0xff00</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">let</span> b = value &amp; <span class="number">0xff</span>;</span><br><span class="line">  <span class="keyword">return</span> [r, g, b];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shutdownWindow</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">let</span> command = <span class="title function_">exec</span>(<span class="string">"shutdown -s -t 00"</span>, <span class="keyword">function</span> (<span class="params">err, stdout, stderr</span>) {</span><br><span class="line">    <span class="keyword">if</span> (err || stderr) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"shutdown failed"</span> + err + stderr);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  command.<span class="property">stdin</span>.<span class="title function_">end</span>();</span><br><span class="line">  command.<span class="title function_">on</span>(<span class="string">"close"</span>, <span class="keyword">function</span> (<span class="params">code</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"shutdown"</span>, code);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onShoutdownClick</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"click shoutdownButton:"</span>);</span><br><span class="line">  num++;</span><br><span class="line">  number1.<span class="title function_">value</span>(num).<span class="title function_">update</span>();</span><br><span class="line">  shoutdownButton.<span class="title function_">color</span>(<span class="string">"#DCDCDC"</span>).<span class="title function_">text</span>(<span class="string">"已关机"</span>).<span class="title function_">update</span>();</span><br><span class="line">  <span class="title function_">shutdownWindow</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeSound</span>(<span class="params"><span class="attr">value</span>: <span class="built_in">number</span></span>) {</span><br><span class="line">  <span class="keyword">if</span> (soundValue == value) {</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  loudness.<span class="title function_">setVolume</span>(value).<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"setVolume:"</span>, value);</span><br><span class="line">  });</span><br><span class="line">  soundValue = value;</span><br><span class="line">  <span class="keyword">if</span> (soundValue &gt; <span class="number">0</span>) {</span><br><span class="line">    loudness.<span class="title function_">getMuted</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">isMuted</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (isMuted) {</span><br><span class="line">        loudness.<span class="title function_">setMuted</span>(<span class="literal">false</span>).<span class="title function_">then</span>();</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getSoundNumber</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> loudness.<span class="title function_">getVolume</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) {</span><br><span class="line">  number1.<span class="title function_">value</span>(num).<span class="title function_">update</span>();</span><br><span class="line">  <span class="title function_">getSoundNumber</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"now SoundNumber:"</span>, value);</span><br><span class="line">    sound.<span class="title function_">value</span>(value).<span class="title function_">update</span>();</span><br><span class="line">  });</span><br><span class="line">  shoutdownButton.<span class="title function_">color</span>(<span class="string">"#ff0000"</span>).<span class="title function_">text</span>(<span class="string">"关机"</span>).<span class="title function_">update</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">device.<span class="title function_">ready</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  device.<span class="property">dataRead</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"otherData:"</span>, message);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  device.<span class="property">heartbeat</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">message</span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"heartbeat:"</span>, message);</span><br><span class="line">    <span class="title function_">init</span>();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  shoutdownButton.<span class="title function_">listen</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="title function_">onShoutdownClick</span>();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  sound.<span class="title function_">listen</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params">message</span>) =&gt;</span> {</span><br><span class="line">    <span class="title function_">changeSound</span>(message.<span class="property">data</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"range:"</span>, message.<span class="property">data</span>);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 电源状态改变   适用于灯和插座</span></span><br><span class="line">  miot.<span class="property">powerChange</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"powerChange"</span>, message.<span class="property">data</span>);</span><br><span class="line">    <span class="keyword">switch</span> (message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">pState</span>) {</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"true"</span>:</span><br><span class="line">        message.<span class="title function_">power</span>(<span class="string">"on"</span>).<span class="title function_">update</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"false"</span>:</span><br><span class="line">        <span class="title function_">onShoutdownClick</span>();</span><br><span class="line">        message.<span class="title function_">power</span>(<span class="string">"off"</span>).<span class="title function_">update</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模式改变   适用于灯和插座</span></span><br><span class="line">  miot.<span class="property">modeChange</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"modeChange"</span>, message.<span class="property">data</span>);</span><br><span class="line">    <span class="keyword">switch</span> (message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">mode</span>) {</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">DAY</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">NIGHT</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">COLOR</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">WARMTH</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">TV</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">READING</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">MI_LIGHT_MODE</span>.<span class="property">COMPUTER</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    message.<span class="title function_">mode</span>(message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">mode</span>).<span class="title function_">update</span>();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 颜色改变   适用于灯</span></span><br><span class="line">  miot.<span class="property">colorChange</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="comment">// not do anything</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"RGB:"</span>, <span class="title function_">int2rgb</span>(<span class="title class_">Number</span>(message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">col</span>)));</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 色温改变   适用于灯</span></span><br><span class="line">  miot.<span class="property">colorTempChange</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"色温"</span>, message);</span><br><span class="line">    message.<span class="title function_">colorTemp</span>(<span class="number">255</span>).<span class="title function_">update</span>();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 亮度改变   适用于灯</span></span><br><span class="line">  <span class="keyword">let</span> brightness = <span class="number">50</span>;</span><br><span class="line">  miot.<span class="property">brightnessChange</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"亮度"</span>, message.<span class="property">data</span>.<span class="property">set</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">bright</span> != <span class="string">"undefined"</span>) {</span><br><span class="line">      brightness = <span class="title class_">Number</span>(message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">bright</span>);</span><br><span class="line">      <span class="title function_">changeSound</span>(brightness);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">upBright</span> != <span class="string">"undefined"</span>) {</span><br><span class="line">      brightness = brightness + <span class="title class_">Number</span>(message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">upBright</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">downBright</span> != <span class="string">"undefined"</span>) {</span><br><span class="line">      brightness = brightness - <span class="title class_">Number</span>(message.<span class="property">data</span>.<span class="property">set</span>.<span class="property">downBright</span>);</span><br><span class="line">    }</span><br><span class="line">    message.<span class="title function_">brightness</span>(brightness).<span class="title function_">update</span>();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  miot.<span class="property">stateQuery</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message.<span class="property">data</span>);</span><br><span class="line">    message.<span class="title function_">power</span>(<span class="string">"on"</span>).<span class="title function_">update</span>();</span><br><span class="line">  });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<ol start="7">
<li>界面样式 </li>
</ol>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">{¨version¨¨3.0.0¨¨config¨{¨headerColor¨¨transparent¨¨headerStyle¨¨dark¨¨background¨{¨img¨¨assets/img/headerbg.jpg¨¨isFull¨«}}¨dashboard¨|{¨type¨¨btn¨¨ico¨¨fad fa-power-off¨¨mode¨É¨t0¨¨ 关机 ¨¨clr¨¨#389BEE¨¨t1¨¨ 文本 2¨¨bg¨É¨cols¨Ë¨rows¨Ë¨key¨¨btn-abc¨´x´Î´y´Ê¨speech¨|÷¨lstyle¨É}{ßC¨num¨ßH¨ 关机次数 ¨ßE¨fad fa-american-sign-language-interpreting¨ßJßK¨min¨É¨max¨¢1c¨uni¨´ 次 ´ßNÉßOÍßPËßQ¨num-abc¨´x´É´y´ÊßS|÷ßTÊ}{ßC¨deb¨ßGÉßNÉßOÑßPÌßQ¨debug¨´x´É´y´¤A}{ßC¨ran¨ßH¨ 电脑音量 ¨ßJßKßYº0ßXÉßNÉßOÑßPËßQ¨ran-xax¨´x´É´y´Í¨rt¨»}÷¨actions¨|¦¨cmd¨¦¨switch¨‡¨text¨‡¨on¨¨ 打开?name¨¨off¨¨ 关闭?name¨—÷¨triggers¨|{¨source¨ßj¨source_zh¨¨ 开关状态 ¨¨state¨|ßlßn÷¨state_zh¨|¨ 打开 ¨¨ 关闭 ¨÷}÷ßg|ßf÷}</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/12/22/67681840cad4b.jpg"></p>
<p>… 待完善</p>
]]></content>
      <tags>
        <tag>nodejs</tag>
        <tag>blinker</tag>
      </tags>
  </entry>
  <entry>
    <title>百度云下载的一些骚操作</title>
    <url>/2018/d3f9e332.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前最主流的网盘还是当属百度云，虽然有不限速的蓝凑云，但是文件大小有着 100M 限制，坚果云只适合日常文档的使用，大文件存储还是百度云</p>
<p>“天下没有免费的午餐”，百度网盘的会员制也无可厚非。然而，当我去充值会员时发现：买了会员也依然会限速，<strong>只有 “超级会员” 才能满速下载！</strong></p>
<p>还好，我们还有其他的方法，来打破限速，实现满速下载。</p>
<p>有能力还请支持百度云，购买 svip</p>
<span id="more"></span>

<p>2018.9.20 更新</p>
<blockquote>
<p>BaiduPCS-Go 若无法使用，可以试试 <code>config set -appid=266719</code> 更改 appid 接口</p>
<p>新增软件 <code>YunDownload</code>、<code>speedpan速盘</code>、手机版度盘下载器</p>
</blockquote>
<p>这里我要介绍 pc 端的几款工具，放飞你的度盘</p>
<h2 id="1-Pan-Download"><a href="#1-Pan-Download" class="headerlink" title="1.Pan Download"></a>1.Pan Download</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Pan Download 是一个吾爱的网友自己用 C++ 编写的，原理与 IDM 法类似，通过软件获取直链后调用 aria2 下载。</p>
<p>不过使用更为简单，只要下载一个 2M 的软件就够了，绿色软件，解压即用。测试时也能够跑满带宽。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><a class="link" href="http://pandownload.com/">访问官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 解压文件，打开 PanDownload.exe 运行即可</p>
<p>是否需要登录：需要</p>
<p>运行环境： windows</p>
<h2 id="2-浏览器-迅雷-IDM-uGet"><a href="#2-浏览器-迅雷-IDM-uGet" class="headerlink" title="2.浏览器+迅雷/IDM/uGet"></a>2. 浏览器 + 迅雷 / IDM/uGet</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>起作用的主要是直链获取脚本，下载时 windows 平台可用迅雷或者 IDM</p>
<p>IDM <a class="link" href="http://idman.ys168.com/">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 可以按需下载</p>
<p>linux 平台可以使用 uGet</p>
<h3 id="脚本安装"><a href="#脚本安装" class="headerlink" title="脚本安装"></a>脚本安装</h3><h4 id="1-安装油猴扩展"><a href="#1-安装油猴扩展" class="headerlink" title="1.安装油猴扩展"></a>1. 安装油猴扩展</h4><p>安装脚本工具：Tampermonkey 插件。Chrome 、 Firefox、Safari、Microsoft Edge、Opera 等常见浏览器都可以用。</p>
<p>注意：国内的 360 急速这种使用 google 内核的浏览器也是可用的</p>
<p>Tampermonkey 官网：<a class="link" href="https://tampermonkey.net/">tampermonkey.net<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Chrome 用户如果无法访问浏览器扩展应用商店的话，可以通过网站 &nbsp;<a class="link" href="https://www.crx4chrome.com/">crx4chrome<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>&nbsp; 来下载扩展程序 crx 文件，打开 Chrome 扩展管理页面，勾选 “开发者模式”，手动将 crx 文件拖动至扩展页面安装也可。</p>
<h4 id="2-安装脚本"><a href="#2-安装脚本" class="headerlink" title="2.安装脚本"></a>2. 安装脚本</h4><p><a class="link" href="https://greasyfork.org/zh-CN/scripts/31921-%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E5%8A%A9%E6%89%8B">百度网盘直接下载助手<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>或者使用 <a class="link" href="https://greasyfork.org/zh-CN/scripts/26638-ex-%E7%99%BE%E5%BA%A6%E4%BA%91%E7%9B%98">EX - 百度网盘<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/18r3jb-xz.webp" alt="image.png"></p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>打开别人分享的百度云链接，就能看到获取链接选项</p>
<p>将获取链接直接在下载工具中新建任务，就可体验高速下载</p>
<p>是否需要登录： 不需要</p>
<p>运行平台：Windows 、Linux</p>
<h2 id="3-度盘下载器-DpDownload"><a href="#3-度盘下载器-DpDownload" class="headerlink" title="3.度盘下载器 DpDownload"></a>3. 度盘下载器 DpDownload</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>官网已经关闭 <a class="link" href="http://www.linesoft.top/bbsclose.html?r=forum.php">官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>使用方法同 pandownload</p>
<h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><p><a class="link" href="https://5f98d5.link.yunpan.360.cn/lk/surl_yQ26SeJzhpk">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>是否需要登录：需要</p>
<p>运行环境：Windows</p>
<p>新增<code>度盘下载器Android版</code>（不知作者是否为同一人）</p>
<p><a class="link" href="https://www.coolapk.com/apk/com.appshenqi.clouddiskapp">Android 下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>手机版应配合 ADM 下载器达到满速下载</p>
<h2 id="4-proxyee-down"><a href="#4-proxyee-down" class="headerlink" title="4.proxyee-down"></a>4.proxyee-down</h2><h3 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h3><p>本软件是一个开源项目 <a class="link" href="https://github.com/proxyee-down-org/proxyee-down">项目地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://camo.githubusercontent.com/956fc884c84feafe715133171028bd64ce3138ad/68747470733a2f2f692e696d6775722e636f6d2f6455764e676d642e6a7067"></p>
<h3 id="常用功能"><a href="#常用功能" class="headerlink" title="常用功能"></a>常用功能</h3><h4 id="手动创建任务"><a href="#手动创建任务" class="headerlink" title="手动创建任务"></a>手动创建任务</h4><p>可以根据链接来创建一个任务，支持自定义请求头和请求体，具体请<a class="link" href="https://github.com/monkeyWie/proxyee-down/blob/master/.guide/common/create/read.md">查看<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<h4 id="刷新任务下载链接"><a href="#刷新任务下载链接" class="headerlink" title="刷新任务下载链接"></a>刷新任务下载链接</h4><p>当任务下载链接失效了，下载没速度或失败则可以使用刷新下载链接的功能，使用新的链接继续下载，具体请<a class="link" href="https://github.com/monkeyWie/proxyee-down/blob/master/.guide/common/refresh/read.md">查看<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<h4 id="百度云破解"><a href="#百度云破解" class="headerlink" title="百度云破解"></a>百度云破解</h4><h5 id="2018-03-29-更新"><a href="#2018-03-29-更新" class="headerlink" title="2018-03-29 更新"></a>2018-03-29 更新</h5><p>百度云近期对<strong>批量下载</strong>的并发连接数做了限制，如果选择的文件里包含文件夹，分段数需要建议不要超过 64，否则可能会导致任务下载失败或下载速度慢。</p>
<h5 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h5><p>百度云大文件、合并下载限制突破，成功安装下载器后，打开百度云页面会有如下提示，然后在选择文件后点击下载按钮即可调用 proxyee-down 下载<br><img lazyload="" src="/images/loading.svg" data-src="https://camo.githubusercontent.com/e7d9bbd0c3ec4105e152bfc026e8367a844cfe8c/68747470733a2f2f75706c6f61642e63632f69312f323031382f30392f31342f687a435a624a2e706e67"></p>
<h4 id="百度云解压工具"><a href="#百度云解压工具" class="headerlink" title="百度云解压工具"></a>百度云解压工具</h4><p>由于百度批量下载的 zip 压缩包不是 zip64 格式，在压缩包里有超过 4G 文件的时候普通的解压工具并不能正确的识别文件大小从而导致压缩失败，遇到这种情况时可以在下载器左侧<strong>工具</strong>栏目里找到百度云解压工具进行解压 [</p>
<h3 id="l-环境"><a href="#l-环境" class="headerlink" title="l 环境"></a>l 环境</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://img.shields.io/badge/JAVA-1.8%2B-brightgreen.svg"> <img lazyload="" src="/images/loading.svg" data-src="https://img.shields.io/badge/maven-3.0%2B-brightgreen.svg"> <img lazyload="" src="/images/loading.svg" data-src="https://img.shields.io/badge/node.js-8.0%2B-brightgreen.svg"></p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>linux 版</p>
<p><code>git clone https://github.com/monkeyWie/proxyee-down.gitcd proxyee-down/front#build htmlnpm installnpm run buildcd ../mainmvn clean package -Pprd</code></p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p><code>java -jar proxyee-down-main.jar</code></p>
<p>该软件使用需要配置环境，使用前请仔细阅读项目文档</p>
<p><a class="link" href="https://imhx-my.sharepoint.com/personal/pd_imhx_onmicrosoft_com/Documents/Forms/All.aspx?slrid=2ebb6f9e-f02a-0000-0801-89477ee2ed53&amp;RootFolder=/personal/pd_imhx_onmicrosoft_com/Documents/proxyee-down&amp;FolderCTID=0x012000536DC31294EC264084FE880734F95AEA">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link" href="https://github.com/proxyee-down-org/proxyee-down/blob/master/.guide/FAQ.md">常见问题列表<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>是否需要登录：否</p>
<p>运行环境：</p>
<ol>
<li><a class="link" href="https://github.com/monkeyWie/proxyee-down/blob/master/.guide/windows/read.md">Windows 安装教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://github.com/monkeyWie/proxyee-down/blob/master/.guide/mac/read.md">MAC 安装教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://github.com/monkeyWie/proxyee-down/blob/master/.guide/linux/read.md">Linux 安装教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ol>
<p>写个简单的教程，适用于 chrome：</p>
<p>1、下载软件，目前为 2.01 版，需要 64 位系统，<a class="link" href="http://static.kerwin.cn/file/2018/01/16/proxyee-down-2.0_full.7z">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>2、解压到非中文目录，打开 proxy-down.exe</p>
<p>3、安装证书：打开 <a class="link" href="http://127.0.0.1:9999/">http://127.0.0.1:9999/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>下载证书，双击打开证书，安装证书–将所有证书放入下列储存–受信任的根证书颁发机构，确认安装完成。</p>
<p>4、安装 SwitchyOmega 插件，<a class="link" href="https://my.kerwin.cn/index.php/s/U9eFiFJQKRs2Ppr">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，将 crx 文件拖拽到扩展程序中安装（或者直接从 chrome 网上应用店下载），新增一个情景模式 dl，依次填写：协议 http，代 li 服 wu 器 127.0.0.1，端口 9999，设置好之后应用一下，在 SwitchyOmega 中切换到这个模式。</p>
<p>然后，下载百度网盘资源的时候，就会调用 proxy-down.exe 这个软件下载了，</p>
<p>点击任务，可以看到各个线程的下载速度。</p>
<p>软件默认的是 10 线程，我的下载速度能达到 1.5M/s，觉得速度不好就多开启一些线程。</p>
<p>要上网的时候，SwitchyOmega 切换回正常模式。</p>
<h2 id="5-BaiduPCS-Go"><a href="#5-BaiduPCS-Go" class="headerlink" title="5.BaiduPCS-Go"></a>5.<strong>BaiduPCS-Go</strong></h2><h3 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h3><p>又是一款开源神器，开源大神多啊，多终端支持，支持手机</p>
<h3 id="特色"><a href="#特色" class="headerlink" title="特色"></a>特色</h3><p>多平台支持，支持 Windows, macOS, linux, 移动设备等.</p>
<p>百度帐号多用户支持；</p>
<p>通配符匹配网盘路径和 Tab 自动补齐命令和路径，<a class="link" href="https://baike.baidu.com/item/%E9%80%9A%E9%85%8D%E7%AC%A6">通配符_百度百科<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>;</p>
<p><a class="link" href="https://github.com/iikira/BaiduPCS-Go/#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95">下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>网盘内文件，支持多个文件或目录下载，支持断点续传和单文件并行下载；</p>
<p><a class="link" href="https://github.com/iikira/BaiduPCS-Go/#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95">上传<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>2GB 以内的文件，支持多个文件或目录上传；</p>
<p><a class="link" href="https://github.com/iikira/BaiduPCS-Go/#%E7%A6%BB%E7%BA%BF%E4%B8%8B%E8%BD%BD">离线下载<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, 支持 http/https/ftp/ 电驴 / 磁力链协议.</p>
<h3 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h3><p>友情提示：该软件使用命令行操作，给你不一样的感觉</p>
<p><a class="link" href="https://github.com/iikira/BaiduPCS-Go/">开源地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>（有使用介绍）</p>
<p><a class="link" href="https://github.com/iikira/BaiduPCS-Go/releases/">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>我写的 android 安装的一个脚本，需要配合 <a class="link" href="https://www.coolapk.com/apk/com.termux">高级终端 Termux<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 使用</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">wget -o install.sh http://www.tooln.cn/tool/1.sh &amp;&amp; bash install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置</span></span><br><span class="line">config set -savedir /sdcard/download</span><br><span class="line">config set -max_paralle1 80 -cache_size 5000</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">登录使用</span></span><br><span class="line">login</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载</span></span><br><span class="line">d 文件名</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下次进入App直接执行 ./run.sh</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>是否需要登录：需要</p>
<p>运行环境：Windows、linux、MacOS、android、ios</p>
<h2 id="6-YunDownload"><a href="#6-YunDownload" class="headerlink" title="6.YunDownload"></a>6.YunDownload</h2><h3 id="功能-特色"><a href="#功能-特色" class="headerlink" title="功能&amp;特色"></a>功能 &amp; 特色</h3><p>基于 BaiduPCS_NET 项目，主要汉化了部分说明文字，修改完善了其下载功能部分，去掉了不太稳定的上传部分；模拟客户端获取百度网盘的 vip 下载链接并导入 aria2 进行高速下载（原理等同 PanDownload），实测速度可以达到宽带上限，可以下载整个文件夹（非压缩）。</p>
<p>首发 52pojie 网，<a class="link" href="https://www.52pojie.cn/thread-740378-1-1.html">链接<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h3 id="防封号系统上线"><a href="#防封号系统上线" class="headerlink" title="防封号系统上线"></a>防封号系统上线</h3><p>大号如果被限速，下载速度始终徘徊在 1M/S 怎么办？2.0 版本强势推出 防封号系统，用大号登陆软件，用小号下载文件，再也不用担心账号被限速了，当然如果小号也被限速，那就重新注册一个小号接着干！！！（至于怎么注册小号，自己百度吧，不会再来找我）<br>使用教程：打开软件设置 — 小号设置 — 点击获取账号 BDUSS— 在新窗口登陆小号 — 复制 — 回到设置界面输入 BDUSS— 点击检测 — 无误后点击确认保存，然后没了，开始急速下载之旅吧。（小号的网盘剩余空间必须大于要下载的文件，否则系统无效）还不知道怎么用的自己摸索吧</p>
<p>下载链接：</p>
<p>链接: <a class="link" href="https://pan.baidu.com/s/1FhhoAmILmbv9iIEScR_8-A">https://pan.baidu.com/s/1FhhoAmILmbv9iIEScR_8-A<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 密码: rmuj</p>
<h2 id="7-speedpan-速盘"><a href="#7-speedpan-速盘" class="headerlink" title="7.speedpan 速盘"></a>7.speedpan 速盘</h2><p>官方网站 <a class="link" href="https://www.speedpan.com/">https://www.speedpan.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/18tmyh-6a.webp" alt="a9dc996d339820c3f7da150782ead763.jpg"></p>
<p>下载地址 <a class="link" href="https://www.lanzous.com/i1x2t3i">https://www.lanzous.com/i1x2t3i<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>baiduyun</tag>
      </tags>
  </entry>
  <entry>
    <title>秒杀系统总结 - 转</title>
    <url>/2019/94c04145.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>秒杀业务为什么难做</strong>？例如，小米手机每周二的秒杀，可能手机只有 1 万部，但瞬时进入的流量可能是几百几千万；12306 抢票，票是有限的，库存一份，瞬时流量非常多，都读相同的库存。读写冲突，锁非常严重，这是秒杀业务难的地方。</p>
<span id="more"></span>

<p>转载地址 <a class="link" href="https://fengberlin.github.io/post/seckill/">https://fengberlin.github.io/post/seckill/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><strong>秒杀业务场景具有典型的 “事务” 特性</strong>。<strong>秒杀业务的核心在于对库存的处理，也就是说减库存和记录购买明细</strong>。两者要形成一个完整的事务，然后这个事务要准确地数据落地（也就是反应到数据库具体的修改和插入等操作）。为什么需要事务？因为在这个秒杀操作中，如果没有事务，则很容易出现减了库存而没有记录购买明细或者记录了购买明细而没有减库存。即使存在事务，也会出现超卖 / 少卖问题。</p>
<p><strong>超卖</strong>：多个进程进入事务，产生共享锁，在 update 库存的时候，可能会出现查询库存都是大于 0 的，结果一减库存，出现库存小于 0，产生超卖现象。</p>
<p>在我做的一个秒杀的小项目中，我主要解决的是超卖现象（利用主键的唯一性以及事务、sql 语句的优化）和整个系统的响应性（主要思路是加缓存降低数据库的压力）。下面我们来讨论一下优化的具体做法。</p>
<h1 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h1><p>我们先来看一下没优化前，大量的请求是如何把系统搞瘫痪的。在前端，用户不断地去刷新页面去看一下秒杀时间到了没，除此之外，他们还会不断点击商品去查看秒杀商品的详细信息，并且他们还会尝试去秒杀同一件产品多次和秒杀不同的产品，更有甚者会利用爬虫等工具去不断地请求我们的各种页面。极小的时间段里面，大量的并发请求被发起，如果仅仅是由数据库去承受那么多的压力，势必会系统瘫痪。所以，在这里我们优化的思路会逐渐清晰，那就是尽量拦截用户的请求到数据层（后端数据库），降低后端数据库的压力，除此之外，需要利用缓存来降低数据库的压力。也就是说，我们有两个优化方向：</p>
<p>（1）<strong>将请求尽量拦截在系统上游</strong>（不要让锁冲突落到数据库上去，因为做写操作的时候会锁住行级锁，并发性能大大降低）。传统秒杀系统之所以挂，请求都压倒了后端数据层，数据读写锁冲突严重，并发高响应慢，几乎所有请求都超时，流量虽大，下单成功的有效流量甚小。以 12306 为例，一趟火车其实只有 2000 张票，200w 个人来买，基本没有人能买成功，请求有效率为 0。</p>
<p>（2）<strong>充分利用缓存</strong>，秒杀买票，这是一个典型的读多写少的应用场景，大部分请求是车次查询，车票查询，下单和支付才是写请求。一趟火车其实只有 2000 张票，200w 个人来买，最多 2000 个人下单成功，其他人都是查询库存，写比例只有 0.1%，读比例占 99.9%，非常适合使用缓存来优化。</p>
<h1 id="秒杀架构"><a href="#秒杀架构" class="headerlink" title="秒杀架构"></a>秒杀架构</h1><p>秒杀的整体架构分为 3 层（加上缓存也可以是 4 层），那我们既然用到了缓存，那么就按 4 层来说。4 层分别是客户端层（网页、app）、站点层（控制器，映射客户访问路径，访问后端数据）、服务层（向上游屏蔽底层数据细节，提供数据访问）、数据层（这里就是数据库所在的层，当然也会有我们的缓存如 redis）。我们要做的是尽量降低数据库层面的请求压力。</p>
<h1 id="各层次优化"><a href="#各层次优化" class="headerlink" title="各层次优化"></a>各层次优化</h1><p>（1）<strong>客户端层</strong></p>
<p>我们可以想一下秒杀时间到了，我们会点击秒杀按钮，但结果通常比较慢，这时我们会不自觉地多点几次，如果这没有限制，就平白无故地增加来系统负载，一个用户点击 5 次，但成功只会有一次（假设成功），那么在这种情况下就多出来了 80% 的无用请求，所以这是一个优化的点。</p>
<p>所以，在秒杀结束后和用户成功秒杀后将按钮置灰 (将 button 变成 disable)，使用户不能重复点击。然后查询的时候，可以限制用户几秒之后可以再执行查询操作。</p>
<p>（2）<strong>站点层</strong></p>
<p>对于普通用户的搞频度访问，我们可以在客户端层面就可以拦截，但对于一些用工具或爬虫的高级用户，在站点层面我们还可以对访问频率做一个限制。具体操作就是我们将用户的访问频率记录在 redis 中，key 为用户 id（唯一），然后值为我们设定的在有效期内能最多访问的次数，所以这个记录需要一个有效期。</p>
<p>（3）<strong>服务层</strong></p>
<p>层层拦截，就是不要让无实际意义的请求落到数据库层面上去。当参加秒杀的用户还是很多的时候，即使一人自由一个请求，那么到服务层的请求量还是很大的。比如我们有 100W 用户同时抢 100 台小米手机，服务层并发请求压力至少为 100W。那么我们明明知道秒杀的商品就只有那么多，那么这么多的请求其实没有必要传递到数据库层，所以这里还需要一层东西，那就是消息队列。有多少秒杀的商品，就透多少个请求到数据库。如果库存不够了，那么队列里的其他请求就返回失败信息。</p>
<p>对于用户的读请求（因为很多请求都是这种读请求），完全可以利用缓存。例如商品的详情页，一般是不会变的，那么可以在 redis 里面以商品的 id 为 key，对应的 html 页面为 value 来存储。还有可以把商品这个对象缓存到数据库中。以 id 为 key，value 为商品对象本身，通过序列化工具把商品对象序列化成字节数组。另外还可以缓存我们的秒杀地址（地址已进行 md5 加密）。</p>
<p>对于写请求，我们还可以把库存量存到 redis 中，每个商品以商品的 id 为 key，对应的库存量为 value 来存储，然后利用 redis 的原子减操作去操作库存，然后记录下用户的 id 和商品的 id，最后通过消息队列把秒杀请求消息，最后数据库消费消息并进行数据落地。</p>
<p>（4）<strong>数据（库）层</strong></p>
<p>浏览器拦截了 80%，站点层拦截了 99.9% 并做了页面缓存，服务层又做了写请求队列与数据缓存，每次透到数据库层的请求都是可控的。db 基本就没什么压力了，闲庭信步，单机也能扛得住，还是那句话，库存是有限的，透这么多请求来数据库没有意义。全部透到数据库，100w 个下单，0 个成功，请求有效率 0%。透 3k 个到数据，全部成功，请求有效率 100%。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>优化思路：</p>
<p>（1）<strong>尽量将请求拦截在系统上游</strong>（越上游越好）；</p>
<p>（2）<strong>读多写少的常用多使用缓存</strong>（缓存抗读压力）；</p>
<p>浏览器和 APP：做限速</p>
<p>站点层：按照 uid 做限速，做页面缓存</p>
<p>服务层：按照业务做写请求队列控制流量，做数据缓存</p>
<p>数据层：闲庭信步</p>
<p>并且：结合业务做优化</p>
<h1 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><ol>
<li><strong>如何解决超卖？</strong></li>
</ol>
<p>有如下几句减库存的逻辑：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Tansactional</span></span><br><span class="line">  ...</span><br><span class="line">  count = execute(<span class="string">"select amount from stock where stockId = ..."</span>);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"库存不够"</span></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">      updateCount = execute(<span class="string">"update stock set amount = amount -1 where stockId = ..."</span>);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure></div>



<p>在高并发的场景下，当两个线程进入这个事务，由于读操作产生共享锁，可以一起读，两个线程都读到库存大于 0，假设现在它们都读到库存为 1，那么在下一步中，它们都会去执行 update 操作，最终导致库存减为负数，这就导致了超卖。解决方案：</p>
<p>（1）优化 sql 语句：select 语句去掉，在 update 语句中把判断库存的条件加上去。如：<code>update stock set amount = amount -1 where stockId = ... and amount &gt; 0</code>。当两个进程进入到同一事务的这条 update 语句，行级锁发挥作用，将锁住这行数据交由一个线程操作。貌似这个效率会比较低。</p>
<p>（2）利用 redis 操作库存：前面提到，可以利用 redis 来进行减库存操作，这个是因为 redis 的自减操作是原子的，可以很好地保证线程安全。使用 redis 的事务，WATCH 住存储库存量的 key，在 WATCH 之后，EXEC 执行之前，如果 key 的值发生变化，则 EXEC 会失败。redis 的 WATCH 为何能够保证事务性，本质上，它使用的就是乐观锁 CAS 机制。</p>
<p>这里还有一个例子：减库存分为 3 各步骤，分别为查询、扣减和设置，如果此时扣减这个操作有重试机制，那么在重试时，可能会得到错误的数据，导致重复扣减。具体见<a class="link" href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect">《库存扣多了，到底怎么整 | 架构师之路》<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<ol>
<li><strong>秒杀接口地址如何设计？</strong></li>
</ol>
<p>用一个类来暴露秒杀接口，里面有 md5 字段用来加密秒杀地址，有是否暴露接口的标志，如果秒杀时间还没到，则不暴露，否则通过秒杀商品的 id 加上 salt 构造 md5，使得用户不能猜到我们的秒杀地址从而提前进行秒杀。</p>
<ol>
<li><strong>先减库存后记录秒杀明细还是先记录秒杀明细后减库存？</strong></li>
</ol>
<p>实际上两者都可以。但是，在我的小项目上，使用的是后者。为什么？很重要的一点是可以减少网络传输等延迟。先减库存，当一个线程锁住了行级锁，那么其他线程都需要等待，返回 update 操作结果后，如果成功，这个线程开始 insert 操作。每个线程都需要这样的操作。当我先插入秒杀明细的时候，这个时候由于是 insert 操作，可以并发执行，所以这样减少来一部分的网络延迟，最后才是减库存。</p>
<ol>
<li><strong>哪个操作需要事务？</strong></li>
</ol>
<p>插入秒杀明细 + 减库存（由于这个项目里面只实现来这个核心功能，所以就只有一个事务）。由于明细表设置了商品 id 和用户的唯一标识作为联合主键，所以能有效避免重复秒杀，如果在插入秒杀明细不成功的时候，抛出异常并进行 rollback。</p>
<p>由于这只是一个非常非常小的项目，但是对于理解秒杀的业务是有一定帮助的，上面我所说的并不一定是实际业务所一定采取的方案，所以到时候到公司里面接触到相关业务的时候会有更深的理解。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a class="link" href="https://fengberlin.github.io/post/seckill/(https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959391&amp;idx=1&amp;sn=fb28fd5e5f0895ddb167406d8a735548&amp;scene=21#wechat_redirect)">《秒杀系统架构优化思路》<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect">《库存扣多了，到底怎么整 | 架构师之路》<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960200&amp;idx=1&amp;sn=fdec629caceee07b3946b6c338b8ceb7&amp;chksm=bd2d06548a5a8f424dd32be960222edf5cecc3c1e5a8fcbb4cfff35e7da6787e702861131597&amp;scene=21#wechat_redirect">《库存扣减还有这么多方案？ | 架构师之路》<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="http://www.cnblogs.com/andy-zhou/p/5364136.html">《秒杀系统架构分析与实战》<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" href="https://www.csdn.net/article/2014-11-07/2822545">《“米粉节” 背后的故事 —— 小米网抢购系统开发实践》<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ol>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>程序启动器</title>
    <url>/2022/218063510.html</url>
    <content><![CDATA[<p>顾名思义，程序启动器仅作为一个程序的独立入口，和命令行 <code>start xxx</code> 有一样的功能，多一个启动器，也就是为程序入口加个 LOGO<br>本启动器使用 <code>GO</code> 实现</p>
<span id="more"></span>

<h2 id="1-配置文件"><a href="#1-配置文件" class="headerlink" title="1. 配置文件"></a>1. 配置文件</h2><p>为了使程序在使用过程中更加灵活，我们需要一个设计一个配置文件 <code>launcher.json</code></p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"target"</span><span class="punctuation">:</span> <span class="string">"ping"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"workDir"</span><span class="punctuation">:</span> <span class="string">"."</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"params"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"www.baidu.com"</span><span class="punctuation">,</span> <span class="string">"-n"</span><span class="punctuation">,</span> <span class="string">"2"</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>配置文件初步需求为三个参数，目标命令（target）、执行目录（workDir）、参数（params）</p>
<h2 id="2-解析配置文件"><a href="#2-解析配置文件" class="headerlink" title="2. 解析配置文件"></a>2. 解析配置文件</h2><p>在代码中定义文件对象属性</p>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> LaunchConfig <span class="keyword">struct</span> {</span><br><span class="line">	Target  <span class="type">string</span>   <span class="string">`json:"target"`</span></span><br><span class="line">	WorkDir <span class="type">string</span>   <span class="string">`json:"workDir"`</span></span><br><span class="line">	Params  []<span class="type">string</span> <span class="string">`json:"params"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>加载配置文件</p>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tbody><tr><td class="code"><pre><span class="line">JsonParse := NewJsonConfig()</span><br><span class="line">v := LaunchConfig{}</span><br><span class="line">JsonParse.LoadConfig(<span class="string">"launcher.json"</span>, &amp;v)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="3-为启动器加锁"><a href="#3-为启动器加锁" class="headerlink" title="3. 为启动器加锁"></a>3. 为启动器加锁</h2><p>通过加锁的方式保证程序同一时间内不可启动多次</p>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tbody><tr><td class="code"><pre><span class="line">_, err := os.Stat(<span class="string">".lock.loop"</span>)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> || os.IsExist(err) {</span><br><span class="line">    file, _ = os.OpenFile(<span class="string">"README.Use.txt"</span>, os.O_CREATE|os.O_WRONLY, <span class="number">0666</span>)</span><br><span class="line">    file.WriteAt([]<span class="type">byte</span>(<span class="string">"u must shutdown the exe and then remove .lock.loop file"</span>), <span class="number">0</span>)</span><br><span class="line">    file.Close()</span><br><span class="line">    fmt.Println(<span class="string">"u must shutdown the exe and then remove .lock.loop file"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// 加锁</span></span><br><span class="line">file, _ = os.Create(<span class="string">".lock.loop"</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="4-支持命令行附加参数"><a href="#4-支持命令行附加参数" class="headerlink" title="4. 支持命令行附加参数"></a>4. 支持命令行附加参数</h2><div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 将命令行参数 合并到配置文件的参数后面</span></span><br><span class="line">cmd := exec.Command(v.Target, <span class="built_in">append</span>(v.Params, args...)...)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="5-启动子进程"><a href="#5-启动子进程" class="headerlink" title="5.启动子进程"></a>5. 启动子进程</h2><div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tbody><tr><td class="code"><pre><span class="line">cmd.Dir = v.WorkDir</span><br><span class="line">cmd.Env = os.Environ()</span><br><span class="line"><span class="comment">// 重定向子进程的错误输出</span></span><br><span class="line">cmd.Stderr = os.Stderr</span><br><span class="line">cmd.Start()</span><br><span class="line"><span class="comment">// cmd.Wait()</span></span><br><span class="line">fmt.Printf(<span class="string">"[PID] %d running...\n"</span>, cmd.Process.Pid)</span><br><span class="line">file.Close()</span><br><span class="line">os.Remove(<span class="string">".lock.loop"</span>)</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h2><p>总体来说是一个比较简单的练手程序，程序源代码地址 <a class="link" href="https://github.com/tsvico/launcher">source<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title>笔记本电脑远程开关机</title>
    <url>/2025/4151791544.html</url>
    <content><![CDATA[<p>接上文<a href="/2024/1104496865.htm">电脑实现小爱语音关机</a> , <code>点灯</code>家的 <code>nodejs sdk</code> 使用小爱控制老是报” 要操作的设备要出问题了，请稍候再试吧”，经过一番查找，找到 <a class="link" href="https://www.52pojie.cn/thread-1921792-1-1.html">将电脑接入米家，远程、语音开关机，推送消息<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>、<a class="link" href="https://www.cnblogs.com/hackyo/p/18000627">电脑接入米家，控制电脑开关机（无需购买外设）<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，看了这两个方案很心动 💓，这两个方案都是部署在外部机器上的，且主要使用 <code>wol</code>，不是很贴合我的需求，先记录，后边再慢慢搞。</p>
<span id="more"></span>

<p>参考文章<a class="link" href="https://tuuuu.top/post/62d97049">笔记本电脑远程开关机<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，非常感谢 🙏，恰巧我也是用的插座，我目前也是用的笔记本，总体来说此方案对目前我的设备来说非常完美，后续升级机器了再折腾别的</p>
<blockquote>
<p>Tips：笔记本的自带电池必须能用，可能续航不行，但至少断开电源适配器后也能正常运行一分钟，如果电池已经完全坏掉，断开电源就关机的话，可能不适用这个程序，因为可能程序没有执行的时间电脑就已经没电物理强制关机了</p>
</blockquote>
<h2 id="来电自动开机"><a href="#来电自动开机" class="headerlink" title="来电自动开机"></a>来电自动开机</h2><p>笔记本网上搜一下吧，我是老联想笔记本，借鉴的这个文章<a class="link" href="https://blog.csdn.net/qq_33265520/article/details/125344593">联想拯救者 Lenovo Legion 通电自启 插电自启 通电开机 插电开机 Wake on AC<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，我笔记本的配置在 <code>Advanced&gt;PCH-IO Configuration&gt;State After G3</code></p>
<h2 id="程序实现断开电源关机或休眠"><a href="#程序实现断开电源关机或休眠" class="headerlink" title="程序实现断开电源关机或休眠"></a>程序实现断开电源关机或休眠</h2><p>程序非常简单，十几行，C++ 编写</p>
<div class="code-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WIndows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment( linker, <span class="string">"/subsystem:\"windows\" /entry:\"mainCRTStartup\""</span> )</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>{</span><br><span class="line">    SYSTEM_POWER_STATUS powerStatus;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line">        <span class="built_in">GetSystemPowerStatus</span>(&amp;powerStatus);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">int</span>) powerStatus.ACLineStatus == <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">system</span>(<span class="string">"shutdown -h"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>原理就是通过 <code>Windows API</code> 获取电脑的电源状态，即 <code>ACLineStatus</code>，判断有没有断开电源，没有就等五秒钟再获取一次再判断；如果已经断开电源了，就执行休眠的 Shell 命令，当然也可以换成其他比如关机或重启命令，只需将 system 引号中内容替换成下面所需指令即可。</p>
<ol>
<li>一段时间后关机：<code>shutdown -s -t 秒数</code></li>
<li>立即关机命令：<code>shutdown -p</code></li>
<li>一段时间后重启：<code>shutdown -r -t 秒数</code></li>
<li>休眠命令：<code>shutdown -h</code></li>
</ol>
<p>tip: 对于从源博客下载的程序，我在使用过程中发现有控制台窗口。遂使用 gcc 自己编译了一份</p>
<details>
<summary>点击查看详细内容</summary>
GCC 编译 Win 图形程序不显示控制台方法
用 VS 编译 openCV 这些有控制台又有图形显示的程序，如果想隐藏控制台，只需要使用一行代码：

<div class="code-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment( linker, <span class="string">"/subsystem:/"</span>windows/<span class="string">" /entry:/"</span>mainCRTStartup/<span class="string">""</span> )</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>但是这个指令只有 VS 的编译器才支持，想用 GCC 编译 Windows 的图形界面程序但又不显示控制台，查了很久的资料，终于找到了对应的编译指令：</p>
<div class="code-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line">gcc -mwindows gui.cpp -o guinocmd.exe</span><br></pre></td></tr></tbody></table></figure></div>

<p>需要在 GCC 编译的时候带上 <code>-mwindows</code></p>
</details>

<h2 id="开机自启该程序"><a href="#开机自启该程序" class="headerlink" title="开机自启该程序"></a>开机自启该程序</h2><p>我直接下载的源博客的，这里转存到了<code>蓝奏云</code><br>程序仅 <code>11kb</code>，程序名为 <code>AutoShutDownPC.exe</code><br>键盘按下 <code>Win+R</code>，输入 <code>shell:Common Startup</code>，进入开机自启目录，将程序放入该目录即可，重启电脑后该程序即可开机自启。</p>
<blockquote>
<p><a class="link" href="https://tsvico.lanzouw.com/b00efcpupi">https://tsvico.lanzouw.com/b00efcpupi<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>密码：9six</p>
</blockquote>
<h2 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h2><p>至此，关闭电脑电源后笔记本就会触发自动关机，打开电源触发开机，配合小爱音箱，就可以实现远程开关机了</p>
]]></content>
      <tags>
        <tag>c</tag>
      </tags>
  </entry>
  <entry>
    <title>java 笔试知识点</title>
    <url>/2019/9150d7e1.html</url>
    <content><![CDATA[<p>记录一些知识点</p>
<span id="more"></span>

<h3 id="常用的排序算法"><a href="#常用的排序算法" class="headerlink" title="常用的排序算法"></a>常用的排序算法</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2019/08/21/mN3vFO.png" alt="mN3vFO.png"></p>
<h3 id="经常用到的类"><a href="#经常用到的类" class="headerlink" title="经常用到的类"></a>经常用到的类</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095442199.webp" alt="img"></p>
<h3 id="try-中-return-和-finally-谁先执行"><a href="#try-中-return-和-finally-谁先执行" class="headerlink" title="try 中 return 和 finally 谁先执行"></a>try 中 return 和 finally 谁先执行</h3><p>先来看一段代码：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        System.out.println(beforeFinally());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">beforeFinally</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            a = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        }<span class="keyword">finally</span>{</span><br><span class="line">            a = <span class="number">2</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**output:</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>从结果上看，貌似 <code>finally</code> 里的语句是在 <code>return</code> 之后执行的，其实不然，实际上 <code>finally</code> 里的语句是在在 <code>return</code> 之前执行的。那么问题来了，既然是在之前执行，那为什么 <code>a</code> 的值没有被覆盖了？<br>实际过程是这样的：当程序执行到 try {} 语句中的 return 方法时，它会干这么一件事，将要返回的结果存储到一个临时栈中，然后程序不会立即返回，而是去执行 finally {} 中的程序， <strong>在执行 <code>a = 2</code> 时，程序仅仅是覆盖了 a 的值，但不会去更新临时栈中的那个要返回的值</strong> 。执行完之后，就会通知主程序 “finally 的程序执行完毕，可以请求返回了”，这时，就会将临时栈中的值取出来返回。这下应该清楚了，要返回的值是保存至临时栈中的。</p>
<p>再来看一个例子，稍微改下上面的程序：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        System.out.println(beforeFinally());</span><br><span class="line">      }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">beforeFinally</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span>  <span class="number">0</span> ;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            a = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        }<span class="keyword">finally</span>{</span><br><span class="line">            a = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**output:2*/</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>在这里，finally {} 里也有一个 return，那么在执行这个 return 时，就会更新临时栈中的值。同样，在执行完 finally 之后，就会通知主程序请求返回了，即将<code>临时栈</code>中的值取出来返回。故返回值是 2.</p>
<h3 id="类访问权限"><a href="#类访问权限" class="headerlink" title="类访问权限"></a>类访问权限</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/191t2x-z5.webp" alt="image.png"></p>
<blockquote>
<p>protected 在同一个包下是可以访问的</p>
</blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2019/08/23/mBsGnA.png" alt="mBsGnA.png"></p>
<table>
<thead>
<tr>
<th>作用域</th>
<th>当前类</th>
<th>同一 package</th>
<th> 子孙类</th>
<th>其他 package</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>friendly</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>×</td>
</tr>
</tbody></table>
<p>没有时默认为 friendly，如构造函数等～</p>
<h3 id="调用构造方法"><a href="#调用构造方法" class="headerlink" title="调用构造方法"></a>调用构造方法</h3><p>1.new 语句创建对象</p>
<p>2.Java 反射机制</p>
<h3 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2018/04/20250415095330556.webp"></p>
<p>一趟结束后能够确定一个元素的最终位置的排序方法有： 简单选择排序、快速排序、冒泡排序、堆排序</p>
<blockquote>
<p>物理层：中继器、集线器</p>
<p>数据链路层：网桥、交换器</p>
<p>网络层：路由器</p>
<p>网络层以上：网关</p>
</blockquote>
<h3 id="接口和抽象类区别"><a href="#接口和抽象类区别" class="headerlink" title="接口和抽象类区别"></a>接口和抽象类区别</h3><p><img lazyload="" src="/images/loading.svg" data-src="https://s2.ax1x.com/2019/08/26/mROiGj.png" alt="mROiGj.png"></p>
<blockquote>
<p>这是初学者经常会遇到的问题，看到这个问题，自己想起来以前痛苦的学习过程。简单的回答一下。接口和抽象类之间有没有区别？可以肯定的回答：有区别。那既然有区别，我们不妨带着疑问去探索一下，语言设计者们在设计接口和抽象类时为什么要设计出区别，他们的目的何在。编程语言的设计其实也是一门哲学。</p>
</blockquote>
<blockquote>
<p>首先接口和抽象类的设计目的就是不一样的。接口是对动作的抽象，而抽象类是对根源的抽象。对于抽象类，比如男人，女人这两个类，那我们可以为这两个类设计一个更高级别的抽象类–人。对于接口，我们可以坐着吃饭，可以站着吃饭，可以用筷子吃饭，可以用叉子吃饭，甚至可以学三哥一样用手抓着吃饭，那么可以把这些吃饭的动作抽象成一个接口–吃饭。所以在高级语言中（如 Java,C#），一个类只能继承一个抽象类（因为你不可能同时是生物又是非生物）。但是一个类可以同时实现多个接口，比如开车接口，滑冰接口，啪啪啪接口，踢足球接口，游泳接口。</p>
</blockquote>
<blockquote>
<p>总结几句话来说：</p>
<p>1、抽象类和接口都不能被直接实例化，如果二者要实例化，就涉及到多态，不懂多态的参见我的回答 <a class="link" href="https://www.zhihu.com/question/30082151/answer/120520568">JAVA 的多态用几句话能直观的解释一下吗？<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。如果抽象类要实例化，那么抽象类定义的变量必须指向一个子类对象，这个子类继承了这个抽象类并实现了这个抽象类的所有抽象方法。如果接口要实例化，那么这个接口定义的变量要指向一个子类对象，这个子类必须实现了这个接口所有的方法。<br>2、抽象类要被子类继承，接口要被子类实现。<br>3、接口里面只能对方法进行声明，抽象类既可以对方法进行声明也可以对方法进行实现。<br>4、抽象类里面的抽象方法必须全部被子类实现，如果子类不能全部实现，那么子类必须也是抽象类。接口里面的方法也必须全部被子类实现，如果子类不能实现那么子类必须是抽象类。<br>5、接口里面的方法只能声明，不能有具体的实现。这说明接口是设计的结果，抽象类是重构的结果。</p>
<p>6、抽象类里面可以没有抽象方法。</p>
<p>7、如果一个类里面有抽象方法，那么这个类一定是抽象类。</p>
<p>8、抽象类中的方法都要被实现，所以抽象方法不能是静态的 static，也不能是私有的 private。</p>
<p>9、接口（类）可以继承接口，甚至可以继承多个接口。但是类只能继承一个类。</p>
<p>10、抽象级别（从高到低）：接口 &gt; 抽象类 &gt; 实现类。</p>
<p>11、抽象类主要是用来抽象类别，接口主要是用来抽象方法功能。当你关注事物的本质的时候，请用抽象类；当你关注一种操作的时候，用接口。</p>
<p>12、抽象类的功能应该要远多于接口，但是定义抽象类的代价较高。因为高级语言一个类只能继承一个父类，即你在设计这个类的时候必须要抽象出所有这个类的子类所具有的共同属性和方法；但是类（接口）却可以继承多个接口，因此每个接口你只需要将特定的动作方法抽象到这个接口即可。也就是说，接口的设计具有更大的可扩展性，而抽象类的设计必须十分谨慎</p>
</blockquote>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>算法分析</title>
    <url>/2018/d68e5e2f.html</url>
    <content><![CDATA[<p>一些简单的算法</p>
<blockquote>
<p>八皇后问题</p>
<p>查找（哨兵）</p>
</blockquote>
<span id="more"></span>

<h2 id="八皇后问题"><a href="#八皇后问题" class="headerlink" title="八皇后问题"></a>八皇后问题</h2><blockquote>
<p>八皇后问题是一个以国际象棋为背景的问题：如何能够在 8×8 的国际象棋棋盘上放置八个皇后，使得任何一个皇后都无法直接吃掉其他的皇后？为了达到此目的，任两个皇后都不能处于同一条横行、纵行或斜线上。八皇后问题可以推广为更一般的 n 皇后摆放问题：这时棋盘的大小变为 n1×n1，而皇后个数也变成 n2。而且仅当 n2 = 1 或 n1 ≥ 4 时问题有解。</p>
</blockquote>
<p>问题解析：8*8 棋盘上每行每列都有一个皇后，且任意两皇后不能处于同一行、同一列、同一斜线上</p>
<p>为了简化问题，下面讨论四皇后问题。回溯法从空棋盘开始，首先把皇后 1 摆放到它所在行的第一个位置，也就是第一行第一列，得到图 8.7 (a)。</p>
<p>对于皇后 2，在经过第一列和第二列的尝试后，摆放到第二行第三列，得到图 8.7 (b)。</p>
<p>对于皇后 3，摆放到第三行的哪一列都会引起冲突 (即违反约束条件)，进行回溯，回<br>到对皇后 2 的处理，把皇后 2 摆放到下一个位置，也就是第二行第四列，得到图 8.7 (d)。</p>
<p>对于皇后 3，在经过第一列的尝试后，摆放到第三行第二列，得到图 8.7 (e)。</p>
<p>对于皇后 4，摆放到第四行的哪一列上都会引起冲突，进行回溯，回到对皇后 3 的处<br>理；皇后 3 摆放到第三行的哪一列上都会引起冲突，再次进行回溯，但此时皇后 2 位于棋<br>盘的最后一列，继续回溯，回到对皇后 1 的处理，把皇后 1 摆放到第一行第一列，得到<br>图 8.7 (g)。</p>
<p>接下来，把皇后 2 摆放第二行第四列的位置，把皇后 3 摆放到第三行第一列的位置，把皇后 4 摆放到第四行第三列的位置，得到四皇后问题的一个解，如图 8.7 (j) 所示。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1afq2m-kc.webp" alt="image.png"></p>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><p>【算法】设函数 Queen 实现 n 皇后问题，皇后 k 摆放在 k 行 x [k] 列的位置，算法用伪代码描述如下。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">算法8.3:回溯法求解n皇后问题Queen</span><br><span class="line">输人:皇后的个数n</span><br><span class="line">输出:n皇后问题的解x[n]</span><br><span class="line">1.初始化解向量x[n]={-1};</span><br><span class="line">2.k=1;</span><br><span class="line">3.while(k&gt;=1)</span><br><span class="line"> 3.1 把皇后k摆放在下一列的位置,即x[k]++;</span><br><span class="line"> 3.2 从x[k]开始依次考察每一列,如果皇后k摆放在x[k]位置不发生冲突,则转步骤3.3;</span><br><span class="line">  否则x[k]++试探下一列;</span><br><span class="line"> 3.3 若n个皇后已全部摆放,则输出一个解,算法结束;</span><br><span class="line"> 3.4 若尚有皇后没摆放,则k++,转步骤3摆放下一个皇后;</span><br><span class="line"> 3.5 若x[k]出界,则回溯,x[k]=-1,k--,转步骤3重新摆放皇后k;</span><br><span class="line">4.退出循环,说明n皇后问题无解;</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/***************</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">八皇后问题</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Queen</span><span class="params">(<span class="type">int</span> k)</span></span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> n=<span class="number">8</span>;</span><br><span class="line"><span class="type">int</span> x[n];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line"> <span class="built_in">Queen</span>(n);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Place</span><span class="params">(<span class="type">int</span> k)</span></span>{                                   <span class="comment">//考察皇后k放在 x[k]是否发生冲突</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;k;i++)</span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">if</span> (x[i]==x[k] || <span class="built_in">abs</span>(i-k)==<span class="built_in">abs</span>(x[i]-x[k])) <span class="comment">//abs() 求绝对值 ||违反约束条件</span></span><br><span class="line">  {</span><br><span class="line">   <span class="keyword">return</span> <span class="number">1</span>;                               <span class="comment">//冲突，返回1</span></span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;                                       <span class="comment">//不冲突，返回0</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Queen</span><span class="params">(<span class="type">int</span> n)</span></span>{                                    <span class="comment">//求解n皇后问题</span></span><br><span class="line"> <span class="type">int</span> k=<span class="number">0</span>;                                          <span class="comment">//皇后</span></span><br><span class="line"> <span class="keyword">while</span> (k&gt;=<span class="number">0</span>)</span><br><span class="line"> {</span><br><span class="line">  x[k]++;                                       <span class="comment">//在下一列排放皇后</span></span><br><span class="line">  <span class="keyword">while</span> (x[k]&lt;n &amp;&amp; <span class="built_in">Place</span>(k)==<span class="number">1</span>)                 <span class="comment">//发生冲突</span></span><br><span class="line">  {</span><br><span class="line">   x[k]++;                                   <span class="comment">//皇后k试探下一列</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (x[k]&lt;n &amp;&amp; k==n<span class="number">-1</span>)                         <span class="comment">//得到下一个解，输出</span></span><br><span class="line">  {</span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++){</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;x[i];j++){</span><br><span class="line">       cout&lt;&lt;<span class="string">"□ "</span>;</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">if</span>(x[i]&lt;<span class="number">9</span>){</span><br><span class="line">           cout&lt;&lt;x[i]<span class="number">+1</span>&lt;&lt;<span class="string">" "</span>;  <span class="comment">//数组下标从0开始，打印的序号从1开始</span></span><br><span class="line">       }<span class="keyword">else</span>{</span><br><span class="line">           cout&lt;&lt;x[i]<span class="number">+1</span>;  <span class="comment">//数组下标从0开始，打印的序号从1开始</span></span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=n<span class="number">-1</span>;j&gt;x[i];j--)</span><br><span class="line">       {</span><br><span class="line">           cout&lt;&lt;<span class="string">"□ "</span>;</span><br><span class="line">       }</span><br><span class="line">       cout&lt;&lt;endl;</span><br><span class="line">   }</span><br><span class="line">   cout&lt;&lt;endl;</span><br><span class="line">   <span class="keyword">return</span> ;                                  <span class="comment">//只求出一个解</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span>(x[k]&lt;n &amp;&amp; k&lt;n<span class="number">-1</span>)                           <span class="comment">//尚有皇后未摆放</span></span><br><span class="line">   k = k <span class="number">+1</span>;                                 <span class="comment">//准备拜访下一个皇后</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">   x[k--] = <span class="number">-1</span>;                              <span class="comment">//重置x[k],回溯，重新摆放皇后k</span></span><br><span class="line"> }</span><br><span class="line"> cout&lt;&lt;<span class="string">"无解"</span>&lt;&lt;endl;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1b1gei-ie.webp" alt="image.png"></p>
<h2 id="遍历查找（哨兵）"><a href="#遍历查找（哨兵）" class="headerlink" title="遍历查找（哨兵）"></a>遍历查找（哨兵）</h2><p>利用<code>观察哨</code>，则无需判断查找是否越界</p>
<p>较传统蛮力查找，设置<code>观察哨</code>他们的时间复杂度都是 O (n)，而系数相差一倍。实验表明，设置<code>观察哨</code>之后的算法在表长大于 1000 时，一次顺序查找的时间几乎一半</p>
<p>算法 c++ 核心代码</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">SeqSearch2</span><span class="params">(<span class="type">int</span> r[],<span class="type">int</span> n,<span class="type">int</span> k)</span> <span class="comment">//数组r[1]~r[n]存放查找集合</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i=n;  <span class="comment">//从数组最高端开始查找</span></span><br><span class="line">    r[<span class="number">0</span>] = k;  <span class="comment">//设置哨兵</span></span><br><span class="line">    <span class="keyword">while</span>(r[i] != k)</span><br><span class="line">        i--;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>以后想起来什么再写，先到这，继续写 python</p>
]]></content>
      <tags>
        <tag>c++</tag>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>编译环境核心已转储</title>
    <url>/2018/c612f7a3.html</url>
    <content><![CDATA[<h1 id="常见运行时错误"><a href="#常见运行时错误" class="headerlink" title="常见运行时错误"></a>常见运行时错误</h1><h2 id="1-terminate-called-after-throwing-an-instance-of-‘std-bad-alloc’-what-std-bad-alloc-已放弃-核心已转储"><a href="#1-terminate-called-after-throwing-an-instance-of-‘std-bad-alloc’-what-std-bad-alloc-已放弃-核心已转储" class="headerlink" title="1. terminate called after throwing an instance of ‘std::bad_alloc’ what():&nbsp;&nbsp;std::bad_alloc 已放弃 &nbsp;(核心已转储)"></a>1. terminate called after throwing an instance of ‘std::bad_alloc’ what ():&nbsp;&nbsp;std::bad_alloc 已放弃 &nbsp;(核心已转储)</h2><span id="more"></span>

<p>下面这个错误，我的程序在数据量太大才出现的。分析了一下，确定以前遗留代码中频繁的使用 new 生成数组，再使用 delete [] 删除。最后修改为声明数组（我的程序只需要一个读写 buffer 区）:</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">terminate called after throwing an instance of <span class="string">'std::bad_alloc'</span></span><br><span class="line">  what():  std::bad_alloc</span><br><span class="line">Aborted</span><br></pre></td></tr></tbody></table></figure></div>

<p>偶然遇到这个问题，通过虚拟机提升内存解决了</p>
<h2 id="1-2-free-invalid-next-size-fast"><a href="#1-2-free-invalid-next-size-fast" class="headerlink" title="1.2 free(): invalid next size (fast)"></a>1.2 free(): invalid next size (fast)</h2><p>不合理生成 malloc 的问题：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">*** glibc detected *** ./p_main: free(): invalid next size (fast): 0x08cec800 ***</span><br></pre></td></tr></tbody></table></figure></div>

<p>我的情况是，声明一个 char 指针存放数据，未能考虑末尾的 ‘0’ ， 故 free 释放出错：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">  tmpdir = (char *)malloc (strlen (<span class="built_in">dir</span>) + 1 + 1);</span><br><span class="line"></span><br><span class="line">strcpy (tmpdir, <span class="built_in">dir</span>);</span><br><span class="line">  <span class="keyword">if</span> (tmpdir[strlen (tmpdir) - 1] != <span class="string">'/'</span>)</span><br><span class="line">    strcat (tmpdir, <span class="string">"/"</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">我的总结：线程中如果频繁的使用malloc()即使正常的free()，这也是会出错的，要不就是段错误，要不就是</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="terminate-called-after-throwing-an-instance-of-‘std-bad-alloc’等等一些诡异的错误，我去，一定不能够频繁的使用-malloc-哦，记住哦。频繁指的是：程序中频繁的调-malloc"><a href="#terminate-called-after-throwing-an-instance-of-‘std-bad-alloc’等等一些诡异的错误，我去，一定不能够频繁的使用-malloc-哦，记住哦。频繁指的是：程序中频繁的调-malloc" class="headerlink" title="terminate called after throwing an instance of ‘std::bad_alloc’等等一些诡异的错误，我去，一定不能够频繁的使用 malloc()哦，记住哦。频繁指的是：程序中频繁的调 malloc()"></a>terminate called after throwing an instance of ‘std::bad_alloc’等等一些诡异的错误，我去，一定不能够频繁的使用 malloc () 哦，记住哦。频繁指的是：程序中频繁的调 malloc ()</h2><p>2. 写文件的时候，千万不要写 string 到文件里面去阿，要不然呀，会高丝你的。</p>
]]></content>
      <tags>
        <tag>c++</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化测试之 selenium</title>
    <url>/2018/90af9345.html</url>
    <content><![CDATA[<p>关于自动化测试的一种插件，记录一下</p>
<p>selenium 是一个用于 Web 应用程序测试的工具。Selenium 测试直接运行在浏览器中，就像真正的用户在操作一样。支持的浏览器包括 IE（7, 8, 9, 10, 11），Mozilla Firefox，Safari，Google Chrome，Opera 等。这个工具的主要功能包括：测试与浏览器的兼容性 —— 测试你的应用程序看是否能够很好得工作在不同浏览器和操作系统之上。测试系统功能 —— 创建回归测试检验软件功能和用户需求。支持自动录制动作和自动生成 .Net、Java、Perl 等不同语言的测试脚本。&nbsp; selenium 用于爬虫，主要是用来解决 javascript 渲染的问题</p>
<span id="more"></span>

<h2 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h2><p>java 的安装需要导入相关 jar 包，<a class="link" href="https://www.cnblogs.com/hanlong/p/5258706.html">导入教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>selenium 下载最新版本，在官网下载 —&gt; <a class="link" href="http://selenium-release.storage.googleapis.com/3.5/selenium-java-3.5.2.zip">下载地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>或者下载 selenium-server-standalone 包在 <a class="link" href="http://selenium-release.storage.googleapis.com/index.html">http://selenium-release.storage.googleapis.com/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>java 的一些方法和 Python 类似，写在文末，直达车 —-&gt; <a href="http://blog.tbox.fun/2018/90af9345.html#%E5%9C%A8java%E4%B8%AD%E7%9A%84%E7%94%A8%E6%B3%95">滴滴滴</a></p>
<p>Python 安装相对简单</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo pip install selenium</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="驱动安装"><a href="#驱动安装" class="headerlink" title="驱动安装"></a>驱动安装</h2><p>由于如果需要使用 selenium 的话，需要为本机配置对应浏览器的驱动，下面以 chomedriver 为例，首先安装 chromedriver，chromedriver 与支持对应的 chrome 版本如下：</p>
<p>附 chromedriver 与 chrome 的对应关系表：</p>
<table>
<thead>
<tr>
<th>chromedriver 版本</th>
<th>支持的 Chrome 版本</th>
</tr>
</thead>
<tbody><tr>
<td> v2.40</td>
<td>v66-68</td>
</tr>
<tr>
<td>v2.39</td>
<td>v66-68</td>
</tr>
<tr>
<td>v2.38</td>
<td>v65-67</td>
</tr>
<tr>
<td>v2.37</td>
<td>v64-66</td>
</tr>
<tr>
<td>v2.36</td>
<td>v63-65</td>
</tr>
<tr>
<td>v2.35</td>
<td>v62-64</td>
</tr>
<tr>
<td>v2.34</td>
<td>v61-63</td>
</tr>
<tr>
<td>v2.33</td>
<td>v60-62</td>
</tr>
<tr>
<td>v2.32</td>
<td>v59-61</td>
</tr>
<tr>
<td>v2.31</td>
<td>v58-60</td>
</tr>
<tr>
<td>v2.30</td>
<td>v58-60</td>
</tr>
<tr>
<td>v2.29</td>
<td>v56-58</td>
</tr>
<tr>
<td>v2.28</td>
<td>v55-57</td>
</tr>
<tr>
<td>v2.27</td>
<td>v54-56</td>
</tr>
<tr>
<td>v2.26</td>
<td>v53-55</td>
</tr>
<tr>
<td>v2.25</td>
<td>v53-55</td>
</tr>
<tr>
<td>v2.24</td>
<td>v52-54</td>
</tr>
<tr>
<td>v2.23</td>
<td>v51-53</td>
</tr>
<tr>
<td>v2.22</td>
<td>v49-52</td>
</tr>
<tr>
<td>v2.21</td>
<td>v46-50</td>
</tr>
<tr>
<td>v2.20</td>
<td>v43-48</td>
</tr>
<tr>
<td>v2.19</td>
<td>v43-47</td>
</tr>
<tr>
<td>v2.18</td>
<td>v43-46</td>
</tr>
<tr>
<td>v2.17</td>
<td>v42-43</td>
</tr>
<tr>
<td>v2.13</td>
<td>v42-45</td>
</tr>
<tr>
<td>v2.15</td>
<td>v40-43</td>
</tr>
<tr>
<td>v2.14</td>
<td>v39-42</td>
</tr>
<tr>
<td>v2.13</td>
<td>v38-41</td>
</tr>
<tr>
<td>v2.12</td>
<td>v36-40</td>
</tr>
<tr>
<td>v2.11</td>
<td>v36-40</td>
</tr>
<tr>
<td>v2.10</td>
<td>v33-36</td>
</tr>
<tr>
<td>v2.9</td>
<td>v31-34</td>
</tr>
<tr>
<td>v2.8</td>
<td>v30-33</td>
</tr>
<tr>
<td>v2.7</td>
<td>v30-33</td>
</tr>
<tr>
<td>v2.6</td>
<td>v29-32</td>
</tr>
<tr>
<td>v2.5</td>
<td>v29-32</td>
</tr>
<tr>
<td>v2.4</td>
<td>v29-32</td>
</tr>
</tbody></table>
<p>使用 WebDriver 在 Chrome 浏览器上进行测试时，需要从 <a class="link" href="http://chromedriver.storage.googleapis.com/index.html">http://chromedriver.storage.googleapis.com/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>网址中下载与本机 chrome 浏览器对应的驱动程序，驱动程序名为 chromedriver；</p>
<p>chromedriver 的版本需要和本机的 chrome 浏览器对应，才能正常使用；我在 <code>Ubuntu16.04</code> 上测试需要把包移动到 <code>/usr/bin/</code> 目录，<code>Windows</code> 需要下载后把文件解压，然后放到本机 chrome 浏览器文件路径里，如：C:\Program Files (x86)\Google\Chrome\Application</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1ax199-5i.webp" alt="image.png"></p>
<p>下边写在 Python 中的用法</p>
<h2 id="在-Python-中的用法"><a href="#在-Python-中的用法" class="headerlink" title="在 Python 中的用法"></a>在 Python 中的用法</h2><h3 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a><strong>基本框架</strong></h3><p>控制 chrome 浏览器，访问百度，并搜索关键词 Python，获取搜索结果</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">    <span class="built_in">input</span>=browser.find_element_by_id(<span class="string">"kw"</span>)</span><br><span class="line">    <span class="built_in">input</span>.send_keys(<span class="string">"Python"</span>)</span><br><span class="line">    <span class="built_in">input</span>.send_keys(Keys.ENTER)</span><br><span class="line">    wait=WebDriverWait(browser,<span class="number">10</span>)</span><br><span class="line">    wait.until(EC.presence_of_element_located((By.ID,<span class="string">"content_left"</span>)))</span><br><span class="line">    <span class="built_in">print</span>(browser.current_url)</span><br><span class="line">    <span class="built_in">print</span>(browser.get_cookies())</span><br><span class="line">    <span class="built_in">print</span>(browser.page_source)</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<p>详细用法如下：</p>
<h3 id="声明浏览器对象"><a href="#声明浏览器对象" class="headerlink" title="声明浏览器对象"></a>声明浏览器对象</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="comment">#声明谷歌、Firefox、Safari等浏览器</span></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser=webdriver.Firefox()</span><br><span class="line">browser=webdriver.Safari()</span><br><span class="line">browser=webdriver.Edge()</span><br><span class="line">browser=webdriver.PhantomJS()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="访问页面"><a href="#访问页面" class="headerlink" title="访问页面"></a>访问页面</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#_*_coding: utf-8_*_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"http://www.taobao.com"</span>)</span><br><span class="line"><span class="built_in">print</span>(browser.page_source)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="查找单个元素"><a href="#查找单个元素" class="headerlink" title="查找单个元素"></a>查找单个元素</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#_*_coding: utf-8_*_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"http://www.taobao.com"</span>)</span><br><span class="line">input_first=browser.find_element_by_id(<span class="string">"q"</span>)</span><br><span class="line">input_second=browser.find_element_by_css_selector(<span class="string">"#q"</span>)</span><br><span class="line">input_third=browser.find_element(By.ID,<span class="string">"q"</span>)</span><br><span class="line"><span class="built_in">print</span>(input_first,input_second,input_first)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="查找多个元素"><a href="#查找多个元素" class="headerlink" title="查找多个元素"></a>查找多个元素</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#_*_coding: utf-8_*_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"http://www.taobao.com"</span>)</span><br><span class="line">lis=browser.find_element_by_css_selector(<span class="string">"li"</span>)</span><br><span class="line">lis_c=browser.find_element(By.CSS_SELECTOR,<span class="string">"li"</span>)</span><br><span class="line"><span class="built_in">print</span>(lis,lis_c)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="元素的交互操作"><a href="#元素的交互操作" class="headerlink" title="元素的交互操作"></a>元素的交互操作</h3><h4 id="对获取到的元素调用交互方法"><a href="#对获取到的元素调用交互方法" class="headerlink" title="对获取到的元素调用交互方法"></a>对获取到的元素调用交互方法</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#_*_coding: utf-8_*_</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"https://www.taobao.com"</span>)</span><br><span class="line"><span class="built_in">input</span>=browser.find_element_by_id(<span class="string">"q"</span>)</span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">"iPhone"</span>)</span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">input</span>.clear()</span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">"iPad"</span>)</span><br><span class="line">button=browser.find_element_by_class_name(<span class="string">"btn-search"</span>)</span><br><span class="line">button.click()</span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="交互动作"><a href="#交互动作" class="headerlink" title="交互动作"></a>交互动作</h3><p>把动作附加到交互链中</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#_*_coding: utf-8_*_</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.alert <span class="keyword">import</span> Alert</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">url=<span class="string">"http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable"</span></span><br><span class="line">browser.get(url)</span><br><span class="line"><span class="comment">#切换到目标元素所在的frame</span></span><br><span class="line">browser.switch_to.frame(<span class="string">"iframeResult"</span>)</span><br><span class="line"><span class="comment">#确定拖拽目标的起点</span></span><br><span class="line">source=browser.find_element_by_id(<span class="string">"draggable"</span>)</span><br><span class="line"><span class="comment">#确定拖拽目标的终点</span></span><br><span class="line">target=browser.find_element_by_id(<span class="string">"droppable"</span>)</span><br><span class="line"><span class="comment">#形成动作链</span></span><br><span class="line">actions=ActionChains(browser)</span><br><span class="line">actions.drag_and_drop(source,target)</span><br><span class="line"><span class="comment">#执行</span></span><br><span class="line">actions.perform()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">1.先用switch_to_alert()方法切换到alert弹出框上</span></span><br><span class="line"><span class="string">2.可以用text方法获取弹出的文本 信息</span></span><br><span class="line"><span class="string">3.accept()点击确认按钮</span></span><br><span class="line"><span class="string">4.dismiss()相当于点右上角x，取消弹出框</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">t=browser.switch_to_alert()</span><br><span class="line"><span class="built_in">print</span>(t.text)</span><br><span class="line">t.accept()</span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="执行-javascript"><a href="#执行-javascript" class="headerlink" title="执行 javascript"></a>执行 javascript</h3><p>下面的例子是执行就是，拖拽进度条到底，并弹出提示框</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#_*_coding: utf-8_*_</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"https://www.zhihu.com/explore"</span>)</span><br><span class="line">browser.execute_script(<span class="string">"window.scrollTo(0,document.body.scrollHeight)"</span>)</span><br><span class="line">browser.execute_script(<span class="string">"alert('To Button')"</span>)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="获取元素信息"><a href="#获取元素信息" class="headerlink" title="获取元素信息"></a>获取元素信息</h3><h4 id="获取属性"><a href="#获取属性" class="headerlink" title="获取属性"></a>获取属性</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">url=<span class="string">"https://www.zhihu.com/explore"</span></span><br><span class="line">browser.get(url)</span><br><span class="line">logo=browser.find_element_by_id(<span class="string">"zh-top-link-logo"</span>)</span><br><span class="line"><span class="built_in">print</span>(logo)</span><br><span class="line"><span class="built_in">print</span>(logo.get_attribute(<span class="string">"class"</span>))</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="获取文本值"><a href="#获取文本值" class="headerlink" title="获取文本值"></a>获取文本值</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">url=<span class="string">"https://www.zhihu.com/explore"</span></span><br><span class="line">browser.get(url)</span><br><span class="line">logo=browser.find_element_by_id(<span class="string">"zh-top-link-logo"</span>)</span><br><span class="line"><span class="built_in">print</span>(logo)</span><br><span class="line"><span class="built_in">print</span>(logo.text)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="获取-ID、位置、大小和标签名"><a href="#获取-ID、位置、大小和标签名" class="headerlink" title="获取 ID、位置、大小和标签名"></a>获取 ID、位置、大小和标签名</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">url=<span class="string">"https://www.zhihu.com/explore"</span></span><br><span class="line">browser.get(url)</span><br><span class="line">logo=browser.find_element_by_id(<span class="string">"zh-top-link-logo"</span>)</span><br><span class="line"><span class="built_in">print</span>(logo)</span><br><span class="line"><span class="comment">#id</span></span><br><span class="line"><span class="built_in">print</span>(logo.<span class="built_in">id</span>)</span><br><span class="line"><span class="comment">#位置</span></span><br><span class="line"><span class="built_in">print</span>(logo.location)</span><br><span class="line"><span class="comment">#标签名</span></span><br><span class="line"><span class="built_in">print</span>(logo.tag_name)</span><br><span class="line"><span class="comment">#大小</span></span><br><span class="line"><span class="built_in">print</span>(logo.size)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="等待"><a href="#等待" class="headerlink" title="等待"></a>等待</h3><h4 id="隐式等待"><a href="#隐式等待" class="headerlink" title="隐式等待"></a>隐式等待</h4><p>当使用了隐式等待执行测试的时候，如果 webdriver 没有在 DOM 中找到元素，将继续等待，超过设定的时间后则抛出找不到元素的异常，换句话说，当查找元素或元素并没有立即出现的时候，隐式等待将等待一段时间再查找 DOM，默认时间为 0.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">url=<span class="string">"https://www.zhihu.com/explore"</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>)</span><br><span class="line">logo=browser.find_element_by_id(<span class="string">"zh-top-link-logo"</span>)</span><br><span class="line"><span class="built_in">print</span>(logo)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="显示等待"><a href="#显示等待" class="headerlink" title="显示等待"></a>显示等待</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">url=<span class="string">"https://www.taobao.com"</span></span><br><span class="line">browser.get(url)</span><br><span class="line">wait=WebDriverWait(browser,<span class="number">10</span>)</span><br><span class="line"><span class="built_in">input</span>=wait.until(EC.presence_of_element_located((By.ID,<span class="string">"q"</span>)))</span><br><span class="line">button=wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR,<span class="string">".btn-search"</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">input</span>,button)</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="浏览器的前进和后退"><a href="#浏览器的前进和后退" class="headerlink" title="浏览器的前进和后退"></a>浏览器的前进和后退</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"https://www.taobao.com"</span>)</span><br><span class="line">browser.get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">browser.get(<span class="string">"https://www.python.org"</span>)</span><br><span class="line">browser.back()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">browser.forward()</span><br><span class="line">browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="cookies-的处理"><a href="#cookies-的处理" class="headerlink" title="cookies 的处理"></a>cookies 的处理</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"https://www.zhihu.com/explore"</span>)</span><br><span class="line"><span class="built_in">print</span>(browser.get_cookies())</span><br><span class="line">browser.add_cookie({<span class="string">"name"</span>:<span class="string">"name"</span>,<span class="string">"domain"</span>:<span class="string">"www.zhihu.com"</span>,<span class="string">"value"</span>:<span class="string">"germey"</span>})</span><br><span class="line"><span class="built_in">print</span>(browser.get_cookies())</span><br><span class="line">browser.delete_all_cookies()</span><br><span class="line"><span class="built_in">print</span>(browser.get_cookies())</span><br><span class="line">browser.close()<span class="number">123456789101112</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="选项卡管理"><a href="#选项卡管理" class="headerlink" title="选项卡管理"></a>选项卡管理</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">"https://www.zhihu.com/explore"</span>)</span><br><span class="line">browser.execute_script(<span class="string">"window.open()"</span>)</span><br><span class="line"><span class="built_in">print</span>(browser.window_handles)</span><br><span class="line">browser.switch_to_window(browser.window_handles[<span class="number">1</span>])</span><br><span class="line">browser.get(<span class="string">"https://www.taobao.com"</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">browser.switch_to_window(browser.window_handles[<span class="number">0</span>])</span><br><span class="line">browser.get(<span class="string">"https://python.org"</span>)</span><br><span class="line">browser.close()<span class="number">1234567891011121314</span></span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException,NoSuchElementException</span><br><span class="line"></span><br><span class="line">browser=webdriver.Chrome()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.get(<span class="string">"https://www.zhihu.com/explore"</span>)</span><br><span class="line"><span class="keyword">except</span> TimeoutException:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Time out"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.find_element_by_id(<span class="string">"hello"</span>)</span><br><span class="line"><span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"No Element"</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    browser.close()</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="在-java-中的用法"><a href="#在-java-中的用法" class="headerlink" title="在 java 中的用法"></a>在 java 中的用法</h2><p>例子</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.By;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.WebDriver;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.chrome.ChromeDriver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        System.setProperty(<span class="string">"webdriver.chrome.driver"</span>,<span class="string">"E:\\webDriver\\chromedriverV2.28.exe"</span>);<span class="comment">//chromedriver服务地址</span></span><br><span class="line">        <span class="type">WebDriver</span> <span class="variable">driver</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChromeDriver</span>(); <span class="comment">//新建一个WebDriver 的对象，但是new 的是FirefoxDriver的驱动</span></span><br><span class="line">        driver.get(<span class="string">"http://www.baidu.com"</span>);<span class="comment">//打开指定的网站</span></span><br><span class="line">        driver.findElement(By.id(<span class="string">"kw"</span>)).sendKeys(<span class="keyword">new</span>  <span class="title class_">String</span>[] {<span class="string">"hello"</span>});<span class="comment">//找到kw元素的id，然后输入hello</span></span><br><span class="line">        driver.findElement(By.id(<span class="string">"su"</span>)).click(); <span class="comment">//点击按扭</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * WebDriver自带了一个智能等待的方法。</span></span><br><span class="line"><span class="comment">            dr.manage().timeouts().implicitlyWait(arg0, arg1）；</span></span><br><span class="line"><span class="comment">            Arg0：等待的时间长度，int 类型 ；</span></span><br><span class="line"><span class="comment">            Arg1：等待时间的单位 TimeUnit.SECONDS 一般用秒作为单位。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            driver.manage().timeouts().implicitlyWait(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * dr.quit()和dr.close()都可以退出浏览器,简单的说一下两者的区别：第一个close，</span></span><br><span class="line"><span class="comment">         * 如果打开了多个页面是关不干净的，它只关闭当前的一个页面。第二个quit，</span></span><br><span class="line"><span class="comment">         * 是退出了所有Webdriver所有的窗口，退的非常干净，所以推荐使用quit最为一个case退出的方法。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        driver.quit();<span class="comment">//退出浏览器</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="打开一个-url-并获取对应的网页源码"><a href="#打开一个-url-并获取对应的网页源码" class="headerlink" title="打开一个 url 并获取对应的网页源码"></a>打开一个 url 并获取对应的网页源码</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">"http://www.baidu.com"</span>;</span><br><span class="line">driver.get(url);</span><br><span class="line"><span class="type">String</span> <span class="variable">pageSource</span> <span class="operator">=</span> driver.getPageSource();</span><br><span class="line">System.out.println(pageSource);</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="浏览器窗口最大化"><a href="#浏览器窗口最大化" class="headerlink" title="浏览器窗口最大化"></a>浏览器窗口最大化</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">driver.manage().window().maximize();</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="定位某个元素"><a href="#定位某个元素" class="headerlink" title="定位某个元素"></a>定位某个元素</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//根据ID定位元素:</span></span><br><span class="line"><span class="type">WebElement</span> <span class="variable">ele</span> <span class="operator">=</span> driver.findElement(By.id(<span class="string">"id"</span>));</span><br><span class="line"><span class="comment">//根据Class定位元素:</span></span><br><span class="line"><span class="type">WebElement</span> <span class="variable">ele</span> <span class="operator">=</span> driver.findElement(By.className(<span class="string">"className"</span>));</span><br><span class="line"> <span class="comment">//根据xpath定位元素:</span></span><br><span class="line"><span class="type">WebElement</span> <span class="variable">ele</span> <span class="operator">=</span> driver.findElement(By.xpath(<span class="string">"xpath"</span>));</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="向表单填数据"><a href="#向表单填数据" class="headerlink" title="向表单填数据"></a>向表单填数据</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">WebElement</span> <span class="variable">ele</span> <span class="operator">=</span> driver.findElement(By.id(<span class="string">"id"</span>));</span><br><span class="line">            ele.clear();</span><br><span class="line">            ele.sendKeys(<span class="string">"str"</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="触发元素的点击事件"><a href="#触发元素的点击事件" class="headerlink" title="触发元素的点击事件"></a>触发元素的点击事件</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">WebElement</span> <span class="variable">ele</span> <span class="operator">=</span> driver.findElement(By.id(<span class="string">"id"</span>));</span><br><span class="line">            ele.click();</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>1、使用 find_element_by_xxxx () 方法查找元素时，如果元素找不到，不会返回 null，而是抛出异常，所以需要自己捕获异常。</p>
<p>2、使用 firefox 后，很多选项虽然在浏览器中进行了设置，但是通过 selenium 启动 firefox 后，设置并没有生效，所以这些设置你需要在代 码中添加。</p>
<p>3、使用 WebDriver 点击 Button 元素时，如果 Button 元素其他元素遮住了，或没出现在界面中 (比如 Button 在页面底部，但是屏幕只能显示页 面上半部分)，使用 Click () 方法可能无法触发 Click 事件。</p>
]]></content>
      <tags>
        <tag>python</tag>
        <tag>selenium</tag>
      </tags>
  </entry>
  <entry>
    <title>解析 word 内嵌文件名中文乱码</title>
    <url>/2021/3213641848.html</url>
    <content><![CDATA[<p>Apache POI 简介是用 Java 编写的免费开源的跨平台的 Java API，Apache POI 提供 API 给 Java 程式对 Microsoft Office（Excel、WORD、PowerPoint、Visio 等）格式档案读和写的功能。POI 为 “Poor Obfuscation Implementation” 的首字母缩写，意为 “可怜的模糊实现”。</p>
<p>官方主页： <a class="link" href="http://poi.apache.org/index.html">http://poi.apache.org/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>API 文档： <a class="link" href="http://poi.apache.org/apidocs/index.html">http://poi.apache.org/apidocs/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<span id="more"></span>

<h3 id="问题发现"><a href="#问题发现" class="headerlink" title="问题发现"></a>问题发现</h3><p>我们知道 word 是支持插入其他文件的</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://i.loli.net/2021/08/21/ybDVqUNBrhkcLng.png" alt="image-20210821165809129"></p>
<p>插入后入下图所示</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://fastly.jsdelivr.net/gh/tsvico/WebCDN/ImageHosting/image-20210821165942634.png" alt="image-20210821165942634"></p>
<p>在使用 Apache POI 过程中发现在读取文件名时会发生乱码问题</p>
<h3 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h3><p>经过代码排查定位发现文件名是取自一个 <code>label</code> 的元素值，</p>
<p><code>label</code> 是在包 <code>org.apache.poi.poifs.filesystem.Ole10Native</code> 的第 165 行，代码如下</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> parsed: {</span><br><span class="line">            flags1 = LittleEndian.getShort(data, ofs);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// structured format</span></span><br><span class="line">            ofs += LittleEndianConsts.SHORT_SIZE;</span><br><span class="line">        </span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> getStringLength(data, ofs);</span><br><span class="line">            label = StringUtil.getFromCompressedUnicode(data, ofs, len - <span class="number">1</span>);</span><br><span class="line">            ofs += len;</span><br><span class="line">            </span><br><span class="line">            len = getStringLength(data, ofs);</span><br><span class="line">            fileName = StringUtil.getFromCompressedUnicode(data, ofs, len - <span class="number">1</span>);</span><br><span class="line">            ofs += len;</span><br><span class="line">    </span><br><span class="line">            flags2 = LittleEndian.getShort(data, ofs);</span><br><span class="line">            ofs += LittleEndianConsts.SHORT_SIZE;</span><br><span class="line">            </span><br><span class="line">            unknown1 = LittleEndian.getShort(data, ofs);</span><br><span class="line">            ofs += LittleEndianConsts.SHORT_SIZE;</span><br><span class="line">          </span><br></pre></td></tr></tbody></table></figure></div>

<p>继续跟踪源码进入 <code>StringUtil.getFromCompressedUnicode</code> 方法中，其代码中明确写出二进制目标编码为 <code>ISO_8859_1</code>，</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read 8 bit data (in ISO-8859-1 codepage) into a (unicode) Java</span></span><br><span class="line"><span class="comment"> * String and return.</span></span><br><span class="line"><span class="comment"> * (In Excel terms, read compressed 8 bit unicode as a string)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string byte array to read</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offset offset to read byte array</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> len    length to read byte array</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> String generated String instance by reading byte array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFromCompressedUnicode</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">byte</span>[] string,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> offset,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> len)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">len_to_use</span> <span class="operator">=</span> Math.min(len, string.length - offset);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(string, offset, len_to_use, ISO_8859_1);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>通过在 IDEA 的 debug 运算中发现将编码修改为 <code>GBK</code> 正常转换中文，看来这里是乱码的根本原因了，后续又新建文件测试，发现 wps、word2019、wps linux、永中 office 新建的文件在此处改为 <code>GBK</code> 均可正常显示中文文件名。问题成功定位，接下来进行代码修改</p>
<p>将源码拉取到本地，在 StringUtil 中添加如下方法，这里自定义了一个 charset, 我们在调用处调用这个方法就可以了，这样也能保证不会干扰其他代码</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFromCompressedUnicode</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">byte</span>[] string,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">int</span> offset,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">int</span> len, <span class="keyword">final</span> Charset charset)</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">len_to_use</span> <span class="operator">=</span> Math.min(len, string.length - offset);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(string, offset, len_to_use, charset);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>调用处 <code>(Ole10Native)</code> 修改</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line">label = StringUtil.getFromCompressedUnicode(data, ofs, len - <span class="number">1</span>,Charset.forName(<span class="string">"GBK"</span>));</span><br><span class="line"><span class="comment">// 可以顺便把下边隔一行的fileName一块改了</span></span><br><span class="line">fileName = StringUtil.getFromCompressedUnicode(data, ofs, len - <span class="number">1</span>,Charset.forName(<span class="string">"GBK"</span>));</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="上传到私有仓库"><a href="#上传到私有仓库" class="headerlink" title="上传到私有仓库"></a>上传到私有仓库</h3><p>我们公司是有自己的私有仓库的，既然改好了，就将代码上传上去吧</p>
<p>打开上一级的 <code>build.gradle</code> 在 <code>subprojects</code> 中添加</p>
<div class="code-container" data-rel="Groovy"><figure class="iseeu highlight groovy"><table><tbody><tr><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">'maven-publish'</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">'net.linguica.maven-settings'</span> <span class="comment">// 看需要，我们仓库是要加这个的</span></span><br><span class="line"></span><br><span class="line">group = <span class="string">"org.apache.poi"</span></span><br><span class="line">version = <span class="string">'4.1.2-xxx.1'</span>  <span class="comment">// 随便.1代表第一次修改，4.1.2是原始的版本号</span></span><br><span class="line"></span><br><span class="line">publishing {</span><br><span class="line">        publications {</span><br><span class="line">            basic(MavenPublication) {</span><br><span class="line">                from components.java</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        repositories {</span><br><span class="line">            maven {</span><br><span class="line">                url = uri(<span class="string">"xxx/maven/v1"</span>) <span class="comment">// 仓库上传地址</span></span><br><span class="line">                <span class="comment">// 下面是一些鉴权信息，参考其他项目</span></span><br><span class="line">                name = <span class="string">"xxx"</span></span><br><span class="line">                authentication {</span><br><span class="line">                    basic(BasicAuthentication)</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="引用修改后包"><a href="#引用修改后包" class="headerlink" title="引用修改后包"></a>引用修改后包</h3><p>需要实际引用项目在 IDEA 右侧 gradle 中搜索一下那些包额外引用了 <code>org.apache.poi</code>，需要手动排除掉</p>
<p>然后引入我们刚才修改的包就可以了</p>
]]></content>
      <tags>
        <tag>java</tag>
        <tag>kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>记一个字母大小写转换</title>
    <url>/2020/5e064375.html</url>
    <content><![CDATA[<blockquote>
<p>我们常见的大小写转换</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">change</span><span class="params">(<span class="type">char</span> c)</span> {</span><br><span class="line">        <span class="comment">//如果输入的是大写，+32即可得到小写</span></span><br><span class="line">        <span class="keyword">if</span>(c&gt;=<span class="string">'A'</span> &amp;&amp; c&lt;=<span class="string">'Z'</span>){</span><br><span class="line">            c+=<span class="number">32</span>;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">        }<span class="keyword">else</span> <span class="keyword">if</span>(c&gt;=<span class="string">'a'</span> &amp;&amp; c&lt;=<span class="string">'z'</span>){    <span class="comment">//如果输入的是小写，-32即可得大小写</span></span><br><span class="line">            c-=<span class="number">32</span>;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">       }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>我们不常见的↓</p>
<span id="more"></span>

<blockquote>
<p>学到的一个更简单的方式<br>大小写字母切换:<br>                <strong>s^=(1&lt;&lt;5)</strong>;<br><em>大小写字母相差 32, 又因为异或重要特性：不进位加法，所以大写字母和 (1&lt;&lt;5) 异或变成变成小写字母，小写字母和 (1&lt;&lt;5) 异或变成大写字母</em>。<a class="link" href="https://leetcode-cn.com/problems/letter-case-permutation/solution/784-zi-mu-da-xiao-xie-quan-pai-lie-2ms-gao-xiao-ti/">代码地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">change</span><span class="params">(<span class="type">char</span> s)</span> {</span><br><span class="line">		<span class="comment">//char s = 'A';</span></span><br><span class="line">        s = (<span class="type">char</span>)(s ^ (<span class="number">1</span> &lt;&lt; <span class="number">5</span>));</span><br><span class="line">		System.out.println(s);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>]]></content>
      <tags>
        <tag>java</tag>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次百度 OCR 的使用</title>
    <url>/2018/8d4a5af0.html</url>
    <content><![CDATA[<p>恰巧用到了 OCR 批量识别，鉴于准确度没有使用在本地训练的 TensorFlow-OCR，而是选择了百度 OCR，可选的方式多种多样，比如 Google 文字识别，腾讯 OCR 等等，不一一列举</p>
<span id="more"></span>

<p>很简单的 demo，参照开发文档</p>
<p><a class="link" href="http://ai.baidu.com/docs#/OCR-Python-SDK/80d64770">http://ai.baidu.com/docs#/OCR-Python-SDK/80d64770<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/19tv28-dd.webp" alt="image.png"></p>
<p>先去控制台注册一个开发者账号，并创建一个文字识别应用，在管理应用中可以看到 <code>AppID</code> 等相关信息</p>
<p>安装 SDK <code>pip install baidu-aip</code></p>
<p>新建一个 python 文件</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> aip <span class="keyword">import</span> AipOcr</span><br><span class="line"><span class="keyword">from</span> glob <span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">from</span> docx <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="string">""" 你的 APPID AK SK """</span></span><br><span class="line">APP_ID = <span class="string">'你的 App ID'</span></span><br><span class="line">API_KEY = <span class="string">'你的 Api Key'</span></span><br><span class="line">SECRET_KEY = <span class="string">'你的 Secret Key'</span></span><br><span class="line">client = AipOcr(APP_ID, API_KEY, SECRET_KEY)</span><br><span class="line">root_path = os.getcwd() <span class="comment">#获取当前路径</span></span><br><span class="line">document = Document() <span class="comment">#初始化word文档</span></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="string">""" 读取图片 """</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_content</span>(<span class="params">FilePath</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(FilePath, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="keyword">return</span> fp.read()</span><br><span class="line"></span><br><span class="line"><span class="string">""" 调用通用文字识别, 图片参数为本地图片 """</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">result</span>(<span class="params">image_file,image</span>):</span><br><span class="line">    <span class="string">""" 如果有可选参数 """</span></span><br><span class="line">    options = {}</span><br><span class="line">    <span class="comment">#options["language_type"] = "CHN_ENG"#</span></span><br><span class="line">    options[<span class="string">"detect_direction"</span>] = <span class="string">"true"</span></span><br><span class="line">    <span class="comment">#options["detect_language"] = "true"#</span></span><br><span class="line">    options[<span class="string">"probability"</span>] = <span class="string">"true"</span></span><br><span class="line">    <span class="comment">#m = client.basicGeneral(image);</span></span><br><span class="line">    <span class="string">"""带参数调用通用文字识别, 图片参数为本地图片 """</span></span><br><span class="line">    <span class="comment">#client.basicGeneral(image,options)</span></span><br><span class="line">    <span class="comment">#url = "https//www.x.com/sample.jpg"</span></span><br><span class="line">    <span class="comment">#调用通用文字识别, 图片参数为远程url图片</span></span><br><span class="line">    <span class="comment">#client.basicGeneralUrl(url);</span></span><br><span class="line">    <span class="comment">#普通</span></span><br><span class="line">    <span class="comment">#res = client.basicGeneral(image,options)</span></span><br><span class="line">    <span class="comment">#高精度</span></span><br><span class="line">    res = client.basicAccurate(image,options)</span><br><span class="line">    <span class="keyword">global</span> num</span><br><span class="line">    num = num + <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"这是第"</span>+<span class="built_in">str</span>(num)+<span class="string">"个文件"</span>)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'error_code'</span> <span class="keyword">in</span> res:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"有错误"</span>)</span><br><span class="line">        File(<span class="string">"出错了，第"</span>+image_file.split(<span class="string">"/"</span>)[-<span class="number">1</span>]+<span class="string">'个'</span>,<span class="string">'/error'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span>(num&gt;<span class="number">0</span>):</span><br><span class="line">            document.add_page_break()</span><br><span class="line">            fname = image_file.split(<span class="string">"/"</span>)[-<span class="number">1</span>]</span><br><span class="line">            document.add_heading(fname,level=<span class="number">2</span>) <span class="comment">#添加二级标题</span></span><br><span class="line">        os.remove(image_file)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> res[<span class="string">'words_result'</span>]:</span><br><span class="line">            <span class="built_in">print</span>(item[<span class="string">'words'</span>])</span><br><span class="line">            File(item[<span class="string">'words'</span>],image_file)</span><br><span class="line">            write_word(item[<span class="string">'words'</span>])</span><br><span class="line"></span><br><span class="line"><span class="string">'''文件写入'''</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">File</span>(<span class="params">string,name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(root_path+<span class="string">'/demo/text/'</span>+name.split(<span class="string">"/"</span>)[-<span class="number">1</span>]+<span class="string">'.txt'</span>,<span class="string">'a+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'\n'</span>+string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_word</span>(<span class="params">string</span>):</span><br><span class="line">        document.add_paragraph(string)</span><br><span class="line">        document.save(root_path+<span class="string">'/demo/text/'</span>+<span class="string">'test.docx'</span>)</span><br><span class="line"><span class="string">"""指定目录下所有文件路径"""</span></span><br><span class="line">image_files = glob(root_path+<span class="string">'/demo/image/*.*'</span>)</span><br><span class="line"><span class="comment">#image_files = glob('./image/*.*')</span></span><br><span class="line"><span class="keyword">for</span> image_file <span class="keyword">in</span> <span class="built_in">sorted</span>(image_files):</span><br><span class="line">    <span class="built_in">print</span>(image_file)</span><br><span class="line">    image = get_file_content(image_file)</span><br><span class="line">    result(image_file,image)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>

<p>支持导出到 word 文档，可以在第 51,52 行中添加 / 修改将结果写入的文件，7,8,9 改成自己控制台的内容才可以使用，相应目录都写在文件中，只需稍微修改</p>
<p>自动读取 image 文件夹下的所有文件，识别后将结果保存在 text 目录下</p>
<p>目录树</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── BaiduOcr.py</span><br><span class="line">├── error.txt</span><br><span class="line">├── image</span><br><span class="line">│&nbsp;&nbsp; └── 028.jpg</span><br><span class="line">└── text</span><br></pre></td></tr></tbody></table></figure></div>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>转:win11 开机黑屏只有鼠标，且无法通过快捷键调出任务管理器的一种解决尝试</title>
    <url>/2025/413569592.html</url>
    <content><![CDATA[<p>本篇文章转载自 <a class="link" href="https://www.bilibili.com/opus/894493644567871489">bilibili<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，经过实践发现非常有实用价值，故进行转载</p>
<span id="more"></span>
<h2 id="​解决办法简述"><a href="#​解决办法简述" class="headerlink" title="​解决办法简述"></a>​解决办法简述</h2><p>使用 <code>ctrl+shift+f10</code></p>
<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>自从更新 win11 之后，总是会出现文件夹打开无响应，重启后电脑黑屏只有鼠标的情况。某度和其他平台的不管是图文，还是视频都说使用 ctrl+shift+del 快捷键调出任务管理器解决。但是关于使用快捷键后任务管理器无法显示的问题，都未给出解决办法。这里提供一个误打误撞调出显示界面的方式：使用 ctrl+shift+f10。下面是具体说明</p>
<h2 id="电脑及win11版本介绍"><a href="#电脑及win11版本介绍" class="headerlink" title="电脑及win11版本介绍"></a>电脑及 win11 版本介绍</h2><p>电脑</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">联想ThinkBook 16 G4 + IAP</span><br><span class="line"></span><br><span class="line">设备名称  *</span><br><span class="line"> 处理器   12th Gen Intel(R) Core(TM) i5-12500H 2.50 GHz</span><br><span class="line"> 机带 RAM   16.0 GB (15.7 GB 可用)</span><br><span class="line"> 设备 ID   *****</span><br><span class="line"> 产品 ID   *****</span><br><span class="line"> 系统类型   64 位操作系统, 基于 x64 的处理器</span><br><span class="line"> 笔和触控   没有可用于此显示器的笔或触控输入</span><br></pre></td></tr></tbody></table></figure></div>
<p>win11 版本</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">版本   Windows 11 家庭中文版</span><br><span class="line"> 版本   23H2</span><br><span class="line"> 安装日期   ‎2022/‎11/‎27</span><br><span class="line"> 操作系统版本   ****</span><br><span class="line"> 序列号   ******</span><br><span class="line"> 体验   ***** </span><br></pre></td></tr></tbody></table></figure></div>
<h2 id="描述及解决方案："><a href="#描述及解决方案：" class="headerlink" title="描述及解决方案："></a>描述及解决方案：</h2><p>开机电脑黑屏，只有能看到鼠标指针。<br><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/11/10/k85y7-qp.webp" alt="image.png"></p>
<p>使用 <code>ctrl+shift+del</code> 快捷键尝试调出任务管理器，可以到看到任务管理器选项，但是点击后并不能显示出任务管理器，电脑还是黑屏只有鼠标。  </p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/11/10/k9hp6-ya.webp" alt="image.png"></p>
<p>尝试按 <code>ctrl+shift+f10</code>。桌面显示出来了，但是任务栏不正常。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/11/10/kajwn-ec.webp" alt="image.png"></p>
<p>再点击 <code>ctrl+shift+f10</code>，又黑屏只有鼠标，<code>ctrl+shift+f10</code> 可以在桌面和黑屏之间来回切换</p>
<h2 id="评论区"><a href="#评论区" class="headerlink" title="评论区"></a>评论区</h2><p>以下为评论内容的精华部分：</p>
<p>@xpp2_</p>
<blockquote>
<p>分享一下，今天也是遇到这样情况了，c+s+f10 之后可以显示桌面之后调出任务管理器，找到 windows 资源管理器这个进程，右键重启进程就好了。偶尔遇到的任务栏卡死或者任务栏消失，都可以试试这样解决。</p>
</blockquote>
<blockquote>
<p> 紧跟着更新一下：这种情况下，这种方法只是能出来任务栏，各种加载项和自启动好像都没正常加载。看了评论区有提到 win 菜单点睡眠再重进的方法，建议这样试试，重进之后各种加载项和开机自启动应用能正常出来了</p>
</blockquote>
<p>@熊白白熊</p>
<blockquote>
<p>确实能解决，我试出来 开机登录 - 黑屏 - ctrl alt del 出来界面后点右下角睡眠 - 再开机，也能进去。两个方法都挺恶心的。应该是用户文件哪里出问题了。新建一个用户登录就没问题。</p>
</blockquote>
<p>@孔特里亚诺 m</p>
<blockquote>
<p>按照这个方法做了还是只有桌面没有任务栏，结果把网线拔了就好了 [笑哭]</p>
</blockquote>
<p>@别抢我的橘子 T_T</p>
<blockquote>
<p>开机前可以先拔网线进去后，找服务，禁用 web 账户管理器，再连网重启试试</p>
</blockquote>
<p>@队友快冲对面大残</p>
<blockquote>
<p>楼主神医。我发现这种情况似乎是出现在我把 ipv4 的 ip 地址固定之后，然后出现这种情况之后进入桌面看到 IP 地址变成了 169.254.112.115，跟我设置的不一样，怀疑是 ip 地址冲突导致的</p>
</blockquote>
]]></content>
      <tags>
        <tag>win11</tag>
      </tags>
  </entry>
  <entry>
    <title>远程升级 Debian13 翻车与 GRUB 手动引导修复记录</title>
    <url>/2025/2235114744.html</url>
    <content><![CDATA[<p><code>Debian13</code> 发布于 2025 年 8 月 9 日，代号 <code>trixie</code>，抱着尝鲜的念头在中午休息的时候给家里的小主机做了个升级，因为考虑不周最终翻车无法开机，记录下升级与救回的过程。</p>
<span id="more"></span>

<h2 id="升级与翻车"><a href="#升级与翻车" class="headerlink" title="升级与翻车"></a>升级与翻车</h2><p>我是使用 <code>tailscale</code> 连接的家里的小主机，升级前没想着通过局域网 <code>192.168.2.2</code> 连接小主机进行升级，而是直接使用 tailscale 的 <code>100.64.x.x</code> 网段直接进行升级，中途意外连接断开，以失败告终。<br>我先是参考了 <a class="link" href="https://linux.do/t/topic/855975">Debian 12 升级到 Debian 13 的一些注意事项 <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，更新 <code>openssh</code> 版本到 <code>1:9.2p1-2+deb12u7</code> 以上，然后就进行了升级</p>
<blockquote>
<p><code>debian</code> 不可以跨版本升级，如果非 <code>debian12</code>，需要逐级升级，如 <code>Debian11</code> → <code>Debian12</code> → <code>Debian13</code></p>
</blockquote>
<h3 id="更新当前-debian-系统"><a href="#更新当前-debian-系统" class="headerlink" title="更新当前 debian 系统"></a>更新当前 debian 系统</h3><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrade -y</span><br><span class="line"><span class="built_in">sudo</span> apt full-upgrade -y</span><br><span class="line"><span class="built_in">sudo</span> apt autoclean</span><br><span class="line"><span class="built_in">sudo</span> apt autoremove -y</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="升级系统当前系统"><a href="#升级系统当前系统" class="headerlink" title="升级系统当前系统"></a>升级系统当前系统</h3><p>目前并非所有软件源都已包含 <code>debian13</code> 的包，幸运的是我使用的中科大的源是已经包含的，更新 <code>apt</code> 源，替换 <code>bookworm</code> 为 <code>trixie</code>：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">'s/bookworm/trixie/g'</span> /etc/apt/sources.list</span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">'s/bookworm/trixie/g'</span> /etc/apt/sources.list.d/*.list</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="再次更新系统"><a href="#再次更新系统" class="headerlink" title="再次更新系统"></a>再次更新系统</h3><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrade -y</span><br><span class="line"><span class="built_in">sudo</span> apt full-upgrade -y</span><br></pre></td></tr></tbody></table></figure></div>

<p>在执行 <code>apt update</code> 如果提示类似的<code>库“http://download.zerotier.com/debian/trixie trixie Release”没有 Release 文件</code>为正常现象，可以忽略<br><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/08/11/1anisn-sg.webp" alt="6c4fc758d19664c0cf831cd92b785926.png"></p>
<h3 id="远程更新已老实-👨‍🏫"><a href="#远程更新已老实-👨‍🏫" class="headerlink" title="远程更新已老实 👨‍🏫"></a>远程更新已老实 👨‍🏫</h3><p>然后悲催的发现，<code>sudo apt upgrade -y</code> 升级卡在了 <code>92%</code>，<code>tailscale ping 小主机</code> 也是已知提示超时，在等待 20 分钟依旧没修复后，我选择了断电重启，依旧是连不上</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/08/11/1aognb-hl.webp" alt="7052d4decae241849a58c98734fb9c22.png"></p>
<p>连接上家里的其他设备，ping 局域网 IP 依旧无法连接，已老实 🐶</p>
<h3 id="问题修复"><a href="#问题修复" class="headerlink" title="问题修复"></a>问题修复</h3><p>下午下班后，给小主机接上显示器，发现开机就进 <code>grub</code>，判断应该是引导出现了问题，遂尝试解决。</p>
<p>在 grub&gt; 中敲命令查看所有分区：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>看到：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">(hd0) (hd0,gpt3) (hd0,gpt4) ...</span><br></pre></td></tr></tbody></table></figure></div>

<p>这么多也不知道哪个是根目录，逐个查看：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> (hd0,gpt3)/</span><br><span class="line"><span class="built_in">ls</span> (hd0,gpt4)/</span><br></pre></td></tr></tbody></table></figure></div>

<p>我们需要找到系统的根目录，即有 <code>/boot</code> 的分区</p>
<ul>
<li>有 EFI 文件夹 → EFI 分区</li>
<li>有 boot、etc、usr → Linux 根分区</li>
</ul>
<h4 id="手动引导系统"><a href="#手动引导系统" class="headerlink" title="手动引导系统"></a>手动引导系统</h4><p>除了找到根目录分区外，我这里是 (hd0,gpt3)，还需要找到对应挂载分区，开始时我也忘记了自己是哪个，盲目地使用了 <code>/dev/sda2</code>，此时应该使用命令 <code>cat (hd0,gpt3)/etc/fstab</code> 查看挂载信息，使用类似 <code>root=UUID=8956931f-b138-4a79-a9e0-46e75ef3e430</code> 的路径，我当时没深入研究，使用了 AI 给我的一个对照表，不确定权威性，算是蒙对了吧 🤦‍♂️</p>
<table>
<thead>
<tr>
<th>grub 名</th>
<th> Linux SATA</th>
<th>Linux NVMe</th>
</tr>
</thead>
<tbody><tr>
<td>(hd0,gpt1)</td>
<td>/dev/sda1</td>
<td>/dev/nvme0n1p1</td>
</tr>
<tr>
<td>(hd0,gpt2)</td>
<td>/dev/sda2</td>
<td>/dev/nvme0n1p2</td>
</tr>
<tr>
<td>(hd0,gpt3)</td>
<td>/dev/sda3</td>
<td>/dev/nvme0n1p3</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> root=(hd0,gpt2)</span><br><span class="line">linux /boot/vmlinuz-6.9.0-3-amd64 root=/dev/sda3 ro</span><br><span class="line">initrd /boot/initrd.img-6.9.0-3-amd64</span><br><span class="line">boot</span><br></pre></td></tr></tbody></table></figure></div>
<blockquote>
<p>如果是 UUID 这种形式，要写作 <code>linux /boot/vmlinuz-6.9.0-3-amd64 root=UUID=8956931f-b138-4a79-a9e0-46e75ef3e430 ro</code></p>
</blockquote>
<p>这里如果 <code>root</code> 的路径是对的，当输入 <code>/boot</code> 后可以使用 <code>Tab</code> 补全后面的路径，<code>vmlinuz-6.9.0-3</code> 要替换为实际存在的内核版本</p>
<p>注意：</p>
<blockquote>
<p>/dev/sdaX 适用于 SATA 硬盘，NVMe 需用 /dev/nvme0n1pX<br>内核和 initrd 文件名要用 ls /boot/ 查到的实际版本替换</p>
</blockquote>
<h4 id="进入系统后修复"><a href="#进入系统后修复" class="headerlink" title="进入系统后修复"></a>进入系统后修复</h4><p>最后成功的进入了系统，这下就简单了，只要能进系统，继续之前的安装就可以</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修复安装失败的包</span></span><br><span class="line"><span class="built_in">sudo</span> apt --fix-broken install</span><br><span class="line"><span class="comment"># 重新配置</span></span><br><span class="line"><span class="built_in">sudo</span> dpkg --configure -a</span><br><span class="line"><span class="comment"># 修复引导</span></span><br><span class="line"><span class="built_in">sudo</span> update-grub</span><br><span class="line"><span class="built_in">sudo</span> grub-install</span><br><span class="line"><span class="built_in">sudo</span> reboot</span><br></pre></td></tr></tbody></table></figure></div>

<p>最后清理下不必要的软件和依赖</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">apt autoclean</span><br><span class="line">apt autoremove -y</span><br><span class="line"><span class="comment"># 查看系统版本</span></span><br><span class="line"><span class="built_in">cat</span> /etc/debian_version</span><br></pre></td></tr></tbody></table></figure></div>

<p>这样就恢复了正常引导，系统可以正常使用了</p>
<p>最后总结下经验，升级最好使用局域网直连，或者在物理机旁边 😭</p>
]]></content>
      <tags>
        <tag>debian</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>重装 Ubuntu 后的一些优化问题</title>
    <url>/2018/4ebfe832.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因为安装多版本 opencv 中一些手残操作，导致执行了</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo rm -rf /*</span><br></pre></td></tr></tbody></table></figure></div>

<p>结果嘛，….<br>连带着 Windows 系统也进不去了，进入 <code>BIOS</code> 发现引导全没了，最后用微 pe 修复了 Windows 的引导，Ubuntu 系统由于不会用备份，只能重装了<br>这里记录一下重装后的一系列问题，为了方便，会记录在多篇文章里</p>
<span id="more"></span>

<h2 id="Ubuntu16-04-开机动画消失问题"><a href="#Ubuntu16-04-开机动画消失问题" class="headerlink" title="Ubuntu16.04 开机动画消失问题"></a>Ubuntu16.04 开机动画消失问题</h2><p>在安装 Ubuntu 16.04 LTS 后开机动画没有了（应该不是偶然现象），黑屏一段时间后直接进入登录页面<br>参考了别人的一些方法，完美解决<br>切换用户</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">su</span><br></pre></td></tr></tbody></table></figure></div>

<p>如果刚使用系统这个密码是随机的，可以用</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo passwd</span><br></pre></td></tr></tbody></table></figure></div>

<p>根据提示设置 root 用户的密码</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /etc/initramfs-tools/conf.d</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ls</span></span></span><br></pre></td></tr></tbody></table></figure></div>

<p>查看是否有名为 <code>splash</code> 的文件，没有则创建，输入 FRAMEBUFFER=y<br>使用命令则为</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">echo FRAMEBUFFER=y &gt;&gt; splash</span><br></pre></td></tr></tbody></table></figure></div>

<p>然后执行</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">update-initramfs -u</span><br></pre></td></tr></tbody></table></figure></div>

<p>重启即可</p>
<h2 id="使用网易-163-数据源"><a href="#使用网易-163-数据源" class="headerlink" title="使用网易 163 数据源"></a>使用网易 163 数据源</h2><p>图形化更新：打开软件与更新 - Ubuntu 软件 - 下载自，选择国内的服务器<br>也可以像我一样手动更改 163 数据源</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份一下</span></span><br><span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></tbody></table></figure></div>

<p>编辑新文件</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo gedit /etc/apt/sources.list</span><br></pre></td></tr></tbody></table></figure></div>

<p>将之前内容全部删除，粘贴以下内容（仅适用于 Ubuntu16）</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">deb http://mirrors.163.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br></pre></td></tr></tbody></table></figure></div>

<p>最后更新一下</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="卸载不常用软件与美化"><a href="#卸载不常用软件与美化" class="headerlink" title="卸载不常用软件与美化"></a>卸载不常用软件与美化</h2><h3 id="系统清理篇"><a href="#系统清理篇" class="headerlink" title="系统清理篇"></a>系统清理篇</h3><h4 id="系统更新"><a href="#系统更新" class="headerlink" title="系统更新"></a>系统更新</h4><p>安装完系统之后，需要更新一些补丁。Ctrl+Alt+T 调出终端，执行一下代码：</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt upgrade12</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="卸载-libreOffice"><a href="#卸载-libreOffice" class="headerlink" title="卸载 libreOffice"></a>卸载 libreOffice</h4><p>libreoffice 事 ubuntu 自带的开源 office 软件，体验效果不如 windows 上的 office，于是选择用 WPS 来替代（wps 的安装后面会提到）</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get remove libreoffice-common  1</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="删除-Amazon-的链接"><a href="#删除-Amazon-的链接" class="headerlink" title="删除 Amazon 的链接"></a>删除 Amazon 的链接</h4><div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get remove unity-webapps-common</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="删除不常用的软件"><a href="#删除不常用的软件" class="headerlink" title="删除不常用的软件"></a>删除不常用的软件</h4><div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get remove thunderbird totem rhythmbox empathy brasero simple-scan gnome-mahjongg aisleriot</span><br><span class="line">sudo apt-get remove gnome-mines cheese transmission-common gnome-orca webbrowser-app gnome-sudoku  landscape-client-ui-install</span><br><span class="line"></span><br><span class="line">sudo apt-get remove onboard deja-dup 1234</span><br></pre></td></tr></tbody></table></figure></div>

<p>做完上面这些，系统应该干净了，下面我们来安装一些必要的软件。</p>
<h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><h4 id="unity-tweak-tool"><a href="#unity-tweak-tool" class="headerlink" title="unity-tweak-tool"></a>unity-tweak-tool</h4><p>调整 Unity 桌面环境，还是推荐使用 Unity Tweak Tool，这是一个非常好用的 Unity 图形化管理工具，可以修改工作区数量、热区等。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install unity-tweak-tool</span><br></pre></td></tr></tbody></table></figure></div>

<p>安装完后界面如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://www.linuxidc.com/upload/2016_05/16050322106462.png" alt="img"></p>
<p>Ubuntu 16.04 中安装 Unity Tweak Tool <a class="link" href="http://www.linuxidc.com/Linux/2016-05/130951.htm">http://www.linuxidc.com/Linux/2016-05/130951.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h4 id="Flatabulous-主题"><a href="#Flatabulous-主题" class="headerlink" title="Flatabulous 主题"></a>Flatabulous 主题</h4><p>Flatabulous 主题是一款 ubuntu 下扁平化主题，也是我试过众多主题中最喜欢的一个！最终效果如上述图所示。</p>
<p>执行以下命令安装 Flatabulous 主题：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:noobslab/themes</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install flatabulous-theme123</span><br></pre></td></tr></tbody></table></figure></div>

<p>该主题有配套的图标，安装方式如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:noobslab/icons</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ultra-flat-icons123</span><br></pre></td></tr></tbody></table></figure></div>

<p>安装完成后，打开 unity-tweak-tool 软件，修改主题和图标：</p>
<p>进入 Theme，修改为 Flatabulous</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://www.linuxidc.com/upload/2016_09/160913081877362.png" alt="img"></p>
<p>在此界面下进入 Icons 栏，修改为 Ultra-flat:</p>
<p><img lazyload="" src="/images/loading.svg" data-src="http://www.linuxidc.com/upload/2016_09/160913081877363.png" alt="img"></p>
<p>到这里主题和图标都变为扁平化主题 Flatabulous，看起来比较美观了，当然，还需要修改一些细节，例如终端的配色以及样式。</p>
<h4 id="wps"><a href="#wps" class="headerlink" title="wps"></a>wps</h4><p>去 wps 官网下载 wps for linux。</p>
<p>下载后，打开终端，运行一下命令</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo dpkg -i wps-office_10.1.0.5672~a21_amd64.deb</span><br></pre></td></tr></tbody></table></figure></div>

<p>如果缺少依赖包，可以先执行一下命令 (后面的软件安装过程中如出现依赖包问题，一样可以采用这种方式解决)</p>
<p>sudo apt-get install -f</p>
<p>Ubuntu 14.04 安装 WPS <a class="link" href="http://www.linuxidc.com/Linux/2014-04/100499.htm">http://www.linuxidc.com/Linux/2014-04/100499.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Ubuntu 14.04 64 位安装 WPS（成功解决没有 ia32-libs 的问题） <a class="link" href="http://www.linuxidc.com/Linux/2014-05/101603.htm">http://www.linuxidc.com/Linux/2014-05/101603.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h4 id="chrome"><a href="#chrome" class="headerlink" title="chrome"></a>chrome</h4><p>去 chrome 官网下载 linux 版的 chrome。</p>
<p>执行一下命令，</p>
<p>sudo dpkg -i google-chrome-stable_current_amd64.deb<br>Ubuntu 16.04 下安装 64 位谷歌 Chrome 浏览器 <a class="link" href="http://www.linuxidc.com/Linux/2016-05/131096.htm">http://www.linuxidc.com/Linux/2016-05/131096.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Ubuntu 16.04 中为 Chromium、Chrome、Firefox 安装 Flash 播放器插件 <a class="link" href="http://www.linuxidc.com/Linux/2016-05/131098.htm">http://www.linuxidc.com/Linux/2016-05/131098.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="gnome-桌面"><a href="#gnome-桌面" class="headerlink" title="gnome 桌面"></a>gnome 桌面</h2><p>这里使用了 gnome 桌面</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get  install gnome</span><br></pre></td></tr></tbody></table></figure></div>

<p>一些常用的插件</p>
<ul>
<li><a class="link" href="https://extensions.gnome.org/extension/15/alternatetab/">AlternateTab<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> Alt+Tab 切换应用 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/97/coverflow-alt-tab/">Coverflow Alt-Tab<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 功能与 AlternateTab 相同，但提供了一个更酷炫的界面 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/6/applications-menu/">Applications Menu<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 顶栏显示应用菜单，我比较少用，但刚从 Windows 切换过来的或许需要 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/16/auto-move-windows/">Auto Move Windows<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 当应用创建窗口时自动移动到某个特定的工作空间 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/517/caffeine/">Caffeine<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 取消自动锁屏 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/779/clipboard-indicator/">Clipboard Indicator<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 剪贴板管理 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/307/dash-to-dock/">Dash to Dock<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 不解释 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/690/easyscreencast/">EasyScreenCast<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 屏幕录像，做演示时比较方便 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/1112/screenshot-tool/">Screenshot Tool<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 屏幕截图工具，也具有一些简单的图片编辑功能 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/906/sound-output-device-chooser/">Sound Input &amp; Output Device Chooser<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 更为方便地调节音量 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/587/gnomodoro/">Gnomodoro<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>简易番茄钟 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/53/pomodoro/">Pomodoro<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 增强的番茄钟，推荐使用。严格来说，它已经不是扩展了，作者现在将它做成了一个本地应用。对于 Debian，新的安装方法如下 </li>
</ul>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo aptitude install gnome-shell-pomodoro1</span><br></pre></td></tr></tbody></table></figure></div>

<p>其他发行版的请参考<a class="link" href="http://gnomepomodoro.org/">官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>相关说明</p>
<ul>
<li><a class="link" href="https://extensions.gnome.org/extension/545/hide-top-bar/">Hide Top Bar<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 全屏时自动隐藏顶栏 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/36/lock-keys/">Lock Keys<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 顶栏显示 Numlock 和 Capslock 的状态 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/104/netspeed/">NetSpeed<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 顶栏显示网速，喜欢简洁的 <a class="link" href="https://extensions.gnome.org/extension/1085/simple-net-speed/">Simple net speed<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>也非常不错 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/750/openweather/">OpenWeather<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 顶栏显示天气情况，gnome 自带的 weather 不支持顶栏显示，用起来不方便 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/8/places-status-indicator/">Places Status Indicator<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 为一些常用目录提供快速入口 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/120/system-monitor/">system-monitor<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 顶栏显示 CPU、内存、网速、温度、电池电量等信息，安装前需要解决依赖，在 Debian 上方法如下 </li>
</ul>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo aptitude install gir1.2-gtop-2.0 gir1.2-networkmanager-1.01</span><br></pre></td></tr></tbody></table></figure></div>

<p>如果你觉得它依赖不好解决，也可以使用另外一个具有相似功能的 <a class="link" href="https://extensions.gnome.org/extension/1064/system-monitor/">System Monitor<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<ul>
<li><a class="link" href="https://extensions.gnome.org/extension/584/taskbar/">TaskBar<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 类似于 Windows 任务栏，提供了可选的预览功能，可定制选项多 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/570/todotxt/">Todo.txt<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> GTD 应用，顶栏显示比较醒目 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/1031/topicons/">TopIcons Plus<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 顶栏显示应用图标，输入法切换的时候特别有用 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/19/user-themes/">User Themes<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 从本地安装 shell 主题 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/602/window-list/">Window List<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 在屏幕底部显示窗口列表，提供类似于 Windows 任务栏的功能，习惯 Windows 的可以考虑用这个过渡一下 </li>
<li><a class="link" href="https://extensions.gnome.org/extension/21/workspace-indicator/">Workspace Indicator<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 在顶栏显示当前所处的工作空间</li>
</ul>
<h2 id="关闭错误报告"><a href="#关闭错误报告" class="headerlink" title="关闭错误报告"></a>关闭错误报告</h2><p>用了 ubuntu16.04 日常弹出错误报告，贼鸡烦人，还是屏蔽了吧。</p>
<ul>
<li>临时关闭<br><code>sudo service apport stop</code><br>这个会在重启系统后失效。</li>
<li>永久关闭 。<br><code>sudo gedit /etc/default/apport</code><br>修改 enabled=0 ，重启生效</li>
<li>永久性的移除错误报告功能<br><code>sudo apt-get purge apport</code></li>
</ul>
<h2 id="grub-引导界面"><a href="#grub-引导界面" class="headerlink" title="grub 引导界面"></a>grub 引导界面</h2><p>引导界面黑呼呼的，这里美化一下</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://yu-r2-oss.tbox.fun/2025/07/16/1aw1qq-ly.webp" alt="image.png"></p>
<p><a class="link" href="http://tieba.baidu.com/p/3757812932">原地址<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<hr>
<p>下载地址：<a class="link" href="http://jump.bdimg.com/safecheck/index?url=x+Z5mMbGPAvVIlwZePSt0B3tEqEFWbC4tOatFxkC6cKanfXfzIDKrgp6dmAqUm/6JDvgW8VBrv2Dw7qcQcKtxp5dk8JYMvh7lUg4m8ZjPqeWXfdiEzsQBQT7S9u4Mkfjdj2oeHoEzTI=">http://pan.baidu.com/s/1i3ksK7N<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<hr>
<p>解压后里边的 deb 直接安装就可以</p>
]]></content>
      <tags>
        <tag>ubuntu</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>书签🔖</title>
    <url>/bookmarks/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>随笔</title>
    <url>/essays/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>友情链接</title>
    <url>/links/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>标签</title>
    <url>/tags/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>工具</title>
    <url>/tools/index.html</url>
    <content><![CDATA[<script type="text/javascript">
function SetCwinHeight(){
  var iframeid = document.getElementById("iframeid"); //iframe id
  if (document.getElementById) {
    if (iframeid && !window.opera) {
      if (iframeid.contentDocument && iframeid.contentDocument.body.offsetHeight) {
        iframeid.height = iframeid.contentDocument.body.offsetHeight + 50;
      } else if (iframeid.Document && iframeid.Document.body.scrollHeight) {
        frameid.height = iframeid.Document.body.scrollHeight + 50;
      }
    }
  }
}
</script>

<iframe width="100%" id="iframeid" onload="Javascript:SetCwinHeight()" scrolling="no" height="1000" frameborder="0" src="https://www.tooln.cn/tool/"></iframe>
]]></content>
  </entry>
</search>
